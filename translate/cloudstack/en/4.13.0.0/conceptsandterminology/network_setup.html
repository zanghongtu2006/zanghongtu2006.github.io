

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>基础网络和高级网络 &mdash; Apache CloudStack 4.13.0.0 文档</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../static/documentation_options.js"></script>
        <script type="text/javascript" src="../static/jquery.js"></script>
        <script type="text/javascript" src="../static/underscore.js"></script>
        <script type="text/javascript" src="../static/doctools.js"></script>
        <script type="text/javascript" src="../static/language_data.js"></script>
        <script type="text/javascript" src="https://assets.readthedocs.org/static/javascript/readthedocs-doc-embed.js"></script>
    
    <script type="text/javascript" src="../static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../static/theme_overrides.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="简介" href="storage_setup.html" />
    <link rel="prev" title="小规模部署" href="choosing_deployment_architecture.html" /> 

<!-- RTD Extra Head -->

<!-- 
Always link to the latest version, as canonical.
http://docs.readthedocs.org/en/latest/canonical.html
-->
<link rel="canonical" href="../../latest/conceptsandterminology/network_setup.html" />

<link rel="stylesheet" href="https://assets.readthedocs.org/static/css/readthedocs-doc-embed.css" type="text/css" />

<script type="text/javascript" src="../static/readthedocs-data.js"></script>

<!-- Add page-specific data, which must exist in the page js, not global -->
<script type="text/javascript">
READTHEDOCS_DATA['page'] = "conceptsandterminology/network_setup"
READTHEDOCS_DATA['source_suffix'] = ".rst"
</script>

<script type="text/javascript" src="https://assets.readthedocs.org/static/javascript/readthedocs-analytics.js"></script>

<!-- end RTD <extrahead> -->
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> Apache CloudStack
          

          
          </a>

          
            
            
            
              <div class="version">
                4.13.0.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">目录:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="reference internal" href="index.html">CloudStack 概念和术语</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="index.html#concepts-and-terminolgy">概念和术语</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#choosing-a-deployment-architecture">架构选型</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html#network-setup">网络配置</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="network_setup.html#">基础网络和高级网络</a></li>
<li class="toctree-l3"><a class="reference internal" href="network_setup.html#vlan-allocation-example">VLAN 划分示例</a></li>
<li class="toctree-l3"><a class="reference internal" href="network_setup.html#example-hardware-configuration">硬件交换机配置示例</a><ul>
<li class="toctree-l4"><a class="reference internal" href="network_setup.html#dell-62xx">Dell 62xx</a></li>
<li class="toctree-l4"><a class="reference internal" href="network_setup.html#cisco-3750">Cisco 3750</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="network_setup.html#layer-2-switch">二层交换机</a><ul>
<li class="toctree-l4"><a class="reference internal" href="network_setup.html#id1">Dell 62xx</a></li>
<li class="toctree-l4"><a class="reference internal" href="network_setup.html#id2">Cisco 3750</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="network_setup.html#hardware-firewall">硬件防火墙</a><ul>
<li class="toctree-l4"><a class="reference internal" href="network_setup.html#generic-firewall-provisions">Generic Firewall Provisions</a></li>
<li class="toctree-l4"><a class="reference internal" href="network_setup.html#external-guest-firewall-integration-for-juniper-srx-optional">External Guest Firewall Integration for Juniper SRX （可选）</a></li>
<li class="toctree-l4"><a class="reference internal" href="network_setup.html#external-guest-firewall-integration-for-cisco-vnmc-optional">External Guest Firewall Integration for Cisco VNMC （可选）</a></li>
<li class="toctree-l4"><a class="reference internal" href="network_setup.html#external-guest-load-balancer-integration-optional">External Guest Load Balancer Integration （可选）</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="network_setup.html#management-server-load-balancing">管理节点负载均衡</a></li>
<li class="toctree-l3"><a class="reference internal" href="network_setup.html#topology-requirements">拓扑要求</a><ul>
<li class="toctree-l4"><a class="reference internal" href="network_setup.html#security-requirements">安全 Requirements</a></li>
<li class="toctree-l4"><a class="reference internal" href="network_setup.html#runtime-internal-communications-requirements">Runtime Internal Communications Requirements</a></li>
<li class="toctree-l4"><a class="reference internal" href="network_setup.html#storage-network-topology-requirements">Storage Network 拓扑要求</a></li>
<li class="toctree-l4"><a class="reference internal" href="network_setup.html#external-firewall-topology-requirements">External Firewall 拓扑要求</a></li>
<li class="toctree-l4"><a class="reference internal" href="network_setup.html#advanced-zone-topology-requirements">Advanced Zone 拓扑要求</a></li>
<li class="toctree-l4"><a class="reference internal" href="network_setup.html#xenserver-topology-requirements">XenServer 拓扑要求</a></li>
<li class="toctree-l4"><a class="reference internal" href="network_setup.html#vmware-topology-requirements">VMware 拓扑要求</a></li>
<li class="toctree-l4"><a class="reference internal" href="network_setup.html#hyper-v-topology-requirements">Hyper-V 拓扑要求</a></li>
<li class="toctree-l4"><a class="reference internal" href="network_setup.html#kvm-topology-requirements">KVM 拓扑要求</a></li>
<li class="toctree-l4"><a class="reference internal" href="network_setup.html#lxc-topology-requirements">LXC 拓扑要求</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="network_setup.html#guest-network-usage-integration-for-traffic-sentinel">Guest Network Usage Integration for Traffic Sentinel</a></li>
<li class="toctree-l3"><a class="reference internal" href="network_setup.html#setting-zone-vlan-and-running-vm-maximums">Setting Zone VLAN and Running VM Maximums</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#storage-setup">存储配置</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../quickinstallationguide/qig.html">快速入门指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installguide/index.html">安装指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../upgrading/index.html">升级 CloudStack</a></li>
<li class="toctree-l1"><a class="reference internal" href="../adminguide/index.html">使用手册</a></li>
<li class="toctree-l1"><a class="reference internal" href="../developersguide/index.html">开发者手册</a></li>
<li class="toctree-l1"><a class="reference internal" href="../plugins/index.html">插件使用手册</a></li>
<li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">发行版本说明</a></li>
</ul>
<p class="caption"><span class="caption-text">其它:</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="http://cloudstack.apache.org/api.html">API 文档</a></li>
<li class="toctree-l1"><a class="reference external" href="https://cwiki.apache.org/confluence/display/CLOUDSTACK/Home">Apache CloudStack Wiki</a></li>
<li class="toctree-l1"><a class="reference external" href="http://cloudstack.apache.org/">Apache CloudStack 官网</a></li>
<li class="toctree-l1"><a class="reference external" href="http://cloudstack.apache.org/downloads.html">Apache CloudStack 源码</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/apache/cloudstack">Apache CloudStack on GitHub</a></li>
</ul>
<p class="caption"><span class="caption-text">Pre 4.11 Documentation:</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="../../../projects/cloudstack-installation.html">安装指南</a></li>
<li class="toctree-l1"><a class="reference external" href="../../../projects/cloudstack-administration.html">管理员手册</a></li>
<li class="toctree-l1"><a class="reference external" href="../../../projects/cloudstack-release-notes.html">发行版本说明</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Apache CloudStack</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">CloudStack 概念和术语</a> &raquo;</li>
        
      <li>基础网络和高级网络</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            
              <a href="https://github.com/apache/cloudstack-documentation/blob/4.13.0.0/source/conceptsandterminology/network_setup.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <p>Achieving the correct networking setup is crucial to a successful
CloudStack installation. This section contains information to help you
make decisions and follow the right procedures to get your network set
up correctly.</p>
<div class="section" id="basic-and-advanced-networking">
<h1>基础网络和高级网络<a class="headerlink" href="network_setup.html#basic-and-advanced-networking" title="Permalink to this headline">¶</a></h1>
<p>CloudStack provides two styles of networking:.</p>
<p><strong>Basic</strong>
For AWS-style networking. Provides a single network where guest isolation can
be provided through layer-3 means such as security groups (IP address source
filtering).</p>
<p><strong>Advanced</strong>
For more sophisticated network topologies. This network model provides the
most flexibility in defining guest networks, but requires more configuration
steps than basic networking.</p>
<p>Each zone has either basic or advanced networking. Once the choice of
networking model for a zone has been made and configured in CloudStack,
it can not be changed. A zone is either basic or advanced for its entire
lifetime.</p>
<p>The following table compares the networking features in the two networking models.</p>
<table border="1" class="table-striped table-bordered table-hover docutils">
<colgroup>
<col width="27%" />
<col width="38%" />
<col width="34%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Networking Feature</th>
<th class="head">Basic Network</th>
<th class="head">Advanced Network</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Number of networks</td>
<td>Single network</td>
<td>Multiple networks</td>
</tr>
<tr class="row-odd"><td>Firewall type</td>
<td>Physical</td>
<td>Physical and Virtual</td>
</tr>
<tr class="row-even"><td>Load balancer</td>
<td>Physical</td>
<td>Physical and Virtual</td>
</tr>
<tr class="row-odd"><td>Isolation type</td>
<td>Layer 3</td>
<td>Layer 2 and Layer 3</td>
</tr>
<tr class="row-even"><td>VPN support</td>
<td>No</td>
<td>Yes</td>
</tr>
<tr class="row-odd"><td>Port forwarding</td>
<td>Physical</td>
<td>Physical and Virtual</td>
</tr>
<tr class="row-even"><td>1:1 NAT</td>
<td>Physical</td>
<td>Physical and Virtual</td>
</tr>
<tr class="row-odd"><td>Source NAT</td>
<td>No</td>
<td>Physical and Virtual</td>
</tr>
<tr class="row-even"><td>Userdata</td>
<td>Yes</td>
<td>Yes</td>
</tr>
<tr class="row-odd"><td>Network usage monitoring</td>
<td>sFlow / netFlow at physical router</td>
<td>Hypervisor and 虚拟路由器</td>
</tr>
<tr class="row-even"><td>DNS 和 DHCP</td>
<td>Yes</td>
<td>Yes</td>
</tr>
</tbody>
</table>
<p>The two types of networking may be in use in the same cloud. However, a
given zone must use either Basic Networking or Advanced Networking.</p>
<p>Different types of network traffic can be segmented on the same physical
network. Guest traffic can also be segmented by account. To isolate
traffic, you can use separate VLANs. If you are using separate VLANs on
a single physical network, make sure the VLAN tags are in separate
numerical ranges.</p>
</div>
<div class="section" id="vlan-allocation-example">
<h1>VLAN 划分示例<a class="headerlink" href="network_setup.html#vlan-allocation-example" title="Permalink to this headline">¶</a></h1>
<p>VLANs are required for public and guest traffic. The following is an
example of a VLAN allocation scheme:</p>
<table border="1" class="table-striped table-bordered table-hover docutils">
<colgroup>
<col width="11%" />
<col width="33%" />
<col width="56%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">VLAN IDs</th>
<th class="head">Traffic type</th>
<th class="head">Scope</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>less than 500</td>
<td>Management traffic. Reserved for administrative purposes.</td>
<td>CloudStack software can access this, hypervisors, system VMs.</td>
</tr>
<tr class="row-odd"><td>500-599</td>
<td>VLAN carrying public traffic.</td>
<td>CloudStack accounts.</td>
</tr>
<tr class="row-even"><td>600-799</td>
<td>VLANs carrying guest traffic.</td>
<td>CloudStack accounts. Account-specific VLAN is chosen from this pool.</td>
</tr>
<tr class="row-odd"><td>800-899</td>
<td>VLANs carrying guest traffic.</td>
<td>CloudStack accounts. Account-specific VLAN chosen by CloudStack admin to assign to that account.</td>
</tr>
<tr class="row-even"><td>900-999</td>
<td>VLAN carrying guest traffic</td>
<td>CloudStack accounts. Can be scoped by project, domain, or all accounts.</td>
</tr>
<tr class="row-odd"><td>greater than 1000</td>
<td>Reserved for future use</td>
<td>&#160;</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="example-hardware-configuration">
<h1>硬件交换机配置示例<a class="headerlink" href="network_setup.html#example-hardware-configuration" title="Permalink to this headline">¶</a></h1>
<p>This section contains an example configuration of specific switch models
for zone-level layer-3 switching. It assumes VLAN management protocols,
such as VTP or GVRP, have been disabled. The example scripts must be
changed appropriately if you choose to use VTP or GVRP.</p>
<div class="section" id="dell-62xx">
<h2>Dell 62xx<a class="headerlink" href="network_setup.html#dell-62xx" title="Permalink to this headline">¶</a></h2>
<p>The following steps show how a Dell 62xx is configured for zone-level
layer-3 switching. These steps assume VLAN 201 is used to route untagged
private IPs for pod 1, and pod 1’s layer-2 switch is connected to
Ethernet port 1/g1.</p>
<p>The Dell 62xx Series switch supports up to 1024 VLANs.</p>
<ol class="arabic">
<li><p class="first">Configure all the VLANs in the database.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vlan</span> <span class="n">database</span>
<span class="n">vlan</span> <span class="mi">200</span><span class="o">-</span><span class="mi">999</span>
<span class="n">exit</span>
</pre></div>
</div>
</li>
<li><p class="first">Configure Ethernet port 1/g1.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">interface</span> <span class="n">ethernet</span> <span class="mi">1</span><span class="o">/</span><span class="n">g1</span>
<span class="n">switchport</span> <span class="n">mode</span> <span class="n">general</span>
<span class="n">switchport</span> <span class="n">general</span> <span class="n">pvid</span> <span class="mi">201</span>
<span class="n">switchport</span> <span class="n">general</span> <span class="n">allowed</span> <span class="n">vlan</span> <span class="n">add</span> <span class="mi">201</span> <span class="n">untagged</span>
<span class="n">switchport</span> <span class="n">general</span> <span class="n">allowed</span> <span class="n">vlan</span> <span class="n">add</span> <span class="mi">300</span><span class="o">-</span><span class="mi">999</span> <span class="n">tagged</span>
<span class="n">exit</span>
</pre></div>
</div>
</li>
</ol>
<p>The statements configure Ethernet port 1/g1 as follows:</p>
<ul class="simple">
<li>VLAN 201 is the native untagged VLAN for port 1/g1.</li>
<li>All VLANs (300-999) are passed to all the pod-level layer-2 switches.</li>
</ul>
</div>
<div class="section" id="cisco-3750">
<h2>Cisco 3750<a class="headerlink" href="network_setup.html#cisco-3750" title="Permalink to this headline">¶</a></h2>
<p>The following steps show how a Cisco 3750 is configured for zone-level
layer-3 switching. These steps assume VLAN 201 is used to route untagged
private IPs for pod 1, and pod 1’s layer-2 switch is connected to
GigabitEthernet1/0/1.</p>
<ol class="arabic">
<li><p class="first">Setting VTP mode to transparent allows us to utilize VLAN IDs above
1000. Since we only use VLANs up to 999, vtp transparent mode is not
strictly required.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vtp</span> <span class="n">mode</span> <span class="n">transparent</span>
<span class="n">vlan</span> <span class="mi">200</span><span class="o">-</span><span class="mi">999</span>
<span class="n">exit</span>
</pre></div>
</div>
</li>
<li><p class="first">Configure GigabitEthernet1/0/1.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">interface</span> <span class="n">GigabitEthernet1</span><span class="o">/</span><span class="mi">0</span><span class="o">/</span><span class="mi">1</span>
<span class="n">switchport</span> <span class="n">trunk</span> <span class="n">encapsulation</span> <span class="n">dot1q</span>
<span class="n">switchport</span> <span class="n">mode</span> <span class="n">trunk</span>
<span class="n">switchport</span> <span class="n">trunk</span> <span class="n">native</span> <span class="n">vlan</span> <span class="mi">201</span>
<span class="n">exit</span>
</pre></div>
</div>
</li>
</ol>
<p>The statements configure GigabitEthernet1/0/1 as follows:</p>
<ul class="simple">
<li>VLAN 201 is the native untagged VLAN for port GigabitEthernet1/0/1.</li>
<li>Cisco passes all VLANs by default. As a result, all VLANs (300-999)
are passed to all the pod-level layer-2 switches.</li>
</ul>
</div>
</div>
<div class="section" id="layer-2-switch">
<h1>二层交换机<a class="headerlink" href="network_setup.html#layer-2-switch" title="Permalink to this headline">¶</a></h1>
<p>The layer-2 switch is the access switching layer inside the pod.</p>
<ul class="simple">
<li>It should trunk all VLANs into every computing host.</li>
<li>It should switch traffic for the management network containing
computing and storage hosts. The layer-3 switch will serve as the
gateway for the management network.</li>
</ul>
<p>The following sections contain example configurations for specific switch models
for pod-level layer-2 switching. It assumes VLAN management protocols
such as VTP or GVRP have been disabled. The scripts must be changed
appropriately if you choose to use VTP or GVRP.</p>
<div class="section" id="id1">
<h2>Dell 62xx<a class="headerlink" href="network_setup.html#id1" title="Permalink to this headline">¶</a></h2>
<p>The following steps show how a Dell 62xx is configured for pod-level
layer-2 switching.</p>
<ol class="arabic">
<li><p class="first">Configure all the VLANs in the database.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vlan</span> <span class="n">database</span>
<span class="n">vlan</span> <span class="mi">300</span><span class="o">-</span><span class="mi">999</span>
<span class="n">exit</span>
</pre></div>
</div>
</li>
<li><p class="first">VLAN 201 is used to route untagged private IP addresses for pod 1,
and pod 1 is connected to this layer-2 switch.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">interface</span> <span class="nb">range</span> <span class="n">ethernet</span> <span class="nb">all</span>
<span class="n">switchport</span> <span class="n">mode</span> <span class="n">general</span>
<span class="n">switchport</span> <span class="n">general</span> <span class="n">allowed</span> <span class="n">vlan</span> <span class="n">add</span> <span class="mi">300</span><span class="o">-</span><span class="mi">999</span> <span class="n">tagged</span>
<span class="n">exit</span>
</pre></div>
</div>
</li>
</ol>
<p>The statements configure all Ethernet ports to function as follows:</p>
<ul class="simple">
<li>All ports are configured the same way.</li>
<li>All VLANs (300-999) are passed through all the ports of the layer-2
switch.</li>
</ul>
</div>
<div class="section" id="id2">
<h2>Cisco 3750<a class="headerlink" href="network_setup.html#id2" title="Permalink to this headline">¶</a></h2>
<p>The following steps show how a Cisco 3750 is configured for pod-level
layer-2 switching.</p>
<ol class="arabic">
<li><p class="first">Setting VTP mode to transparent allows us to utilize VLAN IDs above
1000. Since we only use VLANs up to 999, vtp transparent mode is not
strictly required.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vtp</span> <span class="n">mode</span> <span class="n">transparent</span>
<span class="n">vlan</span> <span class="mi">300</span><span class="o">-</span><span class="mi">999</span>
<span class="n">exit</span>
</pre></div>
</div>
</li>
<li><p class="first">Configure all ports to dot1q and set 201 as the native VLAN.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">interface</span> <span class="nb">range</span> <span class="n">GigabitEthernet</span> <span class="mi">1</span><span class="o">/</span><span class="mi">0</span><span class="o">/</span><span class="mi">1</span><span class="o">-</span><span class="mi">24</span>
<span class="n">switchport</span> <span class="n">trunk</span> <span class="n">encapsulation</span> <span class="n">dot1q</span>
<span class="n">switchport</span> <span class="n">mode</span> <span class="n">trunk</span>
<span class="n">switchport</span> <span class="n">trunk</span> <span class="n">native</span> <span class="n">vlan</span> <span class="mi">201</span>
<span class="n">exit</span>
</pre></div>
</div>
</li>
</ol>
<p>By default, Cisco passes all VLANs. Cisco switches complain of the
native VLAN IDs are different when 2 ports are connected together.
That’s why you must specify VLAN 201 as the native VLAN on the layer-2
switch.</p>
</div>
</div>
<div class="section" id="hardware-firewall">
<h1>硬件防火墙<a class="headerlink" href="network_setup.html#hardware-firewall" title="Permalink to this headline">¶</a></h1>
<p>All deployments should have a firewall protecting the management server;
see Generic Firewall Provisions. Optionally, some deployments may also
have a Juniper SRX firewall that will be the default gateway for the
guest networks; see <a class="reference internal" href="network_setup.html#external-guest-firewall-integration-for-juniper-srx-optional"><span class="std std-ref">External Guest Firewall Integration for Juniper SRX （可选）</span></a></p>
<div class="section" id="generic-firewall-provisions">
<h2>Generic Firewall Provisions<a class="headerlink" href="network_setup.html#generic-firewall-provisions" title="Permalink to this headline">¶</a></h2>
<p>The hardware firewall is required to serve two purposes:</p>
<ul class="simple">
<li>Protect the Management Servers. NAT and port forwarding should be
configured to direct traffic from the public Internet to the
Management Servers.</li>
<li>Route management network traffic between multiple zones. Site-to-site
VPN should be configured between multiple zones.</li>
</ul>
<p>To achieve the above purposes you must set up fixed configurations for
the firewall. Firewall rules and policies need not change as users are
provisioned into the cloud. Any brand of hardware firewall that supports
NAT and site-to-site VPN can be used.</p>
</div>
<div class="section" id="external-guest-firewall-integration-for-juniper-srx-optional">
<span id="id3"></span><h2>External Guest Firewall Integration for Juniper SRX （可选）<a class="headerlink" href="network_setup.html#external-guest-firewall-integration-for-juniper-srx-optional" title="Permalink to this headline">¶</a></h2>
<div class="admonition note">
<p class="first admonition-title">提示</p>
<p class="last">Available only for guests using advanced networking.</p>
</div>
<p>CloudStack provides for direct management of the Juniper SRX series of
firewalls. This enables CloudStack to establish static NAT mappings from
public IPs to guest VMs, and to use the Juniper device in place of the
virtual router for firewall services. You can have one or more Juniper
SRX per zone. This feature is optional. If Juniper integration is not
provisioned, CloudStack will use the virtual router for these services.</p>
<p>The Juniper SRX can optionally be used in conjunction with an external
load balancer. External Network elements can be deployed in a
side-by-side or inline configuration.</p>
<p><img alt="parallel-mode.png: adding a firewall and load balancer in parallel mode." src="../images/parallel-mode.png" /></p>
<p>CloudStack requires the Juniper SRX firewall to be configured as follows:</p>
<div class="admonition note">
<p class="first admonition-title">提示</p>
<p class="last">Supported SRX software version is 10.3 or higher.</p>
</div>
<ol class="arabic">
<li><p class="first">Install your SRX appliance according to the vendor’s instructions.</p>
</li>
<li><p class="first">Connect one interface to the management network and one interface to
the public network. Alternatively, you can connect the same interface
to both networks and a use a VLAN for the public network.</p>
</li>
<li><p class="first">Make sure “vlan-tagging” is enabled on the private interface.</p>
</li>
<li><p class="first">Record the public and private interface names. If you used a VLAN for
the public interface, add a “.[VLAN TAG]” after the interface name.
For example, if you are using ge-0/0/3 for your public interface and
VLAN tag 301, your public interface name would be “ge-0/0/3.301”.
Your private interface name should always be untagged because the
CloudStack software automatically creates tagged logical interfaces.</p>
</li>
<li><p class="first">Create a public security zone and a private security zone. By
default, these will already exist and will be called “untrust” and
“trust”. Add the public interface to the public zone and the private
interface to the private zone. Note down the security zone names.</p>
</li>
<li><p class="first">Make sure there is a security policy from the private zone to the
public zone that allows all traffic.</p>
</li>
<li><p class="first">Note the username and password of the account you want the CloudStack
software to log in to when it is programming rules.</p>
</li>
<li><p class="first">Make sure the “ssh” and “xnm-clear-text” system services are enabled.</p>
</li>
<li><p class="first">If traffic metering is desired:</p>
<ol class="arabic">
<li><p class="first">Create an incoming firewall filter and an outgoing firewall
filter. These filters should be the same names as your public
security zone name and private security zone name respectively.
The filters should be set to be “interface-specific”. For example,
here is the configuration where the public zone is “untrust” and
the private zone is “trust”:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">root</span><span class="nd">@cloud</span><span class="o">-</span><span class="n">srx</span><span class="c1"># show firewall</span>
<span class="nb">filter</span> <span class="n">trust</span> <span class="p">{</span>
    <span class="n">interface</span><span class="o">-</span><span class="n">specific</span><span class="p">;</span>
<span class="p">}</span>
<span class="nb">filter</span> <span class="n">untrust</span> <span class="p">{</span>
    <span class="n">interface</span><span class="o">-</span><span class="n">specific</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
<li><p class="first">Add the firewall filters to your public interface. For example, a
sample configuration output (for public interface ge-0/0/3.0,
public security zone untrust, and private security zone trust) is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ge</span><span class="o">-</span><span class="mi">0</span><span class="o">/</span><span class="mi">0</span><span class="o">/</span><span class="mi">3</span> <span class="p">{</span>
    <span class="n">unit</span> <span class="mi">0</span> <span class="p">{</span>
        <span class="n">family</span> <span class="n">inet</span> <span class="p">{</span>
            <span class="nb">filter</span> <span class="p">{</span>
                <span class="nb">input</span> <span class="n">untrust</span><span class="p">;</span>
                <span class="n">output</span> <span class="n">trust</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">address</span> <span class="mf">172.25</span><span class="o">.</span><span class="mf">0.252</span><span class="o">/</span><span class="mi">16</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>
</div>
</li>
</ol>
</li>
<li><p class="first">Make sure all VLANs are brought to the private interface of the SRX.</p>
</li>
<li><p class="first">After the CloudStack 管理服务 is installed, log in to the
CloudStack UI as administrator.</p>
</li>
<li><p class="first">In the left navigation bar, click Infrastructure.</p>
</li>
<li><p class="first">In Zones, click View More.</p>
</li>
<li><p class="first">Choose the zone you want to work with.</p>
</li>
<li><p class="first">Click the Network tab.</p>
</li>
<li><p class="first">In the Network Service Providers node of the diagram, click
Configure. (You might have to scroll down to see this.)</p>
</li>
<li><p class="first">Click SRX.</p>
</li>
<li><p class="first">Click the Add New SRX button (+) and provide the following:</p>
<ul class="simple">
<li>IP Address: The IP address of the SRX.</li>
<li>Username: The user name of the account on the SRX that CloudStack
should use.</li>
<li>Password: The password of the account.</li>
<li>Public Interface. The name of the public interface on the SRX. For
example, ge-0/0/2. A “.x” at the end of the interface indicates
the VLAN that is in use.</li>
<li>Private Interface: The name of the private interface on the SRX.
For example, ge-0/0/1.</li>
<li>Usage Interface: （可选） Typically, the public interface is
used to meter traffic. If you want to use a different interface,
specify its name here</li>
<li>Number of Retries: The number of times to attempt a command on the
SRX before failing. The default value is 2.</li>
<li>Timeout (seconds): The time to wait for a command on the SRX
before considering it failed. Default is 300 seconds.</li>
<li>Public Network: The name of the public network on the SRX. For
example, trust.</li>
<li>Private Network: The name of the private network on the SRX. For
example, untrust.</li>
<li>Capacity: The number of networks the device can handle</li>
<li>Dedicated: When marked as dedicated, this device will be dedicated
to a single account. When Dedicated is checked, the value in the
Capacity field has no significance implicitly, its value is 1</li>
</ul>
</li>
<li><p class="first">Click OK.</p>
</li>
<li><p class="first">Click Global Settings. Set the parameter
external.network.stats.interval to indicate how often you want
CloudStack to fetch network usage statistics from the Juniper SRX. If
you are not using the SRX to gather network usage statistics, set to 0.</p>
</li>
</ol>
</div>
<div class="section" id="external-guest-firewall-integration-for-cisco-vnmc-optional">
<h2>External Guest Firewall Integration for Cisco VNMC （可选）<a class="headerlink" href="network_setup.html#external-guest-firewall-integration-for-cisco-vnmc-optional" title="Permalink to this headline">¶</a></h2>
<p>Cisco Virtual Network Management Center (VNMC) provides centralized
multi-device and policy management for Cisco Network Virtual Services.
You can integrate Cisco VNMC with CloudStack to leverage the firewall
and NAT service offered by ASA 1000v Cloud Firewall. Use it in a Cisco
Nexus 1000v dvSwitch-enabled cluster in CloudStack. In such a
deployment, you will be able to:</p>
<ul class="simple">
<li>Configure Cisco ASA 1000v firewalls. You can configure one per guest
network.</li>
<li>Use Cisco ASA 1000v firewalls to create and apply security profiles
that contain ACL policy sets for both ingress and egress traffic.</li>
<li>Use Cisco ASA 1000v firewalls to create and apply Source NAT, Port
Forwarding, and Static NAT policy sets.</li>
</ul>
<p>CloudStack supports Cisco VNMC on Cisco Nexus 1000v dvSwich-enabled
VMware hypervisors.</p>
<div class="section" id="using-cisco-asa-1000v-firewall-cisco-nexus-1000v-dvswitch-and-cisco-vnmc-in-a-deployment">
<h3>Using Cisco ASA 1000v Firewall, Cisco Nexus 1000v dvSwitch, and Cisco VNMC in a Deployment<a class="headerlink" href="network_setup.html#using-cisco-asa-1000v-firewall-cisco-nexus-1000v-dvswitch-and-cisco-vnmc-in-a-deployment" title="Permalink to this headline">¶</a></h3>
<div class="section" id="guidelines">
<h4>Guidelines<a class="headerlink" href="network_setup.html#guidelines" title="Permalink to this headline">¶</a></h4>
<ul>
<li><p class="first">Cisco ASA 1000v firewall is supported only in Isolated Guest
Networks.</p>
</li>
<li><p class="first">Cisco ASA 1000v firewall is not supported on VPC.</p>
</li>
<li><p class="first">Cisco ASA 1000v firewall is not supported for load balancing.</p>
</li>
<li><p class="first">When a guest network is created with Cisco VNMC firewall provider, an
additional public IP is acquired along with the Source NAT IP. The
Source NAT IP is used for the rules, whereas the additional IP is
used to for the ASA outside interface. Ensure that this additional
public IP is not released. You can identify this IP as soon as the
network is in implemented state and before acquiring any further
public IPs. The additional IP is the one that is not marked as Source
NAT. You can find the IP used for the ASA outside interface by
looking at the Cisco VNMC used in your guest network.</p>
</li>
<li><p class="first">Use the public IP address range from a single subnet. You cannot add
IP addresses from different subnets.</p>
</li>
<li><p class="first">Only one ASA instance per VLAN is allowed because multiple VLANS
cannot be trunked to ASA ports. Therefore, you can use only one ASA
instance in a guest network.</p>
</li>
<li><p class="first">Only one Cisco VNMC per zone is allowed.</p>
</li>
<li><p class="first">Supported only in Inline mode deployment with load balancer.</p>
</li>
<li><p class="first">The ASA firewall rule is applicable to all the public IPs in the
guest network. Unlike the firewall rules created on virtual router, a
rule created on the ASA device is not tied to a specific public IP.</p>
</li>
<li><p class="first">Use a version of Cisco Nexus 1000v dvSwitch that support the vservice
command. For example: nexus-1000v.4.2.1.SV1.5.2b.bin</p>
<p>Cisco VNMC requires the vservice command to be available on the Nexus
switch to create a guest network in CloudStack.</p>
</li>
</ul>
</div>
<div class="section" id="prerequisites">
<h4>前提<a class="headerlink" href="network_setup.html#prerequisites" title="Permalink to this headline">¶</a></h4>
<ol class="arabic">
<li><p class="first">Configure Cisco Nexus 1000v dvSwitch in a vCenter environment.</p>
<p>Create Port profiles for both internal and external network
interfaces on Cisco Nexus 1000v dvSwitch. Note down the inside port
profile, which needs to be provided while adding the ASA appliance to
CloudStack.</p>
<p>For information on configuration, see <a class="reference internal" href="../installguide/hypervisor/vsphere.html#configuring-a-vsphere-cluster-with-nexus-1000v-virtual-switch"><span class="std std-ref">Configuring a vSphere 集群 with Nexus 1000v Virtual Switch</span></a>.</p>
</li>
<li><p class="first">Deploy and configure Cisco VNMC.</p>
<p>For more information, see
<a class="reference external" href="http://www.cisco.com/en/US/docs/switches/datacenter/vsg/sw/4_2_1_VSG_2_1_1/install_upgrade/guide/b_Cisco_VSG_for_VMware_vSphere_Rel_4_2_1_VSG_2_1_1_and_Cisco_VNMC_Rel_2_1_Installation_and_Upgrade_Guide_chapter_011.html">Installing Cisco Virtual Network Management Center</a>
and <a class="reference external" href="http://www.cisco.com/en/US/docs/unified_computing/vnmc/sw/1.2/VNMC_GUI_Configuration/b_VNMC_GUI_Configuration_Guide_1_2_chapter_010.html">Configuring Cisco Virtual Network Management Center</a>.</p>
</li>
<li><p class="first">Register Cisco Nexus 1000v dvSwitch with Cisco VNMC.</p>
<p>For more information, see <a class="reference external" href="http://www.cisco.com/en/US/docs/switches/datacenter/vsg/sw/4_2_1_VSG_1_2/vnmc_and_vsg_qi/guide/vnmc_vsg_install_5register.html#wp1064301">Registering a Cisco Nexus 1000V with Cisco VNMC</a>.</p>
</li>
<li><p class="first">Create Inside and Outside port profiles in Cisco Nexus 1000v dvSwitch.</p>
<p>For more information, see <a class="reference internal" href="../installguide/hypervisor/vsphere.html#configuring-a-vsphere-cluster-with-nexus-1000v-virtual-switch"><span class="std std-ref">Configuring a vSphere 集群 with Nexus 1000v Virtual Switch</span></a>.</p>
</li>
<li><p class="first">Deploy and Cisco ASA 1000v appliance.</p>
<p>For more information, see <a class="reference external" href="http://www.cisco.com/en/US/docs/security/asa/quick_start/asa1000V/setup_vnmc.html">Setting Up the ASA 1000V Using VNMC</a>.</p>
<p>Typically, you create a pool of ASA 1000v appliances and register
them with CloudStack.</p>
<p>Specify the following while setting up a Cisco ASA 1000v instance:</p>
<ul class="simple">
<li>VNMC host IP.</li>
<li>Ensure that you add ASA appliance in VNMC mode.</li>
<li>Port profiles for the Management and HA network interfaces. This
need to be pre-created on Cisco Nexus 1000v dvSwitch.</li>
<li>Internal and external port profiles.</li>
<li>The Management IP for Cisco ASA 1000v appliance. Specify the
gateway such that the VNMC IP is reachable.</li>
<li>Administrator credentials</li>
<li>VNMC credentials</li>
</ul>
</li>
<li><p class="first">Register Cisco ASA 1000v with VNMC.</p>
<p>After Cisco ASA 1000v instance is powered on, register VNMC from the
ASA console.</p>
</li>
</ol>
</div>
<div class="section" id="using-cisco-asa-1000v-services">
<h4>Using Cisco ASA 1000v Services<a class="headerlink" href="network_setup.html#using-cisco-asa-1000v-services" title="Permalink to this headline">¶</a></h4>
<ol class="arabic">
<li><p class="first">Ensure that all the prerequisites are met.</p>
<p>See <a class="reference external" href="network_setup.html#prerequisites">“前提”</a>.</p>
</li>
<li><p class="first">Add a VNMC instance.</p>
<p>See <a class="reference external" href="network_setup.html#adding-a-vnmc-instance">“Adding a VNMC Instance”</a>.</p>
</li>
<li><p class="first">Add a ASA 1000v instance.</p>
<p>See <a class="reference internal" href="network_setup.html#adding-an-asa-1000v-instance"><span class="std std-ref">Adding an ASA 1000v Instance</span></a>.</p>
</li>
<li><p class="first">Create a Network Offering and use Cisco VNMC as the service provider
for desired services.</p>
<p>See <a class="reference internal" href="network_setup.html#creating-a-network-offering-using-cisco-asa-1000v"><span class="std std-ref">Creating a Network Offering Using Cisco ASA 1000v</span></a>.</p>
</li>
<li><p class="first">Create an Isolated Guest Network by using the network offering you
just created.</p>
</li>
</ol>
</div>
</div>
<div class="section" id="id5">
<h3>Adding a VNMC Instance<a class="headerlink" href="network_setup.html#id5" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p class="first">Log in to the CloudStack UI as administrator.</p>
</li>
<li><p class="first">In the left navigation bar, click Infrastructure.</p>
</li>
<li><p class="first">In Zones, click View More.</p>
</li>
<li><p class="first">Choose the zone you want to work with.</p>
</li>
<li><p class="first">Click the Physical Network tab.</p>
</li>
<li><p class="first">In the Network Service Providers node of the diagram, click
Configure.</p>
<p>You might have to scroll down to see this.</p>
</li>
<li><p class="first">Click Cisco VNMC.</p>
</li>
<li><p class="first">Click View VNMC Devices.</p>
</li>
<li><p class="first">Click the Add VNMC Device and provide the following:</p>
<ul class="simple">
<li>Host: The IP address of the VNMC instance.</li>
<li>Username: The user name of the account on the VNMC instance that
CloudStack should use.</li>
<li>Password: The password of the account.</li>
</ul>
</li>
<li><p class="first">Click OK.</p>
</li>
</ol>
</div>
<div class="section" id="adding-an-asa-1000v-instance">
<span id="id6"></span><h3>Adding an ASA 1000v Instance<a class="headerlink" href="network_setup.html#adding-an-asa-1000v-instance" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p class="first">Log in to the CloudStack UI as administrator.</p>
</li>
<li><p class="first">In the left navigation bar, click Infrastructure.</p>
</li>
<li><p class="first">In Zones, click View More.</p>
</li>
<li><p class="first">Choose the zone you want to work with.</p>
</li>
<li><p class="first">Click the Physical Network tab.</p>
</li>
<li><p class="first">In the Network Service Providers node of the diagram, click
Configure.</p>
<p>You might have to scroll down to see this.</p>
</li>
<li><p class="first">Click Cisco VNMC.</p>
</li>
<li><p class="first">Click View ASA 1000v.</p>
</li>
<li><p class="first">Click the Add CiscoASA1000v Resource and provide the following:</p>
<ul>
<li><p class="first"><strong>Host</strong>: The management IP address of the ASA 1000v instance. The
IP address is used to connect to ASA 1000V.</p>
</li>
<li><p class="first"><strong>Inside Port Profile</strong>: The Inside Port Profile configured on
Cisco Nexus1000v dvSwitch.</p>
</li>
<li><p class="first"><strong>集群</strong>: The VMware cluster to which you are adding the ASA
1000v instance.</p>
<p>Ensure that the cluster is Cisco Nexus 1000v dvSwitch enabled.</p>
</li>
</ul>
</li>
<li><p class="first">Click OK.</p>
</li>
</ol>
</div>
<div class="section" id="creating-a-network-offering-using-cisco-asa-1000v">
<span id="id7"></span><h3>Creating a Network Offering Using Cisco ASA 1000v<a class="headerlink" href="network_setup.html#creating-a-network-offering-using-cisco-asa-1000v" title="Permalink to this headline">¶</a></h3>
<p>To have Cisco ASA 1000v support for a guest network, create a network
offering as follows:</p>
<ol class="arabic">
<li><p class="first">Log in to the CloudStack UI as a user or admin.</p>
</li>
<li><p class="first">From the Select Offering drop-down, choose Network Offering.</p>
</li>
<li><p class="first">Click Add Network Offering.</p>
</li>
<li><p class="first">In the dialog, make the following choices:</p>
<ul class="simple">
<li><strong>Name</strong>: Any desired name for the network offering.</li>
<li><strong>Description</strong>: A short description of the offering that can be
displayed to users.</li>
<li><strong>Network Rate</strong>: Allowed data transfer rate in MB per second.</li>
<li><strong>Traffic Type</strong>: The type of network traffic that will be carried
on the network.</li>
<li><strong>Guest Type</strong>: Choose whether the guest network is isolated or
shared.</li>
<li><strong>Persistent</strong>: Indicate whether the guest network is persistent
or not. The network that you can provision without having to
deploy a VM on it is termed persistent network.</li>
<li><strong>VPC</strong>: This option indicate whether the guest network is Virtual
Private Cloud-enabled. A Virtual Private Cloud (VPC) is a private,
isolated part of CloudStack. A VPC can have its own virtual
network topology that resembles a traditional physical network.
For more information on VPCs, see :ref: <cite>about-vpc</cite>.</li>
<li><strong>Specify VLAN</strong>: (Isolated guest networks only) Indicate whether
a VLAN should be specified when this offering is used.</li>
<li><strong>Supported Services</strong>: Use Cisco VNMC as the service provider for
Firewall, Source NAT, Port Forwarding, and Static NAT to create an
Isolated guest network offering.</li>
<li><strong>System Offering</strong>: Choose the system service offering that you
want virtual routers to use in this network.</li>
<li><strong>Conserve mode</strong>: Indicate whether to use conserve mode. In this
mode, network resources are allocated only when the first virtual
machine starts in the network.</li>
</ul>
</li>
<li><p class="first">Click OK</p>
<p>The network offering is created.</p>
</li>
</ol>
</div>
<div class="section" id="reusing-asa-1000v-appliance-in-new-guest-networks">
<h3>Reusing ASA 1000v Appliance in new Guest Networks<a class="headerlink" href="network_setup.html#reusing-asa-1000v-appliance-in-new-guest-networks" title="Permalink to this headline">¶</a></h3>
<p>You can reuse an ASA 1000v appliance in a new guest network after the
necessary cleanup. Typically, ASA 1000v is cleaned up when the logical
edge firewall is cleaned up in VNMC. If this cleanup does not happen,
you need to reset the appliance to its factory settings for use in new
guest networks. As part of this, enable SSH on the appliance and store
the SSH credentials by registering on VNMC.</p>
<ol class="arabic">
<li><p class="first">Open a command line on the ASA appliance:</p>
<ol class="arabic">
<li><p class="first">Run the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ASA1000V</span><span class="p">(</span><span class="n">config</span><span class="p">)</span><span class="c1"># reload</span>
</pre></div>
</div>
<p>You are prompted with the following message:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>System config has been modified. Save? [Y]es/[N]o:&quot;
</pre></div>
</div>
</li>
<li><p class="first">Enter N.</p>
<p>You will get the following confirmation message:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;Proceed with reload? [confirm]&quot;</span>
</pre></div>
</div>
</li>
<li><p class="first">Restart the appliance.</p>
</li>
</ol>
</li>
<li><p class="first">Register the ASA 1000v appliance with the VNMC:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ASA1000V</span><span class="p">(</span><span class="n">config</span><span class="p">)</span><span class="c1"># vnmc policy-agent</span>
<span class="n">ASA1000V</span><span class="p">(</span><span class="n">config</span><span class="o">-</span><span class="n">vnmc</span><span class="o">-</span><span class="n">policy</span><span class="o">-</span><span class="n">agent</span><span class="p">)</span><span class="c1"># registration host vnmc_ip_address</span>
<span class="n">ASA1000V</span><span class="p">(</span><span class="n">config</span><span class="o">-</span><span class="n">vnmc</span><span class="o">-</span><span class="n">policy</span><span class="o">-</span><span class="n">agent</span><span class="p">)</span><span class="c1"># shared-secret key where key is the shared secret for authentication of the ASA 1000V connection to the Cisco VNMC</span>
</pre></div>
</div>
</li>
</ol>
</div>
</div>
<div class="section" id="external-guest-load-balancer-integration-optional">
<h2>External Guest Load Balancer Integration （可选）<a class="headerlink" href="network_setup.html#external-guest-load-balancer-integration-optional" title="Permalink to this headline">¶</a></h2>
<p>CloudStack can optionally use a Citrix NetScaler or BigIP F5 load
balancer to provide load balancing services to guests. If this is not
enabled, CloudStack will use the software load balancer in the virtual
router.</p>
<p>To install and enable an external load balancer for CloudStack
management:</p>
<ol class="arabic">
<li><p class="first">Set up the appliance according to the vendor’s directions.</p>
</li>
<li><p class="first">Connect it to the networks carrying public traffic and management
traffic (these could be the same network).</p>
</li>
<li><p class="first">Record the IP address, username, password, public interface name, and
private interface name. The interface names will be something like
“1.1” or “1.2”.</p>
</li>
<li><p class="first">Make sure that the VLANs are trunked to the management network
interface.</p>
</li>
<li><p class="first">After the CloudStack 管理服务 is installed, log in as
administrator to the CloudStack UI.</p>
</li>
<li><p class="first">In the left navigation bar, click Infrastructure.</p>
</li>
<li><p class="first">In Zones, click View More.</p>
</li>
<li><p class="first">Choose the zone you want to work with.</p>
</li>
<li><p class="first">Click the Network tab.</p>
</li>
<li><p class="first">In the Network Service Providers node of the diagram, click
Configure. (You might have to scroll down to see this.)</p>
</li>
<li><p class="first">Click NetScaler or F5.</p>
</li>
<li><p class="first">Click the Add button (+) and provide the following:</p>
<p>For NetScaler:</p>
<ul class="simple">
<li>IP Address: The IP address of the SRX.</li>
<li>Username/Password: The authentication credentials to access the
device. CloudStack uses these credentials to access the device.</li>
<li>Type: The type of device that is being added. It could be F5 Big
Ip Load Balancer, NetScaler VPX, NetScaler MPX, or NetScaler SDX.
For a comparison of the NetScaler types, see the CloudStack
管理员手册.</li>
<li>Public interface: Interface of device that is configured to be
part of the public network.</li>
<li>Private interface: Interface of device that is configured to be
part of the private network.</li>
<li>Number of retries. Number of times to attempt a command on the
device before considering the operation failed. Default is 2.</li>
<li>Capacity: The number of networks the device can handle.</li>
<li>Dedicated: When marked as dedicated, this device will be dedicated
to a single account. When Dedicated is checked, the value in the
Capacity field has no significance implicitly, its value is 1.</li>
</ul>
</li>
<li><p class="first">Click OK.</p>
</li>
</ol>
<p>The installation and provisioning of the external load balancer is
finished. You can proceed to add VMs and NAT or load balancing rules.</p>
</div>
</div>
<div class="section" id="management-server-load-balancing">
<h1>管理节点负载均衡<a class="headerlink" href="network_setup.html#management-server-load-balancing" title="Permalink to this headline">¶</a></h1>
<p>CloudStack can use a load balancer to provide a virtual IP for multiple
Management Servers. The administrator is responsible for creating the
load balancer rules for the Management Servers. The application requires
persistence or stickiness across multiple sessions. The following chart
lists the ports that should be load balanced and whether or not
persistence is required.</p>
<p>Even if persistence is not required, enabling it is permitted.</p>
<table border="1" class="table-striped table-bordered table-hover docutils">
<colgroup>
<col width="16%" />
<col width="35%" />
<col width="19%" />
<col width="30%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Source Port</th>
<th class="head">Destination Port</th>
<th class="head">Protocol</th>
<th class="head">Persistence Required?</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>80 or 443</td>
<td>8080 (or 20400 with AJP)</td>
<td>HTTP (or AJP)</td>
<td>Yes</td>
</tr>
<tr class="row-odd"><td>8250</td>
<td>8250</td>
<td>TCP</td>
<td>Yes</td>
</tr>
<tr class="row-even"><td>8096</td>
<td>8096</td>
<td>HTTP</td>
<td>No</td>
</tr>
</tbody>
</table>
<p>In addition to above settings, the administrator is responsible for
setting the ‘host’ global config value from the management server IP to
load balancer virtual IP address. If the ‘host’ value is not set to the
VIP for Port 8250 and one of your management servers crashes, the UI is
still available but the system VMs will not be able to contact the
management server.</p>
</div>
<div class="section" id="topology-requirements">
<h1>拓扑要求<a class="headerlink" href="network_setup.html#topology-requirements" title="Permalink to this headline">¶</a></h1>
<div class="section" id="security-requirements">
<h2>安全 Requirements<a class="headerlink" href="network_setup.html#security-requirements" title="Permalink to this headline">¶</a></h2>
<p>The public Internet must not be able to access port 8096 or port 8250 on
the 管理服务.</p>
</div>
<div class="section" id="runtime-internal-communications-requirements">
<h2>Runtime Internal Communications Requirements<a class="headerlink" href="network_setup.html#runtime-internal-communications-requirements" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>The Management Servers communicate with each other to coordinate
tasks. This communication uses TCP on ports 8250 and 9090.</li>
<li>The console proxy VMs connect to all hosts in the zone over the
management traffic network. Therefore the management traffic network
of any given pod in the zone must have connectivity to the management
traffic network of all other pods in the zone.</li>
<li>The secondary storage VMs and console proxy VMs connect to the
管理服务 on port 8250. If you are using multiple Management
Servers, the load balanced IP address of the Management Servers on
port 8250 must be reachable.</li>
</ul>
</div>
<div class="section" id="storage-network-topology-requirements">
<h2>Storage Network 拓扑要求<a class="headerlink" href="network_setup.html#storage-network-topology-requirements" title="Permalink to this headline">¶</a></h2>
<p>The secondary storage NFS export is mounted by the secondary storage VM.
Secondary storage traffic goes over the management traffic network, even
if there is a 独立存储网络. Primary storage traffic goes
over the storage network, if available. If you choose to place secondary
storage NFS servers on the storage network, you must make sure there is
a route from the management traffic network to the storage network.</p>
</div>
<div class="section" id="external-firewall-topology-requirements">
<h2>External Firewall 拓扑要求<a class="headerlink" href="network_setup.html#external-firewall-topology-requirements" title="Permalink to this headline">¶</a></h2>
<p>When external firewall integration is in place, the public IP VLAN must
still be trunked to the Hosts. This is required to support the Secondary
Storage VM and 控制台代理 VM.</p>
</div>
<div class="section" id="advanced-zone-topology-requirements">
<h2>Advanced Zone 拓扑要求<a class="headerlink" href="network_setup.html#advanced-zone-topology-requirements" title="Permalink to this headline">¶</a></h2>
<p>With Advanced Networking, separate subnets must be used for private and
public networks.</p>
</div>
<div class="section" id="xenserver-topology-requirements">
<h2>XenServer 拓扑要求<a class="headerlink" href="network_setup.html#xenserver-topology-requirements" title="Permalink to this headline">¶</a></h2>
<p>The Management Servers communicate with XenServer hosts on ports 22
(ssh), 80 (HTTP), and 443 (HTTPs).</p>
</div>
<div class="section" id="vmware-topology-requirements">
<h2>VMware 拓扑要求<a class="headerlink" href="network_setup.html#vmware-topology-requirements" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>The 管理服务 and secondary storage VMs must be able to
access vCenter and all ESXi hosts in the zone. To allow the necessary
access through the firewall, keep port 443 open.</li>
<li>The Management Servers communicate with VMware vCenter servers on
port 443 (HTTPs).</li>
<li>The Management Servers communicate with the System VMs on port 3922
(ssh) on the management traffic network.</li>
</ul>
</div>
<div class="section" id="hyper-v-topology-requirements">
<h2>Hyper-V 拓扑要求<a class="headerlink" href="network_setup.html#hyper-v-topology-requirements" title="Permalink to this headline">¶</a></h2>
<p>CloudStack 管理服务 communicates with Hyper-V Agent by using
HTTPS. For secure communication between the 管理服务 and the
Hyper-V host, open port 8250.</p>
</div>
<div class="section" id="kvm-topology-requirements">
<h2>KVM 拓扑要求<a class="headerlink" href="network_setup.html#kvm-topology-requirements" title="Permalink to this headline">¶</a></h2>
<p>The Management Servers communicate with KVM hosts on port 22 (ssh).</p>
</div>
<div class="section" id="lxc-topology-requirements">
<h2>LXC 拓扑要求<a class="headerlink" href="network_setup.html#lxc-topology-requirements" title="Permalink to this headline">¶</a></h2>
<p>The Management Servers communicate with LXC hosts on port 22 (ssh).</p>
</div>
</div>
<div class="section" id="guest-network-usage-integration-for-traffic-sentinel">
<h1>Guest Network Usage Integration for Traffic Sentinel<a class="headerlink" href="network_setup.html#guest-network-usage-integration-for-traffic-sentinel" title="Permalink to this headline">¶</a></h1>
<p>To collect usage data for a guest network, CloudStack needs to pull the
data from an external network statistics collector installed on the
network. Metering statistics for guest networks are available through
CloudStack’s integration with inMon Traffic Sentinel.</p>
<p>Traffic Sentinel is a network traffic usage data collection package.
CloudStack can feed statistics from Traffic Sentinel into its own usage
records, providing a basis for billing users of cloud infrastructure.
Traffic Sentinel uses the traffic monitoring protocol sFlow. Routers
and switches generate sFlow records and provide them for collection by
Traffic Sentinel, then CloudStack queries the Traffic Sentinel database
to obtain this information</p>
<p>To construct the query, CloudStack determines what guest IPs were in use
during the current query interval. This includes both newly assigned IPs
and IPs that were assigned in a previous time period and continued to be
in use. CloudStack queries Traffic Sentinel for network statistics that
apply to these IPs during the time period they remained allocated in
CloudStack. The returned data is correlated with the customer account
that owned each IP and the timestamps when IPs were assigned and
released in order to create billable metering records in CloudStack.
When the Usage Server runs, it collects this data.</p>
<p>To set up the integration between CloudStack and Traffic Sentinel:</p>
<ol class="arabic">
<li><p class="first">On your network infrastructure, install Traffic Sentinel and
configure it to gather traffic data. For installation and
configuration steps, see inMon documentation at
<a class="reference external" href="http://inmon.com.">Traffic Sentinel Documentation</a>.</p>
</li>
<li><p class="first">In the Traffic Sentinel UI, configure Traffic Sentinel to accept
script querying from guest users. CloudStack will be the guest user
performing the remote queries to gather network usage for one or more
IP addresses.</p>
<p>Click File &gt; Users &gt; Access Control &gt; Reports Query, then select
Guest from the drop-down list.</p>
</li>
<li><p class="first">On CloudStack, add the Traffic Sentinel host by calling the
CloudStack API command addTrafficMonitor. Pass in the URL of the
Traffic Sentinel as protocol + host + port (optional); for example,
<a class="reference external" href="http://10.147.28.100:8080">http://10.147.28.100:8080</a>. For the addTrafficMonitor command syntax,
see the API Reference at <a class="reference external" href="http://cloudstack.apache.org/docs/api/index.html">API 文档</a>.</p>
<p>For information about how to call the CloudStack API, see the
Developer’s Guide at the CloudStack API Developer’s Guide <a class="reference internal" href="../developersguide/developer_guide.html#the-api"><span class="std std-ref">CloudStack API</span></a></p>
</li>
<li><p class="first">Log in to the CloudStack UI as administrator.</p>
</li>
<li><p class="first">Select Configuration from the Global Settings page, and set the
following:</p>
<p>direct.network.stats.interval: How often you want CloudStack to query
Traffic Sentinel.</p>
</li>
</ol>
</div>
<div class="section" id="setting-zone-vlan-and-running-vm-maximums">
<h1>Setting Zone VLAN and Running VM Maximums<a class="headerlink" href="network_setup.html#setting-zone-vlan-and-running-vm-maximums" title="Permalink to this headline">¶</a></h1>
<p>In the external networking case, every VM in a zone must have a unique
guest IP address. There are two variables that you need to consider in
determining how to configure CloudStack to support this: how many Zone
VLANs do you expect to have and how many VMs do you expect to have
running in the Zone at any one time.</p>
<p>Use the following table to determine how to configure CloudStack for
your deployment.</p>
<table border="1" class="table-striped table-bordered table-hover docutils">
<colgroup>
<col width="25%" />
<col width="46%" />
<col width="30%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">guest.vlan.bits</th>
<th class="head">Maximum Running VMs per Zone</th>
<th class="head">Maximum Zone VLANs</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>12</td>
<td>4096</td>
<td>4094</td>
</tr>
<tr class="row-odd"><td>11</td>
<td>8192</td>
<td>2048</td>
</tr>
<tr class="row-even"><td>10</td>
<td>16384</td>
<td>1024</td>
</tr>
<tr class="row-odd"><td>10</td>
<td>32768</td>
<td>512</td>
</tr>
</tbody>
</table>
<p>Based on your deployment’s needs, choose the appropriate value of
guest.vlan.bits. Set it as described in Edit the Global Configuration
Settings （可选） section and restart the 管理服务.</p>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="storage_setup.html" class="btn btn-neutral float-right" title="简介" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="choosing_deployment_architecture.html" class="btn btn-neutral float-left" title="小规模部署" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Apache Foundation
      
        <span class="commit">
          Revision <code>29a3d9e2</code>.
        </span>
      

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="fa fa-book"> Read the Docs</span>
      v: 4.13.0.0
      <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
      <dl>
        <dt>Versions</dt>
        
          <dd><a href="http://docs.cloudstack.apache.org/en/master/">master</a></dd>
        
          <dd><a href="../../../index.html">latest</a></dd>
        
          <dd><a href="../index.html">4.13.0.0</a></dd>
        
          <dd><a href="../../4.12.0.0/index.html">4.12.0.0</a></dd>
        
          <dd><a href="../../4.11.3.0/index.html">4.11.3.0</a></dd>
        
          <dd><a href="../../4.11.2.0/index.html">4.11.2.0</a></dd>
        
          <dd><a href="../../4.11.1.0/index.html">4.11.1.0</a></dd>
        
      </dl>
      <dl>
        <dt>Downloads</dt>
        
          <dd><a href="http://readthedocs.org/projects/cloudstack-documentation/downloads/htmlzip/4.13.0.0/">html</a></dd>
        
      </dl>
      <dl>
        <dt>On Read the Docs</dt>
          <dd>
            <a href="http://readthedocs.org/projects/cloudstack-documentation/?fromdocs=cloudstack-documentation">Project Home</a>
          </dd>
          <dd>
            <a href="http://readthedocs.org/builds/cloudstack-documentation/?fromdocs=cloudstack-documentation">Builds</a>
          </dd>
      </dl>
      <hr/>
      Free document hosting provided by <a href="http://www.readthedocs.org">Read the Docs</a>.

    </div>
  </div>



  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
   

</body>
</html>