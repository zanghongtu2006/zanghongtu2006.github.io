

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Guest Traffic &mdash; Apache CloudStack 4.11.3.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
        <script type="text/javascript" src="https://assets.readthedocs.org/static/javascript/readthedocs-doc-embed.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Using Remote Access VPN" href="networking/using_remote_access.html" />
    <link rel="prev" title="Working with Usage" href="usage.html" /> 

<!-- RTD Extra Head -->

<!-- 
Always link to the latest version, as canonical.
http://docs.readthedocs.org/en/latest/canonical.html
-->
<link rel="canonical" href="../../latest/adminguide/networking_and_traffic.html" />

<link rel="stylesheet" href="https://assets.readthedocs.org/static/css/readthedocs-doc-embed.css" type="text/css" />

<script type="text/javascript" src="../_static/readthedocs-data.js"></script>

<!-- Add page-specific data, which must exist in the page js, not global -->
<script type="text/javascript">
READTHEDOCS_DATA['page'] = "adminguide/networking_and_traffic"
READTHEDOCS_DATA['source_suffix'] = ".rst"
</script>

<script type="text/javascript" src="https://assets.readthedocs.org/static/javascript/readthedocs-analytics.js"></script>

<!-- end RTD <extrahead> -->
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> Apache CloudStack
          

          
          </a>

          
            
            
            
              <div class="version">
                4.11.3.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">目录:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../conceptsandterminology/index.html">CloudStack 概念和术语</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickinstallationguide/qig.html">快速入门指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installguide/index.html">安装指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../upgrading/index.html">升级 CloudStack</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">使用手册</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="index.html#user-interface">用户界面</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#managing-accounts-users-and-domains">账户、用户和域</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#using-projects-to-organize-user-resources">用项目来管理用户资源</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#service-offerings">计算方案</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#setting-up-networking-for-users">设置用户网络</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#working-with-virtual-machines">虚拟机</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#working-with-templates">模板</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#working-with-hosts">主机</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#working-with-storage">存储</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#working-with-system-virtual-machines">系统虚拟机</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#working-with-usage">Working with Usage</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html#managing-networks-and-traffic">Managing Networks and Traffic</a><ul class="current">
<li class="toctree-l3 current"><a class="current reference internal" href="networking_and_traffic.html#">Guest Traffic</a></li>
<li class="toctree-l3"><a class="reference internal" href="networking_and_traffic.html#networking-in-a-pod">Networking in a Pod</a></li>
<li class="toctree-l3"><a class="reference internal" href="networking_and_traffic.html#networking-in-a-zone">Networking in a Zone</a></li>
<li class="toctree-l3"><a class="reference internal" href="networking_and_traffic.html#basic-zone-physical-network-configuration">Basic Zone Physical Network Configuration</a></li>
<li class="toctree-l3"><a class="reference internal" href="networking_and_traffic.html#advanced-zone-physical-network-configuration">Advanced Zone Physical Network Configuration</a><ul>
<li class="toctree-l4"><a class="reference internal" href="networking_and_traffic.html#configure-guest-traffic-in-an-advanced-zone">Configure Guest Traffic in an Advanced Zone</a></li>
<li class="toctree-l4"><a class="reference internal" href="networking_and_traffic.html#configure-public-traffic-in-an-advanced-zone">Configure Public Traffic in an Advanced Zone</a></li>
<li class="toctree-l4"><a class="reference internal" href="networking_and_traffic.html#configuring-a-shared-guest-network">Configuring a Shared Guest Network</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="networking_and_traffic.html#using-multiple-guest-networks">Using Multiple Guest Networks</a><ul>
<li class="toctree-l4"><a class="reference internal" href="networking_and_traffic.html#adding-an-additional-guest-network">Adding an Additional Guest Network</a></li>
<li class="toctree-l4"><a class="reference internal" href="networking_and_traffic.html#reconfiguring-networks-in-vms">Reconfiguring Networks in VMs</a></li>
<li class="toctree-l4"><a class="reference internal" href="networking_and_traffic.html#changing-the-network-offering-on-a-guest-network">Changing the Network Offering on a Guest Network</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="networking_and_traffic.html#ip-reservation-in-isolated-guest-networks">IP Reservation in Isolated Guest Networks</a><ul>
<li class="toctree-l4"><a class="reference internal" href="networking_and_traffic.html#ip-reservation-considerations">IP Reservation Considerations</a></li>
<li class="toctree-l4"><a class="reference internal" href="networking_and_traffic.html#limitations">Limitations</a></li>
<li class="toctree-l4"><a class="reference internal" href="networking_and_traffic.html#best-practices">最佳实践</a></li>
<li class="toctree-l4"><a class="reference internal" href="networking_and_traffic.html#reserving-an-ip-range">Reserving an IP Range</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="networking_and_traffic.html#reserving-public-ip-addresses-and-vlans-for-accounts">Reserving Public IP Addresses and VLANs for Accounts</a><ul>
<li class="toctree-l4"><a class="reference internal" href="networking_and_traffic.html#dedicating-ip-address-ranges-to-an-account">Dedicating IP Address Ranges to an Account</a></li>
<li class="toctree-l4"><a class="reference internal" href="networking_and_traffic.html#dedicating-vlan-ranges-to-an-account">Dedicating VLAN Ranges to an Account</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="networking_and_traffic.html#configuring-multiple-ip-addresses-on-a-single-nic">Configuring Multiple IP Addresses on a Single NIC</a><ul>
<li class="toctree-l4"><a class="reference internal" href="networking_and_traffic.html#use-cases">Use Cases</a></li>
<li class="toctree-l4"><a class="reference internal" href="networking_and_traffic.html#guidelines">Guidelines</a></li>
<li class="toctree-l4"><a class="reference internal" href="networking_and_traffic.html#assigning-additional-ips-to-a-vm">Assigning Additional IPs to a VM</a></li>
<li class="toctree-l4"><a class="reference internal" href="networking_and_traffic.html#port-forwarding-and-staticnat-services-changes">Port Forwarding and StaticNAT Services Changes</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="networking_and_traffic.html#about-multiple-ip-ranges">About Multiple IP Ranges</a></li>
<li class="toctree-l3"><a class="reference internal" href="networking_and_traffic.html#about-elastic-ips">About Elastic IPs</a></li>
<li class="toctree-l3"><a class="reference internal" href="networking_and_traffic.html#portable-ips">Portable IPs</a><ul>
<li class="toctree-l4"><a class="reference internal" href="networking_and_traffic.html#about-portable-ip">About Portable IP</a></li>
<li class="toctree-l4"><a class="reference internal" href="networking_and_traffic.html#configuring-portable-ips">Configuring Portable IPs</a></li>
<li class="toctree-l4"><a class="reference internal" href="networking_and_traffic.html#acquiring-a-portable-ip">Acquiring a Portable IP</a></li>
<li class="toctree-l4"><a class="reference internal" href="networking_and_traffic.html#transferring-portable-ip">Transferring Portable IP</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="networking_and_traffic.html#multiple-subnets-in-shared-network">Multiple Subnets in Shared Network</a><ul>
<li class="toctree-l4"><a class="reference internal" href="networking_and_traffic.html#prerequisites-and-guidelines">前提 and Guidelines</a></li>
<li class="toctree-l4"><a class="reference internal" href="networking_and_traffic.html#adding-multiple-subnets-to-a-shared-network">Adding Multiple Subnets to a Shared Network</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="networking_and_traffic.html#isolation-in-advanced-zone-using-private-vlan">Isolation in Advanced Zone Using Private VLAN</a><ul>
<li class="toctree-l4"><a class="reference internal" href="networking_and_traffic.html#about-private-vlan">About Private VLAN</a></li>
<li class="toctree-l4"><a class="reference internal" href="networking_and_traffic.html#id2">前提</a></li>
<li class="toctree-l4"><a class="reference internal" href="networking_and_traffic.html#creating-a-pvlan-enabled-guest-network">Creating a PVLAN-Enabled Guest Network</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="networking_and_traffic.html#security-groups">安全组</a><ul>
<li class="toctree-l4"><a class="reference internal" href="networking_and_traffic.html#about-security-groups">About 安全组</a></li>
<li class="toctree-l4"><a class="reference internal" href="networking_and_traffic.html#adding-a-security-group">Adding a 安全 Group</a></li>
<li class="toctree-l4"><a class="reference internal" href="networking_and_traffic.html#security-groups-in-advanced-zones-kvm-only">安全组 in Advanced Zones (KVM Only)</a></li>
<li class="toctree-l4"><a class="reference internal" href="networking_and_traffic.html#enabling-security-groups">Enabling 安全组</a></li>
<li class="toctree-l4"><a class="reference internal" href="networking_and_traffic.html#adding-ingress-and-egress-rules-to-a-security-group">Adding Ingress and Egress Rules to a 安全 Group</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="networking_and_traffic.html#external-firewalls-and-load-balancers">External Firewalls and Load Balancers</a><ul>
<li class="toctree-l4"><a class="reference internal" href="networking_and_traffic.html#about-using-a-netscaler-load-balancer">About Using a NetScaler Load Balancer</a></li>
<li class="toctree-l4"><a class="reference internal" href="networking_and_traffic.html#configuring-snmp-community-string-on-a-rhel-server">Configuring SNMP Community String on a RHEL Server</a></li>
<li class="toctree-l4"><a class="reference internal" href="networking_and_traffic.html#initial-setup-of-external-firewalls-and-load-balancers">Initial Setup of External Firewalls and Load Balancers</a></li>
<li class="toctree-l4"><a class="reference internal" href="networking_and_traffic.html#ongoing-configuration-of-external-firewalls-and-load-balancers">Ongoing Configuration of External Firewalls and Load Balancers</a></li>
<li class="toctree-l4"><a class="reference internal" href="networking_and_traffic.html#load-balancer-rules">Load Balancer Rules</a></li>
<li class="toctree-l4"><a class="reference internal" href="networking_and_traffic.html#configuring-autoscale">Configuring AutoScale</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="networking_and_traffic.html#global-server-load-balancing-support">Global Server 负载均衡 Support</a><ul>
<li class="toctree-l4"><a class="reference internal" href="networking_and_traffic.html#about-global-server-load-balancing">About Global Server 负载均衡</a></li>
<li class="toctree-l4"><a class="reference internal" href="networking_and_traffic.html#configuring-gslb">Configuring GSLB</a></li>
<li class="toctree-l4"><a class="reference internal" href="networking_and_traffic.html#known-limitation">Known Limitation</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="networking_and_traffic.html#guest-ip-ranges">Guest IP Ranges</a></li>
<li class="toctree-l3"><a class="reference internal" href="networking_and_traffic.html#acquiring-a-new-ip-address">Acquiring a New IP Address</a></li>
<li class="toctree-l3"><a class="reference internal" href="networking_and_traffic.html#releasing-an-ip-address">Releasing an IP Address</a></li>
<li class="toctree-l3"><a class="reference internal" href="networking_and_traffic.html#static-nat">Static NAT</a><ul>
<li class="toctree-l4"><a class="reference internal" href="networking_and_traffic.html#enabling-or-disabling-static-nat">Enabling or Disabling Static NAT</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="networking_and_traffic.html#ip-forwarding-and-firewalling">IP 转发和防火墙</a><ul>
<li class="toctree-l4"><a class="reference internal" href="networking_and_traffic.html#firewall-rules">Firewall Rules</a></li>
<li class="toctree-l4"><a class="reference internal" href="networking_and_traffic.html#egress-firewall-rules-in-an-advanced-zone">Egress Firewall Rules in an Advanced Zone</a></li>
<li class="toctree-l4"><a class="reference internal" href="networking_and_traffic.html#port-forwarding">Port Forwarding</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="networking_and_traffic.html#ip-load-balancing">IP 负载均衡</a></li>
<li class="toctree-l3"><a class="reference internal" href="networking_and_traffic.html#dns-and-dhcp">DNS 和 DHCP</a></li>
<li class="toctree-l3"><a class="reference internal" href="networking_and_traffic.html#remote-access-vpn">Remote Access VPN</a><ul>
<li class="toctree-l4"><a class="reference internal" href="networking_and_traffic.html#configuring-remote-access-vpn">Configuring Remote Access VPN</a></li>
<li class="toctree-l4"><a class="reference internal" href="networking_and_traffic.html#configuring-remote-access-vpn-in-vpc">Configuring Remote Access VPN in VPC</a></li>
<li class="toctree-l4"><a class="reference internal" href="networking_and_traffic.html#setting-up-a-site-to-site-vpn-connection">Setting Up a Site-to-Site VPN Connection</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="networking_and_traffic.html#about-inter-vlan-routing-ntier-apps">About Inter-VLAN Routing (nTier Apps)</a></li>
<li class="toctree-l3"><a class="reference internal" href="networking_and_traffic.html#configuring-a-virtual-private-cloud">Configuring a Virtual Private Cloud</a><ul>
<li class="toctree-l4"><a class="reference internal" href="networking_and_traffic.html#about-virtual-private-clouds">About Virtual Private Clouds</a></li>
<li class="toctree-l4"><a class="reference internal" href="networking_and_traffic.html#adding-a-virtual-private-cloud">Adding a Virtual Private Cloud</a></li>
<li class="toctree-l4"><a class="reference internal" href="networking_and_traffic.html#adding-tiers">Adding Tiers</a></li>
<li class="toctree-l4"><a class="reference internal" href="networking_and_traffic.html#configuring-network-access-control-list">Configuring Network Access Control List</a></li>
<li class="toctree-l4"><a class="reference internal" href="networking_and_traffic.html#adding-a-private-gateway-to-a-vpc">Adding a Private Gateway to a VPC</a></li>
<li class="toctree-l4"><a class="reference internal" href="networking_and_traffic.html#deploying-vms-to-the-tier">Deploying VMs to the Tier</a></li>
<li class="toctree-l4"><a class="reference internal" href="networking_and_traffic.html#deploying-vms-to-vpc-tier-and-shared-networks">Deploying VMs to VPC Tier and Shared Networks</a></li>
<li class="toctree-l4"><a class="reference internal" href="networking_and_traffic.html#acquiring-a-new-ip-address-for-a-vpc">Acquiring a New IP Address for a VPC</a></li>
<li class="toctree-l4"><a class="reference internal" href="networking_and_traffic.html#releasing-an-ip-address-alloted-to-a-vpc">Releasing an IP Address Alloted to a VPC</a></li>
<li class="toctree-l4"><a class="reference internal" href="networking_and_traffic.html#enabling-or-disabling-static-nat-on-a-vpc">Enabling or Disabling Static NAT on a VPC</a></li>
<li class="toctree-l4"><a class="reference internal" href="networking_and_traffic.html#adding-load-balancing-rules-on-a-vpc">Adding 负载均衡 Rules on a VPC</a></li>
<li class="toctree-l4"><a class="reference internal" href="networking_and_traffic.html#adding-a-port-forwarding-rule-on-a-vpc">Adding a Port Forwarding Rule on a VPC</a></li>
<li class="toctree-l4"><a class="reference internal" href="networking_and_traffic.html#removing-tiers">Removing Tiers</a></li>
<li class="toctree-l4"><a class="reference internal" href="networking_and_traffic.html#editing-restarting-and-removing-a-virtual-private-cloud">Editing, Restarting, and Removing a Virtual Private Cloud</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="networking_and_traffic.html#persistent-networks">Persistent Networks</a><ul>
<li class="toctree-l4"><a class="reference internal" href="networking_and_traffic.html#persistent-network-considerations">Persistent Network Considerations</a></li>
<li class="toctree-l4"><a class="reference internal" href="networking_and_traffic.html#creating-a-persistent-guest-network">Creating a Persistent Guest Network</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="networking_and_traffic.html#setup-a-palo-alto-networks-firewall">Setup a Palo Alto Networks Firewall</a><ul>
<li class="toctree-l4"><a class="reference internal" href="networking_and_traffic.html#functionality-provided">Functionality Provided</a></li>
<li class="toctree-l4"><a class="reference internal" href="networking_and_traffic.html#initial-palo-alto-networks-firewall-configuration">Initial Palo Alto Networks Firewall Configuration</a></li>
<li class="toctree-l4"><a class="reference internal" href="networking_and_traffic.html#setup-the-palo-alto-networks-firewall-in-cloudstack">Setup the Palo Alto Networks Firewall in CloudStack</a></li>
<li class="toctree-l4"><a class="reference internal" href="networking_and_traffic.html#additional-features">Additional Features</a></li>
<li class="toctree-l4"><a class="reference internal" href="networking_and_traffic.html#id23">Limitations</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="networking/using_remote_access.html">Using Remote Access VPN</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="index.html#managing-the-cloud">管理云</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#system-reliability-and-availability">系统的可靠性和可用性</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#tuning">调优</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#events-and-troubleshooting">Events and Troubleshooting</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../developersguide/index.html">开发者手册</a></li>
<li class="toctree-l1"><a class="reference internal" href="../plugins/index.html">插件使用手册</a></li>
<li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">发行版本说明</a></li>
</ul>
<p class="caption"><span class="caption-text">其它:</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="http://cloudstack.apache.org/api.html">API 文档</a></li>
<li class="toctree-l1"><a class="reference external" href="https://cwiki.apache.org/confluence/display/CLOUDSTACK/Home">Apache CloudStack Wiki</a></li>
<li class="toctree-l1"><a class="reference external" href="http://cloudstack.apache.org/">Apache CloudStack 官网</a></li>
<li class="toctree-l1"><a class="reference external" href="http://cloudstack.apache.org/downloads.html">Apache CloudStack 源码</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/apache/cloudstack">Apache CloudStack on GitHub</a></li>
</ul>
<p class="caption"><span class="caption-text">Pre 4.11 Documentation:</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="../../../projects/cloudstack-installation.html">安装指南</a></li>
<li class="toctree-l1"><a class="reference external" href="../../../projects/cloudstack-administration.html">管理员手册</a></li>
<li class="toctree-l1"><a class="reference external" href="../../../projects/cloudstack-release-notes.html">发行版本说明</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Apache CloudStack</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">使用手册</a> &raquo;</li>
        
      <li>Guest Traffic</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            
              <a href="https://github.com/apache/cloudstack-documentation/blob/4.11.3.0/source/adminguide/networking_and_traffic.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <p>In a CloudStack, guest VMs can communicate with each other using shared
infrastructure with the security and user perception that the guests
have a private LAN. The CloudStack virtual router is the main component
providing networking features for guest traffic.</p>
<div class="section" id="guest-traffic">
<h1>Guest Traffic<a class="headerlink" href="networking_and_traffic.html#guest-traffic" title="Permalink to this headline">¶</a></h1>
<p>A network can carry guest traffic only between VMs within one zone.
Virtual machines in different zones cannot communicate with each other
using their IP addresses; they must communicate with each other by
routing through a public IP address.</p>
<p>See a typical guest traffic setup given below:</p>
<p><img alt="Depicts a guest traffic setup" src="../_images/guest-traffic-setup.png" /></p>
<p>Typically, the 管理服务 automatically creates a virtual router
for each network. A virtual router is a special virtual machine that
runs on the hosts. Each virtual router in an isolated network has three
network interfaces. If multiple public VLAN is used, the router will
have multiple public interfaces. Its eth0 interface serves as the
gateway for the guest traffic and has the IP address of 10.1.1.1. Its
eth1 interface is used by the system to configure the virtual router.
Its eth2 interface is assigned a public IP address for public traffic.
If multiple public VLAN is used, the router will have multiple public
interfaces.</p>
<p>The virtual router provides DHCP and will automatically assign an IP
address for each guest VM within the IP range assigned for the network.
The user can manually reconfigure guest VMs to assume different IP
addresses.</p>
<p>Source NAT is automatically configured in the virtual router to forward
outbound traffic for all guest VMs</p>
</div>
<div class="section" id="networking-in-a-pod">
<h1>Networking in a Pod<a class="headerlink" href="networking_and_traffic.html#networking-in-a-pod" title="Permalink to this headline">¶</a></h1>
<p>The figure below illustrates 网络配置 within a single pod. The
hosts are connected to a pod-level switch. At a minimum, the hosts
should have one physical uplink to each switch. Bonded NICs are
supported as well. The pod-level switch is a pair of redundant gigabit
switches with 10 G uplinks.</p>
<p><img alt="diagram showing logical view of network in a pod." src="../_images/network-singlepod.png" /></p>
<p>Servers are connected as follows:</p>
<ul class="simple">
<li>Storage devices are connected to only the network that carries
management traffic.</li>
<li>Hosts are connected to networks for both management traffic and
public traffic.</li>
<li>Hosts are also connected to one or more networks carrying guest
traffic.</li>
</ul>
<p>We recommend the use of multiple physical Ethernet cards to implement
each network interface as well as redundant switch fabric in order to
maximize throughput and improve reliability.</p>
</div>
<div class="section" id="networking-in-a-zone">
<h1>Networking in a Zone<a class="headerlink" href="networking_and_traffic.html#networking-in-a-zone" title="Permalink to this headline">¶</a></h1>
<p>The following figure illustrates the 网络配置 within a single zone.</p>
<p><img alt="Depicts 网络配置 in a single zone." src="../_images/network-setup-zone.png" /></p>
<p>A firewall for management traffic operates in the NAT mode. The network
typically is assigned IP addresses in the 192.168.0.0/16 Class B private
address space. Each pod is assigned IP addresses in the 192.168.*.0/24
Class C private address space.</p>
<p>Each zone has its own set of public IP addresses. Public IP addresses
from different zones do not overlap.</p>
</div>
<div class="section" id="basic-zone-physical-network-configuration">
<h1>Basic Zone Physical Network Configuration<a class="headerlink" href="networking_and_traffic.html#basic-zone-physical-network-configuration" title="Permalink to this headline">¶</a></h1>
<p>In a basic network, configuring the physical network is fairly
straightforward. You only need to configure one guest network to carry
traffic that is generated by guest VMs. When you first add a zone to
CloudStack, you set up the guest network through the Add Zone screens.</p>
</div>
<div class="section" id="advanced-zone-physical-network-configuration">
<h1>Advanced Zone Physical Network Configuration<a class="headerlink" href="networking_and_traffic.html#advanced-zone-physical-network-configuration" title="Permalink to this headline">¶</a></h1>
<p>Within a zone that uses advanced networking, you need to tell the
管理服务 how the physical network is set up to carry different
kinds of traffic in isolation.</p>
<div class="section" id="configure-guest-traffic-in-an-advanced-zone">
<h2>Configure Guest Traffic in an Advanced Zone<a class="headerlink" href="networking_and_traffic.html#configure-guest-traffic-in-an-advanced-zone" title="Permalink to this headline">¶</a></h2>
<p>These steps assume you have already logged in to the CloudStack UI. To
configure the base guest network:</p>
<ol class="arabic">
<li><p class="first">In the left navigation, choose Infrastructure. On Zones, click View
More, then click the zone to which you want to add a network.</p>
</li>
<li><p class="first">Click the Network tab.</p>
</li>
<li><p class="first">Click Add guest network.</p>
<p>The Add guest network window is displayed:</p>
<p><img alt="Add Guest 网络配置 in a single zone." src="../_images/add-guest-network.png" /></p>
</li>
<li><p class="first">Provide the following information:</p>
<ul class="simple">
<li><strong>Name</strong>: The name of the network. This will be user-visible</li>
<li><strong>Display Text</strong>: The description of the network. This will be
user-visible</li>
<li><strong>Zone</strong>: The zone in which you are configuring the guest network.</li>
<li><strong>Network offering</strong>: If the administrator has configured multiple
network offerings, select the one you want to use for this network</li>
<li><strong>Guest Gateway</strong>: The gateway that the guests should use</li>
<li><strong>Guest Netmask</strong>: The netmask in use on the subnet the guests
will use</li>
</ul>
</li>
<li><p class="first">Click OK.</p>
</li>
</ol>
</div>
<div class="section" id="configure-public-traffic-in-an-advanced-zone">
<h2>Configure Public Traffic in an Advanced Zone<a class="headerlink" href="networking_and_traffic.html#configure-public-traffic-in-an-advanced-zone" title="Permalink to this headline">¶</a></h2>
<p>In a zone that uses advanced networking, you need to configure at least
one range of IP addresses for Internet traffic.</p>
</div>
<div class="section" id="configuring-a-shared-guest-network">
<h2>Configuring a Shared Guest Network<a class="headerlink" href="networking_and_traffic.html#configuring-a-shared-guest-network" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p class="first">Log in to the CloudStack UI as administrator.</p>
</li>
<li><p class="first">In the left navigation, choose Infrastructure.</p>
</li>
<li><p class="first">On Zones, click View More.</p>
</li>
<li><p class="first">Click the zone to which you want to add a guest network.</p>
</li>
<li><p class="first">Click the Physical Network tab.</p>
</li>
<li><p class="first">Click the physical network you want to work with.</p>
</li>
<li><p class="first">On the Guest node of the diagram, click Configure.</p>
</li>
<li><p class="first">Click the Network tab.</p>
</li>
<li><p class="first">Click Add guest network.</p>
<p>The Add guest network window is displayed.</p>
</li>
<li><p class="first">Specify the following:</p>
<ul>
<li><p class="first"><strong>Name</strong>: The name of the network. This will be visible to the user.</p>
</li>
<li><p class="first"><strong>Description</strong>: The short description of the network that can be
displayed to users.</p>
</li>
<li><p class="first"><strong>VLAN ID</strong>: The unique ID of the VLAN.</p>
</li>
<li><p class="first"><strong>Isolated VLAN ID</strong>: The unique ID of the Secondary Isolated
VLAN.</p>
</li>
<li><p class="first"><strong>Scope</strong>: The available scopes are Domain, Account, Project, and
All.</p>
<ul class="simple">
<li><strong>Domain</strong>: Selecting Domain limits the scope of this guest
network to the domain you specify. The network will not be
available for other domains. If you select Subdomain Access,
the guest network is available to all the sub domains within
the selected domain.</li>
<li><strong>Account</strong>: The account for which the guest network is being
created for. You must specify the domain the account belongs
to.</li>
<li><strong>Project</strong>: The project for which the guest network is being
created for. You must specify the domain the project belongs
to.</li>
<li><strong>All</strong>: The guest network is available for all the domains,
account, projects within the selected zone.</li>
</ul>
</li>
<li><p class="first"><strong>Network Offering</strong>: If the administrator has configured multiple
network offerings, select the one you want to use for this
network.</p>
</li>
<li><p class="first"><strong>Gateway</strong>: The gateway that the guests should use.</p>
</li>
<li><p class="first"><strong>Netmask</strong>: The netmask in use on the subnet the guests will use.</p>
</li>
<li><p class="first"><strong>IP Range</strong>: A range of IP addresses that are accessible from the
Internet and are assigned to the guest VMs.</p>
<p>If one NIC is used, these IPs should be in the same CIDR in the
case of IPv6.</p>
</li>
<li><p class="first"><strong>IPv6 CIDR</strong>: The network prefix that defines the guest network
subnet. This is the CIDR that describes the IPv6 addresses in use
in the guest networks in this zone. To allot IP addresses from
within a particular address block, enter a CIDR.</p>
</li>
<li><p class="first"><strong>Network Domain</strong>: A custom DNS suffix at the level of a network.
If you want to assign a special domain name to the guest VM
network, specify a DNS suffix.</p>
</li>
</ul>
</li>
<li><p class="first">Click OK to confirm.</p>
</li>
</ol>
</div>
</div>
<div class="section" id="using-multiple-guest-networks">
<h1>Using Multiple Guest Networks<a class="headerlink" href="networking_and_traffic.html#using-multiple-guest-networks" title="Permalink to this headline">¶</a></h1>
<p>In zones that use advanced networking, additional networks for guest
traffic may be added at any time after the initial installation. You can
also customize the domain name associated with the network by specifying
a DNS suffix for each network.</p>
<p>A VM’s networks are defined at VM creation time. A VM cannot add or
remove networks after it has been created, although the user can go into
the guest and remove the IP address from the NIC on a particular
network.</p>
<p>Each VM has just one default network. The virtual router’s DHCP reply
will set the guest’s default gateway as that for the default network.
Multiple non-default networks may be added to a guest in addition to the
single, required default network. The administrator can control which
networks are available as the default network.</p>
<p>Additional networks can either be available to all accounts or be
assigned to a specific account. Networks that are available to all
accounts are zone-wide. Any user with access to the zone can create a VM
with access to that network. These zone-wide networks provide little or
no isolation between guests.Networks that are assigned to a specific
account provide strong isolation.</p>
<div class="section" id="adding-an-additional-guest-network">
<h2>Adding an Additional Guest Network<a class="headerlink" href="networking_and_traffic.html#adding-an-additional-guest-network" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li>Log in to the CloudStack UI as an administrator or end user.</li>
<li>In the left navigation, choose Network.</li>
<li>Click Add guest network. Provide the following information:<ul>
<li><strong>Name</strong>: The name of the network. This will be user-visible.</li>
<li><strong>Display Text</strong>: The description of the network. This will be
user-visible.</li>
<li><strong>Zone</strong>. The name of the zone this network applies to. Each zone
is a broadcast domain, and therefore each zone has a different IP
range for the guest network. The administrator must configure the
IP range for each zone.</li>
<li><strong>Network offering</strong>: If the administrator has configured multiple
network offerings, select the one you want to use for this
network.</li>
<li><strong>Guest Gateway</strong>: The gateway that the guests should use.</li>
<li><strong>Guest Netmask</strong>: The netmask in use on the subnet the guests
will use.</li>
</ul>
</li>
<li>Click Create.</li>
</ol>
</div>
<div class="section" id="reconfiguring-networks-in-vms">
<h2>Reconfiguring Networks in VMs<a class="headerlink" href="networking_and_traffic.html#reconfiguring-networks-in-vms" title="Permalink to this headline">¶</a></h2>
<p>CloudStack provides you the ability to move VMs between networks and
reconfigure a VM’s network. You can remove a VM from a network and add
to a new network. You can also change the default network of a virtual
machine. With this functionality, hybrid or traditional server loads can
be accommodated with ease.</p>
<p>This feature is supported on XenServer, VMware, and KVM hypervisors.</p>
<div class="section" id="prerequisites">
<h3>前提<a class="headerlink" href="networking_and_traffic.html#prerequisites" title="Permalink to this headline">¶</a></h3>
<p>Ensure that vm-tools are running on guest VMs for adding or removing
networks to work on VMware hypervisor.</p>
</div>
<div class="section" id="adding-a-network">
<h3>Adding a Network<a class="headerlink" href="networking_and_traffic.html#adding-a-network" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p class="first">Log in to the CloudStack UI as an administrator or end user.</p>
</li>
<li><p class="first">In the left navigation, click Instances.</p>
</li>
<li><p class="first">Choose the VM that you want to work with.</p>
</li>
<li><p class="first">Click the NICs tab.</p>
</li>
<li><p class="first">Click Add network to VM.</p>
<p>The Add network to VM dialog is displayed.</p>
</li>
<li><p class="first">In the drop-down list, select the network that you would like to add
this VM to.</p>
<p>A new NIC is added for this network. You can view the following
details in the NICs page:</p>
<ul class="simple">
<li>ID</li>
<li>Network Name</li>
<li>Type</li>
<li>IP Address</li>
<li>Gateway</li>
<li>Netmask</li>
<li>Is default</li>
<li>CIDR (for IPv6)</li>
</ul>
</li>
</ol>
</div>
<div class="section" id="removing-a-network">
<h3>Removing a Network<a class="headerlink" href="networking_and_traffic.html#removing-a-network" title="Permalink to this headline">¶</a></h3>
<ol class="arabic simple">
<li>Log in to the CloudStack UI as an administrator or end user.</li>
<li>In the left navigation, click Instances.</li>
<li>Choose the VM that you want to work with.</li>
<li>Click the NICs tab.</li>
<li>Locate the NIC you want to remove.</li>
<li>Click Remove NIC button. <img alt="button to remove a NIC." src="../_images/remove-nic.png" /></li>
<li>Click Yes to confirm.</li>
</ol>
</div>
<div class="section" id="selecting-the-default-network">
<h3>Selecting the Default Network<a class="headerlink" href="networking_and_traffic.html#selecting-the-default-network" title="Permalink to this headline">¶</a></h3>
<ol class="arabic simple">
<li>Log in to the CloudStack UI as an administrator or end user.</li>
<li>In the left navigation, click Instances.</li>
<li>Choose the VM that you want to work with.</li>
<li>Click the NICs tab.</li>
<li>Locate the NIC you want to work with.</li>
<li>Click the Set default NIC button. <img alt="button to set a NIC as default one." src="../_images/set-default-nic.png" />.</li>
<li>Click Yes to confirm.</li>
</ol>
</div>
</div>
<div class="section" id="changing-the-network-offering-on-a-guest-network">
<h2>Changing the Network Offering on a Guest Network<a class="headerlink" href="networking_and_traffic.html#changing-the-network-offering-on-a-guest-network" title="Permalink to this headline">¶</a></h2>
<p>A user or administrator can change the network offering that is
associated with an existing guest network.</p>
<ol class="arabic">
<li><p class="first">Log in to the CloudStack UI as an administrator or end user.</p>
</li>
<li><p class="first">If you are changing from a network offering that uses the CloudStack
virtual router to one that uses external devices as network service
providers, you must first stop all the VMs on the network.</p>
</li>
<li><p class="first">In the left navigation, choose Network.</p>
</li>
<li><p class="first">Click the name of the network you want to modify.</p>
</li>
<li><p class="first">In the Details tab, click Edit. <img alt="button to edit." src="../_images/edit-icon.png" /></p>
</li>
<li><p class="first">In Network Offering, choose the new network offering, then click
Apply.</p>
<p>A prompt is displayed asking whether you want to keep the existing
CIDR. This is to let you know that if you change the network
offering, the CIDR will be affected.</p>
<p>If you upgrade between virtual router as a provider and an external
network device as provider, acknowledge the change of CIDR to
continue, so choose Yes.</p>
</li>
<li><p class="first">Wait for the update to complete. Don’t try to restart VMs until the
network change is complete.</p>
</li>
<li><p class="first">If you stopped any VMs, restart them.</p>
</li>
</ol>
</div>
</div>
<div class="section" id="ip-reservation-in-isolated-guest-networks">
<h1>IP Reservation in Isolated Guest Networks<a class="headerlink" href="networking_and_traffic.html#ip-reservation-in-isolated-guest-networks" title="Permalink to this headline">¶</a></h1>
<p>In isolated guest networks, a part of the guest IP address space can be
reserved for non-CloudStack VMs or physical servers. To do so, you
configure a range of Reserved IP addresses by specifying the CIDR when a
guest network is in Implemented state. If your customers wish to have
non-CloudStack controlled VMs or physical servers on the same network,
they can share a part of the IP address space that is primarily provided
to the guest network.</p>
<p>In an Advanced zone, an IP address range or a CIDR is assigned to a
network when the network is defined. The CloudStack virtual router acts
as the DHCP server and uses CIDR for assigning IP addresses to the guest
VMs. If you decide to reserve CIDR for non-CloudStack purposes, you can
specify a part of the IP address range or the CIDR that should only be
allocated by the DHCP service of the virtual router to the guest VMs
created in CloudStack. The remaining IPs in that network are called
Reserved IP Range. When IP reservation is configured, the administrator
can add additional VMs or physical servers that are not part of
CloudStack to the same network and assign them the Reserved IP
addresses. CloudStack guest VMs cannot acquire IPs from the Reserved IP
Range.</p>
<div class="section" id="ip-reservation-considerations">
<h2>IP Reservation Considerations<a class="headerlink" href="networking_and_traffic.html#ip-reservation-considerations" title="Permalink to this headline">¶</a></h2>
<p>Consider the following before you reserve an IP range for non-CloudStack
machines:</p>
<ul>
<li><p class="first">IP Reservation is supported only in Isolated networks.</p>
</li>
<li><p class="first">IP Reservation can be applied only when the network is in Implemented
state.</p>
</li>
<li><p class="first">No IP Reservation is done by default.</p>
</li>
<li><p class="first">Guest VM CIDR you specify must be a subset of the network CIDR.</p>
</li>
<li><p class="first">Specify a valid Guest VM CIDR. IP Reservation is applied only if no
active IPs exist outside the Guest VM CIDR.</p>
<p>You cannot apply IP Reservation if any VM is alloted with an IP
address that is outside the Guest VM CIDR.</p>
</li>
<li><p class="first">To reset an existing IP Reservation, apply IP reservation by
specifying the value of network CIDR in the CIDR field.</p>
<p>For example, the following table describes three scenarios of guest
network creation:</p>
<table border="1" class="table-striped table-bordered table-hover docutils">
<colgroup>
<col width="4%" />
<col width="10%" />
<col width="11%" />
<col width="31%" />
<col width="44%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Case</th>
<th class="head">CIDR</th>
<th class="head">Network CIDR</th>
<th class="head">Reserved IP Range for Non-CloudStack VMs</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>1</td>
<td>10.1.1.0/24</td>
<td>None</td>
<td>None</td>
<td>No IP Reservation.</td>
</tr>
<tr class="row-odd"><td>2</td>
<td>10.1.1.0/26</td>
<td>10.1.1.0/24</td>
<td>10.1.1.64 to 10.1.1.254</td>
<td>IP Reservation configured by the UpdateNetwork API with
guestvmcidr=10.1.1.0/26 or enter 10.1.1.0/26 in the CIDR
field in the UI.</td>
</tr>
<tr class="row-even"><td>3</td>
<td>10.1.1.0/24</td>
<td>None</td>
<td>None</td>
<td>Removing IP Reservation by the UpdateNetwork API with
guestvmcidr=10.1.1.0/24 or enter 10.1.1.0/24 in the CIDR
field in the UI.</td>
</tr>
</tbody>
</table>
</li>
</ul>
</div>
<div class="section" id="limitations">
<h2>Limitations<a class="headerlink" href="networking_and_traffic.html#limitations" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>The IP Reservation is not supported if active IPs that are found
outside the Guest VM CIDR.</li>
<li>Upgrading network offering which causes a change in CIDR (such as
upgrading an offering with no external devices to one with external
devices) IP Reservation becomes void if any. Reconfigure IP
Reservation in the new re-implemeted network.</li>
</ul>
</div>
<div class="section" id="best-practices">
<h2>最佳实践<a class="headerlink" href="networking_and_traffic.html#best-practices" title="Permalink to this headline">¶</a></h2>
<p>Apply IP Reservation to the guest network as soon as the network state
changes to Implemented. If you apply reservation soon after the first
guest VM is deployed, lesser conflicts occurs while applying
reservation.</p>
</div>
<div class="section" id="reserving-an-ip-range">
<h2>Reserving an IP Range<a class="headerlink" href="networking_and_traffic.html#reserving-an-ip-range" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p class="first">Log in to the CloudStack UI as an administrator or end user.</p>
</li>
<li><p class="first">In the left navigation, choose Network.</p>
</li>
<li><p class="first">Click the name of the network you want to modify.</p>
</li>
<li><p class="first">In the Details tab, click Edit. <img alt="button to edit." src="../_images/edit-icon.png" /></p>
<p>The CIDR field changes to editable one.</p>
</li>
<li><p class="first">In CIDR, specify the Guest VM CIDR.</p>
</li>
<li><p class="first">Click Apply.</p>
<p>Wait for the update to complete. The Network CIDR and the Reserved IP
Range are displayed on the Details page.</p>
</li>
</ol>
</div>
</div>
<div class="section" id="reserving-public-ip-addresses-and-vlans-for-accounts">
<h1>Reserving Public IP Addresses and VLANs for Accounts<a class="headerlink" href="networking_and_traffic.html#reserving-public-ip-addresses-and-vlans-for-accounts" title="Permalink to this headline">¶</a></h1>
<p>CloudStack provides you the ability to reserve a set of public IP
addresses and VLANs exclusively for an account. During zone creation,
you can continue defining a set of VLANs and multiple public IP ranges.
This feature extends the functionality to enable you to dedicate a fixed
set of VLANs and guest IP addresses for a tenant.</p>
<p>Note that if an account has consumed all the VLANs and IPs dedicated to
it, the account can acquire two more resources from the system.
CloudStack provides the root admin with two configuration parameter to
modify this default behavior: use.system.public.ips and
use.system.guest.vlans. These global parameters enable the root admin to
disallow an account from acquiring public IPs and guest VLANs from the
system, if the account has dedicated resources and these dedicated
resources have all been consumed. Both these configurations are
configurable at the account level.</p>
<p>This feature provides you the following capabilities:</p>
<ul>
<li><p class="first">Reserve a VLAN range and public IP address range from an Advanced
zone and assign it to an account</p>
</li>
<li><p class="first">Disassociate a VLAN and public IP address range from an account</p>
</li>
<li><p class="first">View the number of public IP addresses allocated to an account</p>
</li>
<li><p class="first">Check whether the required range is available and is conforms to
account limits.</p>
<p>The maximum IPs per account limit cannot be superseded.</p>
</li>
</ul>
<div class="section" id="dedicating-ip-address-ranges-to-an-account">
<h2>Dedicating IP Address Ranges to an Account<a class="headerlink" href="networking_and_traffic.html#dedicating-ip-address-ranges-to-an-account" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p class="first">Log in to the CloudStack UI as administrator.</p>
</li>
<li><p class="first">In the left navigation bar, click Infrastructure.</p>
</li>
<li><p class="first">In Zones, click View All.</p>
</li>
<li><p class="first">Choose the zone you want to work with.</p>
</li>
<li><p class="first">Click the Physical Network tab.</p>
</li>
<li><p class="first">In the Public node of the diagram, click Configure.</p>
</li>
<li><p class="first">Click the IP Ranges tab.</p>
<p>You can either assign an existing IP range to an account, or create a
new IP range and assign to an account.</p>
</li>
<li><p class="first">To assign an existing IP range to an account, perform the following:</p>
<ol class="arabic">
<li><p class="first">Locate the IP range you want to work with.</p>
</li>
<li><p class="first">Click Add Account <img alt="button to assign an IP range to an account." src="../_images/addAccount-icon.png" /> button.</p>
<p>The Add Account dialog is displayed.</p>
</li>
<li><p class="first">Specify the following:</p>
<ul class="simple">
<li><strong>Account</strong>: The account to which you want to assign the IP
address range.</li>
<li><strong>Domain</strong>: The domain associated with the account.</li>
</ul>
<p>To create a new IP range and assign an account, perform the
following:</p>
<ol class="arabic">
<li><p class="first">Specify the following:</p>
<ul>
<li><p class="first"><strong>Gateway</strong></p>
</li>
<li><p class="first"><strong>Netmask</strong></p>
</li>
<li><p class="first"><strong>VLAN</strong></p>
</li>
<li><p class="first"><strong>Start IP</strong></p>
</li>
<li><p class="first"><strong>End IP</strong></p>
</li>
<li><p class="first"><strong>Account</strong>: Perform the following:</p>
<ol class="arabic">
<li><p class="first">Click Account.</p>
<p>The Add Account page is displayed.</p>
</li>
<li><p class="first">Specify the following:</p>
<ul class="simple">
<li><strong>Account</strong>: The account to which you want to
assign an IP address range.</li>
<li><strong>Domain</strong>: The domain associated with the
account.</li>
</ul>
</li>
<li><p class="first">Click OK.</p>
</li>
</ol>
</li>
</ul>
</li>
<li><p class="first">Click Add.</p>
</li>
</ol>
</li>
</ol>
</li>
</ol>
</div>
<div class="section" id="dedicating-vlan-ranges-to-an-account">
<h2>Dedicating VLAN Ranges to an Account<a class="headerlink" href="networking_and_traffic.html#dedicating-vlan-ranges-to-an-account" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p class="first">After the CloudStack 管理服务 is installed, log in to the
CloudStack UI as administrator.</p>
</li>
<li><p class="first">In the left navigation bar, click Infrastructure.</p>
</li>
<li><p class="first">In Zones, click View All.</p>
</li>
<li><p class="first">Choose the zone you want to work with.</p>
</li>
<li><p class="first">Click the Physical Network tab.</p>
</li>
<li><p class="first">In the Guest node of the diagram, click Configure.</p>
</li>
<li><p class="first">Select the Dedicated VLAN Ranges tab.</p>
</li>
<li><p class="first">Click Dedicate VLAN Range.</p>
<p>The Dedicate VLAN Range dialog is displayed.</p>
</li>
<li><p class="first">Specify the following:</p>
<ul class="simple">
<li><strong>VLAN Range</strong>: The VLAN range that you want to assign to an
account.</li>
<li><strong>Account</strong>: The account to which you want to assign the
selected VLAN range.</li>
<li><strong>Domain</strong>: The domain associated with the account.</li>
</ul>
</li>
</ol>
</div>
</div>
<div class="section" id="configuring-multiple-ip-addresses-on-a-single-nic">
<h1>Configuring Multiple IP Addresses on a Single NIC<a class="headerlink" href="networking_and_traffic.html#configuring-multiple-ip-addresses-on-a-single-nic" title="Permalink to this headline">¶</a></h1>
<p>CloudStack provides you the ability to associate multiple private IP
addresses per guest VM NIC. In addition to the primary IP, you can
assign additional IPs to the guest VM NIC. This feature is supported on
all the network configurations: Basic, Advanced, and VPC. 安全
Groups, Static NAT and Port forwarding services are supported on these
additional IPs.</p>
<p>As always, you can specify an IP from the guest subnet; if not
specified, an IP is automatically picked up from the guest VM subnet.
You can view the IPs associated with for each guest VM NICs on the UI.
You can apply NAT on these additional guest IPs by using network
configuration option in the CloudStack UI. You must specify the NIC to
which the IP should be associated.</p>
<p>This feature is supported on XenServer, KVM, and VMware hypervisors.
Note that Basic zone security groups are not supported on VMware.</p>
<div class="section" id="use-cases">
<h2>Use Cases<a class="headerlink" href="networking_and_traffic.html#use-cases" title="Permalink to this headline">¶</a></h2>
<p>Some of the use cases are described below:</p>
<ul class="simple">
<li>Network devices, such as firewalls and load balancers, generally work
best when they have access to multiple IP addresses on the network
interface.</li>
<li>Moving private IP addresses between interfaces or instances.
Applications that are bound to specific IP addresses can be moved
between instances.</li>
<li>Hosting multiple SSL Websites on a single instance. You can install
multiple SSL certificates on a single instance, each associated with
a distinct IP address.</li>
</ul>
</div>
<div class="section" id="guidelines">
<h2>Guidelines<a class="headerlink" href="networking_and_traffic.html#guidelines" title="Permalink to this headline">¶</a></h2>
<p>To prevent IP conflict, configure different subnets when multiple
networks are connected to the same VM.</p>
</div>
<div class="section" id="assigning-additional-ips-to-a-vm">
<h2>Assigning Additional IPs to a VM<a class="headerlink" href="networking_and_traffic.html#assigning-additional-ips-to-a-vm" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p class="first">Log in to the CloudStack UI.</p>
</li>
<li><p class="first">In the left navigation bar, click Instances.</p>
</li>
<li><p class="first">Click the name of the instance you want to work with.</p>
</li>
<li><p class="first">In the Details tab, click NICs.</p>
</li>
<li><p class="first">Click View Secondary IPs.</p>
</li>
<li><p class="first">Click Acquire New Secondary IP, and click Yes in the confirmation
dialog.</p>
<p>You need to configure the IP on the guest VM NIC manually. CloudStack
will not automatically configure the acquired IP address on the VM.
Ensure that the IP address configuration persist on VM reboot.</p>
<p>Within a few moments, the new IP address should appear with the state
Allocated. You can now use the IP address in Port Forwarding or
StaticNAT rules.</p>
</li>
</ol>
</div>
<div class="section" id="port-forwarding-and-staticnat-services-changes">
<h2>Port Forwarding and StaticNAT Services Changes<a class="headerlink" href="networking_and_traffic.html#port-forwarding-and-staticnat-services-changes" title="Permalink to this headline">¶</a></h2>
<p>Because multiple IPs can be associated per NIC, you are allowed to
select a desired IP for the Port Forwarding and StaticNAT services. The
default is the primary IP. To enable this functionality, an extra
optional parameter ‘vmguestip’ is added to the Port forwarding and
StaticNAT APIs (enableStaticNat, createIpForwardingRule) to indicate on
what IP address NAT need to be configured. If vmguestip is passed, NAT
is configured on the specified private IP of the VM. if not passed, NAT
is configured on the primary IP of the VM.</p>
</div>
</div>
<div class="section" id="about-multiple-ip-ranges">
<h1>About Multiple IP Ranges<a class="headerlink" href="networking_and_traffic.html#about-multiple-ip-ranges" title="Permalink to this headline">¶</a></h1>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The feature can only be implemented on IPv4 addresses.</p>
</div>
<p>CloudStack provides you with the flexibility to add guest IP ranges from
different subnets in Basic zones and security groups-enabled Advanced
zones. For security groups-enabled Advanced zones, it implies multiple
subnets can be added to the same VLAN. With the addition of this
feature, you will be able to add IP address ranges from the same subnet
or from a different one when IP address are exhausted. This would in
turn allows you to employ higher number of subnets and thus reduce the
address management overhead. To support this feature, the capability of
<code class="docutils literal notranslate"><span class="pre">createVlanIpRange</span></code> API is extended to add IP ranges also from a
different subnet.</p>
<p>Ensure that you manually configure the gateway of the new subnet before
adding the IP range. Note that CloudStack supports only one gateway for
a subnet; overlapping subnets are not currently supported.</p>
<p>Use the <code class="docutils literal notranslate"><span class="pre">deleteVlanRange</span></code> API to delete IP ranges. This operation
fails if an IP from the remove range is in use. If the remove range
contains the IP address on which the DHCP server is running, CloudStack
acquires a new IP from the same subnet. If no IP is available in the
subnet, the remove operation fails.</p>
<p>This feature is supported on KVM, xenServer, and VMware hypervisors.</p>
</div>
<div class="section" id="about-elastic-ips">
<h1>About Elastic IPs<a class="headerlink" href="networking_and_traffic.html#about-elastic-ips" title="Permalink to this headline">¶</a></h1>
<p>Elastic IP (EIP) addresses are the IP addresses that are associated with
an account, and act as static IP addresses. The account owner has the
complete control over the Elastic IP addresses that belong to the
account. As an account owner, you can allocate an Elastic IP to a VM of
your choice from the EIP pool of your account. Later if required you can
reassign the IP address to a different VM. This feature is extremely
helpful during VM failure. Instead of replacing the VM which is down,
the IP address can be reassigned to a new VM in your account.</p>
<p>Similar to the public IP address, Elastic IP addresses are mapped to
their associated private IP addresses by using StaticNAT. The EIP
service is equipped with StaticNAT (1:1) service in an EIP-enabled basic
zone. The default network offering,
DefaultSharedNetscalerEIPandELBNetworkOffering, provides your network
with EIP and ELB network services if a NetScaler device is deployed in
your zone. Consider the following illustration for more details.</p>
<p><img alt="Elastic IP in a NetScaler-enabled Basic Zone." src="../_images/eip-ns-basiczone.png" /></p>
<p>In the illustration, a NetScaler appliance is the default entry or exit
point for the CloudStack instances, and firewall is the default entry or
exit point for the rest of the data center. Netscaler provides LB
services and staticNAT service to the guest networks. The guest traffic
in the pods and the 管理服务 are on different subnets / VLANs.
The policy-based routing in the data center core switch sends the public
traffic through the NetScaler, whereas the rest of the data center goes
through the firewall.</p>
<p>The EIP work flow is as follows:</p>
<ul>
<li><p class="first">When a user VM is deployed, a public IP is automatically acquired
from the pool of public IPs configured in the zone. This IP is owned
by the VM’s account.</p>
</li>
<li><p class="first">Each VM will have its own private IP. When the user VM starts, Static
NAT is provisioned on the NetScaler device by using the Inbound
Network Address Translation (INAT) and Reverse NAT (RNAT) rules
between the public IP and the private IP.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Inbound NAT (INAT) is a type of NAT supported by NetScaler, in which
the destination IP address is replaced in the packets from the public
network, such as the Internet, with the private IP address of a VM in
the private network. Reverse NAT (RNAT) is a type of NAT supported by
NetScaler, in which the source IP address is replaced in the packets
generated by a VM in the private network with the public IP address.</p>
</div>
</li>
<li><p class="first">This default public IP will be released in two cases:</p>
<ul class="simple">
<li>When the VM is stopped. When the VM starts, it again receives a
new public IP, not necessarily the same one allocated initially,
from the pool of Public IPs.</li>
<li>The user acquires a public IP (Elastic IP). This public IP is
associated with the account, but will not be mapped to any private
IP. However, the user can enable Static NAT to associate this IP
to the private IP of a VM in the account. The Static NAT rule for
the public IP can be disabled at any time. When Static NAT is
disabled, a new public IP is allocated from the pool, which is not
necessarily be the same one allocated initially.</li>
</ul>
</li>
</ul>
<p>For the deployments where public IPs are limited resources, you have the
flexibility to choose not to allocate a public IP by default. You can
use the Associate Public IP option to turn on or off the automatic
public IP assignment in the EIP-enabled Basic zones. If you turn off the
automatic public IP assignment while creating a network offering, only a
private IP is assigned to a VM when the VM is deployed with that network
offering. Later, the user can acquire an IP for the VM and enable static
NAT.</p>
<p>For more information on the Associate Public IP option, see
<a class="reference external" href="networking.html#creating-a-new-network-offering">“Creating a New Network Offering”</a>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The Associate Public IP feature is designed only for use with user VMs.
The System VMs continue to get both public IP and private by default,
irrespective of the network offering configuration.</p>
</div>
<p>New deployments which use the default shared network offering with EIP
and ELB services to create a shared network in the Basic zone will
continue allocating public IPs to each user VM.</p>
</div>
<div class="section" id="portable-ips">
<h1>Portable IPs<a class="headerlink" href="networking_and_traffic.html#portable-ips" title="Permalink to this headline">¶</a></h1>
<div class="section" id="about-portable-ip">
<h2>About Portable IP<a class="headerlink" href="networking_and_traffic.html#about-portable-ip" title="Permalink to this headline">¶</a></h2>
<p>Portable IPs in CloudStack are region-level pool of IPs, which are
elastic in nature, that can be transferred across geographically
separated zones. As an administrator, you can provision a pool of
portable public IPs at region level and are available for user
consumption. The users can acquire portable IPs if admin has provisioned
portable IPs at the region level they are part of. These IPs can be use
for any service within an advanced zone. You can also use portable IPs
for EIP services in basic zones.</p>
<p>The salient features of Portable IP are as follows:</p>
<ul class="simple">
<li>IP is statically allocated</li>
<li>IP need not be associated with a network</li>
<li>IP association is transferable across networks</li>
<li>IP is transferable across both Basic and Advanced zones</li>
<li>IP is transferable across VPC, non-VPC isolated and shared networks</li>
<li>Portable IP transfer is available only for static NAT.</li>
</ul>
<div class="section" id="id1">
<h3>Guidelines<a class="headerlink" href="networking_and_traffic.html#id1" title="Permalink to this headline">¶</a></h3>
<p>Before transferring to another network, ensure that no network rules
(Firewall, Static NAT, Port Forwarding, and so on) exist on that
portable IP.</p>
</div>
</div>
<div class="section" id="configuring-portable-ips">
<h2>Configuring Portable IPs<a class="headerlink" href="networking_and_traffic.html#configuring-portable-ips" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p class="first">Log in to the CloudStack UI as an administrator or end user.</p>
</li>
<li><p class="first">In the left navigation, click Regions.</p>
</li>
<li><p class="first">Choose the Regions that you want to work with.</p>
</li>
<li><p class="first">Click View Portable IP.</p>
</li>
<li><p class="first">Click Portable IP Range.</p>
<p>The Add Portable IP Range window is displayed.</p>
</li>
<li><p class="first">Specify the following:</p>
<ul class="simple">
<li><strong>Start IP/ End IP</strong>: A range of IP addresses that are accessible
from the Internet and will be allocated to guest VMs. Enter the
first and last IP addresses that define a range that CloudStack
can assign to guest VMs.</li>
<li><strong>Gateway</strong>: The gateway in use for the Portable IP addresses you
are configuring.</li>
<li><strong>Netmask</strong>: The netmask associated with the Portable IP range.</li>
<li><strong>VLAN</strong>: The VLAN that will be used for public traffic.</li>
</ul>
</li>
<li><p class="first">Click OK.</p>
</li>
</ol>
</div>
<div class="section" id="acquiring-a-portable-ip">
<h2>Acquiring a Portable IP<a class="headerlink" href="networking_and_traffic.html#acquiring-a-portable-ip" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p class="first">Log in to the CloudStack UI as an administrator or end user.</p>
</li>
<li><p class="first">In the left navigation, choose Network.</p>
</li>
<li><p class="first">Click the name of the network where you want to work with.</p>
</li>
<li><p class="first">Click View IP Addresses.</p>
</li>
<li><p class="first">Click Acquire New IP.</p>
<p>The Acquire New IP window is displayed.</p>
</li>
<li><p class="first">Specify whether you want cross-zone IP or not.</p>
</li>
<li><p class="first">Click Yes in the confirmation dialog.</p>
<p>Within a few moments, the new IP address should appear with the state
Allocated. You can now use the IP address in port forwarding or
static NAT rules.</p>
</li>
</ol>
</div>
<div class="section" id="transferring-portable-ip">
<h2>Transferring Portable IP<a class="headerlink" href="networking_and_traffic.html#transferring-portable-ip" title="Permalink to this headline">¶</a></h2>
<p>An IP can be transferred from one network to another only if Static NAT
is enabled. However, when a portable IP is associated with a network,
you can use it for any service in the network.</p>
<p>To transfer a portable IP across the networks, execute the following
API:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>http://localhost:8096/client/api?command=enableStaticNat&amp;response=json&amp;ipaddressid=a4bc37b2-4b4e-461d-9a62-b66414618e36&amp;virtualmachineid=a242c476-ef37-441e-9c7b-b303e2a9cb4f&amp;networkid=6e7cd8d1-d1ba-4c35-bdaf-333354cbd49810
</pre></div>
</div>
<p>Replace the UUID with appropriate UUID. For example, if you want to
transfer a portable IP to network X and VM Y in a network, execute the
following:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>http://localhost:8096/client/api?command=enableStaticNat&amp;response=json&amp;ipaddressid=a4bc37b2-4b4e-461d-9a62-b66414618e36&amp;virtualmachineid=Y&amp;networkid=X
</pre></div>
</div>
</div>
</div>
<div class="section" id="multiple-subnets-in-shared-network">
<h1>Multiple Subnets in Shared Network<a class="headerlink" href="networking_and_traffic.html#multiple-subnets-in-shared-network" title="Permalink to this headline">¶</a></h1>
<p>CloudStack provides you with the flexibility to add guest IP ranges from
different subnets in Basic zones and security groups-enabled Advanced
zones. For security groups-enabled Advanced zones, it implies multiple
subnets can be added to the same VLAN. With the addition of this
feature, you will be able to add IP address ranges from the same subnet
or from a different one when IP address are exhausted. This would in
turn allows you to employ higher number of subnets and thus reduce the
address management overhead. You can delete the IP ranges you have
added.</p>
<div class="section" id="prerequisites-and-guidelines">
<h2>前提 and Guidelines<a class="headerlink" href="networking_and_traffic.html#prerequisites-and-guidelines" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>This feature can only be implemented:<ul>
<li>on IPv4 addresses</li>
<li>if virtual router is the DHCP provider</li>
<li>on KVM, xenServer, and VMware hypervisors</li>
</ul>
</li>
<li>Manually configure the gateway of the new subnet before adding the IP
range.</li>
<li>CloudStack supports only one gateway for a subnet; overlapping
subnets are not currently supported</li>
</ul>
</div>
<div class="section" id="adding-multiple-subnets-to-a-shared-network">
<h2>Adding Multiple Subnets to a Shared Network<a class="headerlink" href="networking_and_traffic.html#adding-multiple-subnets-to-a-shared-network" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p class="first">Log in to the CloudStack UI as an administrator or end user.</p>
</li>
<li><p class="first">In the left navigation, choose Infrastructure.</p>
</li>
<li><p class="first">On Zones, click View More, then click the zone to which you want to
work with..</p>
</li>
<li><p class="first">Click Physical Network.</p>
</li>
<li><p class="first">In the Guest node of the diagram, click Configure.</p>
</li>
<li><p class="first">Click Networks.</p>
</li>
<li><p class="first">Select the networks you want to work with.</p>
</li>
<li><p class="first">Click View IP Ranges.</p>
</li>
<li><p class="first">Click Add IP Range.</p>
<p>The Add IP Range dialog is displayed, as follows:</p>
<p><img alt="adding an IP range to a network." src="../_images/add-ip-range.png" /></p>
</li>
<li><p class="first">Specify the following:</p>
<p>All the fields are mandatory.</p>
<ul>
<li><p class="first"><strong>Gateway</strong>: The gateway for the tier you create. Ensure that the
gateway is within the Super CIDR range that you specified while
creating the VPC, and is not overlapped with the CIDR of any
existing tier within the VPC.</p>
</li>
<li><p class="first"><strong>Netmask</strong>: The netmask for the tier you create.</p>
<p>For example, if the VPC CIDR is 10.0.0.0/16 and the network tier
CIDR is 10.0.1.0/24, the gateway of the tier is 10.0.1.1, and the
netmask of the tier is 255.255.255.0.</p>
</li>
<li><p class="first"><strong>Start IP/ End IP</strong>: A range of IP addresses that are accessible
from the Internet and will be allocated to guest VMs. Enter the
first and last IP addresses that define a range that CloudStack
can assign to guest VMs .</p>
</li>
</ul>
</li>
<li><p class="first">Click OK.</p>
</li>
</ol>
</div>
</div>
<div class="section" id="isolation-in-advanced-zone-using-private-vlan">
<h1>Isolation in Advanced Zone Using Private VLAN<a class="headerlink" href="networking_and_traffic.html#isolation-in-advanced-zone-using-private-vlan" title="Permalink to this headline">¶</a></h1>
<p>Isolation of guest traffic in shared networks can be achieved by using
Private VLANs (PVLAN). PVLANs provide Layer 2 isolation between ports
within the same VLAN. In a PVLAN-enabled shared network, a user VM
cannot reach other user VM though they can reach the DHCP server and
gateway, this would in turn allow users to control traffic within a
network and help them deploy multiple applications without communication
between application as well as prevent communication with other users’
VMs.</p>
<ul class="simple">
<li>Isolate VMs in a shared networks by using Private VLANs.</li>
<li>Supported on KVM, XenServer, and VMware hypervisors</li>
<li>PVLAN-enabled shared network can be a part of multiple networks of a
guest VM.</li>
</ul>
<div class="section" id="about-private-vlan">
<h2>About Private VLAN<a class="headerlink" href="networking_and_traffic.html#about-private-vlan" title="Permalink to this headline">¶</a></h2>
<p>In an Ethernet switch, a VLAN is a broadcast domain where hosts can
establish direct communication with each another at Layer 2. Private
VLAN is designed as an extension of VLAN standard to add further
segmentation of the logical broadcast domain. A regular VLAN is a single
broadcast domain, whereas a private VLAN partitions a larger VLAN
broadcast domain into smaller sub-domains. A sub-domain is represented
by a pair of VLANs: a Primary VLAN and a Secondary VLAN. The original
VLAN that is being divided into smaller groups is called Primary, which
implies that all VLAN pairs in a private VLAN share the same Primary
VLAN. All the secondary VLANs exist only inside the Primary. Each
Secondary VLAN has a specific VLAN ID associated to it, which
differentiates one sub-domain from another.</p>
<p>Three types of ports exist in a private VLAN domain, which essentially
determine the behaviour of the participating hosts. Each ports will have
its own unique set of rules, which regulate a connected host’s ability
to communicate with other connected host within the same private VLAN
domain. Configure each host that is part of a PVLAN pair can be by using
one of these three port designation:</p>
<ul class="simple">
<li><strong>Promiscuous</strong>: A promiscuous port can communicate with all the
interfaces, including the community and isolated host ports that
belong to the secondary VLANs. In Promiscuous mode, hosts are
connected to promiscuous ports and are able to communicate directly
with resources on both primary and secondary VLAN. Routers, DHCP
servers, and other trusted devices are typically attached to
promiscuous ports.</li>
<li><strong>Isolated VLANs</strong>: The ports within an isolated VLAN cannot
communicate with each other at the layer-2 level. The hosts that are
connected to Isolated ports can directly communicate only with the
Promiscuous resources. If your customer device needs to have access
only to a gateway router, attach it to an isolated port.</li>
<li><strong>Community VLANs</strong>: The ports within a community VLAN can
communicate with each other and with the promiscuous ports, but they
cannot communicate with the ports in other communities at the layer-2
level. In a Community mode, direct communication is permitted only
with the hosts in the same community and those that are connected to
the Primary PVLAN in promiscuous mode. If your customer has two
devices that need to be isolated from other customers’ devices, but
to be able to communicate among themselves, deploy them in community
ports.</li>
</ul>
<p>For further reading:</p>
<ul class="simple">
<li><a class="reference external" href="http://www.cisco.com/en/US/docs/switches/lan/catalyst3750/software/release/12.2_25_see/configuration/guide/swpvlan.html#wp1038379">Understanding Private
VLANs</a></li>
<li><a class="reference external" href="http://tools.ietf.org/html/rfc5517">Cisco Systems’ Private VLANs: Scalable 安全 in a Multi-Client
Environment</a></li>
<li><a class="reference external" href="http://kb.vmware.com">Private VLAN (PVLAN) on vNetwork Distributed Switch - Concept
概述 (1010691)</a></li>
</ul>
</div>
<div class="section" id="id2">
<h2>前提<a class="headerlink" href="networking_and_traffic.html#id2" title="Permalink to this headline">¶</a></h2>
<ul>
<li><p class="first">Use a PVLAN supported switch.</p>
<p>See <a class="reference external" href="http://www.cisco.com/en/US/products/hw/switches/ps708/products_tech_note09186a0080094830.shtml">Private VLAN Catalyst Switch Support
Matrix</a> for
more information.</p>
</li>
<li><p class="first">All the layer 2 switches, which are PVLAN-aware, are connected to
each other, and one of them is connected to a router. All the ports
connected to the host would be configured in trunk mode. Open
Management VLAN, Primary VLAN (public) and Secondary Isolated VLAN
ports. Configure the switch port connected to the router in PVLAN
promiscuous trunk mode, which would translate an isolated VLAN to
primary VLAN for the PVLAN-unaware router.</p>
<p>Note that only Cisco Catalyst 4500 has the PVLAN promiscuous trunk
mode to connect both normal VLAN and PVLAN to a PVLAN-unaware switch.
For the other Catalyst PVLAN support switch, connect the switch to
upper switch by using cables, one each for a PVLAN pair.</p>
</li>
<li><p class="first">Configure private VLAN on your physical switches out-of-band.</p>
</li>
<li><p class="first">Before you use PVLAN on XenServer and KVM, enable Open vSwitch (OVS).</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">OVS on XenServer and KVM does not support PVLAN natively. Therefore,
CloudStack managed to simulate PVLAN on OVS for XenServer and KVM by
modifying the flow table.</p>
</div>
</li>
</ul>
</div>
<div class="section" id="creating-a-pvlan-enabled-guest-network">
<h2>Creating a PVLAN-Enabled Guest Network<a class="headerlink" href="networking_and_traffic.html#creating-a-pvlan-enabled-guest-network" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p class="first">Log in to the CloudStack UI as administrator.</p>
</li>
<li><p class="first">In the left navigation, choose Infrastructure.</p>
</li>
<li><p class="first">On Zones, click View More.</p>
</li>
<li><p class="first">Click the zone to which you want to add a guest network.</p>
</li>
<li><p class="first">Click the Physical Network tab.</p>
</li>
<li><p class="first">Click the physical network you want to work with.</p>
</li>
<li><p class="first">On the Guest node of the diagram, click Configure.</p>
</li>
<li><p class="first">Click the Network tab.</p>
</li>
<li><p class="first">Click Add guest network.</p>
<p>The Add guest network window is displayed.</p>
</li>
<li><p class="first">Specify the following:</p>
<ul>
<li><p class="first"><strong>Name</strong>: The name of the network. This will be visible to the
user.</p>
</li>
<li><p class="first"><strong>Description</strong>: The short description of the network that can be
displayed to users.</p>
</li>
<li><p class="first"><strong>VLAN ID</strong>: The unique ID of the VLAN.</p>
</li>
<li><p class="first"><strong>Secondary Isolated VLAN ID</strong>: The unique ID of the Secondary
Isolated VLAN.</p>
<p>For the description on Secondary Isolated VLAN, see
<a class="reference external" href="networking_and_traffic.html#about-private-vlan">About Private VLAN”</a>.</p>
</li>
<li><p class="first"><strong>Scope</strong>: The available scopes are Domain, Account, Project, and
All.</p>
<ul class="simple">
<li><strong>Domain</strong>: Selecting Domain limits the scope of this guest
network to the domain you specify. The network will not be
available for other domains. If you select Subdomain Access,
the guest network is available to all the sub domains within
the selected domain.</li>
<li><strong>Account</strong>: The account for which the guest network is being
created for. You must specify the domain the account belongs
to.</li>
<li><strong>Project</strong>: The project for which the guest network is being
created for. You must specify the domain the project belongs
to.</li>
<li><strong>All</strong>: The guest network is available for all the domains,
account, projects within the selected zone.</li>
</ul>
</li>
<li><p class="first"><strong>Network Offering</strong>: If the administrator has configured multiple
network offerings, select the one you want to use for this
network.</p>
</li>
<li><p class="first"><strong>Gateway</strong>: The gateway that the guests should use.</p>
</li>
<li><p class="first"><strong>Netmask</strong>: The netmask in use on the subnet the guests will use.</p>
</li>
<li><p class="first"><strong>IP Range</strong>: A range of IP addresses that are accessible from the
Internet and are assigned to the guest VMs.</p>
</li>
<li><p class="first"><strong>Network Domain</strong>: A custom DNS suffix at the level of a network.
If you want to assign a special domain name to the guest VM
network, specify a DNS suffix.</p>
</li>
</ul>
</li>
<li><p class="first">Click OK to confirm.</p>
</li>
</ol>
</div>
</div>
<div class="section" id="security-groups">
<h1>安全组<a class="headerlink" href="networking_and_traffic.html#security-groups" title="Permalink to this headline">¶</a></h1>
<div class="section" id="about-security-groups">
<h2>About 安全组<a class="headerlink" href="networking_and_traffic.html#about-security-groups" title="Permalink to this headline">¶</a></h2>
<p>安全 groups provide a way to isolate traffic to VMs. A security
group is a group of VMs that filter their incoming and outgoing traffic
according to a set of rules, called ingress and egress rules. These
rules filter network traffic according to the IP address that is
attempting to communicate with the VM. 安全 groups are particularly
useful in zones that use basic networking, because there is a single
guest network for all guest VMs. In advanced zones, security groups are
supported only on the KVM hypervisor.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">In a zone that uses advanced networking, you can instead define
multiple guest networks to isolate traffic to VMs.</p>
</div>
<p>Each CloudStack account comes with a default security group that denies
all inbound traffic and allows all outbound traffic. The default
security group can be modified so that all new VMs inherit some other
desired set of rules.</p>
<p>Any CloudStack user can set up any number of additional security groups.
When a new VM is launched, it is assigned to the default security group
unless another user-defined security group is specified. A VM can be a
member of any number of security groups. Once a VM is assigned to a
security group, it remains in that group for its entire lifetime; you
can not move a running VM from one security group to another.</p>
<p>You can modify a security group by deleting or adding any number of
ingress and egress rules. When you do, the new rules apply to all VMs in
the group, whether running or stopped.</p>
<p>If no ingress rules are specified, then no traffic will be allowed in,
except for responses to any traffic that has been allowed out through an
egress rule.</p>
</div>
<div class="section" id="adding-a-security-group">
<h2>Adding a 安全 Group<a class="headerlink" href="networking_and_traffic.html#adding-a-security-group" title="Permalink to this headline">¶</a></h2>
<p>A user or administrator can define a new security group.</p>
<ol class="arabic">
<li><p class="first">Log in to the CloudStack UI as an administrator or end user.</p>
</li>
<li><p class="first">In the left navigation, choose Network.</p>
</li>
<li><p class="first">In Select view, choose 安全组.</p>
</li>
<li><p class="first">Click Add 安全 Group.</p>
</li>
<li><p class="first">Provide a name and description.</p>
</li>
<li><p class="first">Click OK.</p>
<p>The new security group appears in the 安全组 Details tab.</p>
</li>
<li><p class="first">To make the security group useful, continue to Adding Ingress and
Egress Rules to a 安全 Group.</p>
</li>
</ol>
</div>
<div class="section" id="security-groups-in-advanced-zones-kvm-only">
<h2>安全组 in Advanced Zones (KVM Only)<a class="headerlink" href="networking_and_traffic.html#security-groups-in-advanced-zones-kvm-only" title="Permalink to this headline">¶</a></h2>
<p>CloudStack provides the ability to use security groups to provide
isolation between guests on a single shared, zone-wide network in an
advanced zone where KVM is the hypervisor. Using security groups in
advanced zones rather than multiple VLANs allows a greater range of
options for setting up guest isolation in a cloud.</p>
<div class="section" id="id4">
<h3>Limitations<a class="headerlink" href="networking_and_traffic.html#id4" title="Permalink to this headline">¶</a></h3>
<p>The following are not supported for this feature:</p>
<ul class="simple">
<li>Two IP ranges with the same VLAN and different gateway or netmask in
security group-enabled shared network.</li>
<li>Two IP ranges with the same VLAN and different gateway or netmask in
account-specific shared networks.</li>
<li>Multiple VLAN ranges in security group-enabled shared network.</li>
<li>Multiple VLAN ranges in account-specific shared networks.</li>
</ul>
<p>安全 groups must be enabled in the zone in order for this feature to
be used.</p>
</div>
</div>
<div class="section" id="enabling-security-groups">
<h2>Enabling 安全组<a class="headerlink" href="networking_and_traffic.html#enabling-security-groups" title="Permalink to this headline">¶</a></h2>
<p>In order for security groups to function in a zone, the security groups
feature must first be enabled for the zone. The administrator can do
this when creating a new zone, by selecting a network offering that
includes security groups. The procedure is described in Basic Zone
Configuration in the Advanced 安装指南. The administrator can
not enable security groups for an existing zone, only when creating a
new zone.</p>
</div>
<div class="section" id="adding-ingress-and-egress-rules-to-a-security-group">
<h2>Adding Ingress and Egress Rules to a 安全 Group<a class="headerlink" href="networking_and_traffic.html#adding-ingress-and-egress-rules-to-a-security-group" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p class="first">Log in to the CloudStack UI as an administrator or end user.</p>
</li>
<li><p class="first">In the left navigation, choose Network</p>
</li>
<li><p class="first">In Select view, choose 安全组, then click the security group
you want.</p>
</li>
<li><p class="first">To add an ingress rule, click the Ingress Rules tab and fill out the
following fields to specify what network traffic is allowed into VM
instances in this security group. If no ingress rules are specified,
then no traffic will be allowed in, except for responses to any
traffic that has been allowed out through an egress rule.</p>
<ul class="simple">
<li><strong>Add by CIDR/Account</strong>. Indicate whether the source of the
traffic will be defined by IP address (CIDR) or an existing
security group in a CloudStack account (Account). Choose Account
if you want to allow incoming traffic from all VMs in another
security group</li>
<li><strong>Protocol</strong>. The networking protocol that sources will use to
send traffic to the security group. TCP and UDP are typically used
for data exchange and end-user communications. ICMP is typically
used to send error messages or network monitoring data.</li>
<li><strong>Start Port, End Port</strong>. (TCP, UDP only) A range of listening
ports that are the destination for the incoming traffic. If you
are opening a single port, use the same number in both fields.</li>
<li><strong>ICMP Type, ICMP Code</strong>. (ICMP only) The type of message and
error code that will be accepted.</li>
<li><strong>CIDR</strong>. (Add by CIDR only) To accept only traffic from IP
addresses within a particular address block, enter a CIDR or a
comma-separated list of CIDRs. The CIDR is the base IP address of
the incoming traffic. For example, 192.168.0.0/22. To allow all
CIDRs, set to 0.0.0.0/0.</li>
<li><strong>Account, 安全 Group</strong>. (Add by Account only) To accept only
traffic from another security group, enter the CloudStack account
and name of a security group that has already been defined in that
account. To allow traffic between VMs within the security group
you are editing now, enter the same name you used in step 7.</li>
</ul>
<p>The following example allows inbound HTTP access from anywhere:</p>
<p><img alt="allows inbound HTTP access from anywhere." src="../_images/http-access.png" /></p>
</li>
<li><p class="first">To add an egress rule, click the Egress Rules tab and fill out the
following fields to specify what type of traffic is allowed to be
sent out of VM instances in this security group. If no egress rules
are specified, then all traffic will be allowed out. Once egress
rules are specified, the following types of traffic are allowed out:
traffic specified in egress rules; queries to DNS 和 DHCP servers;
and responses to any traffic that has been allowed in through an
ingress rule</p>
<ul class="simple">
<li><strong>Add by CIDR/Account</strong>. Indicate whether the destination of the
traffic will be defined by IP address (CIDR) or an existing
security group in a CloudStack account (Account). Choose Account
if you want to allow outgoing traffic to all VMs in another
security group.</li>
<li><strong>Protocol</strong>. The networking protocol that VMs will use to send
outgoing traffic. TCP and UDP are typically used for data exchange
and end-user communications. ICMP is typically used to send error
messages or network monitoring data.</li>
<li><strong>Start Port, End Port</strong>. (TCP, UDP only) A range of listening
ports that are the destination for the outgoing traffic. If you
are opening a single port, use the same number in both fields.</li>
<li><strong>ICMP Type, ICMP Code</strong>. (ICMP only) The type of message and
error code that will be sent</li>
<li><strong>CIDR</strong>. (Add by CIDR only) To send traffic only to IP addresses
within a particular address block, enter a CIDR or a
comma-separated list of CIDRs. The CIDR is the base IP address of
the destination. For example, 192.168.0.0/22. To allow all CIDRs,
set to 0.0.0.0/0.</li>
<li><strong>Account, 安全 Group</strong>. (Add by Account only) To allow
traffic to be sent to another security group, enter the CloudStack
account and name of a security group that has already been defined
in that account. To allow traffic between VMs within the security
group you are editing now, enter its name.</li>
</ul>
</li>
<li><p class="first">Click Add.</p>
</li>
</ol>
</div>
</div>
<div class="section" id="external-firewalls-and-load-balancers">
<h1>External Firewalls and Load Balancers<a class="headerlink" href="networking_and_traffic.html#external-firewalls-and-load-balancers" title="Permalink to this headline">¶</a></h1>
<p>CloudStack is capable of replacing its 虚拟路由器 with an external
Juniper SRX device and an optional external NetScaler or F5 load
balancer for gateway and load balancing services. In this case, the VMs
use the SRX as their gateway.</p>
<div class="section" id="about-using-a-netscaler-load-balancer">
<h2>About Using a NetScaler Load Balancer<a class="headerlink" href="networking_and_traffic.html#about-using-a-netscaler-load-balancer" title="Permalink to this headline">¶</a></h2>
<p>Citrix NetScaler is supported as an external network element for load
balancing in zones that use isolated networking in advanced zones. Set
up an external load balancer when you want to provide load balancing
through means other than CloudStack’s provided virtual router.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">In a Basic zone, load balancing service is supported only if
Elastic IP or Elastic LB services are enabled.</p>
</div>
<p>When NetScaler load balancer is used to provide EIP or ELB services in a
Basic zone, ensure that all guest VM traffic must enter and exit through
the NetScaler device. When inbound traffic goes through the NetScaler
device, traffic is routed by using the NAT protocol depending on the
EIP/ELB configured on the public IP to the private IP. The traffic that
is originated from the guest VMs usually goes through the layer 3
router. To ensure that outbound traffic goes through NetScaler device
providing EIP/ELB, layer 3 router must have a policy-based routing. A
policy-based route must be set up so that all traffic originated from
the guest VM’s are directed to NetScaler device. This is required to
ensure that the outbound traffic from the guest VM’s is routed to a
public IP by using NAT.For more information on Elastic IP, see
<a class="reference external" href="networking_and_traffic.html#about-elastic-ip">“About Elastic IP”</a>.</p>
<p>The NetScaler can be set up in direct (outside the firewall) mode. It
must be added before any load balancing rules are deployed on guest VMs
in the zone.</p>
<p>The functional behavior of the NetScaler with CloudStack is the same as
described in the CloudStack documentation for using an F5 external load
balancer. The only exception is that the F5 supports routing domains,
and NetScaler does not. NetScaler can not yet be used as a firewall.</p>
<p>To install and enable an external load balancer for CloudStack
management, see External Guest Load Balancer Integration in the
安装指南.</p>
<p>The Citrix NetScaler comes in three varieties. The following
summarizes how these variants are treated in CloudStack.</p>
<p><strong>MPX</strong></p>
<ul class="simple">
<li>Physical appliance. Capable of deep packet inspection. Can act as
application firewall and load balancer</li>
<li>In advanced zones, load balancer functionality fully supported without
limitation. In basic zones, static NAT, elastic IP (EIP), and elastic
load balancing (ELB) are also provided.</li>
</ul>
<p><strong>VPX</strong></p>
<ul class="simple">
<li>Virtual appliance. Can run as VM on XenServer, ESXi, and Hyper-V
hypervisors. Same functionality as MPX</li>
<li>Supported on ESXi and XenServer. Same functional support as for MPX.
CloudStack will treat VPX and MPX as the same device type.</li>
</ul>
<p><strong>SDX</strong></p>
<ul class="simple">
<li>Physical appliance. Can create multiple fully isolated VPX instances on
a single appliance to support multi-tenant usage</li>
<li>CloudStack will dynamically provision, configure, and manage the life
cycle of VPX instances on the SDX. Provisioned instances are added into
CloudStack automatically - no manual configuration by the administrator
is required. Once a VPX instance is added into CloudStack, it is treated
the same as a VPX on an ESXi host.</li>
</ul>
</div>
<div class="section" id="configuring-snmp-community-string-on-a-rhel-server">
<h2>Configuring SNMP Community String on a RHEL Server<a class="headerlink" href="networking_and_traffic.html#configuring-snmp-community-string-on-a-rhel-server" title="Permalink to this headline">¶</a></h2>
<p>The SNMP Community string is similar to a user id or password that
provides access to a network device, such as router. This string is sent
along with all SNMP requests. If the community string is correct, the
device responds with the requested information. If the community string
is incorrect, the device discards the request and does not respond.</p>
<p>The NetScaler device uses SNMP to communicate with the VMs. You must
install SNMP and configure SNMP Community string for a secure
communication between the NetScaler device and the RHEL machine.</p>
<ol class="arabic">
<li><p class="first">Ensure that you installed SNMP on RedHat. If not, run the following
command:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">yum</span> <span class="n">install</span> <span class="n">net</span><span class="o">-</span><span class="n">snmp</span><span class="o">-</span><span class="n">utils</span>
</pre></div>
</div>
</li>
<li><p class="first">Edit the /etc/snmp/snmpd.conf file to allow the SNMP polling from the
NetScaler device.</p>
<ol class="arabic">
<li><p class="first">Map the community name into a security name (local and mynetwork,
depending on where the request is coming from):</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Use a strong password instead of public when you edit the
following table.</p>
</div>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#         sec.name   source        community</span>
<span class="n">com2sec</span>   <span class="n">local</span>      <span class="n">localhost</span>     <span class="n">public</span>
<span class="n">com2sec</span>   <span class="n">mynetwork</span>  <span class="mf">0.0</span><span class="o">.</span><span class="mf">0.0</span>       <span class="n">public</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Setting to 0.0.0.0 allows all IPs to poll the NetScaler server.</p>
</div>
</li>
<li><p class="first">Map the security names into group names:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#       group.name    sec.model  sec.name</span>
<span class="n">group</span>   <span class="n">MyRWGroup</span>     <span class="n">v1</span>         <span class="n">local</span>
<span class="n">group</span>   <span class="n">MyRWGroup</span>     <span class="n">v2c</span>        <span class="n">local</span>
<span class="n">group</span>   <span class="n">MyROGroup</span>     <span class="n">v1</span>         <span class="n">mynetwork</span>
<span class="n">group</span>   <span class="n">MyROGroup</span>     <span class="n">v2c</span>        <span class="n">mynetwork</span>
</pre></div>
</div>
</li>
<li><p class="first">Create a view to allow the groups to have the permission to:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">incl</span><span class="o">/</span><span class="n">excl</span> <span class="n">subtree</span> <span class="n">mask</span> <span class="n">view</span> <span class="nb">all</span> <span class="n">included</span> <span class="o">.</span><span class="mi">1</span>
</pre></div>
</div>
</li>
<li><p class="first">Grant access with different write permissions to the two groups to
the view you created.</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># context     sec.model     sec.level      prefix     read     write    notif</span>
  <span class="n">access</span>      <span class="n">MyROGroup</span> <span class="s2">&quot;&quot;</span>  <span class="nb">any</span> <span class="n">noauth</span>     <span class="n">exact</span>      <span class="nb">all</span>      <span class="n">none</span>     <span class="n">none</span>
  <span class="n">access</span>      <span class="n">MyRWGroup</span> <span class="s2">&quot;&quot;</span>  <span class="nb">any</span> <span class="n">noauth</span>     <span class="n">exact</span>      <span class="nb">all</span>      <span class="nb">all</span>      <span class="nb">all</span>
</pre></div>
</div>
</li>
</ol>
</li>
<li><p class="first">Unblock SNMP in iptables.</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">iptables</span> <span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">p</span> <span class="n">udp</span> <span class="o">--</span><span class="n">dport</span> <span class="mi">161</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
</pre></div>
</div>
</li>
<li><p class="first">Start the SNMP service:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">service</span> <span class="n">snmpd</span> <span class="n">start</span>
</pre></div>
</div>
</li>
<li><p class="first">Ensure that the SNMP service is started automatically during the
system startup:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">chkconfig</span> <span class="n">snmpd</span> <span class="n">on</span>
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="initial-setup-of-external-firewalls-and-load-balancers">
<h2>Initial Setup of External Firewalls and Load Balancers<a class="headerlink" href="networking_and_traffic.html#initial-setup-of-external-firewalls-and-load-balancers" title="Permalink to this headline">¶</a></h2>
<p>When the first VM is created for a new account, CloudStack programs the
external firewall and load balancer to work with the VM. The following
objects are created on the firewall:</p>
<ul class="simple">
<li>A new logical interface to connect to the account’s private VLAN. The
interface IP is always the first IP of the account’s private subnet
(e.g. 10.1.1.1).</li>
<li>A source NAT rule that forwards all outgoing traffic from the
account’s private VLAN to the public Internet, using the account’s
public IP address as the source address</li>
<li>A firewall filter counter that measures the number of bytes of
outgoing traffic for the account</li>
</ul>
<p>The following objects are created on the load balancer:</p>
<ul class="simple">
<li>A new VLAN that matches the account’s provisioned Zone VLAN</li>
<li>A self IP for the VLAN. This is always the second IP of the account’s
private subnet (e.g. 10.1.1.2).</li>
</ul>
</div>
<div class="section" id="ongoing-configuration-of-external-firewalls-and-load-balancers">
<h2>Ongoing Configuration of External Firewalls and Load Balancers<a class="headerlink" href="networking_and_traffic.html#ongoing-configuration-of-external-firewalls-and-load-balancers" title="Permalink to this headline">¶</a></h2>
<p>Additional user actions (e.g. setting a port forward) will cause further
programming of the firewall and load balancer. A user may request
additional public IP addresses and forward traffic received at these IPs
to specific VMs. This is accomplished by enabling static NAT for a
public IP address, assigning the IP to a VM, and specifying a set of
protocols and port ranges to open. When a static NAT rule is created,
CloudStack programs the zone’s external firewall with the following
objects:</p>
<ul class="simple">
<li>A static NAT rule that maps the public IP address to the private IP
address of a VM.</li>
<li>A security policy that allows traffic within the set of protocols and
port ranges that are specified.</li>
<li>A firewall filter counter that measures the number of bytes of
incoming traffic to the public IP.</li>
</ul>
<p>The number of incoming and outgoing bytes through source NAT, static
NAT, and load balancing rules is measured and saved on each external
element. This data is collected on a regular basis and stored in the
CloudStack database.</p>
</div>
<div class="section" id="load-balancer-rules">
<h2>Load Balancer Rules<a class="headerlink" href="networking_and_traffic.html#load-balancer-rules" title="Permalink to this headline">¶</a></h2>
<p>A CloudStack user or administrator may create load balancing rules that
balance traffic received at a public IP to one or more VMs. A user
creates a rule, specifies an algorithm, and assigns the rule to a set of
VMs.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If you create load balancing rules while using a network service
offering that includes an external load balancer device such as
NetScaler, and later change the network service offering to one that
uses the CloudStack virtual router, you must create a firewall rule on
the virtual router for each of your existing load balancing rules so
that they continue to function.</p>
</div>
<div class="section" id="adding-a-load-balancer-rule">
<span id="adding-lb-rule"></span><h3>Adding a Load Balancer Rule<a class="headerlink" href="networking_and_traffic.html#adding-a-load-balancer-rule" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p class="first">Log in to the CloudStack UI as an administrator or end user.</p>
</li>
<li><p class="first">In the left navigation, choose Network.</p>
</li>
<li><p class="first">Click the name of the network where you want to load balance the
traffic.</p>
</li>
<li><p class="first">Click View IP Addresses.</p>
</li>
<li><p class="first">Click the IP address for which you want to create the rule, then
click the Configuration tab.</p>
</li>
<li><p class="first">In the 负载均衡 node of the diagram, click View All.</p>
<p>In a Basic zone, you can also create a load balancing rule without
acquiring or selecting an IP address. CloudStack internally assign an
IP when you create the load balancing rule, which is listed in the IP
Addresses page when the rule is created.</p>
<p>To do that, select the name of the network, then click Add Load
Balancer tab. Continue with #7.</p>
</li>
<li><p class="first">Fill in the following:</p>
<ul class="simple">
<li><strong>Name</strong>: A name for the load balancer rule.</li>
<li><strong>Public Port</strong>: The port receiving incoming traffic to be
balanced.</li>
<li><strong>Private Port</strong>: The port that the VMs will use to receive the
traffic.</li>
<li><strong>Algorithm</strong>: Choose the load balancing algorithm you want
CloudStack to use. CloudStack supports a variety of well-known
algorithms. If you are not familiar with these choices, you will
find plenty of information about them on the Internet.</li>
<li><strong>Stickiness</strong>: (Optional) Click Configure and choose the
algorithm for the stickiness policy. See Sticky Session Policies
for Load Balancer Rules.</li>
<li><strong>AutoScale</strong>: Click Configure and complete the AutoScale
configuration as explained in <a class="reference internal" href="networking_and_traffic.html#conf-autoscale"><span class="std std-ref">Configuring AutoScale</span></a>.</li>
<li><strong>Health Check</strong>: (Optional; NetScaler load balancers only) Click
Configure and fill in the characteristics of the health check
policy. See <a class="reference internal" href="networking_and_traffic.html#health-check"><span class="std std-ref">Health Checks for Load Balancer Rules</span></a>.<ul>
<li><strong>Ping path (Optional)</strong>: Sequence of destinations to which to
send health check queries. Default: / (all).</li>
<li><strong>Response time (Optional)</strong>: How long to wait for a response
from the health check (2 - 60 seconds). Default: 5 seconds.</li>
<li><strong>Interval time (Optional)</strong>: Amount of time between health
checks (1 second - 5 minutes). Default value is set in the
global configuration parameter lbrule_health
check_time_interval.</li>
<li><strong>Healthy threshold (Optional)</strong>: Number of consecutive health
check successes that are required before declaring an instance
healthy. Default: 2.</li>
<li><strong>Unhealthy threshold (Optional)</strong>: Number of consecutive
health check failures that are required before declaring an
instance unhealthy. Default: 10.</li>
</ul>
</li>
</ul>
</li>
<li><p class="first">Click Add VMs, then select two or more VMs that will divide the load
of incoming traffic, and click Apply.</p>
<p>The new load balancer rule appears in the list. You can repeat these
steps to add more load balancer rules for this IP address.</p>
</li>
</ol>
</div>
<div class="section" id="sticky-session-policies-for-load-balancer-rules">
<h3>Sticky Session Policies for Load Balancer Rules<a class="headerlink" href="networking_and_traffic.html#sticky-session-policies-for-load-balancer-rules" title="Permalink to this headline">¶</a></h3>
<p>Sticky sessions are used in Web-based applications to ensure continued
availability of information across the multiple requests in a user’s
session. For example, if a shopper is filling a cart, you need to
remember what has been purchased so far. The concept of “stickiness” is
also referred to as persistence or maintaining state.</p>
<p>Any load balancer rule defined in CloudStack can have a stickiness
policy. The policy consists of a name, stickiness method, and
parameters. The parameters are name-value pairs or flags, which are
defined by the load balancer vendor. The stickiness method could be load
balancer-generated cookie, application-generated cookie, or
source-based. In the source-based method, the source IP address is used
to identify the user and locate the user’s stored data. In the other
methods, cookies are used. The cookie generated by the load balancer or
application is included in request and response URLs to create
persistence. The cookie name can be specified by the administrator or
automatically generated. A variety of options are provided to control
the exact behavior of cookies, such as how they are generated and
whether they are cached.</p>
<p>For the most up to date list of available stickiness methods, see the
CloudStack UI or call listNetworks and check the
SupportedStickinessMethods capability.</p>
</div>
<div class="section" id="health-checks-for-load-balancer-rules">
<span id="health-check"></span><h3>Health Checks for Load Balancer Rules<a class="headerlink" href="networking_and_traffic.html#health-checks-for-load-balancer-rules" title="Permalink to this headline">¶</a></h3>
<p>(NetScaler load balancer only; requires NetScaler version 10.0)</p>
<p>Health checks are used in load-balanced applications to ensure that
requests are forwarded only to running, available services. When
creating a load balancer rule, you can specify a health check policy.
This is in addition to specifying the stickiness policy, algorithm, and
other load balancer rule options. You can configure one health check
policy per load balancer rule.</p>
<p>Any load balancer rule defined on a NetScaler load balancer in
CloudStack can have a health check policy. The policy consists of a ping
path, thresholds to define “healthy” and “unhealthy” states, health
check frequency, and timeout wait interval.</p>
<p>When a health check policy is in effect, the load balancer will stop
forwarding requests to any resources that are found to be unhealthy. If
the resource later becomes available again, the periodic health check
will discover it, and the resource will once again be added to the pool
of resources that can receive requests from the load balancer. At any
given time, the most recent result of the health check is displayed in
the UI. For any VM that is attached to a load balancer rule with a
health check configured, the state will be shown as UP or DOWN in the UI
depending on the result of the most recent health check.</p>
<p>You can delete or modify existing health check policies.</p>
<p>To configure how often the health check is performed by default, use the
global configuration setting healthcheck.update.interval (default value
is 600 seconds). You can override this value for an individual health
check policy.</p>
<p>For details on how to set a health check policy using the UI, see
<a class="reference internal" href="networking_and_traffic.html#adding-lb-rule"><span class="std std-ref">Adding a Load Balancer Rule</span></a>.</p>
</div>
</div>
<div class="section" id="configuring-autoscale">
<span id="conf-autoscale"></span><h2>Configuring AutoScale<a class="headerlink" href="networking_and_traffic.html#configuring-autoscale" title="Permalink to this headline">¶</a></h2>
<p>AutoScaling allows you to scale your back-end services or application
VMs up or down seamlessly and automatically according to the conditions
you define. With AutoScaling enabled, you can ensure that the number of
VMs you are using seamlessly scale up when demand increases, and
automatically decreases when demand subsides. Thus it helps you save
compute costs by terminating underused VMs automatically and launching
new VMs when you need them, without the need for manual intervention.</p>
<p>NetScaler AutoScaling is designed to seamlessly launch or terminate VMs
based on user-defined conditions. Conditions for triggering a scaleup or
scaledown action can vary from a simple use case like monitoring the CPU
usage of a server to a complex use case of monitoring a combination of
server’s responsiveness and its CPU usage. For example, you can
configure AutoScaling to launch an additional VM whenever CPU usage
exceeds 80 percent for 15 minutes, or to remove a VM whenever CPU usage
is less than 20 percent for 30 minutes.</p>
<p>CloudStack uses the NetScaler load balancer to monitor all aspects of a
system’s health and work in unison with CloudStack to initiate scale-up
or scale-down actions.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">AutoScale is supported on NetScaler Release 10 Build 74.4006.e and beyond.</p>
</div>
<div class="section" id="id5">
<h3>前提<a class="headerlink" href="networking_and_traffic.html#id5" title="Permalink to this headline">¶</a></h3>
<p>Before you configure an AutoScale rule, consider the following:</p>
<ul>
<li><p class="first">Ensure that the necessary template is prepared before configuring
AutoScale. When a VM is deployed by using a template and when it
comes up, the application should be up and running.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If the application is not running, the NetScaler device considers the
VM as ineffective and continues provisioning the VMs unconditionally
until the resource limit is exhausted.</p>
</div>
</li>
<li><p class="first">Deploy the templates you prepared. Ensure that the applications come
up on the first boot and is ready to take the traffic. Observe the
time requires to deploy the template. Consider this time when you
specify the quiet time while configuring AutoScale.</p>
</li>
<li><p class="first">The AutoScale feature supports the SNMP counters that can be used to
define conditions for taking scale up or scale down actions. To
monitor the SNMP-based counter, ensure that the SNMP agent is
installed in the template used for creating the AutoScale VMs, and
the SNMP operations work with the configured SNMP community and port
by using standard SNMP managers. For example, see
<a class="reference external" href="networking_and_traffic.html#configuring-snmp-community-string-on-a-rhel-server">“Configuring SNMP Community String on a RHELServer”</a>
to configure SNMP on a RHEL machine.</p>
</li>
<li><p class="first">Ensure that the endpointe.url parameter present in the Global
Settings is set to the 管理服务 API URL. For example,
<code class="docutils literal notranslate"><span class="pre">http://10.102.102.22:8080/client/api</span></code>. In a multi-node Management
Server deployment, use the virtual IP address configured in the load
balancer for the management server’s cluster. Additionally, ensure
that the NetScaler device has access to this IP address to provide
AutoScale support.</p>
<p>If you update the endpointe.url, disable the AutoScale functionality
of the load balancer rules in the system, then enable them back to
reflect the changes. For more information see <a class="reference internal" href="networking_and_traffic.html#update-autoscale"><span class="std std-ref">Updating an AutoScale Configuration</span></a>.</p>
</li>
<li><p class="first">If the API Key and Secret Key are regenerated for an AutoScale user,
ensure that the AutoScale functionality of the load balancers that
the user participates in are disabled and then enabled to reflect the
configuration changes in the NetScaler.</p>
</li>
<li><p class="first">In an advanced Zone, ensure that at least one VM should be present
before configuring a load balancer rule with AutoScale. Having one VM
in the network ensures that the network is in implemented state for
configuring AutoScale.</p>
</li>
</ul>
</div>
<div class="section" id="configuration">
<h3>Configuration<a class="headerlink" href="networking_and_traffic.html#configuration" title="Permalink to this headline">¶</a></h3>
<p>Specify the following:</p>
<p><img alt="Configuring AutoScale." src="../_images/autoscale-config.png" /></p>
<ul>
<li><p class="first"><strong>Template</strong>: A template consists of a base OS image and application.
A template is used to provision the new instance of an application on
a scaleup action. When a VM is deployed from a template, the VM can
start taking the traffic from the load balancer without any admin
intervention. For example, if the VM is deployed for a Web service,
it should have the Web server running, the database connected, and so
on.</p>
</li>
<li><p class="first"><strong>Compute offering</strong>: A predefined set of virtual hardware
attributes, including CPU speed, number of CPUs, and RAM size, that
the user can select when creating a new virtual machine instance.
Choose one of the compute offerings to be used while provisioning a
VM instance as part of scaleup action.</p>
</li>
<li><p class="first"><strong>Min Instance</strong>: The minimum number of active VM instances that is
assigned to a load balancing rule. The active VM instances are the
application instances that are up and serving the traffic, and are
being load balanced. This parameter ensures that a load balancing
rule has at least the configured number of active VM instances are
available to serve the traffic.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If an application, such as SAP, running on a VM instance is down for
some reason, the VM is then not counted as part of Min Instance
parameter, and the AutoScale feature initiates a scaleup action if
the number of active VM instances is below the configured value.
Similarly, when an application instance comes up from its earlier
down state, this application instance is counted as part of the
active instance count and the AutoScale process initiates a scaledown
action when the active instance count breaches the Max instance
value.</p>
</div>
</li>
<li><p class="first"><strong>Max Instance</strong>: Maximum number of active VM instances that <strong>should
be assigned to</strong>a load balancing rule. This parameter defines the
upper limit of active VM instances that can be assigned to a load
balancing rule.</p>
<p>Specifying a large value for the maximum instance parameter might
result in provisioning large number of VM instances, which in turn
leads to a single load balancing rule exhausting the VM instances
limit specified at the account or domain level.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If an application, such as SAP, running on a VM instance is down for
some reason, the VM is not counted as part of Max Instance parameter.
So there may be scenarios where the number of VMs provisioned for a
scaleup action might be more than the configured Max Instance value.
Once the application instances in the VMs are up from an earlier down
state, the AutoScale feature starts aligning to the configured Max
Instance value.</p>
</div>
</li>
</ul>
<p>Specify the following scale-up and scale-down policies:</p>
<ul class="simple">
<li><strong>Duration</strong>: The duration, in seconds, for which the conditions you
specify must be true to trigger a scaleup action. The conditions
defined should hold true for the entire duration you specify for an
AutoScale action to be invoked.</li>
<li><strong>Counter</strong>: The performance counters expose the state of the
monitored instances. By default, CloudStack offers four performance
counters: Three SNMP counters and one NetScaler counter. The SNMP
counters are Linux User CPU, Linux System CPU, and Linux CPU Idle.
The NetScaler counter is ResponseTime. The root administrator can add
additional counters into CloudStack by using the CloudStack API.</li>
<li><strong>Operator</strong>: The following five relational operators are supported
in AutoScale feature: Greater than, Less than, Less than or equal to,
Greater than or equal to, and Equal to.</li>
<li><strong>Threshold</strong>: Threshold value to be used for the counter. Once the
counter defined above breaches the threshold value, the AutoScale
feature initiates a scaleup or scaledown action.</li>
<li><strong>Add</strong>: Click Add to add the condition.</li>
</ul>
<p>Additionally, if you want to configure the advanced settings, click Show
advanced settings, and specify the following:</p>
<ul class="simple">
<li><strong>Polling interval</strong>: Frequency in which the conditions, combination
of counter, operator and threshold, are to be evaluated before taking
a scale up or down action. The default polling interval is 30
seconds.</li>
<li><strong>Quiet Time</strong>: This is the cool down period after an AutoScale
action is initiated. The time includes the time taken to complete
provisioning a VM instance from its template and the time taken by an
application to be ready to serve traffic. This quiet time allows the
fleet to come up to a stable state before any action can take place.
The default is 300 seconds.</li>
<li><strong>Destroy VM Grace Period</strong>: The duration in seconds, after a
scaledown action is initiated, to wait before the VM is destroyed as
part of scaledown action. This is to ensure graceful close of any
pending sessions or transactions being served by the VM marked for
destroy. The default is 120 seconds.</li>
<li><strong>安全组</strong>: 安全 groups provide a way to isolate traffic
to the VM instances. A security group is a group of VMs that filter
their incoming and outgoing traffic according to a set of rules,
called ingress and egress rules. These rules filter network traffic
according to the IP address that is attempting to communicate with
the VM.</li>
<li><strong>磁盘方案</strong>: A predefined set of disk size for primary data
storage.</li>
<li><strong>SNMP Community</strong>: The SNMP community string to be used by the
NetScaler device to query the configured counter value from the
provisioned VM instances. Default is public.</li>
<li><strong>SNMP Port</strong>: The port number on which the SNMP agent that run on
the provisioned VMs is listening. Default port is 161.</li>
<li><strong>User</strong>: This is the user that the NetScaler device use to invoke
scaleup and scaledown API calls to the cloud. If no option is
specified, the user who configures AutoScaling is applied. Specify
another user name to override.</li>
<li><strong>Apply</strong>: Click Apply to create the AutoScale configuration.</li>
</ul>
</div>
<div class="section" id="disabling-and-enabling-an-autoscale-configuration">
<h3>Disabling and Enabling an AutoScale Configuration<a class="headerlink" href="networking_and_traffic.html#disabling-and-enabling-an-autoscale-configuration" title="Permalink to this headline">¶</a></h3>
<p>If you want to perform any maintenance operation on the AutoScale VM
instances, disable the AutoScale configuration. When the AutoScale
configuration is disabled, no scaleup or scaledown action is performed.
You can use this downtime for the maintenance activities. To disable the
AutoScale configuration, click the Disable AutoScale <img alt="button to enable or disable AutoScale." src="../_images/enable-disable-autoscale.png" /> button.</p>
<p>The button toggles between enable and disable, depending on whether
AutoScale is currently enabled or not. After the maintenance operations
are done, you can enable the AutoScale configuration back. To enable,
open the AutoScale configuration page again, then click the Enable
AutoScale <img alt="button to enable or disable AutoScale." src="../_images/enable-disable-autoscale.png" /> button.</p>
</div>
<div class="section" id="updating-an-autoscale-configuration">
<span id="update-autoscale"></span><h3>Updating an AutoScale Configuration<a class="headerlink" href="networking_and_traffic.html#updating-an-autoscale-configuration" title="Permalink to this headline">¶</a></h3>
<p>You can update the various parameters and add or delete the conditions
in a scaleup or scaledown rule. Before you update an AutoScale
configuration, ensure that you disable the AutoScale load balancer rule
by clicking the Disable AutoScale button.</p>
<p>After you modify the required AutoScale parameters, click Apply. To
apply the new AutoScale policies, open the AutoScale configuration page
again, then click the Enable AutoScale button.</p>
</div>
<div class="section" id="runtime-considerations">
<h3>Runtime Considerations<a class="headerlink" href="networking_and_traffic.html#runtime-considerations" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>An administrator should not assign a VM to a load balancing rule
which is configured for AutoScale.</li>
<li>Before a VM provisioning is completed if NetScaler is shutdown or
restarted, the provisioned VM cannot be a part of the load balancing
rule though the intent was to assign it to a load balancing rule. To
workaround, rename the AutoScale provisioned VMs based on the rule
name or ID so at any point of time the VMs can be reconciled to its
load balancing rule.</li>
<li>Making API calls outside the context of AutoScale, such as destroyVM,
on an autoscaled VM leaves the load balancing configuration in an
inconsistent state. Though VM is destroyed from the load balancer
rule, NetScaler continues to show the VM as a service assigned to a
rule.</li>
</ul>
</div>
</div>
</div>
<div class="section" id="global-server-load-balancing-support">
<h1>Global Server 负载均衡 Support<a class="headerlink" href="networking_and_traffic.html#global-server-load-balancing-support" title="Permalink to this headline">¶</a></h1>
<p>CloudStack supports Global Server 负载均衡 (GSLB) functionalities
to provide business continuity, and enable seamless resource movement
within a CloudStack environment. CloudStack achieve this by extending
its functionality of integrating with NetScaler Application Delivery
Controller (ADC), which also provides various GSLB capabilities, such as
disaster recovery and load balancing. The DNS redirection technique is
used to achieve GSLB in CloudStack.</p>
<p>In order to support this functionality, region level services and
service provider are introduced. A new service ‘GSLB’ is introduced as a
region level service. The GSLB service provider is introduced that will
provider the GSLB service. Currently, NetScaler is the supported GSLB
provider in CloudStack. GSLB functionality works in an Active-Active
data center environment.</p>
<div class="section" id="about-global-server-load-balancing">
<h2>About Global Server 负载均衡<a class="headerlink" href="networking_and_traffic.html#about-global-server-load-balancing" title="Permalink to this headline">¶</a></h2>
<p>Global Server 负载均衡 (GSLB) is an extension of load balancing
functionality, which is highly efficient in avoiding downtime. Based on
the nature of deployment, GSLB represents a set of technologies that is
used for various purposes, such as load sharing, disaster recovery,
performance, and legal obligations. With GSLB, workloads can be
distributed across multiple data centers situated at geographically
separated locations. GSLB can also provide an alternate location for
accessing a resource in the event of a failure, or to provide a means of
shifting traffic easily to simplify maintenance, or both.</p>
<div class="section" id="components-of-gslb">
<h3>Components of GSLB<a class="headerlink" href="networking_and_traffic.html#components-of-gslb" title="Permalink to this headline">¶</a></h3>
<p>A typical GSLB environment is comprised of the following components:</p>
<ul class="simple">
<li><strong>GSLB Site</strong>: In CloudStack 术语, GSLB sites are represented
by zones that are mapped to data centers, each of which has various
network appliances. Each GSLB site is managed by a NetScaler
appliance that is local to that site. Each of these appliances treats
its own site as the local site and all other sites, managed by other
appliances, as remote sites. It is the central entity in a GSLB
deployment, and is represented by a name and an IP address.</li>
<li><strong>GSLB Services</strong>: A GSLB service is typically represented by a load
balancing or content switching virtual server. In a GSLB environment,
you can have a local as well as remote GSLB services. A local GSLB
service represents a local load balancing or content switching
virtual server. A remote GSLB service is the one configured at one of
the other sites in the GSLB setup. At each site in the GSLB setup,
you can create one local GSLB service and any number of remote GSLB
services.</li>
<li><strong>GSLB Virtual Servers</strong>: A GSLB virtual server refers to one or more
GSLB services and balances traffic between traffic across the VMs in
multiple zones by using the CloudStack functionality. It evaluates
the configured GSLB methods or algorithms to select a GSLB service to
which to send the client requests. One or more virtual servers from
different zones are bound to the GSLB virtual server. GSLB virtual
server does not have a public IP associated with it, instead it will
have a FQDN DNS name.</li>
<li><strong>负载均衡 or Content Switching Virtual Servers</strong>: According to
Citrix NetScaler terminology, a load balancing or content switching
virtual server represents one or many servers on the local network.
Clients send their requests to the load balancing or content
switching virtual server’s virtual IP (VIP) address, and the virtual
server balances the load across the local servers. After a GSLB
virtual server selects a GSLB service representing either a local or
a remote load balancing or content switching virtual server, the
client sends the request to that virtual server’s VIP address.</li>
<li><strong>DNS VIPs</strong>: DNS virtual IP represents a load balancing DNS virtual
server on the GSLB service provider. The DNS requests for domains for
which the GSLB service provider is authoritative can be sent to a DNS
VIP.</li>
<li><strong>Authoritative DNS</strong>: ADNS (Authoritative Domain Name Server) is a
service that provides actual answer to DNS queries, such as web site
IP address. In a GSLB environment, an ADNS service responds only to
DNS requests for domains for which the GSLB service provider is
authoritative. When an ADNS service is configured, the service
provider owns that IP address and advertises it. When you create an
ADNS service, the NetScaler responds to DNS queries on the configured
ADNS service IP and port.</li>
</ul>
</div>
<div class="section" id="how-does-gslb-works-in-cloudstack">
<h3>How Does GSLB Works in CloudStack?<a class="headerlink" href="networking_and_traffic.html#how-does-gslb-works-in-cloudstack" title="Permalink to this headline">¶</a></h3>
<p>Global server load balancing is used to manage the traffic flow to a web
site hosted on two separate zones that ideally are in different
geographic locations. The following is an illustration of how GLSB
functionality is provided in CloudStack: An organization, xyztelco, has
set up a public cloud that spans two zones, Zone-1 and Zone-2, across
geographically separated data centers that are managed by CloudStack.
Tenant-A of the cloud launches a highly available solution by using
xyztelco cloud. For that purpose, they launch two instances each in both
the zones: VM1 and VM2 in Zone-1 and VM5 and VM6 in Zone-2. Tenant-A
acquires a public IP, IP-1 in Zone-1, and configures a load balancer
rule to load balance the traffic between VM1 and VM2 instances.
CloudStack orchestrates setting up a virtual server on the LB service
provider in Zone-1. Virtual server 1 that is set up on the LB service
provider in Zone-1 represents a publicly accessible virtual server that
client reaches at IP-1. The client traffic to virtual server 1 at IP-1
will be load balanced across VM1 and VM2 instances.</p>
<p>Tenant-A acquires another public IP, IP-2 in Zone-2 and sets up a load
balancer rule to load balance the traffic between VM5 and VM6 instances.
Similarly in Zone-2, CloudStack orchestrates setting up a virtual server
on the LB service provider. Virtual server 2 that is setup on the LB
service provider in Zone-2 represents a publicly accessible virtual
server that client reaches at IP-2. The client traffic that reaches
virtual server 2 at IP-2 is load balanced across VM5 and VM6 instances.
At this point Tenant-A has the service enabled in both the zones, but
has no means to set up a disaster recovery plan if one of the zone
fails. Additionally, there is no way for Tenant-A to load balance the
traffic intelligently to one of the zones based on load, proximity and
so on. The cloud administrator of xyztelco provisions a GSLB service
provider to both the zones. A GSLB provider is typically an ADC that has
the ability to act as an ADNS (Authoritative Domain Name Server) and has
the mechanism to monitor health of virtual servers both at local and
remote sites. The cloud admin enables GSLB as a service to the tenants
that use zones 1 and 2.</p>
<p><img alt="GSLB architecture" src="../_images/gslb.png" /></p>
<p>Tenant-A wishes to leverage the GSLB service provided by the xyztelco
cloud. Tenant-A configures a GSLB rule to load balance traffic across
virtual server 1 at Zone-1 and virtual server 2 at Zone-2. The domain
name is provided as A.xyztelco.com. CloudStack orchestrates setting up
GSLB virtual server 1 on the GSLB service provider at Zone-1. CloudStack
binds virtual server 1 of Zone-1 and virtual server 2 of Zone-2 to GLSB
virtual server 1. GSLB virtual server 1 is configured to start
monitoring the health of virtual server 1 and 2 in Zone-1. CloudStack
will also orchestrate setting up GSLB virtual server 2 on GSLB service
provider at Zone-2. CloudStack will bind virtual server 1 of Zone-1 and
virtual server 2 of Zone-2 to GLSB virtual server 2. GSLB virtual server
2 is configured to start monitoring the health of virtual server 1 and
2. CloudStack will bind the domain A.xyztelco.com to both the GSLB
virtual server 1 and 2. At this point, Tenant-A service will be globally
reachable at A.xyztelco.com. The private DNS server for the domain
xyztelcom.com is configured by the admin out-of-band to resolve the
domain A.xyztelco.com to the GSLB providers at both the zones, which are
configured as ADNS for the domain A.xyztelco.com. A client when sends a
DNS request to resolve A.xyztelcom.com, will eventually get DNS
delegation to the address of GSLB providers at zone 1 and 2. A client
DNS request will be received by the GSLB provider. The GSLB provider,
depending on the domain for which it needs to resolve, will pick up the
GSLB virtual server associated with the domain. Depending on the health
of the virtual servers being load balanced, DNS request for the domain
will be resolved to the public IP associated with the selected virtual
server.</p>
</div>
</div>
<div class="section" id="configuring-gslb">
<h2>Configuring GSLB<a class="headerlink" href="networking_and_traffic.html#configuring-gslb" title="Permalink to this headline">¶</a></h2>
<p>To configure a GSLB deployment, you must first configure a standard load
balancing setup for each zone. This enables you to balance load across
the different servers in each zone in the region. Then on the NetScaler
side, configure both NetScaler appliances that you plan to add to each
zone as authoritative DNS (ADNS) servers. Next, create a GSLB site for
each zone, configure GSLB virtual servers for each site, create GLSB
services, and bind the GSLB services to the GSLB virtual servers.
Finally, bind the domain to the GSLB virtual servers. The GSLB
configurations on the two appliances at the two different zones are
identical, although each sites load-balancing configuration is specific
to that site.</p>
<p>Perform the following as a cloud administrator. As per the example given
above, the administrator of xyztelco is the one who sets up GSLB:</p>
<ol class="arabic">
<li><p class="first">In the cloud.dns.name global parameter, specify the DNS name of your
tenant’s cloud that make use of the GSLB service.</p>
</li>
<li><p class="first">On the NetScaler side, configure GSLB as given in <a class="reference external" href="http://support.citrix.com/proddocs/topic/netscaler-traffic-management-10-map/ns-gslb-config-con.html">Configuring Global
Server 负载均衡 (GSLB)</a>:</p>
<ol class="arabic">
<li><p class="first">Configuring a standard load balancing setup.</p>
</li>
<li><p class="first">Configure Authoritative DNS, as explained in <a class="reference external" href="http://support.citrix.com/proddocs/topic/netscaler-traffic-management-10-map/ns-gslb-config-adns-svc-tsk.html">Configuring an
Authoritative DNS Service</a>.</p>
</li>
<li><p class="first">Configure a GSLB site with site name formed from the domain name
details.</p>
<p>Configure a GSLB site with the site name formed from the domain
name.</p>
<p>As per the example given above, the site names are A.xyztelco.com
and B.xyztelco.com.</p>
<p>For more information, see <a class="reference external" href="http://support.citrix.com/proddocs/topic/netscaler-traffic-management-10-map/ns-gslb-config-basic-site-tsk.html">Configuring a Basic GSLB Site</a>.</p>
</li>
<li><p class="first">Configure a GSLB virtual server.</p>
<p>For more information, see <a class="reference external" href="http://support.citrix.com/proddocs/topic/netscaler-traffic-management-10-map/ns-gslb-config-vsvr-tsk.html">Configuring a GSLB Virtual Server</a>.</p>
</li>
<li><p class="first">Configure a GSLB service for each virtual server.</p>
<p>For more information, see <a class="reference external" href="http://support.citrix.com/proddocs/topic/netscaler-traffic-management-10-map/ns-gslb-config-svc-tsk.html">Configuring a GSLB Service</a>.</p>
</li>
<li><p class="first">Bind the GSLB services to the GSLB virtual server.</p>
<p>For more information, see <a class="reference external" href="http://support.citrix.com/proddocs/topic/netscaler-traffic-management-10-map/ns-gslb-bind-svc-vsvr-tsk.html">Binding GSLB Services to a GSLB Virtual
Server</a>.</p>
</li>
<li><p class="first">Bind domain name to GSLB virtual server. Domain name is obtained
from the domain details.</p>
<p>For more information, see <a class="reference external" href="http://support.citrix.com/proddocs/topic/netscaler-traffic-management-10-map/ns-gslb-bind-dom-vsvr-tsk.html">Binding a Domain to a GSLB Virtual
Server</a>.</p>
</li>
</ol>
</li>
<li><p class="first">In each zone that are participating in GSLB, add GSLB-enabled
NetScaler device.</p>
<p>For more information, see <a class="reference internal" href="networking_and_traffic.html#enabling-gslb-in-ns"><span class="std std-ref">Enabling GSLB in NetScaler</span></a>.</p>
</li>
</ol>
<p>As a domain administrator/ user perform the following:</p>
<ol class="arabic">
<li><p class="first">Add a GSLB rule on both the sites.</p>
<p>See “<a class="reference internal" href="networking_and_traffic.html#adding-gslb-rule"><span class="std std-ref">Adding a GSLB Rule</span></a>”.</p>
</li>
<li><p class="first">Assign load balancer rules.</p>
<p>See “<a class="reference internal" href="networking_and_traffic.html#assigning-lb-rule-gslb"><span class="std std-ref">Assigning 负载均衡 Rules to GSLB</span></a>”.</p>
</li>
</ol>
<div class="section" id="id6">
<h3>前提 and Guidelines<a class="headerlink" href="networking_and_traffic.html#id6" title="Permalink to this headline">¶</a></h3>
<ul>
<li><p class="first">The GSLB functionality is supported both Basic and Advanced zones.</p>
</li>
<li><p class="first">GSLB is added as a new network service.</p>
</li>
<li><p class="first">GSLB service provider can be added to a physical network in a zone.</p>
</li>
<li><p class="first">The admin is allowed to enable or disable GSLB functionality at
region level.</p>
</li>
<li><p class="first">The admin is allowed to configure a zone as GSLB capable or enabled.</p>
<p>A zone shall be considered as GSLB capable only if a GSLB service
provider is provisioned in the zone.</p>
</li>
<li><p class="first">When users have VMs deployed in multiple availability zones which are
GSLB enabled, they can use the GSLB functionality to load balance
traffic across the VMs in multiple zones.</p>
</li>
<li><p class="first">The users can use GSLB to load balance across the VMs across zones in
a region only if the admin has enabled GSLB in that region.</p>
</li>
<li><p class="first">The users can load balance traffic across the availability zones in
the same region or different regions.</p>
</li>
<li><p class="first">The admin can configure DNS name for the entire cloud.</p>
</li>
<li><p class="first">The users can specify an unique name across the cloud for a globally
load balanced service. The provided name is used as the domain name
under the DNS name associated with the cloud.</p>
<p>The user-provided name along with the admin-provided DNS name is used
to produce a globally resolvable FQDN for the globally load balanced
service of the user. For example, if the admin has configured
xyztelco.com as the DNS name for the cloud, and user specifies ‘foo’
for the GSLB virtual service, then the FQDN name of the GSLB virtual
service is foo.xyztelco.com.</p>
</li>
<li><p class="first">While setting up GSLB, users can select a load balancing method, such
as round robin, for using across the zones that are part of GSLB.</p>
</li>
<li><p class="first">The user shall be able to set weight to zone-level virtual server.
Weight shall be considered by the load balancing method for
distributing the traffic.</p>
</li>
<li><p class="first">The GSLB functionality shall support session persistence, where
series of client requests for particular domain name is sent to a
virtual server on the same zone.</p>
<p>Statistics is collected from each GSLB virtual server.</p>
</li>
</ul>
</div>
<div class="section" id="enabling-gslb-in-netscaler">
<span id="enabling-gslb-in-ns"></span><h3>Enabling GSLB in NetScaler<a class="headerlink" href="networking_and_traffic.html#enabling-gslb-in-netscaler" title="Permalink to this headline">¶</a></h3>
<p>In each zone, add GSLB-enabled NetScaler device for load balancing.</p>
<ol class="arabic">
<li><p class="first">Log in as administrator to the CloudStack UI.</p>
</li>
<li><p class="first">In the left navigation bar, click Infrastructure.</p>
</li>
<li><p class="first">In Zones, click View More.</p>
</li>
<li><p class="first">Choose the zone you want to work with.</p>
</li>
<li><p class="first">Click the Physical Network tab, then click the name of the physical
network.</p>
</li>
<li><p class="first">In the Network Service Providers node of the diagram, click
Configure.</p>
<p>You might have to scroll down to see this.</p>
</li>
<li><p class="first">Click NetScaler.</p>
</li>
<li><p class="first">Click Add NetScaler device and provide the following:</p>
<p>For NetScaler:</p>
<ul class="simple">
<li><strong>IP Address</strong>: The IP address of the SDX.</li>
<li><strong>Username/Password</strong>: The authentication credentials to access
the device. CloudStack uses these credentials to access the
device.</li>
<li><strong>Type</strong>: The type of device that is being added. It could be F5
Big Ip Load Balancer, NetScaler VPX, NetScaler MPX, or NetScaler
SDX. For a comparison of the NetScaler types, see the CloudStack
管理员手册.</li>
<li><strong>Public interface</strong>: Interface of device that is configured to be
part of the public network.</li>
<li><strong>Private interface</strong>: Interface of device that is configured to
be part of the private network.</li>
<li><strong>GSLB service</strong>: Select this option.</li>
<li><strong>GSLB service Public IP</strong>: The public IP address of the NAT
translator for a GSLB service that is on a private network.</li>
<li><strong>GSLB service Private IP</strong>: The private IP of the GSLB service.</li>
<li><strong>Number of Retries</strong>. Number of times to attempt a command on the
device before considering the operation failed. Default is 2.</li>
<li><strong>Capacity</strong>: The number of networks the device can handle.</li>
<li><strong>Dedicated</strong>: When marked as dedicated, this device will be
dedicated to a single account. When Dedicated is checked, the
value in the Capacity field has no significance implicitly, its
value is 1.</li>
</ul>
</li>
<li><p class="first">Click OK.</p>
</li>
</ol>
</div>
<div class="section" id="adding-a-gslb-rule">
<span id="adding-gslb-rule"></span><h3>Adding a GSLB Rule<a class="headerlink" href="networking_and_traffic.html#adding-a-gslb-rule" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p class="first">Log in to the CloudStack UI as a domain administrator or user.</p>
</li>
<li><p class="first">In the left navigation pane, click Region.</p>
</li>
<li><p class="first">Select the region for which you want to create a GSLB rule.</p>
</li>
<li><p class="first">In the Details tab, click View GSLB.</p>
</li>
<li><p class="first">Click Add GSLB.</p>
<p>The Add GSLB page is displayed as follows:</p>
<p><img alt="adding a gslb rule." src="../_images/add-gslb.png" /></p>
</li>
<li><p class="first">Specify the following:</p>
<ul class="simple">
<li><strong>Name</strong>: Name for the GSLB rule.</li>
<li><strong>Description</strong>: (Optional) A short description of the GSLB rule
that can be displayed to users.</li>
<li><strong>GSLB Domain Name</strong>: A preferred domain name for the service.</li>
<li><strong>Algorithm</strong>: (Optional) The algorithm to use to load balance the
traffic across the zones. The options are Round Robin, Least
Connection, and Proximity.</li>
<li><strong>Service Type</strong>: The transport protocol to use for GSLB. The
options are TCP and UDP.</li>
<li><strong>Domain</strong>: (Optional) The domain for which you want to create the
GSLB rule.</li>
<li><strong>Account</strong>: (Optional) The account on which you want to apply the
GSLB rule.</li>
</ul>
</li>
<li><p class="first">Click OK to confirm.</p>
</li>
</ol>
</div>
<div class="section" id="assigning-load-balancing-rules-to-gslb">
<span id="assigning-lb-rule-gslb"></span><h3>Assigning 负载均衡 Rules to GSLB<a class="headerlink" href="networking_and_traffic.html#assigning-load-balancing-rules-to-gslb" title="Permalink to this headline">¶</a></h3>
<ol class="arabic simple">
<li>Log in to the CloudStack UI as a domain administrator or user.</li>
<li>In the left navigation pane, click Region.</li>
<li>Select the region for which you want to create a GSLB rule.</li>
<li>In the Details tab, click View GSLB.</li>
<li>Select the desired GSLB.</li>
<li>Click view assigned load balancing.</li>
<li>Click assign more load balancing.</li>
<li>Select the load balancing rule you have created for the zone.</li>
<li>Click OK to confirm.</li>
</ol>
</div>
</div>
<div class="section" id="known-limitation">
<h2>Known Limitation<a class="headerlink" href="networking_and_traffic.html#known-limitation" title="Permalink to this headline">¶</a></h2>
<p>Currently, CloudStack does not support orchestration of services across
the zones. The notion of services and service providers in region are to
be introduced.</p>
</div>
</div>
<div class="section" id="guest-ip-ranges">
<h1>Guest IP Ranges<a class="headerlink" href="networking_and_traffic.html#guest-ip-ranges" title="Permalink to this headline">¶</a></h1>
<p>The IP ranges for guest network traffic are set on a per-account basis
by the user. This allows the users to configure their network in a
fashion that will enable VPN linking between their guest network and
their clients.</p>
<p>In shared networks in Basic zone and 安全 Group-enabled Advanced
networks, you will have the flexibility to add multiple guest IP ranges
from different subnets. You can add or remove one IP range at a time.
For more information, see <a class="reference external" href="networking_and_traffic.html#about-multiple-ip-ranges">“About Multiple IP
Ranges”</a>.</p>
</div>
<div class="section" id="acquiring-a-new-ip-address">
<h1>Acquiring a New IP Address<a class="headerlink" href="networking_and_traffic.html#acquiring-a-new-ip-address" title="Permalink to this headline">¶</a></h1>
<ol class="arabic">
<li><p class="first">Log in to the CloudStack UI as an administrator or end user.</p>
</li>
<li><p class="first">In the left navigation, choose Network.</p>
</li>
<li><p class="first">Click the name of the network where you want to work with.</p>
</li>
<li><p class="first">Click View IP Addresses.</p>
</li>
<li><p class="first">Click Acquire New IP.</p>
<p>The Acquire New IP window is displayed.</p>
</li>
<li><p class="first">Specify whether you want cross-zone IP or not.</p>
<p>If you want Portable IP click Yes in the confirmation dialog. If you
want a normal Public IP click No.</p>
<p>For more information on Portable IP, see <a class="reference external" href="networking_and_traffic.html#portable-ips">“Portable
IPs”</a>.</p>
<p>Within a few moments, the new IP address should appear with the state
Allocated. You can now use the IP address in port forwarding or
static NAT rules.</p>
</li>
</ol>
</div>
<div class="section" id="releasing-an-ip-address">
<h1>Releasing an IP Address<a class="headerlink" href="networking_and_traffic.html#releasing-an-ip-address" title="Permalink to this headline">¶</a></h1>
<p>When the last rule for an IP address is removed, you can release that IP
address. The IP address still belongs to the VPC; however, it can be
picked up for any guest network again.</p>
<ol class="arabic simple">
<li>Log in to the CloudStack UI as an administrator or end user.</li>
<li>In the left navigation, choose Network.</li>
<li>Click the name of the network where you want to work with.</li>
<li>Click View IP Addresses.</li>
<li>Click the IP address you want to release.</li>
<li>Click the Release IP button. <img alt="button to release an IP" src="../_images/release-ip-icon.png" /></li>
</ol>
</div>
<div class="section" id="static-nat">
<h1>Static NAT<a class="headerlink" href="networking_and_traffic.html#static-nat" title="Permalink to this headline">¶</a></h1>
<p>A static NAT rule maps a public IP address to the private IP address of
a VM in order to allow Internet traffic into the VM. The public IP
address always remains the same, which is why it is called static NAT.
This section tells how to enable or disable static NAT for a particular
IP address.</p>
<div class="section" id="enabling-or-disabling-static-nat">
<h2>Enabling or Disabling Static NAT<a class="headerlink" href="networking_and_traffic.html#enabling-or-disabling-static-nat" title="Permalink to this headline">¶</a></h2>
<p>If port forwarding rules are already in effect for an IP address, you
cannot enable static NAT to that IP.</p>
<p>If a guest VM is part of more than one network, static NAT rules will
function only if they are defined on the default network.</p>
<ol class="arabic">
<li><p class="first">Log in to the CloudStack UI as an administrator or end user.</p>
</li>
<li><p class="first">In the left navigation, choose Network.</p>
</li>
<li><p class="first">Click the name of the network where you want to work with.</p>
</li>
<li><p class="first">Click View IP Addresses.</p>
</li>
<li><p class="first">Click the IP address you want to work with.</p>
</li>
<li><p class="first">Click the Static NAT <img alt="button to enable/disable NAT." src="../_images/enable-disable.png" /> button.</p>
<p>The button toggles between Enable and Disable, depending on whether
static NAT is currently enabled for the IP address.</p>
</li>
<li><p class="first">If you are enabling static NAT, a dialog appears where you can choose
the destination VM and click Apply.</p>
</li>
</ol>
</div>
</div>
<div class="section" id="ip-forwarding-and-firewalling">
<h1>IP 转发和防火墙<a class="headerlink" href="networking_and_traffic.html#ip-forwarding-and-firewalling" title="Permalink to this headline">¶</a></h1>
<p>By default, all incoming traffic to the public IP address is rejected.
All outgoing traffic from the guests is also blocked by default.</p>
<p>To allow outgoing traffic, follow the procedure in <a class="reference internal" href="networking_and_traffic.html#egress-fw-rules"><span class="std std-ref">Egress Firewall Rules in an Advanced Zone</span></a>.</p>
<p>To allow incoming traffic, users may set up firewall rules and/or port
forwarding rules. For example, you can use a firewall rule to open a
range of ports on the public IP address, such as 33 through 44. Then use
port forwarding rules to direct traffic from individual ports within
that range to specific ports on user VMs. For example, one port
forwarding rule could route incoming traffic on the public IP’s port 33
to port 100 on one user VM’s private IP.</p>
<div class="section" id="firewall-rules">
<h2>Firewall Rules<a class="headerlink" href="networking_and_traffic.html#firewall-rules" title="Permalink to this headline">¶</a></h2>
<p>By default, all incoming traffic to the public IP address is rejected by
the firewall. To allow external traffic, you can open firewall ports by
specifying firewall rules. You can optionally specify one or more CIDRs
to filter the source IPs. This is useful when you want to allow only
incoming requests from certain IP addresses.</p>
<p>You cannot use firewall rules to open ports for an elastic IP address.
When elastic IP is used, outside access is instead controlled through
the use of security groups. See <a class="reference external" href="networking_and_traffic.html#adding-a-security-group">“Adding a 安全
Group”</a>.</p>
<p>In an advanced zone, you can also create egress firewall rules by using
the virtual router. For more information, see “<a class="reference internal" href="networking_and_traffic.html#egress-fw-rules"><span class="std std-ref">Egress Firewall Rules in an Advanced Zone</span></a>”.</p>
<p>Firewall rules can be created using the Firewall tab in the Management
Server UI. This tab is not displayed by default when CloudStack is
installed. To display the Firewall tab, the CloudStack administrator
must set the global configuration parameter firewall.rule.ui.enabled to
“true.”</p>
<p>To create a firewall rule:</p>
<ol class="arabic simple">
<li>Log in to the CloudStack UI as an administrator or end user.</li>
<li>In the left navigation, choose Network.</li>
<li>Click the name of the network where you want to work with.</li>
<li>Click View IP Addresses.</li>
<li>Click the IP address you want to work with.</li>
<li>Click the Configuration tab and fill in the following values.<ul>
<li><strong>Source CIDR</strong>: (Optional) To accept only traffic from IP
addresses within a particular address block, enter a CIDR or a
comma-separated list of CIDRs. Example: 192.168.0.0/22. Leave
empty to allow all CIDRs.</li>
<li><strong>Protocol</strong>: The communication protocol in use on the opened
port(s).</li>
<li><strong>Start Port and End Port</strong>: The port(s) you want to open on the
firewall. If you are opening a single port, use the same number in
both fields</li>
<li><strong>ICMP Type and ICMP Code</strong>: Used only if Protocol is set to ICMP.
Provide the type and code required by the ICMP protocol to fill
out the ICMP header. Refer to ICMP documentation for more details
if you are not sure what to enter</li>
</ul>
</li>
<li>Click Add.</li>
</ol>
</div>
<div class="section" id="egress-firewall-rules-in-an-advanced-zone">
<span id="egress-fw-rules"></span><h2>Egress Firewall Rules in an Advanced Zone<a class="headerlink" href="networking_and_traffic.html#egress-firewall-rules-in-an-advanced-zone" title="Permalink to this headline">¶</a></h2>
<p>The egress traffic originates from a private network to a public
network, such as the Internet. By default, the egress traffic is blocked
in default network offerings, so no outgoing traffic is allowed from a
guest network to the Internet. However, you can control the egress
traffic in an Advanced zone by creating egress firewall rules. When an
egress firewall rule is applied, the traffic specific to the rule is
allowed and the remaining traffic is blocked. When all the firewall
rules are removed the default policy, Block, is applied.</p>
<div class="section" id="id10">
<h3>前提 and Guidelines<a class="headerlink" href="networking_and_traffic.html#id10" title="Permalink to this headline">¶</a></h3>
<p>Consider the following scenarios to apply egress firewall rules:</p>
<ul class="simple">
<li>Egress firewall rules are supported on Juniper SRX and virtual
router.</li>
<li>The egress firewall rules are not supported on shared networks.</li>
<li>Allow the egress traffic from specified source CIDR. The Source CIDR
is part of guest network CIDR.</li>
<li>Allow the egress traffic with protocol TCP,UDP,ICMP, or ALL.</li>
<li>Allow the egress traffic with protocol and destination port range.
The port range is specified for TCP, UDP or for ICMP type and code.</li>
<li>The default policy is Allow for the new network offerings, whereas on
upgrade existing network offerings with firewall service providers
will have the default egress policy Deny.</li>
</ul>
</div>
<div class="section" id="configuring-an-egress-firewall-rule">
<h3>Configuring an Egress Firewall Rule<a class="headerlink" href="networking_and_traffic.html#configuring-an-egress-firewall-rule" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p class="first">Log in to the CloudStack UI as an administrator or end user.</p>
</li>
<li><p class="first">In the left navigation, choose Network.</p>
</li>
<li><p class="first">In Select view, choose Guest networks, then click the Guest network
you want.</p>
</li>
<li><p class="first">To add an egress rule, click the Egress rules tab and fill out the
following fields to specify what type of traffic is allowed to be
sent out of VM instances in this guest network:</p>
<p><img alt="adding an egress firewall rule." src="../_images/egress-firewall-rule.png" /></p>
<ul class="simple">
<li><strong>CIDR</strong>: (Add by CIDR only) To send traffic only to the IP
addresses within a particular address block, enter a CIDR or a
comma-separated list of CIDRs. The CIDR is the base IP address of
the destination. For example, 192.168.0.0/22. To allow all CIDRs,
set to 0.0.0.0/0.</li>
<li><strong>Protocol</strong>: The networking protocol that VMs uses to send
outgoing traffic. The TCP and UDP protocols are typically used for
data exchange and end-user communications. The ICMP protocol is
typically used to send error messages or network monitoring data.</li>
<li><strong>Start Port, End Port</strong>: (TCP, UDP only) A range of listening
ports that are the destination for the outgoing traffic. If you
are opening a single port, use the same number in both fields.</li>
<li><strong>ICMP Type, ICMP Code</strong>: (ICMP only) The type of message and
error code that are sent.</li>
</ul>
</li>
<li><p class="first">Click Add.</p>
</li>
</ol>
</div>
<div class="section" id="configuring-the-default-egress-policy">
<h3>Configuring the Default Egress Policy<a class="headerlink" href="networking_and_traffic.html#configuring-the-default-egress-policy" title="Permalink to this headline">¶</a></h3>
<p>The default egress policy for Isolated guest network is configured by
using Network offering. Use the create network offering option to
determine whether the default policy should be block or allow all the
traffic to the public network from a guest network. Use this network
offering to create the network. If no policy is specified, by default
all the traffic is allowed from the guest network that you create by
using this network offering.</p>
<p>You have two options: Allow and Deny.</p>
<div class="section" id="allow">
<h4>Allow<a class="headerlink" href="networking_and_traffic.html#allow" title="Permalink to this headline">¶</a></h4>
<p>If you select Allow for a network offering, by default egress traffic is
allowed. However, when an egress rule is configured for a guest network,
rules are applied to block the specified traffic and rest are allowed.
If no egress rules are configured for the network, egress traffic is
accepted.</p>
</div>
<div class="section" id="deny">
<h4>Deny<a class="headerlink" href="networking_and_traffic.html#deny" title="Permalink to this headline">¶</a></h4>
<p>If you select Deny for a network offering, by default egress traffic for
the guest network is blocked. However, when an egress rules is
configured for a guest network, rules are applied to allow the specified
traffic. While implementing a guest network, CloudStack adds the
firewall egress rule specific to the default egress policy for the guest
network.</p>
<p>This feature is supported only on virtual router and Juniper SRX.</p>
<ol class="arabic">
<li><p class="first">Create a network offering with your desirable default egress policy:</p>
<ol class="arabic simple">
<li>Log in with admin privileges to the CloudStack UI.</li>
<li>In the left navigation bar, click 计算方案.</li>
<li>In Select Offering, choose Network Offering.</li>
<li>Click Add Network Offering.</li>
<li>In the dialog, make necessary choices, including firewall
provider.</li>
<li>In the Default egress policy field, specify the behaviour.</li>
<li>Click OK.</li>
</ol>
</li>
<li><p class="first">Create an isolated network by using this network offering.</p>
<p>Based on your selection, the network will have the egress public
traffic blocked or allowed.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="section" id="port-forwarding">
<h2>Port Forwarding<a class="headerlink" href="networking_and_traffic.html#port-forwarding" title="Permalink to this headline">¶</a></h2>
<p>A port forward service is a set of port forwarding rules that define a
policy. A port forward service is then applied to one or more guest VMs.
The guest VM then has its inbound network access managed according to
the policy defined by the port forwarding service. You can optionally
specify one or more CIDRs to filter the source IPs. This is useful when
you want to allow only incoming requests from certain IP addresses to be
forwarded.</p>
<p>A guest VM can be in any number of port forward services. Port forward
services can be defined but have no members. If a guest VM is part of
more than one network, port forwarding rules will function only if they
are defined on the default network</p>
<p>You cannot use port forwarding to open ports for an elastic IP address.
When elastic IP is used, outside access is instead controlled through
the use of security groups. See 安全组.</p>
<p>To set up port forwarding:</p>
<ol class="arabic simple">
<li>Log in to the CloudStack UI as an administrator or end user.</li>
<li>If you have not already done so, add a public IP address range to a
zone in CloudStack. See Adding a Zone and Pod in the 安装
Guide.</li>
<li>Add one or more VM instances to CloudStack.</li>
<li>In the left navigation bar, click Network.</li>
<li>Click the name of the guest network where the VMs are running.</li>
<li>Choose an existing IP address or acquire a new IP address. See
<a class="reference external" href="networking_and_traffic.html#acquiring-a-new-ip-address">“Acquiring a New IP Address”</a>.
Click the name of the IP address in the list.</li>
<li>Click the Configuration tab.</li>
<li>In the Port Forwarding node of the diagram, click View All.</li>
<li>Fill in the following:<ul>
<li><strong>Public Port</strong>: The port to which public traffic will be
addressed on the IP address you acquired in the previous step.</li>
<li><strong>Private Port</strong>: The port on which the instance is listening for
forwarded public traffic.</li>
<li><strong>Protocol</strong>: The communication protocol in use between the two
ports</li>
</ul>
</li>
<li>Click Add.</li>
</ol>
</div>
</div>
<div class="section" id="ip-load-balancing">
<h1>IP 负载均衡<a class="headerlink" href="networking_and_traffic.html#ip-load-balancing" title="Permalink to this headline">¶</a></h1>
<p>The user may choose to associate the same public IP for multiple guests.
CloudStack implements a TCP-level load balancer with the following
policies.</p>
<ul class="simple">
<li>Round-robin</li>
<li>Least connection</li>
<li>Source IP</li>
</ul>
<p>This is similar to port forwarding but the destination may be multiple
IP addresses.</p>
</div>
<div class="section" id="dns-and-dhcp">
<h1>DNS 和 DHCP<a class="headerlink" href="networking_and_traffic.html#dns-and-dhcp" title="Permalink to this headline">¶</a></h1>
<p>The 虚拟路由器 provides DNS 和 DHCP services to the guests. It
proxies DNS requests to the DNS server configured on the Availability
Zone.</p>
</div>
<div class="section" id="remote-access-vpn">
<span id="id12"></span><h1>Remote Access VPN<a class="headerlink" href="networking_and_traffic.html#remote-access-vpn" title="Permalink to this headline">¶</a></h1>
<p>CloudStack account owners can create virtual private networks (VPN) to
access their virtual machines. If the guest network is instantiated from
a network offering that offers the Remote Access VPN service, the
virtual router (based on the System VM) is used to provide the service.
CloudStack provides a L2TP-over-IPsec-based remote access VPN service to
guest virtual networks. Since each network gets its own virtual router,
VPNs are not shared across the networks. VPN clients native to <a class="reference external" href="networking/using_remote_access.html">Windows,
Mac OS X</a> and iOS can be used to connect to the guest networks. The
account owner can create and manage users for their VPN. CloudStack does
not use its account database for this purpose but uses a separate table.
The VPN user database is shared across all the VPNs created by the
account owner. All VPN users get access to all VPNs created by the
account owner.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Make sure that not all traffic goes through the VPN. That is, the route
installed by the VPN should be only for the guest network and not for
all traffic.</p>
</div>
<ul class="simple">
<li><strong>Road Warrior / Remote Access</strong>. Users want to be able to connect
securely from a home or office to a private network in the cloud.
Typically, the IP address of the connecting client is dynamic and
cannot be preconfigured on the VPN server.</li>
<li><strong>Site to Site</strong>. In this scenario, two private subnets are connected
over the public Internet with a secure VPN tunnel. The cloud user’s
subnet (for example, an office network) is connected through a
gateway to the network in the cloud. The address of the user’s
gateway must be preconfigured on the VPN server in the cloud. Note
that although L2TP-over-IPsec can be used to set up Site-to-Site
VPNs, this is not the primary intent of this feature. For more
information, see “<a class="reference internal" href="networking_and_traffic.html#setting-s2s-vpn-conn"><span class="std std-ref">Setting Up a Site-to-Site VPN Connection</span></a>”.</li>
</ul>
<div class="section" id="configuring-remote-access-vpn">
<h2>Configuring Remote Access VPN<a class="headerlink" href="networking_and_traffic.html#configuring-remote-access-vpn" title="Permalink to this headline">¶</a></h2>
<p>To set up VPN for the cloud:</p>
<ol class="arabic simple">
<li>Log in to the CloudStack UI as an administrator or end user.</li>
<li>In the left navigation, click Global Settings.</li>
<li>Set the following global configuration parameters.<ul>
<li>remote.access.vpn.client.ip.range - The range of IP addresses to
be allocated to remote access VPN clients. The first IP in the
range is used by the VPN server.</li>
<li>remote.access.vpn.psk.length - Length of the IPSec key.</li>
<li>remote.access.vpn.user.limit - Maximum number of VPN users per
account.</li>
</ul>
</li>
</ol>
<p>To enable VPN for a particular network:</p>
<ol class="arabic">
<li><p class="first">Log in as a user or administrator to the CloudStack UI.</p>
</li>
<li><p class="first">In the left navigation, click Network.</p>
</li>
<li><p class="first">Click the name of the network you want to work with.</p>
</li>
<li><p class="first">Click View IP Addresses.</p>
</li>
<li><p class="first">Click one of the displayed IP address names.</p>
</li>
<li><p class="first">Click the Enable VPN button. <img alt="vpn-icon.png" src="../_images/vpn-icon.png" /></p>
<p>The IPsec key is displayed in a popup window.</p>
</li>
</ol>
</div>
<div class="section" id="configuring-remote-access-vpn-in-vpc">
<h2>Configuring Remote Access VPN in VPC<a class="headerlink" href="networking_and_traffic.html#configuring-remote-access-vpn-in-vpc" title="Permalink to this headline">¶</a></h2>
<p>On enabling Remote Access VPN on a VPC, any VPN client present outside
the VPC can access VMs present in the VPC by using the Remote VPN
connection. The VPN client can be present anywhere except inside the VPC
on which the user enabled the Remote Access VPN service.</p>
<p>To enable VPN for a VPC:</p>
<ol class="arabic">
<li><p class="first">Log in as a user or administrator to the CloudStack UI.</p>
</li>
<li><p class="first">In the left navigation, click Network.</p>
</li>
<li><p class="first">In the Select view, select VPC.</p>
<p>All the VPCs that you have created for the account is listed in the
page.</p>
</li>
<li><p class="first">Click the Configure button of the VPC.</p>
<p>For each tier, the following options are displayed:</p>
<ul class="simple">
<li>Internal LB</li>
<li>Public LB IP</li>
<li>Static NAT</li>
<li>Virtual Machines</li>
<li>CIDR</li>
</ul>
<p>The following router information is displayed:</p>
<ul class="simple">
<li>Private Gateways</li>
<li>Public IP Addresses</li>
<li>Site-to-Site VPNs</li>
<li>Network ACL Lists</li>
</ul>
</li>
<li><p class="first">In the Router node, select Public IP Addresses.</p>
<p>The IP Addresses page is displayed.</p>
</li>
<li><p class="first">Click Source NAT IP address.</p>
</li>
<li><p class="first">Click the Enable VPN button. <img alt="vpn-icon.png" src="../_images/vpn-icon.png" /></p>
<p>Click OK to confirm. The IPsec key is displayed in a pop-up window.</p>
</li>
</ol>
<p>Now, you need to add the VPN users.</p>
<ol class="arabic simple">
<li>Click the Source NAT IP.</li>
<li>Select the VPN tab.</li>
<li>Add the username and the corresponding password of the user you
wanted to add.</li>
<li>Click Add.</li>
<li>Repeat the same steps to add the VPN users.</li>
</ol>
</div>
<div class="section" id="setting-up-a-site-to-site-vpn-connection">
<span id="setting-s2s-vpn-conn"></span><h2>Setting Up a Site-to-Site VPN Connection<a class="headerlink" href="networking_and_traffic.html#setting-up-a-site-to-site-vpn-connection" title="Permalink to this headline">¶</a></h2>
<p>A Site-to-Site VPN connection helps you establish a secure connection
from an enterprise datacenter to the cloud infrastructure. This allows
users to access the guest VMs by establishing a VPN connection to the
virtual router of the account from a device in the datacenter of the
enterprise. You can also establish a secure connection between two VPC
setups or high availability zones in your environment. Having this
facility eliminates the need to establish VPN connections to individual
VMs.</p>
<p>The difference from Remote VPN is that Site-to-site VPNs connects entire
networks to each other, for example, connecting a branch office network
to a company headquarters network. In a site-to-site VPN, hosts do not
have VPN client software; they send and receive normal TCP/IP traffic
through a VPN gateway.</p>
<p>The supported endpoints on the remote datacenters are:</p>
<ul class="simple">
<li>Cisco ISR with IOS 12.4 or later</li>
<li>Juniper J-Series routers with JunOS 9.5 or later</li>
<li>CloudStack virtual routers</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">In addition to the specific Cisco and Juniper devices listed above, the
expectation is that any Cisco or Juniper device running on the supported
operating systems are able to establish VPN connections.</p>
</div>
<p>To set up a Site-to-Site VPN connection, perform the following:</p>
<ol class="arabic">
<li><p class="first">Create a Virtual Private Cloud (VPC).</p>
<p>See “<a class="reference internal" href="networking_and_traffic.html#configuring-vpc"><span class="std std-ref">Configuring a Virtual Private Cloud</span></a>”.</p>
</li>
<li><p class="first">Create a VPN Customer Gateway.</p>
</li>
<li><p class="first">Create a VPN gateway for the VPC that you created.</p>
</li>
<li><p class="first">Create VPN connection from the VPC VPN gateway to the customer VPN
gateway.</p>
</li>
</ol>
<div class="section" id="creating-and-updating-a-vpn-customer-gateway">
<h3>Creating and Updating a VPN Customer Gateway<a class="headerlink" href="networking_and_traffic.html#creating-and-updating-a-vpn-customer-gateway" title="Permalink to this headline">¶</a></h3>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">A VPN customer gateway can be connected to only one VPN gateway at a time.</p>
</div>
<p>To add a VPN Customer Gateway:</p>
<ol class="arabic">
<li><p class="first">Log in to the CloudStack UI as an administrator or end user.</p>
</li>
<li><p class="first">In the left navigation, choose Network.</p>
</li>
<li><p class="first">In the Select view, select VPN Customer Gateway.</p>
</li>
<li><p class="first">Click Add VPN Customer Gateway.</p>
<p><img alt="adding a customer gateway." src="../_images/add-vpn-customer-gateway.png" /></p>
<p>Provide the following information:</p>
<ul>
<li><p class="first"><strong>Name</strong>: A unique name for the VPN customer gateway you create.</p>
</li>
<li><p class="first"><strong>Gateway</strong>: The IP address for the remote gateway.</p>
</li>
<li><p class="first"><strong>CIDR list</strong>: The guest CIDR list of the remote subnets. Enter a
CIDR or a comma-separated list of CIDRs. Ensure that a guest CIDR
list is not overlapped with the VPC’s CIDR, or another guest CIDR.
The CIDR must be RFC1918-compliant.</p>
</li>
<li><p class="first"><strong>IPsec Preshared Key</strong>: Preshared keying is a method where the
endpoints of the VPN share a secret key. This key value is used to
authenticate the customer gateway and the VPC VPN gateway to each
other. The sequence cannot contain a newline or double-quote.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The IKE peers (VPN end points) authenticate each other by
computing and sending a keyed hash of data that includes the
Preshared key. If the receiving peer is able to create the same
hash independently by using its Preshared key, it knows that both
peers must share the same secret, thus authenticating the customer
gateway.</p>
</div>
</li>
<li><p class="first"><strong>IKE Encryption</strong>: The Internet Key Exchange (IKE) policy for
phase-1. The supported encryption algorithms are AES128, AES192,
AES256, and 3DES. Authentication is accomplished through the
Preshared Keys.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The phase-1 is the first phase in the IKE process. In this initial
negotiation phase, the two VPN endpoints agree on the methods to
be used to provide security for the underlying IP traffic. The
phase-1 authenticates the two VPN gateways to each other, by
confirming that the remote gateway has a matching Preshared Key.</p>
</div>
</li>
<li><p class="first"><strong>IKE Hash</strong>: The IKE hash for phase-1. The supported hash
algorithms are SHA1 and MD5.</p>
</li>
<li><p class="first"><strong>IKE DH</strong>: A public-key cryptography protocol which allows two
parties to establish a shared secret over an insecure
communications channel. The 1536-bit Diffie-Hellman group is used
within IKE to establish session keys. The supported options are
None, Group-5 (1536-bit) and Group-2 (1024-bit).</p>
</li>
<li><p class="first"><strong>ESP Encryption</strong>: Encapsulating 安全 Payload (ESP) algorithm
within phase-2. The supported encryption algorithms are AES128,
AES192, AES256, and 3DES.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The phase-2 is the second phase in the IKE process. The purpose of
IKE phase-2 is to negotiate IPSec security associations (SA) to
set up the IPSec tunnel. In phase-2, new keying material is
extracted from the Diffie-Hellman key exchange in phase-1, to
provide session keys to use in protecting the VPN data flow.</p>
</div>
</li>
<li><p class="first"><strong>ESP Hash</strong>: Encapsulating 安全 Payload (ESP) hash for
phase-2. Supported hash algorithms are SHA1 and MD5.</p>
</li>
<li><p class="first"><strong>Perfect Forward Secrecy</strong>: Perfect Forward Secrecy (or PFS) is
the property that ensures that a session key derived from a set of
long-term public and private keys will not be compromised. This
property enforces a new Diffie-Hellman key exchange. It provides
the keying material that has greater key material life and thereby
greater resistance to cryptographic attacks. The available options
are None, Group-5 (1536-bit) and Group-2 (1024-bit). The security
of the key exchanges increase as the DH groups grow larger, as
does the time of the exchanges.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">When PFS is turned on, for every negotiation of a new phase-2 SA
the two gateways must generate a new set of phase-1 keys. This
adds an extra layer of protection that PFS adds, which ensures if
the phase-2 SA’s have expired, the keys used for new phase-2 SA’s
have not been generated from the current phase-1 keying material.</p>
</div>
</li>
<li><p class="first"><strong>IKE Lifetime (seconds)</strong>: The phase-1 lifetime of the security
association in seconds. Default is 86400 seconds (1 day). Whenever
the time expires, a new phase-1 exchange is performed.</p>
</li>
<li><p class="first"><strong>ESP Lifetime (seconds)</strong>: The phase-2 lifetime of the security
association in seconds. Default is 3600 seconds (1 hour). Whenever
the value is exceeded, a re-key is initiated to provide a new
IPsec encryption and authentication session keys.</p>
</li>
<li><p class="first"><strong>Dead Peer Detection</strong>: A method to detect an unavailable
Internet Key Exchange (IKE) peer. Select this option if you want
the virtual router to query the liveliness of its IKE peer at
regular intervals. It’s recommended to have the same configuration
of DPD on both side of VPN connection.</p>
</li>
</ul>
</li>
<li><p class="first">Click OK.</p>
</li>
</ol>
<div class="section" id="updating-and-removing-a-vpn-customer-gateway">
<h4>Updating and Removing a VPN Customer Gateway<a class="headerlink" href="networking_and_traffic.html#updating-and-removing-a-vpn-customer-gateway" title="Permalink to this headline">¶</a></h4>
<p>You can update a customer gateway either with no VPN connection, or
related VPN connection is in error state.</p>
<ol class="arabic simple">
<li>Log in to the CloudStack UI as an administrator or end user.</li>
<li>In the left navigation, choose Network.</li>
<li>In the Select view, select VPN Customer Gateway.</li>
<li>Select the VPN customer gateway you want to work with.</li>
<li>To modify the required parameters, click the Edit VPN Customer
Gateway button <img alt="button to edit." src="../_images/edit-icon.png" /></li>
<li>To remove the VPN customer gateway, click the Delete VPN Customer
Gateway button <img alt="button to remove a VPN customer gateway." src="../_images/delete-button.png" /></li>
<li>Click OK.</li>
</ol>
</div>
</div>
<div class="section" id="creating-a-vpn-gateway-for-the-vpc">
<h3>Creating a VPN gateway for the VPC<a class="headerlink" href="networking_and_traffic.html#creating-a-vpn-gateway-for-the-vpc" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p class="first">Log in to the CloudStack UI as an administrator or end user.</p>
</li>
<li><p class="first">In the left navigation, choose Network.</p>
</li>
<li><p class="first">In the Select view, select VPC.</p>
<p>All the VPCs that you have created for the account is listed in the
page.</p>
</li>
<li><p class="first">Click the Configure button of the VPC to which you want to deploy the
VMs.</p>
<p>The VPC page is displayed where all the tiers you created are listed
in a diagram.</p>
<p>For each tier, the following options are displayed:</p>
<ul class="simple">
<li>Internal LB</li>
<li>Public LB IP</li>
<li>Static NAT</li>
<li>Virtual Machines</li>
<li>CIDR</li>
</ul>
<p>The following router information is displayed:</p>
<ul class="simple">
<li>Private Gateways</li>
<li>Public IP Addresses</li>
<li>Site-to-Site VPNs</li>
<li>Network ACL Lists</li>
</ul>
</li>
<li><p class="first">Select Site-to-Site VPN.</p>
<p>If you are creating the VPN gateway for the first time, selecting
Site-to-Site VPN prompts you to create a VPN gateway.</p>
</li>
<li><p class="first">In the confirmation dialog, click Yes to confirm.</p>
<p>Within a few moments, the VPN gateway is created. You will be
prompted to view the details of the VPN gateway you have created.
Click Yes to confirm.</p>
<p>The following details are displayed in the VPN Gateway page:</p>
<ul class="simple">
<li>IP Address</li>
<li>Account</li>
<li>Domain</li>
</ul>
</li>
</ol>
</div>
<div class="section" id="creating-a-vpn-connection">
<h3>Creating a VPN Connection<a class="headerlink" href="networking_and_traffic.html#creating-a-vpn-connection" title="Permalink to this headline">¶</a></h3>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">CloudStack supports creating up to 8 VPN connections.</p>
</div>
<ol class="arabic">
<li><p class="first">Log in to the CloudStack UI as an administrator or end user.</p>
</li>
<li><p class="first">In the left navigation, choose Network.</p>
</li>
<li><p class="first">In the Select view, select VPC.</p>
<p>All the VPCs that you create for the account are listed in the page.</p>
</li>
<li><p class="first">Click the Configure button of the VPC to which you want to deploy the
VMs.</p>
<p>The VPC page is displayed where all the tiers you created are listed
in a diagram.</p>
</li>
<li><p class="first">Click the Settings icon.</p>
<p>For each tier, the following options are displayed:</p>
<ul class="simple">
<li>Internal LB</li>
<li>Public LB IP</li>
<li>Static NAT</li>
<li>Virtual Machines</li>
<li>CIDR</li>
</ul>
<p>The following router information is displayed:</p>
<ul class="simple">
<li>Private Gateways</li>
<li>Public IP Addresses</li>
<li>Site-to-Site VPNs</li>
<li>Network ACL Lists</li>
</ul>
</li>
<li><p class="first">Select Site-to-Site VPN.</p>
<p>The Site-to-Site VPN page is displayed.</p>
</li>
<li><p class="first">From the Select View drop-down, ensure that VPN Connection is
selected.</p>
</li>
<li><p class="first">Click Create VPN Connection.</p>
<p>The Create VPN Connection dialog is displayed:</p>
<p><img alt="creating a VPN connection to the customer gateway." src="../_images/create-vpn-connection.png" /></p>
</li>
<li><p class="first">Select the desired customer gateway.</p>
</li>
<li><p class="first">Select Passive if you want to establish a connection between two VPC
virtual routers.</p>
<p>If you want to establish a connection between two VPC virtual
routers, select Passive only on one of the VPC virtual routers, which
waits for the other VPC virtual router to initiate the connection. Do
not select Passive on the VPC virtual router that initiates the
connection.</p>
</li>
<li><p class="first">Click OK to confirm.</p>
<p>Within a few moments, the VPN Connection is displayed.</p>
<p>The following information on the VPN connection is displayed:</p>
<ul class="simple">
<li>IP Address</li>
<li>Gateway</li>
<li>State</li>
<li>IPSec Preshared Key</li>
<li>IKE Policy</li>
<li>ESP Policy</li>
</ul>
</li>
</ol>
</div>
<div class="section" id="site-to-site-vpn-connection-between-vpc-networks">
<h3>Site-to-Site VPN Connection Between VPC Networks<a class="headerlink" href="networking_and_traffic.html#site-to-site-vpn-connection-between-vpc-networks" title="Permalink to this headline">¶</a></h3>
<p>CloudStack provides you with the ability to establish a site-to-site VPN
connection between CloudStack virtual routers. To achieve that, add a
passive mode Site-to-Site VPN. With this functionality, users can deploy
applications in multiple Availability Zones or VPCs, which can
communicate with each other by using a secure Site-to-Site VPN Tunnel.</p>
<p>This feature is supported on all the hypervisors.</p>
<ol class="arabic">
<li><p class="first">Create two VPCs. For example, VPC A and VPC B.</p>
<p>For more information, see “<a class="reference internal" href="networking_and_traffic.html#configuring-vpc"><span class="std std-ref">Configuring a Virtual Private Cloud</span></a>”.</p>
</li>
<li><p class="first">Create VPN gateways on both the VPCs you created.</p>
<p>For more information, see <a class="reference external" href="networking_and_traffic.html#creating-a-vpn-gateway-for-the-vpc">“Creating a VPN gateway
for the VPC”</a>.</p>
</li>
<li><p class="first">Create VPN customer gateway for both the VPCs.</p>
<p>For more information, see <a class="reference external" href="networking_and_traffic.html#creating-and-updating-a-vpn-customer-gateway">“Creating and Updating
a VPN Customer Gateway”</a>.</p>
</li>
<li><p class="first">Enable a VPN connection on VPC A in passive mode.</p>
<p>For more information, see <a class="reference external" href="networking_and_traffic.html#creating-a-vpn-connection">“Creating a VPN
Connection”</a>.</p>
<p>Ensure that the customer gateway is pointed to VPC B. The VPN
connection is shown in the Disconnected state.</p>
</li>
<li><p class="first">Enable a VPN connection on VPC B.</p>
<p>Ensure that the customer gateway is pointed to VPC A. Because virtual
router of VPC A, in this case, is in passive mode and is waiting for
the virtual router of VPC B to initiate the connection, VPC B virtual
router should not be in passive mode.</p>
<p>The VPN connection is shown in the Disconnected state.</p>
<p>Creating VPN connection on both the VPCs initiates a VPN connection.
Wait for few seconds. The default is 30 seconds for both the VPN
connections to show the Connected state.</p>
</li>
</ol>
</div>
<div class="section" id="restarting-and-removing-a-vpn-connection">
<h3>Restarting and Removing a VPN Connection<a class="headerlink" href="networking_and_traffic.html#restarting-and-removing-a-vpn-connection" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p class="first">Log in to the CloudStack UI as an administrator or end user.</p>
</li>
<li><p class="first">In the left navigation, choose Network.</p>
</li>
<li><p class="first">In the Select view, select VPC.</p>
<p>All the VPCs that you have created for the account is listed in the
page.</p>
</li>
<li><p class="first">Click the Configure button of the VPC to which you want to deploy the
VMs.</p>
<p>The VPC page is displayed where all the tiers you created are listed
in a diagram.</p>
</li>
<li><p class="first">Click the Settings icon.</p>
<p>For each tier, the following options are displayed:</p>
<ul class="simple">
<li>Internal LB</li>
<li>Public LB IP</li>
<li>Static NAT</li>
<li>Virtual Machines</li>
<li>CIDR</li>
</ul>
<p>The following router information is displayed:</p>
<ul class="simple">
<li>Private Gateways</li>
<li>Public IP Addresses</li>
<li>Site-to-Site VPNs</li>
<li>Network ACL Lists</li>
</ul>
</li>
<li><p class="first">Select Site-to-Site VPN.</p>
<p>The Site-to-Site VPN page is displayed.</p>
</li>
<li><p class="first">From the Select View drop-down, ensure that VPN Connection is
selected.</p>
<p>All the VPN connections you created are displayed.</p>
</li>
<li><p class="first">Select the VPN connection you want to work with.</p>
<p>The Details tab is displayed.</p>
</li>
<li><p class="first">To remove a VPN connection, click the Delete VPN connection button
<img alt="button to remove a VPN connection" src="../_images/remove-vpn.png" /></p>
<p>To restart a VPN connection, click the Reset VPN connection button
present in the Details tab. <img alt="button to reset a VPN connection" src="../_images/reset-vpn.png" /></p>
</li>
</ol>
</div>
</div>
</div>
<div class="section" id="about-inter-vlan-routing-ntier-apps">
<h1>About Inter-VLAN Routing (nTier Apps)<a class="headerlink" href="networking_and_traffic.html#about-inter-vlan-routing-ntier-apps" title="Permalink to this headline">¶</a></h1>
<p>Inter-VLAN Routing (nTier Apps) is the capability to route network
traffic between VLANs. This feature enables you to build Virtual Private
Clouds (VPC), an isolated segment of your cloud, that can hold
multi-tier applications. These tiers are deployed on different VLANs
that can communicate with each other. You provision VLANs to the tiers
your create, and VMs can be deployed on different tiers. The VLANs are
connected to a virtual router, which facilitates communication between
the VMs. In effect, you can segment VMs by means of VLANs into different
networks that can host multi-tier applications, such as Web,
Application, or Database. Such segmentation by means of VLANs logically
separate application VMs for higher security and lower broadcasts, while
remaining physically connected to the same device.</p>
<p>This feature is supported on XenServer, KVM, and VMware hypervisors.</p>
<p>The major advantages are:</p>
<ul>
<li><p class="first">The administrator can deploy a set of VLANs and allow users to deploy
VMs on these VLANs. A guest VLAN is randomly alloted to an account
from a pre-specified set of guest VLANs. All the VMs of a certain
tier of an account reside on the guest VLAN allotted to that account.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">A VLAN allocated for an account cannot be shared between multiple accounts.</p>
</div>
</li>
<li><p class="first">The administrator can allow users create their own VPC and deploy the
application. In this scenario, the VMs that belong to the account are
deployed on the VLANs allotted to that account.</p>
</li>
<li><p class="first">Both administrators and users can create multiple VPCs. The guest
network NIC is plugged to the VPC virtual router when the first VM is
deployed in a tier.</p>
</li>
<li><p class="first">The administrator can create the following gateways to send to or
receive traffic from the VMs:</p>
<ul class="simple">
<li><strong>VPN Gateway</strong>: For more information, see <a class="reference external" href="networking_and_traffic.html#creating-a-vpn-gateway-for-the-vpc">“Creating a VPN gateway for the
VPC”</a>.</li>
<li><strong>Public Gateway</strong>: The public gateway for a VPC is added to the
virtual router when the virtual router is created for VPC. The
public gateway is not exposed to the end users. You are not
allowed to list it, nor allowed to create any static routes.</li>
<li><strong>Private Gateway</strong>: For more information, see “<a class="reference internal" href="networking_and_traffic.html#adding-priv-gw-vpc"><span class="std std-ref">Adding a Private Gateway to a VPC</span></a>”.</li>
</ul>
</li>
<li><p class="first">Both administrators and users can create various possible
destinations-gateway combinations. However, only one gateway of each
type can be used in a deployment.</p>
<p>For example:</p>
<ul class="simple">
<li><strong>VLANs and Public Gateway</strong>: For example, an application is
deployed in the cloud, and the Web application VMs communicate
with the Internet.</li>
<li><strong>VLANs, VPN Gateway, and Public Gateway</strong>: For example, an
application is deployed in the cloud; the Web application VMs
communicate with the Internet; and the database VMs communicate
with the on-premise devices.</li>
</ul>
</li>
<li><p class="first">The administrator can define Network Access Control List (ACL) on the
virtual router to filter the traffic among the VLANs or between the
Internet and a VLAN. You can define ACL based on CIDR, port range,
protocol, type code (if ICMP protocol is selected) and Ingress/Egress
type.</p>
</li>
</ul>
<p>The following figure shows the possible deployment scenarios of a
Inter-VLAN setup:</p>
<p><img alt="a multi-tier setup." src="../_images/multi-tier-app.png" /></p>
<p>To set up a multi-tier Inter-VLAN deployment, see “<a class="reference internal" href="networking_and_traffic.html#configuring-vpc"><span class="std std-ref">Configuring a Virtual Private Cloud</span></a>”.</p>
</div>
<div class="section" id="configuring-a-virtual-private-cloud">
<span id="configuring-vpc"></span><h1>Configuring a Virtual Private Cloud<a class="headerlink" href="networking_and_traffic.html#configuring-a-virtual-private-cloud" title="Permalink to this headline">¶</a></h1>
<div class="section" id="about-virtual-private-clouds">
<span id="about-vpc"></span><h2>About Virtual Private Clouds<a class="headerlink" href="networking_and_traffic.html#about-virtual-private-clouds" title="Permalink to this headline">¶</a></h2>
<p>CloudStack Virtual Private Cloud is a private, isolated part of
CloudStack. A VPC can have its own virtual network topology that
resembles a traditional physical network. You can launch VMs in the
virtual network that can have private addresses in the range of your
choice, for example: 10.0.0.0/16. You can define network tiers within
your VPC network range, which in turn enables you to group similar kinds
of instances based on IP address range.</p>
<p>For example, if a VPC has the private range 10.0.0.0/16, its guest
networks can have the network ranges 10.0.1.0/24, 10.0.2.0/24,
10.0.3.0/24, and so on.</p>
<div class="section" id="major-components-of-a-vpc">
<h3>Major Components of a VPC<a class="headerlink" href="networking_and_traffic.html#major-components-of-a-vpc" title="Permalink to this headline">¶</a></h3>
<p>A VPC is comprised of the following network components:</p>
<ul class="simple">
<li><strong>VPC</strong>: A VPC acts as a container for multiple isolated networks
that can communicate with each other via its virtual router.</li>
<li><strong>Network Tiers</strong>: Each tier acts as an isolated network with its own
VLANs and CIDR list, where you can place groups of resources, such as
VMs. The tiers are segmented by means of VLANs. The NIC of each tier
acts as its gateway.</li>
<li><strong>虚拟路由器</strong>: A virtual router is automatically created and
started when you create a VPC. The virtual router connect the tiers
and direct traffic among the public gateway, the VPN gateways, and
the NAT instances. For each tier, a corresponding NIC and IP exist in
the virtual router. The virtual router provides DNS 和 DHCP services
through its IP.</li>
<li><strong>Public Gateway</strong>: The traffic to and from the Internet routed to
the VPC through the public gateway. In a VPC, the public gateway is
not exposed to the end user; therefore, static routes are not support
for the public gateway.</li>
<li><strong>Private Gateway</strong>: All the traffic to and from a private network
routed to the VPC through the private gateway. For more information,
see “<a class="reference internal" href="networking_and_traffic.html#adding-priv-gw-vpc"><span class="std std-ref">Adding a Private Gateway to a VPC</span></a>”.</li>
<li><strong>VPN Gateway</strong>: The VPC side of a VPN connection.</li>
<li><strong>Site-to-Site VPN Connection</strong>: A hardware-based VPN connection
between your VPC and your datacenter, home network, or co-location
facility. For more information, see “<a class="reference internal" href="networking_and_traffic.html#setting-s2s-vpn-conn"><span class="std std-ref">Setting Up a Site-to-Site VPN Connection</span></a>”.</li>
<li><strong>Customer Gateway</strong>: The customer side of a VPN Connection. For more
information, see <a class="reference external" href="networking_and_traffic.html#creating-and-updating-a-vpn-customer-gateway">“Creating and Updating a VPN
Customer Gateway”</a>.</li>
<li><strong>NAT Instance</strong>: An instance that provides Port Address Translation
for instances to access the Internet via the public gateway. For more
information, see “<a class="reference internal" href="networking_and_traffic.html#enabling-disabling-static-nat-on-vpc"><span class="std std-ref">Enabling or Disabling Static NAT on a VPC</span></a>”.</li>
<li><strong>Network ACL</strong>: Network ACL is a group of Network ACL items. Network
ACL items are nothing but numbered rules that are evaluated in order,
starting with the lowest numbered rule. These rules determine whether
traffic is allowed in or out of any tier associated with the network
ACL. For more information, see “<a class="reference internal" href="networking_and_traffic.html#conf-net-acl"><span class="std std-ref">Configuring Network Access Control List</span></a>”.</li>
</ul>
</div>
<div class="section" id="network-architecture-in-a-vpc">
<h3>Network Architecture in a VPC<a class="headerlink" href="networking_and_traffic.html#network-architecture-in-a-vpc" title="Permalink to this headline">¶</a></h3>
<p>In a VPC, the following four basic options of network architectures are
present:</p>
<ul class="simple">
<li>VPC with a public gateway only</li>
<li>VPC with public and private gateways</li>
<li>VPC with public and private gateways and site-to-site VPN access</li>
<li>VPC with a private gateway only and site-to-site VPN access</li>
</ul>
</div>
<div class="section" id="connectivity-options-for-a-vpc">
<h3>Connectivity Options for a VPC<a class="headerlink" href="networking_and_traffic.html#connectivity-options-for-a-vpc" title="Permalink to this headline">¶</a></h3>
<p>You can connect your VPC to:</p>
<ul class="simple">
<li>The Internet through the public gateway.</li>
<li>The corporate datacenter by using a site-to-site VPN connection
through the VPN gateway.</li>
<li>Both the Internet and your corporate datacenter by using both the
public gateway and a VPN gateway.</li>
</ul>
</div>
<div class="section" id="vpc-network-considerations">
<h3>VPC Network Considerations<a class="headerlink" href="networking_and_traffic.html#vpc-network-considerations" title="Permalink to this headline">¶</a></h3>
<p>Consider the following before you create a VPC:</p>
<ul class="simple">
<li>A VPC, by default, is created in the enabled state.</li>
<li>A VPC can be created in Advance zone only, and can’t belong to more
than one zone at a time.</li>
<li>The default number of VPCs an account can create is 20. However, you
can change it by using the max.account.vpcs global parameter, which
controls the maximum number of VPCs an account is allowed to create.</li>
<li>The default number of tiers an account can create within a VPC is 3.
You can configure this number by using the vpc.max.networks
parameter.</li>
<li>Each tier should have an unique CIDR in the VPC. Ensure that the
tier’s CIDR should be within the VPC CIDR range.</li>
<li>A tier belongs to only one VPC.</li>
<li>All network tiers inside the VPC should belong to the same account.</li>
<li>When a VPC is created, by default, a SourceNAT IP is allocated to it.
The Source NAT IP is released only when the VPC is removed.</li>
<li>A public IP can be used for only one purpose at a time. If the IP is
a sourceNAT, it cannot be used for StaticNAT or port forwarding.</li>
<li>The instances can only have a private IP address that you provision.
To communicate with the Internet, enable NAT to an instance that you
launch in your VPC.</li>
<li>Only new networks can be added to a VPC. The maximum number of
networks per VPC is limited by the value you specify in the
vpc.max.networks parameter. The default value is three.</li>
<li>The load balancing service can be supported by only one tier inside
the VPC.</li>
<li>If an IP address is assigned to a tier:<ul>
<li>That IP can’t be used by more than one tier at a time in the VPC.
For example, if you have tiers A and B, and a public IP1, you can
create a port forwarding rule by using the IP either for A or B,
but not for both.</li>
<li>That IP can’t be used for StaticNAT, load balancing, or port
forwarding rules for another guest network inside the VPC.</li>
</ul>
</li>
<li>Remote access VPN is not supported in VPC networks.</li>
</ul>
</div>
</div>
<div class="section" id="adding-a-virtual-private-cloud">
<h2>Adding a Virtual Private Cloud<a class="headerlink" href="networking_and_traffic.html#adding-a-virtual-private-cloud" title="Permalink to this headline">¶</a></h2>
<p>When creating the VPC, you simply provide the zone and a set of IP
addresses for the VPC network address space. You specify this set of
addresses in the form of a Classless Inter-Domain Routing (CIDR) block.</p>
<ol class="arabic">
<li><p class="first">Log in to the CloudStack UI as an administrator or end user.</p>
</li>
<li><p class="first">In the left navigation, choose Network.</p>
</li>
<li><p class="first">In the Select view, select VPC.</p>
</li>
<li><p class="first">Click Add VPC. The Add VPC page is displayed as follows:</p>
<p><img alt="adding a vpc." src="../_images/add-vpc.png" /></p>
<p>Provide the following information:</p>
<ul class="simple">
<li><strong>Name</strong>: A short name for the VPC that you are creating.</li>
<li><strong>Description</strong>: A brief description of the VPC.</li>
<li><strong>Zone</strong>: Choose the zone where you want the VPC to be available.</li>
<li><strong>Super CIDR for Guest Networks</strong>: Defines the CIDR range for all
the tiers (guest networks) within a VPC. When you create a tier,
ensure that its CIDR is within the Super CIDR value you enter. The
CIDR must be RFC1918 compliant.</li>
<li><strong>DNS domain for Guest Networks</strong>: If you want to assign a special
domain name, specify the DNS suffix. This parameter is applied to
all the tiers within the VPC. That implies, all the tiers you
create in the VPC belong to the same DNS domain. If the parameter
is not specified, a DNS domain name is generated automatically.</li>
<li><strong>Public Load Balancer Provider</strong>: You have two options: VPC
虚拟路由器 and Netscaler.</li>
</ul>
</li>
<li><p class="first">Click OK.</p>
</li>
</ol>
</div>
<div class="section" id="adding-tiers">
<h2>Adding Tiers<a class="headerlink" href="networking_and_traffic.html#adding-tiers" title="Permalink to this headline">¶</a></h2>
<p>Tiers are distinct locations within a VPC that act as isolated networks,
which do not have access to other tiers by default. Tiers are set up on
different VLANs that can communicate with each other by using a virtual
router. Tiers provide inexpensive, low latency network connectivity to
other tiers within the VPC.</p>
<ol class="arabic">
<li><p class="first">Log in to the CloudStack UI as an administrator or end user.</p>
</li>
<li><p class="first">In the left navigation, choose Network.</p>
</li>
<li><p class="first">In the Select view, select VPC.</p>
<p>All the VPC that you have created for the account is listed in the
page.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The end users can see their own VPCs, while root and domain admin can
see any VPC they are authorized to see.</p>
</div>
</li>
<li><p class="first">Click the Configure button of the VPC for which you want to set up
tiers.</p>
</li>
<li><p class="first">Click Create network.</p>
<p>The Add new tier dialog is displayed, as follows:</p>
<p><img alt="adding a tier to a vpc." src="../_images/add-tier.png" /></p>
<p>If you have already created tiers, the VPC diagram is displayed.
Click Create Tier to add a new tier.</p>
</li>
<li><p class="first">Specify the following:</p>
<p>All the fields are mandatory.</p>
<ul>
<li><p class="first"><strong>Name</strong>: A unique name for the tier you create.</p>
</li>
<li><p class="first"><strong>Network Offering</strong>: The following default network offerings are
listed: Internal LB,
DefaultIsolatedNetworkOfferingForVpcNetworksNoLB,
DefaultIsolatedNetworkOfferingForVpcNetworks</p>
<p>In a VPC, only one tier can be created by using LB-enabled network
offering.</p>
</li>
<li><p class="first"><strong>Gateway</strong>: The gateway for the tier you create. Ensure that the
gateway is within the Super CIDR range that you specified while
creating the VPC, and is not overlapped with the CIDR of any
existing tier within the VPC.</p>
</li>
<li><p class="first"><strong>VLAN</strong>: The VLAN ID for the tier that the root admin creates.</p>
<p>This option is only visible if the network offering you selected
is VLAN-enabled.</p>
<p>For more information, see <a class="reference external" href="hosts.html#assigning-vlans-to-isolated-networks">“Assigning VLANs to
Isolated Networks”</a>.</p>
</li>
<li><p class="first"><strong>Netmask</strong>: The netmask for the tier you create.</p>
<p>For example, if the VPC CIDR is 10.0.0.0/16 and the network tier
CIDR is 10.0.1.0/24, the gateway of the tier is 10.0.1.1, and the
netmask of the tier is 255.255.255.0.</p>
</li>
</ul>
</li>
<li><p class="first">Click OK.</p>
</li>
<li><p class="first">Continue with configuring access control list for the tier.</p>
</li>
</ol>
</div>
<div class="section" id="configuring-network-access-control-list">
<span id="conf-net-acl"></span><h2>Configuring Network Access Control List<a class="headerlink" href="networking_and_traffic.html#configuring-network-access-control-list" title="Permalink to this headline">¶</a></h2>
<p>Define Network Access Control List (ACL) on the VPC virtual router to
control incoming (ingress) and outgoing (egress) traffic between the VPC
tiers, and the tiers and Internet. By default, all incoming traffic to
the guest networks is blocked and all outgoing traffic from guest
networks is allowed, once you add an ACL rule for outgoing traffic, then
only outgoing traffic specified in this ACL rule is allowed, the rest is
blocked. To open the ports, you must create a new network ACL. The
network ACLs can be created for the tiers only if the NetworkACL service
is supported.</p>
<div class="section" id="about-network-acl-lists">
<h3>About Network ACL Lists<a class="headerlink" href="networking_and_traffic.html#about-network-acl-lists" title="Permalink to this headline">¶</a></h3>
<p>In CloudStack 术语, Network ACL is a group of Network ACL items.
Network ACL items are nothing but numbered rules that are evaluated in
order, starting with the lowest numbered rule. These rules determine
whether traffic is allowed in or out of any tier associated with the
network ACL. You need to add the Network ACL items to the Network ACL,
then associate the Network ACL with a tier. Network ACL is associated
with a VPC and can be assigned to multiple VPC tiers within a VPC. A
Tier is associated with a Network ACL at all the times. Each tier can be
associated with only one ACL.</p>
<p>The default Network ACL is used when no ACL is associated. Default
behavior is all the incoming traffic is blocked and outgoing traffic is
allowed from the tiers. Default network ACL cannot be removed or
modified. 目录 of the default Network ACL is:</p>
<table border="1" class="table-striped table-bordered table-hover docutils">
<colgroup>
<col width="13%" />
<col width="20%" />
<col width="30%" />
<col width="15%" />
<col width="23%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Rule</th>
<th class="head">Protocol</th>
<th class="head">Traffic type</th>
<th class="head">Action</th>
<th class="head">CIDR</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>1</td>
<td>All</td>
<td>Ingress</td>
<td>Deny</td>
<td>0.0.0.0/0</td>
</tr>
<tr class="row-odd"><td>2</td>
<td>All</td>
<td>Egress</td>
<td>Deny</td>
<td>0.0.0.0/0</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="creating-acl-lists">
<h3>Creating ACL Lists<a class="headerlink" href="networking_and_traffic.html#creating-acl-lists" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p class="first">Log in to the CloudStack UI as an administrator or end user.</p>
</li>
<li><p class="first">In the left navigation, choose Network.</p>
</li>
<li><p class="first">In the Select view, select VPC.</p>
<p>All the VPCs that you have created for the account is listed in the
page.</p>
</li>
<li><p class="first">Click the Configure button of the VPC.</p>
<p>For each tier, the following options are displayed:</p>
<ul class="simple">
<li>Internal LB</li>
<li>Public LB IP</li>
<li>Static NAT</li>
<li>Virtual Machines</li>
<li>CIDR</li>
</ul>
<p>The following router information is displayed:</p>
<ul class="simple">
<li>Private Gateways</li>
<li>Public IP Addresses</li>
<li>Site-to-Site VPNs</li>
<li>Network ACL Lists</li>
</ul>
</li>
<li><p class="first">Select Network ACL Lists.</p>
<p>The following default rules are displayed in the Network ACLs page:
default_allow, default_deny.</p>
</li>
<li><p class="first">Click Add ACL Lists, and specify the following:</p>
<ul class="simple">
<li><strong>ACL List Name</strong>: A name for the ACL list.</li>
<li><strong>Description</strong>: A short description of the ACL list that can be
displayed to users.</li>
</ul>
</li>
</ol>
</div>
<div class="section" id="creating-an-acl-rule">
<h3>Creating an ACL Rule<a class="headerlink" href="networking_and_traffic.html#creating-an-acl-rule" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p class="first">Log in to the CloudStack UI as an administrator or end user.</p>
</li>
<li><p class="first">In the left navigation, choose Network.</p>
</li>
<li><p class="first">In the Select view, select VPC.</p>
<p>All the VPCs that you have created for the account is listed in the
page.</p>
</li>
<li><p class="first">Click the Configure button of the VPC.</p>
</li>
<li><p class="first">Select Network ACL Lists.</p>
<p>In addition to the custom ACL lists you have created, the following
default rules are displayed in the Network ACLs page: default_allow,
default_deny.</p>
</li>
<li><p class="first">Select the desired ACL list.</p>
</li>
<li><p class="first">Select the ACL List Rules tab.</p>
<p>To add an ACL rule, fill in the following fields to specify what kind
of network traffic is allowed in the VPC.</p>
<ul class="simple">
<li><strong>Rule Number</strong>: The order in which the rules are evaluated.</li>
<li><strong>CIDR</strong>: The CIDR acts as the Source CIDR for the Ingress rules,
and Destination CIDR for the Egress rules. To accept traffic only
from or to the IP addresses within a particular address block,
enter a CIDR or a comma-separated list of CIDRs. The CIDR is the
base IP address of the incoming traffic. For example,
192.168.0.0/22. To allow all CIDRs, set to 0.0.0.0/0.</li>
<li><strong>Action</strong>: What action to be taken. Allow traffic or block.</li>
<li><strong>Protocol</strong>: The networking protocol that sources use to send
traffic to the tier. The TCP and UDP protocols are typically used
for data exchange and end-user communications. The ICMP protocol
is typically used to send error messages or network monitoring
data. All supports all the traffic. Other option is Protocol
Number.</li>
<li><strong>Start Port</strong>, <strong>End Port</strong> (TCP, UDP only): A range of listening
ports that are the destination for the incoming traffic. If you
are opening a single port, use the same number in both fields.</li>
<li><strong>Protocol Number</strong>: The protocol number associated with IPv4 or
IPv6. For more information, see <a class="reference external" href="http://www.iana.org/assignments/protocol-numbers/protocol-numbers.xml">Protocol Numbers</a>.</li>
<li><strong>ICMP Type</strong>, <strong>ICMP Code</strong> (ICMP only): The type of message and
error code that will be sent.</li>
<li><strong>Traffic Type</strong>: The type of traffic: Incoming or outgoing.</li>
</ul>
</li>
<li><p class="first">Click Add. The ACL rule is added.</p>
<p>You can edit the tags assigned to the ACL rules and delete the ACL
rules you have created. Click the appropriate button in the Details
tab.</p>
</li>
</ol>
</div>
<div class="section" id="creating-a-tier-with-custom-acl-list">
<h3>Creating a Tier with Custom ACL List<a class="headerlink" href="networking_and_traffic.html#creating-a-tier-with-custom-acl-list" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p class="first">Create a VPC.</p>
</li>
<li><p class="first">Create a custom ACL list.</p>
</li>
<li><p class="first">Add ACL rules to the ACL list.</p>
</li>
<li><p class="first">Create a tier in the VPC.</p>
<p>Select the desired ACL list while creating a tier.</p>
</li>
<li><p class="first">Click OK.</p>
</li>
</ol>
</div>
<div class="section" id="assigning-a-custom-acl-list-to-a-tier">
<h3>Assigning a Custom ACL List to a Tier<a class="headerlink" href="networking_and_traffic.html#assigning-a-custom-acl-list-to-a-tier" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p class="first">Create a VPC.</p>
</li>
<li><p class="first">Create a tier in the VPC.</p>
</li>
<li><p class="first">Associate the tier with the default ACL rule.</p>
</li>
<li><p class="first">Create a custom ACL list.</p>
</li>
<li><p class="first">Add ACL rules to the ACL list.</p>
</li>
<li><p class="first">Select the tier for which you want to assign the custom ACL.</p>
</li>
<li><p class="first">Click the Replace ACL List icon. <img alt="button to replace an ACL list" src="../_images/replace-acl-icon.png" /></p>
<p>The Replace ACL List dialog is displayed.</p>
</li>
<li><p class="first">Select the desired ACL list.</p>
</li>
<li><p class="first">Click OK.</p>
</li>
</ol>
</div>
</div>
<div class="section" id="adding-a-private-gateway-to-a-vpc">
<span id="adding-priv-gw-vpc"></span><h2>Adding a Private Gateway to a VPC<a class="headerlink" href="networking_and_traffic.html#adding-a-private-gateway-to-a-vpc" title="Permalink to this headline">¶</a></h2>
<p>A private gateway can be added by the root admin only. The VPC private
network has 1:1 relationship with the NIC of the physical network. You
can configure multiple private gateways to a single VPC. No gateways
with duplicated VLAN and IP are allowed in the same data center.</p>
<ol class="arabic">
<li><p class="first">Log in to the CloudStack UI as an administrator or end user.</p>
</li>
<li><p class="first">In the left navigation, choose Network.</p>
</li>
<li><p class="first">In the Select view, select VPC.</p>
<p>All the VPCs that you have created for the account is listed in the
page.</p>
</li>
<li><p class="first">Click the Configure button of the VPC to which you want to configure
load balancing rules.</p>
<p>The VPC page is displayed where all the tiers you created are listed
in a diagram.</p>
</li>
<li><p class="first">Click the Settings icon.</p>
<p>The following options are displayed.</p>
<ul class="simple">
<li>Internal LB</li>
<li>Public LB IP</li>
<li>Static NAT</li>
<li>Virtual Machines</li>
<li>CIDR</li>
</ul>
<p>The following router information is displayed:</p>
<ul class="simple">
<li>Private Gateways</li>
<li>Public IP Addresses</li>
<li>Site-to-Site VPNs</li>
<li>Network ACL Lists</li>
</ul>
</li>
<li><p class="first">Select Private Gateways.</p>
<p>The Gateways page is displayed.</p>
</li>
<li><p class="first">Click Add new gateway:</p>
<p><img alt="adding a private gateway for the VPC." src="../_images/add-new-gateway-vpc.png" /></p>
</li>
<li><p class="first">Specify the following:</p>
<ul>
<li><p class="first"><strong>Physical Network</strong>: The physical network you have created in the
zone.</p>
</li>
<li><p class="first"><strong>IP Address</strong>: The IP address associated with the VPC gateway.</p>
</li>
<li><p class="first"><strong>Gateway</strong>: The gateway through which the traffic is routed to
and from the VPC.</p>
</li>
<li><p class="first"><strong>Netmask</strong>: The netmask associated with the VPC gateway.</p>
</li>
<li><p class="first"><strong>VLAN</strong>: The VLAN associated with the VPC gateway.</p>
</li>
<li><p class="first"><strong>Source NAT</strong>: Select this option to enable the source NAT
service on the VPC private gateway.</p>
<p>See “<a class="reference internal" href="networking_and_traffic.html#source-nat-priv-gw"><span class="std std-ref">Source NAT on Private Gateway</span></a>”.</p>
</li>
<li><p class="first"><strong>ACL</strong>: Controls both ingress and egress traffic on a VPC private
gateway. By default, all the traffic is blocked.</p>
<p>See “<a class="reference internal" href="networking_and_traffic.html#acl-priv-gw"><span class="std std-ref">ACL on Private Gateway</span></a>”.</p>
</li>
</ul>
<p>The new gateway appears in the list. You can repeat these steps to
add more gateway for this VPC.</p>
</li>
</ol>
<div class="section" id="source-nat-on-private-gateway">
<span id="source-nat-priv-gw"></span><h3>Source NAT on Private Gateway<a class="headerlink" href="networking_and_traffic.html#source-nat-on-private-gateway" title="Permalink to this headline">¶</a></h3>
<p>You might want to deploy multiple VPCs with the same super CIDR and
guest tier CIDR. Therefore, multiple guest VMs from different VPCs can
have the same IPs to reach a enterprise data center through the private
gateway. In such cases, a NAT service need to be configured on the
private gateway to avoid IP conflicts. If Source NAT is enabled, the
guest VMs in VPC reaches the enterprise network via private gateway IP
address by using the NAT service.</p>
<p>The Source NAT service on a private gateway can be enabled while adding
the private gateway. On deletion of a private gateway, source NAT rules
specific to the private gateway are deleted.</p>
<p>To enable source NAT on existing private gateways, delete them and
create afresh with source NAT.</p>
</div>
<div class="section" id="acl-on-private-gateway">
<span id="acl-priv-gw"></span><h3>ACL on Private Gateway<a class="headerlink" href="networking_and_traffic.html#acl-on-private-gateway" title="Permalink to this headline">¶</a></h3>
<p>The traffic on the VPC private gateway is controlled by creating both
ingress and egress network ACL rules. The ACLs contains both allow and
deny rules. As per the rule, all the ingress traffic to the private
gateway interface and all the egress traffic out from the private
gateway interface are blocked.</p>
<p>You can change this default behaviour while creating a private gateway.
Alternatively, you can do the following:</p>
<ol class="arabic">
<li><p class="first">In a VPC, identify the Private Gateway you want to work with.</p>
</li>
<li><p class="first">In the Private Gateway page, do either of the following:</p>
<ul class="simple">
<li>Use the Quickview. See 3.</li>
<li>Use the Details tab. See 4 through .</li>
</ul>
</li>
<li><p class="first">In the Quickview of the selected Private Gateway, click Replace ACL,
select the ACL rule, then click OK</p>
</li>
<li><p class="first">Click the IP address of the Private Gateway you want to work with.</p>
</li>
<li><p class="first">In the Detail tab, click the Replace ACL button.
<img alt="button to replace an ACL list" src="../_images/replace-acl-icon.png" /></p>
<p>The Replace ACL dialog is displayed.</p>
</li>
<li><p class="first">select the ACL rule, then click OK.</p>
<p>Wait for few seconds. You can see that the new ACL rule is displayed
in the Details page.</p>
</li>
</ol>
</div>
<div class="section" id="creating-a-static-route">
<h3>Creating a Static Route<a class="headerlink" href="networking_and_traffic.html#creating-a-static-route" title="Permalink to this headline">¶</a></h3>
<p>CloudStack enables you to specify routing for the VPN connection you
create. You can enter one or CIDR addresses to indicate which traffic is
to be routed back to the gateway.</p>
<ol class="arabic">
<li><p class="first">In a VPC, identify the Private Gateway you want to work with.</p>
</li>
<li><p class="first">In the Private Gateway page, click the IP address of the Private
Gateway you want to work with.</p>
</li>
<li><p class="first">Select the Static Routes tab.</p>
</li>
<li><p class="first">Specify the CIDR of destination network.</p>
</li>
<li><p class="first">Click Add.</p>
<p>Wait for few seconds until the new route is created.</p>
</li>
</ol>
</div>
<div class="section" id="blacklisting-routes">
<h3>Blacklisting Routes<a class="headerlink" href="networking_and_traffic.html#blacklisting-routes" title="Permalink to this headline">¶</a></h3>
<p>CloudStack enables you to block a list of routes so that they are not
assigned to any of the VPC private gateways. Specify the list of routes
that you want to blacklist in the <code class="docutils literal notranslate"><span class="pre">blacklisted.routes</span></code> global
parameter. Note that the parameter update affects only new static route
creations. If you block an existing static route, it remains intact and
continue functioning. You cannot add a static route if the route is
blacklisted for the zone.</p>
</div>
</div>
<div class="section" id="deploying-vms-to-the-tier">
<h2>Deploying VMs to the Tier<a class="headerlink" href="networking_and_traffic.html#deploying-vms-to-the-tier" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p class="first">Log in to the CloudStack UI as an administrator or end user.</p>
</li>
<li><p class="first">In the left navigation, choose Network.</p>
</li>
<li><p class="first">In the Select view, select VPC.</p>
<p>All the VPCs that you have created for the account is listed in the
page.</p>
</li>
<li><p class="first">Click the Configure button of the VPC to which you want to deploy the
VMs.</p>
<p>The VPC page is displayed where all the tiers you have created are
listed.</p>
</li>
<li><p class="first">Click Virtual Machines tab of the tier to which you want to add a VM.</p>
<p><img alt="adding a VM to a vpc." src="../_images/add-vm-vpc.png" /></p>
<p>The Add Instance page is displayed.</p>
<p>Follow the on-screen instruction to add an instance. For information
on adding an instance, see the 安装指南.</p>
</li>
</ol>
</div>
<div class="section" id="deploying-vms-to-vpc-tier-and-shared-networks">
<h2>Deploying VMs to VPC Tier and Shared Networks<a class="headerlink" href="networking_and_traffic.html#deploying-vms-to-vpc-tier-and-shared-networks" title="Permalink to this headline">¶</a></h2>
<p>CloudStack allows you deploy VMs on a VPC tier and one or more shared
networks. With this feature, VMs deployed in a multi-tier application
can receive monitoring services via a shared network provided by a
service provider.</p>
<ol class="arabic">
<li><p class="first">Log in to the CloudStack UI as an administrator.</p>
</li>
<li><p class="first">In the left navigation, choose Instances.</p>
</li>
<li><p class="first">Click Add Instance.</p>
</li>
<li><p class="first">Select a zone.</p>
</li>
<li><p class="first">Select a template or ISO, then follow the steps in the wizard.</p>
</li>
<li><p class="first">Ensure that the hardware you have allows starting the selected
service offering.</p>
</li>
<li><p class="first">Under Networks, select the desired networks for the VM you are
launching.</p>
<p>You can deploy a VM to a VPC tier and multiple shared networks.</p>
<p><img alt="adding a VM to a VPC tier and shared network." src="../_images/addvm-tier-sharednw.png" /></p>
</li>
<li><p class="first">Click Next, review the configuration and click Launch.</p>
<p>Your VM will be deployed to the selected VPC tier and shared network.</p>
</li>
</ol>
</div>
<div class="section" id="acquiring-a-new-ip-address-for-a-vpc">
<h2>Acquiring a New IP Address for a VPC<a class="headerlink" href="networking_and_traffic.html#acquiring-a-new-ip-address-for-a-vpc" title="Permalink to this headline">¶</a></h2>
<p>When you acquire an IP address, all IP addresses are allocated to VPC,
not to the guest networks within the VPC. The IPs are associated to the
guest network only when the first port-forwarding, load balancing, or
Static NAT rule is created for the IP or the network. IP can’t be
associated to more than one network at a time.</p>
<ol class="arabic">
<li><p class="first">Log in to the CloudStack UI as an administrator or end user.</p>
</li>
<li><p class="first">In the left navigation, choose Network.</p>
</li>
<li><p class="first">In the Select view, select VPC.</p>
<p>All the VPCs that you have created for the account is listed in the
page.</p>
</li>
<li><p class="first">Click the Configure button of the VPC to which you want to deploy the
VMs.</p>
<p>The VPC page is displayed where all the tiers you created are listed
in a diagram.</p>
<p>The following options are displayed.</p>
<ul class="simple">
<li>Internal LB</li>
<li>Public LB IP</li>
<li>Static NAT</li>
<li>Virtual Machines</li>
<li>CIDR</li>
</ul>
<p>The following router information is displayed:</p>
<ul class="simple">
<li>Private Gateways</li>
<li>Public IP Addresses</li>
<li>Site-to-Site VPNs</li>
<li>Network ACL Lists</li>
</ul>
</li>
<li><p class="first">Select IP Addresses.</p>
<p>The Public IP Addresses page is displayed.</p>
</li>
<li><p class="first">Click Acquire New IP, and click Yes in the confirmation dialog.</p>
<p>You are prompted for confirmation because, typically, IP addresses
are a limited resource. Within a few moments, the new IP address
should appear with the state Allocated. You can now use the IP
address in port forwarding, load balancing, and static NAT rules.</p>
</li>
</ol>
</div>
<div class="section" id="releasing-an-ip-address-alloted-to-a-vpc">
<h2>Releasing an IP Address Alloted to a VPC<a class="headerlink" href="networking_and_traffic.html#releasing-an-ip-address-alloted-to-a-vpc" title="Permalink to this headline">¶</a></h2>
<p>The IP address is a limited resource. If you no longer need a particular
IP, you can disassociate it from its VPC and return it to the pool of
available addresses. An IP address can be released from its tier, only
when all the networking ( port forwarding, load balancing, or StaticNAT
) rules are removed for this IP address. The released IP address will
still belongs to the same VPC.</p>
<ol class="arabic">
<li><p class="first">Log in to the CloudStack UI as an administrator or end user.</p>
</li>
<li><p class="first">In the left navigation, choose Network.</p>
</li>
<li><p class="first">In the Select view, select VPC.</p>
<p>All the VPCs that you have created for the account is listed in the
page.</p>
</li>
<li><p class="first">Click the Configure button of the VPC whose IP you want to release.</p>
<p>The VPC page is displayed where all the tiers you created are listed
in a diagram.</p>
<p>The following options are displayed.</p>
<ul class="simple">
<li>Internal LB</li>
<li>Public LB IP</li>
<li>Static NAT</li>
<li>Virtual Machines</li>
<li>CIDR</li>
</ul>
<p>The following router information is displayed:</p>
<ul class="simple">
<li>Private Gateways</li>
<li>Public IP Addresses</li>
<li>Site-to-Site VPNs</li>
<li>Network ACL Lists</li>
</ul>
</li>
<li><p class="first">Select Public IP Addresses.</p>
<p>The IP Addresses page is displayed.</p>
</li>
<li><p class="first">Click the IP you want to release.</p>
</li>
<li><p class="first">In the Details tab, click the Release IP button <img alt="button to release an IP." src="../_images/release-ip-icon.png" /></p>
</li>
</ol>
</div>
<div class="section" id="enabling-or-disabling-static-nat-on-a-vpc">
<span id="enabling-disabling-static-nat-on-vpc"></span><h2>Enabling or Disabling Static NAT on a VPC<a class="headerlink" href="networking_and_traffic.html#enabling-or-disabling-static-nat-on-a-vpc" title="Permalink to this headline">¶</a></h2>
<p>A static NAT rule maps a public IP address to the private IP address of
a VM in a VPC to allow Internet traffic to it. This section tells how to
enable or disable static NAT for a particular IP address in a VPC.</p>
<p>If port forwarding rules are already in effect for an IP address, you
cannot enable static NAT to that IP.</p>
<p>If a guest VM is part of more than one network, static NAT rules will
function only if they are defined on the default network.</p>
<ol class="arabic">
<li><p class="first">Log in to the CloudStack UI as an administrator or end user.</p>
</li>
<li><p class="first">In the left navigation, choose Network.</p>
</li>
<li><p class="first">In the Select view, select VPC.</p>
<p>All the VPCs that you have created for the account is listed in the
page.</p>
</li>
<li><p class="first">Click the Configure button of the VPC to which you want to deploy the
VMs.</p>
<p>The VPC page is displayed where all the tiers you created are listed
in a diagram.</p>
<p>For each tier, the following options are displayed.</p>
<ul class="simple">
<li>Internal LB</li>
<li>Public LB IP</li>
<li>Static NAT</li>
<li>Virtual Machines</li>
<li>CIDR</li>
</ul>
<p>The following router information is displayed:</p>
<ul class="simple">
<li>Private Gateways</li>
<li>Public IP Addresses</li>
<li>Site-to-Site VPNs</li>
<li>Network ACL Lists</li>
</ul>
</li>
<li><p class="first">In the Router node, select Public IP Addresses.</p>
<p>The IP Addresses page is displayed.</p>
</li>
<li><p class="first">Click the IP you want to work with.</p>
</li>
<li><p class="first">In the Details tab,click the Static NAT button. <img alt="button to enable Static NAT." src="../_images/enable-disable.png" />
The button toggles between Enable and
Disable, depending on whether static NAT is currently enabled for the
IP address.</p>
</li>
<li><p class="first">If you are enabling static NAT, a dialog appears as follows:</p>
<p><img alt="selecting a tier to apply staticNAT." src="../_images/select-vm-staticnat-vpc.png" /></p>
</li>
<li><p class="first">Select the tier and the destination VM, then click Apply.</p>
</li>
</ol>
</div>
<div class="section" id="adding-load-balancing-rules-on-a-vpc">
<h2>Adding 负载均衡 Rules on a VPC<a class="headerlink" href="networking_and_traffic.html#adding-load-balancing-rules-on-a-vpc" title="Permalink to this headline">¶</a></h2>
<p>In a VPC, you can configure two types of load balancing: external LB and
internal LB. External LB is nothing but a LB rule created to redirect
the traffic received at a public IP of the VPC virtual router. The
traffic is load balanced within a tier based on your configuration.
Citrix NetScaler and VPC virtual router are supported for external LB.
When you use internal LB service, traffic received at a tier is load
balanced across different VMs within that tier. For example, traffic
reached at Web tier is redirected to another VM in that tier. External
load balancing devices are not supported for internal LB. The service is
provided by a internal LB VM configured on the target tier.</p>
<div class="section" id="load-balancing-within-a-tier-external-lb">
<h3>负载均衡 Within a Tier (External LB)<a class="headerlink" href="networking_and_traffic.html#load-balancing-within-a-tier-external-lb" title="Permalink to this headline">¶</a></h3>
<p>A CloudStack user or administrator may create load balancing rules that
balance traffic received at a public IP to one or more VMs that belong
to a network tier that provides load balancing service in a VPC. A user
creates a rule, specifies an algorithm, and assigns the rule to a set of
VMs within a tier.</p>
<div class="section" id="enabling-netscaler-as-the-lb-provider-on-a-vpc-tier">
<h4>Enabling NetScaler as the LB Provider on a VPC Tier<a class="headerlink" href="networking_and_traffic.html#enabling-netscaler-as-the-lb-provider-on-a-vpc-tier" title="Permalink to this headline">¶</a></h4>
<ol class="arabic">
<li><p class="first">Add and enable Netscaler VPX in dedicated mode.</p>
<p>Netscaler can be used in a VPC environment only if it is in dedicated
mode.</p>
</li>
<li><p class="first">Create a network offering, as given in “<a class="reference internal" href="networking_and_traffic.html#create-net-offering-ext-lb"><span class="std std-ref">Creating a Network Offering for External LB</span></a>”.</p>
</li>
<li><p class="first">Create a VPC with Netscaler as the Public LB provider.</p>
<p>For more information, see <a class="reference external" href="networking_and_traffic.html#adding-a-virtual-private-cloud">“Adding a Virtual Private
Cloud”</a>.</p>
</li>
<li><p class="first">For the VPC, acquire an IP.</p>
</li>
<li><p class="first">Create an external load balancing rule and apply, as given in
<a class="reference internal" href="networking_and_traffic.html#create-ext-lb-rule"><span class="std std-ref">Creating an External LB Rule</span></a>.</p>
</li>
</ol>
</div>
<div class="section" id="creating-a-network-offering-for-external-lb">
<span id="create-net-offering-ext-lb"></span><h4>Creating a Network Offering for External LB<a class="headerlink" href="networking_and_traffic.html#creating-a-network-offering-for-external-lb" title="Permalink to this headline">¶</a></h4>
<p>To have external LB support on VPC, create a network offering as
follows:</p>
<ol class="arabic simple">
<li>Log in to the CloudStack UI as a user or admin.</li>
<li>From the Select Offering drop-down, choose Network Offering.</li>
<li>Click Add Network Offering.</li>
<li>In the dialog, make the following choices:<ul>
<li><strong>Name</strong>: Any desired name for the network offering.</li>
<li><strong>Description</strong>: A short description of the offering that can be
displayed to users.</li>
<li><strong>Network Rate</strong>: Allowed data transfer rate in MB per second.</li>
<li><strong>Traffic Type</strong>: The type of network traffic that will be carried
on the network.</li>
<li><strong>Guest Type</strong>: Choose whether the guest network is isolated or
shared.</li>
<li><strong>Persistent</strong>: Indicate whether the guest network is persistent
or not. The network that you can provision without having to
deploy a VM on it is termed persistent network.</li>
<li><strong>VPC</strong>: This option indicate whether the guest network is Virtual
Private Cloud-enabled. A Virtual Private Cloud (VPC) is a private,
isolated part of CloudStack. A VPC can have its own virtual
network topology that resembles a traditional physical network.
For more information on VPCs, see :ref: <cite>about-vpc</cite>.</li>
<li><strong>Specify VLAN</strong>: (Isolated guest networks only) Indicate whether
a VLAN should be specified when this offering is used.</li>
<li><strong>Supported Services</strong>: Select Load Balancer. Use Netscaler or
VpcVirtualRouter.</li>
<li><strong>Load Balancer Type</strong>: Select Public LB from the drop-down.</li>
<li><strong>LB Isolation</strong>: Select Dedicated if Netscaler is used as the
external LB provider.</li>
<li><strong>System Offering</strong>: Choose the system service offering that you
want virtual routers to use in this network.</li>
<li><strong>Conserve mode</strong>: Indicate whether to use conserve mode. In this
mode, network resources are allocated only when the first virtual
machine starts in the network.</li>
</ul>
</li>
<li>Click OK and the network offering is created.</li>
</ol>
</div>
<div class="section" id="creating-an-external-lb-rule">
<span id="create-ext-lb-rule"></span><h4>Creating an External LB Rule<a class="headerlink" href="networking_and_traffic.html#creating-an-external-lb-rule" title="Permalink to this headline">¶</a></h4>
<ol class="arabic">
<li><p class="first">Log in to the CloudStack UI as an administrator or end user.</p>
</li>
<li><p class="first">In the left navigation, choose Network.</p>
</li>
<li><p class="first">In the Select view, select VPC.</p>
<p>All the VPCs that you have created for the account is listed in the
page.</p>
</li>
<li><p class="first">Click the Configure button of the VPC, for which you want to
configure load balancing rules.</p>
<p>The VPC page is displayed where all the tiers you created listed in a
diagram.</p>
<p>For each tier, the following options are displayed:</p>
<ul class="simple">
<li>Internal LB</li>
<li>Public LB IP</li>
<li>Static NAT</li>
<li>Virtual Machines</li>
<li>CIDR</li>
</ul>
<p>The following router information is displayed:</p>
<ul class="simple">
<li>Private Gateways</li>
<li>Public IP Addresses</li>
<li>Site-to-Site VPNs</li>
<li>Network ACL Lists</li>
</ul>
</li>
<li><p class="first">In the Router node, select Public IP Addresses.</p>
<p>The IP Addresses page is displayed.</p>
</li>
<li><p class="first">Click the IP address for which you want to create the rule, then
click the Configuration tab.</p>
</li>
<li><p class="first">In the 负载均衡 node of the diagram, click View All.</p>
</li>
<li><p class="first">Select the tier to which you want to apply the rule.</p>
</li>
<li><p class="first">Specify the following:</p>
<ul class="simple">
<li><strong>Name</strong>: A name for the load balancer rule.</li>
<li><strong>Public Port</strong>: The port that receives the incoming traffic to be
balanced.</li>
<li><strong>Private Port</strong>: The port that the VMs will use to receive the
traffic.</li>
<li><strong>Algorithm</strong>. Choose the load balancing algorithm you want
CloudStack to use. CloudStack supports the following well-known
algorithms:<ul>
<li>Round-robin</li>
<li>Least connections</li>
<li>Source</li>
</ul>
</li>
<li><strong>Stickiness</strong>. (Optional) Click Configure and choose the
algorithm for the stickiness policy. See Sticky Session Policies
for Load Balancer Rules.</li>
<li><strong>Add VMs</strong>: Click Add VMs, then select two or more VMs that will
divide the load of incoming traffic, and click Apply.</li>
</ul>
</li>
</ol>
<p>The new load balancing rule appears in the list. You can repeat these
steps to add more load balancing rules for this IP address.</p>
</div>
</div>
<div class="section" id="load-balancing-across-tiers">
<h3>负载均衡 Across Tiers<a class="headerlink" href="networking_and_traffic.html#load-balancing-across-tiers" title="Permalink to this headline">¶</a></h3>
<p>CloudStack supports sharing workload across different tiers within your
VPC. Assume that multiple tiers are set up in your environment, such as
Web tier and Application tier. Traffic to each tier is balanced on the
VPC virtual router on the public side, as explained in
<a class="reference external" href="networking_and_traffic.html#adding-load-balancing-rules-on-a-vpc">“Adding 负载均衡 Rules on a VPC”</a>.
If you want the traffic coming
from the Web tier to the Application tier to be balanced, use the
internal load balancing feature offered by CloudStack.</p>
<div class="section" id="how-does-internal-lb-work-in-vpc">
<h4>How Does Internal LB Work in VPC?<a class="headerlink" href="networking_and_traffic.html#how-does-internal-lb-work-in-vpc" title="Permalink to this headline">¶</a></h4>
<p>In this figure, a public LB rule is created for the public IP
72.52.125.10 with public port 80 and private port 81. The LB rule,
created on the VPC virtual router, is applied on the traffic coming from
the Internet to the VMs on the Web tier. On the Application tier two
internal load balancing rules are created. An internal LB rule for the
guest IP 10.10.10.4 with load balancer port 23 and instance port 25 is
configured on the VM, InternalLBVM1. Another internal LB rule for the
guest IP 10.10.10.4 with load balancer port 45 and instance port 46 is
configured on the VM, InternalLBVM1. Another internal LB rule for the
guest IP 10.10.10.6, with load balancer port 23 and instance port 25 is
configured on the VM, InternalLBVM2.</p>
<p><img alt="Configuring internal LB for VPC" src="../_images/vpc-lb.png" /></p>
</div>
<div class="section" id="id20">
<h4>Guidelines<a class="headerlink" href="networking_and_traffic.html#id20" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li>Internal LB and Public LB are mutually exclusive on a tier. If the
tier has LB on the public side, then it can’t have the Internal LB.</li>
<li>Internal LB is supported just on VPC networks in CloudStack 4.2
release.</li>
<li>Only Internal LB VM can act as the Internal LB provider in CloudStack
4.2 release.</li>
<li>Network upgrade is not supported from the network offering with
Internal LB to the network offering with Public LB.</li>
<li>Multiple tiers can have internal LB support in a VPC.</li>
<li>Only one tier can have Public LB support in a VPC.</li>
</ul>
</div>
<div class="section" id="enabling-internal-lb-on-a-vpc-tier">
<h4>Enabling Internal LB on a VPC Tier<a class="headerlink" href="networking_and_traffic.html#enabling-internal-lb-on-a-vpc-tier" title="Permalink to this headline">¶</a></h4>
<ol class="arabic simple">
<li>Create a network offering, as given in
<a class="reference internal" href="networking_and_traffic.html#creating-net-offering-internal-lb"><span class="std std-ref">Creating a Network Offering for Internal LB</span></a>.</li>
<li>Create an internal load balancing rule and apply, as given in
<a class="reference internal" href="networking_and_traffic.html#create-int-lb-rule"><span class="std std-ref">Creating an Internal LB Rule</span></a>.</li>
</ol>
</div>
<div class="section" id="creating-a-network-offering-for-internal-lb">
<span id="creating-net-offering-internal-lb"></span><h4>Creating a Network Offering for Internal LB<a class="headerlink" href="networking_and_traffic.html#creating-a-network-offering-for-internal-lb" title="Permalink to this headline">¶</a></h4>
<p>To have internal LB support on VPC, either use the default offering,
DefaultIsolatedNetworkOfferingForVpcNetworksWithInternalLB, or create a
network offering as follows:</p>
<ol class="arabic simple">
<li>Log in to the CloudStack UI as a user or admin.</li>
<li>From the Select Offering drop-down, choose Network Offering.</li>
<li>Click Add Network Offering.</li>
<li>In the dialog, make the following choices:<ul>
<li><strong>Name</strong>: Any desired name for the network offering.</li>
<li><strong>Description</strong>: A short description of the offering that can be
displayed to users.</li>
<li><strong>Network Rate</strong>: Allowed data transfer rate in MB per second.</li>
<li><strong>Traffic Type</strong>: The type of network traffic that will be carried
on the network.</li>
<li><strong>Guest Type</strong>: Choose whether the guest network is isolated or
shared.</li>
<li><strong>Persistent</strong>: Indicate whether the guest network is persistent
or not. The network that you can provision without having to
deploy a VM on it is termed persistent network.</li>
<li><strong>VPC</strong>: This option indicate whether the guest network is Virtual
Private Cloud-enabled. A Virtual Private Cloud (VPC) is a private,
isolated part of CloudStack. A VPC can have its own virtual
network topology that resembles a traditional physical network.
For more information on VPCs, see <a class="reference external" href="networking_and_traffic.html#about-virtual-private-clouds">“About Virtual
Private Clouds”</a>.</li>
<li><strong>Specify VLAN</strong>: (Isolated guest networks only) Indicate whether
a VLAN should be specified when this offering is used.</li>
<li><strong>Supported Services</strong>: Select Load Balancer. Select
<code class="docutils literal notranslate"><span class="pre">InternalLbVM</span></code> from the provider list.</li>
<li><strong>Load Balancer Type</strong>: Select Internal LB from the drop-down.</li>
<li><strong>System Offering</strong>: Choose the system service offering that you
want virtual routers to use in this network.</li>
<li><strong>Conserve mode</strong>: Indicate whether to use conserve mode. In this
mode, network resources are allocated only when the first virtual
machine starts in the network.</li>
</ul>
</li>
<li>Click OK and the network offering is created.</li>
</ol>
</div>
<div class="section" id="creating-an-internal-lb-rule">
<span id="create-int-lb-rule"></span><h4>Creating an Internal LB Rule<a class="headerlink" href="networking_and_traffic.html#creating-an-internal-lb-rule" title="Permalink to this headline">¶</a></h4>
<p>When you create the Internal LB rule and applies to a VM, an Internal LB
VM, which is responsible for load balancing, is created.</p>
<p>You can view the created Internal LB VM in the Instances page if you
navigate to <strong>Infrastructure</strong> &gt; <strong>Zones</strong> &gt; &lt;zone_ name&gt; &gt;
&lt;physical_network_name&gt; &gt; <strong>Network Service Providers</strong> &gt; <strong>Internal
LB VM</strong>. You can manage the Internal LB VMs as and when required from
the location.</p>
<ol class="arabic">
<li><p class="first">Log in to the CloudStack UI as an administrator or end user.</p>
</li>
<li><p class="first">In the left navigation, choose Network.</p>
</li>
<li><p class="first">In the Select view, select VPC.</p>
<p>All the VPCs that you have created for the account is listed in the
page.</p>
</li>
<li><p class="first">Locate the VPC for which you want to configure internal LB, then
click Configure.</p>
<p>The VPC page is displayed where all the tiers you created listed in a
diagram.</p>
</li>
<li><p class="first">Locate the Tier for which you want to configure an internal LB rule,
click Internal LB.</p>
<p>In the Internal LB page, click Add Internal LB.</p>
</li>
<li><p class="first">In the dialog, specify the following:</p>
<ul>
<li><p class="first"><strong>Name</strong>: A name for the load balancer rule.</p>
</li>
<li><p class="first"><strong>Description</strong>: A short description of the rule that can be
displayed to users.</p>
</li>
<li><p class="first"><strong>Source IP Address</strong>: (Optional) The source IP from which traffic
originates. The IP is acquired from the CIDR of that particular
tier on which you want to create the Internal LB rule. If not
specified, the IP address is automatically allocated from the
network CIDR.</p>
<p>For every Source IP, a new Internal LB VM is created for load
balancing.</p>
</li>
<li><p class="first"><strong>Source Port</strong>: The port associated with the source IP. Traffic
on this port is load balanced.</p>
</li>
<li><p class="first"><strong>Instance Port</strong>: The port of the internal LB VM.</p>
</li>
<li><p class="first"><strong>Algorithm</strong>. Choose the load balancing algorithm you want
CloudStack to use. CloudStack supports the following well-known
algorithms:</p>
<ul class="simple">
<li>Round-robin</li>
<li>Least connections</li>
<li>Source</li>
</ul>
</li>
</ul>
</li>
</ol>
</div>
</div>
</div>
<div class="section" id="adding-a-port-forwarding-rule-on-a-vpc">
<h2>Adding a Port Forwarding Rule on a VPC<a class="headerlink" href="networking_and_traffic.html#adding-a-port-forwarding-rule-on-a-vpc" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p class="first">Log in to the CloudStack UI as an administrator or end user.</p>
</li>
<li><p class="first">In the left navigation, choose Network.</p>
</li>
<li><p class="first">In the Select view, select VPC.</p>
<p>All the VPCs that you have created for the account is listed in the
page.</p>
</li>
<li><p class="first">Click the Configure button of the VPC to which you want to deploy the
VMs.</p>
<p>The VPC page is displayed where all the tiers you created are listed
in a diagram.</p>
<p>For each tier, the following options are displayed:</p>
<ul class="simple">
<li>Internal LB</li>
<li>Public LB IP</li>
<li>Static NAT</li>
<li>Virtual Machines</li>
<li>CIDR</li>
</ul>
<p>The following router information is displayed:</p>
<ul class="simple">
<li>Private Gateways</li>
<li>Public IP Addresses</li>
<li>Site-to-Site VPNs</li>
<li>Network ACL Lists</li>
</ul>
</li>
<li><p class="first">In the Router node, select Public IP Addresses.</p>
<p>The IP Addresses page is displayed.</p>
</li>
<li><p class="first">Click the IP address for which you want to create the rule, then
click the Configuration tab.</p>
</li>
<li><p class="first">In the Port Forwarding node of the diagram, click View All.</p>
</li>
<li><p class="first">Select the tier to which you want to apply the rule.</p>
</li>
<li><p class="first">Specify the following:</p>
<ul>
<li><p class="first"><strong>Public Port</strong>: The port to which public traffic will be
addressed on the IP address you acquired in the previous step.</p>
</li>
<li><p class="first"><strong>Private Port</strong>: The port on which the instance is listening for
forwarded public traffic.</p>
</li>
<li><p class="first"><strong>Protocol</strong>: The communication protocol in use between the two
ports.</p>
<ul class="simple">
<li>TCP</li>
<li>UDP</li>
</ul>
</li>
<li><p class="first"><strong>Add VM</strong>: Click Add VM. Select the name of the instance to which
this rule applies, and click Apply.</p>
<p>You can test the rule by opening an SSH session to the instance.</p>
</li>
</ul>
</li>
</ol>
</div>
<div class="section" id="removing-tiers">
<h2>Removing Tiers<a class="headerlink" href="networking_and_traffic.html#removing-tiers" title="Permalink to this headline">¶</a></h2>
<p>You can remove a tier from a VPC. A removed tier cannot be revoked. When
a tier is removed, only the resources of the tier are expunged. All the
network rules (port forwarding, load balancing and staticNAT) and the IP
addresses associated to the tier are removed. The IP address still be
belonging to the same VPC.</p>
<ol class="arabic">
<li><p class="first">Log in to the CloudStack UI as an administrator or end user.</p>
</li>
<li><p class="first">In the left navigation, choose Network.</p>
</li>
<li><p class="first">In the Select view, select VPC.</p>
<p>All the VPC that you have created for the account is listed in the
page.</p>
</li>
<li><p class="first">Click the Configure button of the VPC for which you want to set up
tiers.</p>
<p>The Configure VPC page is displayed. Locate the tier you want to work
with.</p>
</li>
<li><p class="first">Select the tier you want to remove.</p>
</li>
<li><p class="first">In the Network Details tab, click the Delete Network button.
<img alt="button to remove a tier" src="../_images/del-tier.png" /></p>
<p>Click Yes to confirm. Wait for some time for the tier to be removed.</p>
</li>
</ol>
</div>
<div class="section" id="editing-restarting-and-removing-a-virtual-private-cloud">
<h2>Editing, Restarting, and Removing a Virtual Private Cloud<a class="headerlink" href="networking_and_traffic.html#editing-restarting-and-removing-a-virtual-private-cloud" title="Permalink to this headline">¶</a></h2>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Ensure that all the tiers are removed before you remove a VPC.</p>
</div>
<ol class="arabic">
<li><p class="first">Log in to the CloudStack UI as an administrator or end user.</p>
</li>
<li><p class="first">In the left navigation, choose Network.</p>
</li>
<li><p class="first">In the Select view, select VPC.</p>
<p>All the VPCs that you have created for the account is listed in the
page.</p>
</li>
<li><p class="first">Select the VPC you want to work with.</p>
</li>
<li><p class="first">In the Details tab, click the Remove VPC button <img alt="button to remove a VPC" src="../_images/remove-vpc.png" /></p>
<p>You can remove the VPC by also using the remove button in the Quick
View.</p>
<p>You can edit the name and description of a VPC. To do that, select
the VPC, then click the Edit button. <img alt="button to edit." src="../_images/edit-icon.png" /></p>
<p>To restart a VPC, select the VPC, then click the Restart button.
<img alt="button to restart a VPC" src="../_images/restart-vpc.png" /></p>
</li>
</ol>
</div>
</div>
<div class="section" id="persistent-networks">
<h1>Persistent Networks<a class="headerlink" href="networking_and_traffic.html#persistent-networks" title="Permalink to this headline">¶</a></h1>
<p>The network that you can provision without having to deploy any VMs on
it is called a persistent network. A persistent network can be part of a
VPC or a non-VPC environment.</p>
<p>When you create other types of network, a network is only a database
entry until the first VM is created on that network. When the first VM
is created, a VLAN ID is assigned and the network is provisioned. Also,
when the last VM is destroyed, the VLAN ID is released and the network
is no longer available. With the addition of persistent network, you
will have the ability to create a network in CloudStack in which
physical devices can be deployed without having to run any VMs.
Additionally, you can deploy physical devices on that network.</p>
<p>One of the advantages of having a persistent network is that you can
create a VPC with a tier consisting of only physical devices. For
example, you might create a VPC for a three-tier application, deploy VMs
for Web and Application tier, and use physical machines for the Database
tier. Another use case is that if you are providing services by using
physical hardware, you can define the network as persistent and
therefore even if all its VMs are destroyed the services will not be
discontinued.</p>
<div class="section" id="persistent-network-considerations">
<h2>Persistent Network Considerations<a class="headerlink" href="networking_and_traffic.html#persistent-network-considerations" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>Persistent network is designed for isolated networks.</li>
<li>All default network offerings are non-persistent.</li>
<li>A network offering cannot be editable because changing it affects the
behavior of the existing networks that were created using this
network offering.</li>
<li>When you create a guest network, the network offering that you select
defines the network persistence. This in turn depends on whether
persistent network is enabled in the selected network offering.</li>
<li>An existing network can be made persistent by changing its network
offering to an offering that has the Persistent option enabled. While
setting this property, even if the network has no running VMs, the
network is provisioned.</li>
<li>An existing network can be made non-persistent by changing its
network offering to an offering that has the Persistent option
disabled. If the network has no running VMs, during the next network
garbage collection run the network is shut down.</li>
<li>When the last VM on a network is destroyed, the network garbage
collector checks if the network offering associated with the network
is persistent, and shuts down the network only if it is
non-persistent.</li>
</ul>
</div>
<div class="section" id="creating-a-persistent-guest-network">
<h2>Creating a Persistent Guest Network<a class="headerlink" href="networking_and_traffic.html#creating-a-persistent-guest-network" title="Permalink to this headline">¶</a></h2>
<p>To create a persistent network, perform the following:</p>
<ol class="arabic">
<li><p class="first">Create a network offering with the Persistent option enabled.</p>
<p>See <a class="reference external" href="networking.html#creating-a-new-network-offering">“Creating a New Network Offering”</a>.</p>
</li>
<li><p class="first">Select Network from the left navigation pane.</p>
</li>
<li><p class="first">Select the guest network that you want to offer this network service
to.</p>
</li>
<li><p class="first">Click the Edit button.</p>
</li>
<li><p class="first">From the Network Offering drop-down, select the persistent network
offering you have just created.</p>
</li>
<li><p class="first">Click OK.</p>
</li>
</ol>
</div>
</div>
<div class="section" id="setup-a-palo-alto-networks-firewall">
<h1>Setup a Palo Alto Networks Firewall<a class="headerlink" href="networking_and_traffic.html#setup-a-palo-alto-networks-firewall" title="Permalink to this headline">¶</a></h1>
<div class="section" id="functionality-provided">
<h2>Functionality Provided<a class="headerlink" href="networking_and_traffic.html#functionality-provided" title="Permalink to this headline">¶</a></h2>
<p>This implementation enables the orchestration of a Palo Alto Networks Firewall
from within CloudStack UI and API.</p>
<p><strong>The following features are supported</strong>:</p>
<ul class="simple">
<li>List/Add/Delete Palo Alto Networks service provider</li>
<li>List/Add/Delete Palo Alto Networks network service offering</li>
<li>List/Add/Delete Palo Alto Networks network using the above service offering</li>
<li>Add an instance to a Palo Alto Networks network</li>
<li>Source NAT management on network create and delete</li>
<li>List/Add/Delete Ingress Firewall rule</li>
<li>List/Add/Delete Egress Firewall rule (both ‘Allow’ and ‘Deny’ default rules
supported)</li>
<li>List/Add/Delete Port Forwarding rule</li>
<li>List/Add/Delete Static NAT rule</li>
<li>Apply a Threat Profile to all firewall rules (more details in the
Additional Features section)</li>
<li>Apply a Log Forwarding profile to all firewall rules (more details in the
Additional Features section)</li>
</ul>
</div>
<div class="section" id="initial-palo-alto-networks-firewall-configuration">
<h2>Initial Palo Alto Networks Firewall Configuration<a class="headerlink" href="networking_and_traffic.html#initial-palo-alto-networks-firewall-configuration" title="Permalink to this headline">¶</a></h2>
<div class="section" id="anatomy-of-the-palo-alto-networks-firewall">
<h3>Anatomy of the Palo Alto Networks Firewall<a class="headerlink" href="networking_and_traffic.html#anatomy-of-the-palo-alto-networks-firewall" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>In <strong>‘Network &gt; Interfaces’</strong> there is a list of physical interfaces as
well as aggregated physical interfaces which are used for managing traffic
in and out of the Palo Alto Networks Firewall device.</li>
<li>In <strong>‘Network &gt; Zones’</strong> there is a list of the different configuration
zones.  This implementation will use two zones; a public (defaults to
‘untrust’) and private (defaults to ‘trust’) zone.</li>
<li>In <strong>‘Network &gt; 虚拟路由器s’</strong> there is a list of VRs which handle
traffic routing for the Palo Alto Firewall.  We only use a single Virtual
Router on the firewall and it is used to handle all the routing to the next
network hop.</li>
<li>In <strong>‘Objects &gt; 安全 Profile Groups’</strong> there is a list of profiles
which can be applied to firewall rules.  These profiles are used to better
understand the types of traffic that is flowing through your network.
Configured when you add the firewall provider to CloudStack.</li>
<li>In <strong>‘Objects &gt; Log Forwarding’</strong> there is a list of profiles which can be
applied to firewall rules.  These profiles are used to better track the
logs generated by the firewall.  Configured when you add the firewall
provider to CloudStack.</li>
<li>In <strong>‘Policies &gt; 安全’</strong> there is a list of firewall rules that are
currently configured.  You will not need to modify this section because it
will be completely automated by CloudStack, but you can review the firewall
rules which have been created here.</li>
<li>In <strong>‘Policies &gt; NAT’</strong> there is a list of the different NAT rules.  You
will not need to modify this section because it will be completely
automated by CloudStack, but you can review the different NAT rules that
have been created here.  Source NAT, Static NAT and Destination NAT (Port
Forwarding) rules will show up in this list.</li>
</ul>
</div>
<div class="section" id="configure-the-public-private-zones-on-the-firewall">
<h3>Configure the Public / Private Zones on the firewall<a class="headerlink" href="networking_and_traffic.html#configure-the-public-private-zones-on-the-firewall" title="Permalink to this headline">¶</a></h3>
<p>No manual configuration is required to setup these zones because CloudStack
will configure them automatically when you add the Palo Alto Networks firewall
device to CloudStack as a service provider.  This implementation depends on
two zones, one for the public side and one for the private side of the
firewall.</p>
<ul class="simple">
<li>The public zone (defaults to ‘untrust’) will contain all of the public
interfaces and public IPs.</li>
<li>The private zone (defaults to ‘trust’) will contain all of the private
interfaces and guest network gateways.</li>
</ul>
<p>The NAT and firewall rules will be configured between these zones.</p>
</div>
<div class="section" id="configure-the-public-private-interfaces-on-the-firewall">
<h3>Configure the Public / Private Interfaces on the firewall<a class="headerlink" href="networking_and_traffic.html#configure-the-public-private-interfaces-on-the-firewall" title="Permalink to this headline">¶</a></h3>
<p>This implementation supports standard physical interfaces as well as grouped
physical interfaces called aggregated interfaces.  Both standard interfaces
and aggregated interfaces are treated the same, so they can be used
interchangeably. For this document, we will assume that we are using
‘ethernet1/1’ as the public interface and ‘ethernet1/2’ as the private
interface.  If aggregated interfaces where used, you would use something
like ‘ae1’ and ‘ae2’ as the interfaces.</p>
<p>This implementation requires that the ‘Interface Type’ be set to ‘Layer3’ for
both the public and private interfaces.  If you want to be able to use the
‘Untagged’ VLAN tag for public traffic in CloudStack, you will need to enable
support for it in the public ‘ethernet1/1’ interface (details below).</p>
<p><strong>Steps to configure the Public Interface</strong>:</p>
<ol class="arabic simple">
<li>Log into Palo Alto Networks Firewall</li>
<li>Navigate to ‘Network &gt; Interfaces’</li>
<li>Click on ‘ethernet1/1’ (for aggregated ethernet, it will probably be called
‘ae1’)</li>
<li>Select ‘Layer3’ from the ‘Interface Type’ list</li>
<li>Click ‘Advanced’</li>
<li>Check the ‘Untagged Subinterface’ check-box</li>
<li>Click ‘OK’</li>
</ol>
<p><strong>Steps to configure the Private Interface</strong>:</p>
<ol class="arabic simple">
<li>Click on ‘ethernet1/2’ (for aggregated ethernet, it will probably be called
‘ae2’)</li>
<li>Select ‘Layer3’ from the ‘Interface Type’ list</li>
<li>Click ‘OK’</li>
</ol>
</div>
<div class="section" id="configure-a-virtual-router-on-the-firewall">
<h3>Configure a 虚拟路由器 on the firewall<a class="headerlink" href="networking_and_traffic.html#configure-a-virtual-router-on-the-firewall" title="Permalink to this headline">¶</a></h3>
<p>The 虚拟路由器 on the Palo Alto Networks Firewall is not to be confused
with the 虚拟路由器s that CloudStack provisions.  For this implementation,
the 虚拟路由器 on the Palo Alto Networks Firewall will ONLY handle the
upstream routing from the Firewall to the next hop.</p>
<p><strong>Steps to configure the 虚拟路由器</strong>:</p>
<ol class="arabic simple">
<li>Log into Palo Alto Networks Firewall</li>
<li>Navigate to ‘Network &gt; 虚拟路由器s’</li>
<li>Select the ‘default’ 虚拟路由器 or Add a new 虚拟路由器 if there
are none in the list<ul>
<li>If you added a new 虚拟路由器, you will need to give it a ‘Name’</li>
</ul>
</li>
<li>Navigate to ‘Static Routes &gt; IPv4’</li>
<li>‘Add’ a new static route<ul>
<li><strong>Name</strong>: next_hop (you can name it anything you want)</li>
<li><strong>Destination</strong>: 0.0.0.0/0 (send all traffic to this route)</li>
<li><strong>Interface</strong>: ethernet1/1 (or whatever you set your public interface
as)</li>
<li><strong>Next Hop</strong>: (specify the gateway IP for the next hop in your network)</li>
<li>Click ‘OK’</li>
</ul>
</li>
<li>Click ‘OK’</li>
</ol>
</div>
<div class="section" id="configure-the-default-public-subinterface">
<h3>Configure the default Public Subinterface<a class="headerlink" href="networking_and_traffic.html#configure-the-default-public-subinterface" title="Permalink to this headline">¶</a></h3>
<p>The current implementation of the Palo Alto Networks firewall integration uses
CIDRs in the form of ‘w.x.y.z/32’ for the public IP addresses that CloudStack
provisions.  Because no broadcast or gateway IPs are in this single IP range,
there is no way for the firewall to route the traffic for these IPs.  To route
the traffic for these IPs, we create a single subinterface on the public
interface with an IP and a CIDR which encapsulates the CloudStack public IP
range.  This IP will need to be inside the subnet defined by the CloudStack
public range netmask, but outside the CloudStack public IP range.  The CIDR
should reflect the same subnet defined by the CloudStack public range netmask.
The name of the subinterface is determined by the VLAN configured for the
public range in CloudStack.</p>
<p>To clarify this concept, we will use the following example.</p>
<p><strong>Example CloudStack Public Range Configuration</strong>:</p>
<ul class="simple">
<li><strong>Gateway</strong>: 172.30.0.1</li>
<li><strong>Netmask</strong>: 255.255.255.0</li>
<li><strong>IP Range</strong>: 172.30.0.100 - 172.30.0.199</li>
<li><strong>VLAN</strong>: Untagged</li>
</ul>
<p><strong>Configure the Public Subinterface</strong>:</p>
<ol class="arabic simple">
<li>Log into Palo Alto Networks Firewall</li>
<li>Navigate to ‘Network &gt; Interfaces’</li>
<li>Select the ‘ethernet1/1’ line (not clicking on the name)</li>
<li>Click ‘Add Subinterface’ at the bottom of the window</li>
<li>Enter ‘Interface Name’: ‘ethernet1/1’ . ‘9999’<ul>
<li>9999 is used if the CloudStack public range VLAN is ‘Untagged’</li>
<li>If the CloudStack public range VLAN is tagged (eg: 333), then the name
will reflect that tag</li>
</ul>
</li>
<li>The ‘Tag’ is the VLAN tag that the traffic is sent to the next hop with, so
set it accordingly.  If you are passing ‘Untagged’ traffic from CloudStack
to your next hop, leave it blank.  If you want to pass tagged traffic from
CloudStack, specify the tag.</li>
<li>Select ‘default’ from the ‘Config &gt; 虚拟路由器’ drop-down (assuming
that is what your virtual router is called)</li>
<li>Click the ‘IPv4’ tab</li>
<li>Select ‘Static’ from the ‘Type’ radio options</li>
<li>Click ‘Add’ in the ‘IP’ section</li>
<li>Enter ‘172.30.0.254/24’ in the new line<ul>
<li>The IP can be any IP outside the CloudStack public IP range, but inside
the CloudStack public range netmask (it can NOT be the gateway IP)</li>
<li>The subnet defined by the CIDR should match the CloudStack public range
netmask</li>
</ul>
</li>
<li>Click ‘OK’</li>
</ol>
</div>
<div class="section" id="commit-configuration-on-the-palo-alto-networks-firewall">
<h3>Commit configuration on the Palo Alto Networks Firewall<a class="headerlink" href="networking_and_traffic.html#commit-configuration-on-the-palo-alto-networks-firewall" title="Permalink to this headline">¶</a></h3>
<p>In order for all the changes we just made to take effect, we need to commit
the changes.</p>
<ol class="arabic simple">
<li>Click the ‘Commit’ link in the top right corner of the window</li>
<li>Click ‘OK’ in the commit window overlay</li>
<li>Click ‘Close’ to the resulting commit status window after the commit
finishes</li>
</ol>
</div>
</div>
<div class="section" id="setup-the-palo-alto-networks-firewall-in-cloudstack">
<h2>Setup the Palo Alto Networks Firewall in CloudStack<a class="headerlink" href="networking_and_traffic.html#setup-the-palo-alto-networks-firewall-in-cloudstack" title="Permalink to this headline">¶</a></h2>
<div class="section" id="add-the-palo-alto-networks-firewall-as-a-service-provider">
<h3>Add the Palo Alto Networks Firewall as a Service Provider<a class="headerlink" href="networking_and_traffic.html#add-the-palo-alto-networks-firewall-as-a-service-provider" title="Permalink to this headline">¶</a></h3>
<ol class="arabic simple">
<li>Navigate to ‘Infrastructure &gt; Zones &gt; ZONE_NAME &gt; Physical Network &gt;
NETWORK_NAME (guest) &gt; Configure; Network Service Providers’</li>
<li>Click on ‘Palo Alto’ in the list</li>
<li>Click ‘View Devices’</li>
<li>Click ‘Add Palo Alto Device’</li>
<li>Enter your configuration in the overlay.  This example will reflect the
details previously used in this guide.<ul>
<li><strong>IP Address</strong>: (the IP of the Palo Alto Networks Firewall)</li>
<li><strong>Username</strong>: (the admin username for the firewall)</li>
<li><strong>Password</strong>: (the admin password for the firewall)</li>
<li><strong>Type</strong>: Palo Alto Firewall</li>
<li><strong>Public Interface</strong>: ethernet1/1 (use what you setup earlier as the
public interface if it is different from my examples)</li>
<li><strong>Private Interface</strong>: ethernet1/2 (use what you setup earlier as the
private interface if it is different from my examples)</li>
<li><strong>Number of Retries</strong>: 2 (the default is fine)</li>
<li><strong>Timeout</strong>: 300 (the default is fine)</li>
<li><strong>Public Network</strong>: untrust (this is the public zone on the firewall and
did not need to be configured)</li>
<li><strong>Private Network</strong>: trust (this is the private zone on the firewall and
did not need to be configured)</li>
<li><strong>虚拟路由器</strong>: default (this is the name of the 虚拟路由器 we
setup on the firewall)</li>
<li><strong>Palo Alto Threat Profile</strong>: (not required.  name of the ‘安全
Profile Groups’ to apply.  more details in the ‘Additional Features’
section)</li>
<li><strong>Palo Alto Log Profile</strong>: (not required.  name of the ‘Log Forwarding’
profile to apply.  more details in the ‘Additional Features’ section)</li>
<li><strong>Capacity</strong>: (not required)</li>
<li><strong>Dedicated</strong>: (not required)</li>
</ul>
</li>
<li>Click ‘OK’</li>
<li>Click on ‘Palo Alto’ in the breadcrumbs to go back one screen.</li>
<li>Click on ‘Enable Provider’ <img alt="button to enable or disable feature." src="../_images/enable-disable-autoscale.png" /></li>
</ol>
</div>
<div class="section" id="add-a-network-service-offering-to-use-the-new-provider">
<h3>Add a Network Service Offering to use the new Provider<a class="headerlink" href="networking_and_traffic.html#add-a-network-service-offering-to-use-the-new-provider" title="Permalink to this headline">¶</a></h3>
<p>There are 6 ‘Supported Services’ that need to be configured in the network
service offering for this functionality.  They are DHCP, DNS, Firewall, Source
NAT, Static NAT and Port Forwarding.  For the other settings, there are
probably additional configurations which will work, but I will just document a
common case.</p>
<ol class="arabic simple">
<li>Navigate to ‘计算方案’</li>
<li>In the drop-down at the top, select ‘Network Offerings’</li>
<li>Click ‘Add Network Offering’<ul>
<li><strong>Name</strong>: (name it whatever you want)</li>
<li><strong>Description</strong>: (again, can be whatever you want)</li>
<li><strong>Guest Type</strong>: Isolated</li>
<li><strong>Supported Services</strong>:<ul>
<li><strong>DHCP</strong>: Provided by ‘VirtualRouter’</li>
<li><strong>DNS</strong>: Provided by ‘VirtualRouter’</li>
<li><strong>Firewall</strong>: Provided by ‘PaloAlto’</li>
<li><strong>Source NAT</strong>: Provided by ‘PaloAlto’</li>
<li><strong>Static NAT</strong>: Provided by ‘PaloAlto’</li>
<li><strong>Port Forwarding</strong>: Provided by ‘PaloAlto’</li>
</ul>
</li>
<li><strong>System Offering for Router</strong>: System Offering For Software Router</li>
<li><strong>Supported Source NAT Type</strong>: Per account (this is the only supported
option)</li>
<li><strong>Default egress policy</strong>: (both ‘Allow’ and ‘Deny’ are supported)</li>
</ul>
</li>
<li>Click ‘OK’</li>
<li>Click on the newly created service offering</li>
<li>Click ‘Enable network offering’ <img alt="button to enable or disable feature." src="../_images/enable-disable-autoscale.png" /></li>
</ol>
<p>When adding networks in CloudStack, select this network offering to use the
Palo Alto Networks firewall.</p>
</div>
</div>
<div class="section" id="additional-features">
<h2>Additional Features<a class="headerlink" href="networking_and_traffic.html#additional-features" title="Permalink to this headline">¶</a></h2>
<p>In addition to the standard functionality exposed by CloudStack, we have added
a couple additional features to this implementation.  We did not add any new
screens to CloudStack, but we have added a couple fields to the ‘Add Palo Alto
Service Provider’ screen which will add functionality globally for the device.</p>
<div class="section" id="palo-alto-networks-threat-profile">
<h3>Palo Alto Networks Threat Profile<a class="headerlink" href="networking_and_traffic.html#palo-alto-networks-threat-profile" title="Permalink to this headline">¶</a></h3>
<p>This feature allows you to specify a ‘安全 Profile Group’ to be applied to
all of the firewall rules which are created on the Palo Alto Networks firewall
device.</p>
<p>To create a ‘安全 Profile Group’ on the Palo Alto Networks firewall, do
the following:</p>
<ol class="arabic simple">
<li>Log into the Palo Alto Networks firewall</li>
<li>Navigate to ‘Objects &gt; 安全 Profile Groups’</li>
<li>Click ‘Add’ at the bottom of the page to add a new group</li>
<li>Give the group a Name and specify the profiles you would like to include in
the group</li>
<li>Click ‘OK’</li>
<li>Click the ‘Commit’ link in the top right of the screen and follow the on
screen instructions</li>
</ol>
<p>Once you have created a profile, you can reference it by Name in the ‘Palo
Alto Threat Profile’ field in the ‘Add the Palo Alto Networks Firewall as a
Service Provider’ step.</p>
</div>
<div class="section" id="palo-alto-networks-log-forwarding-profile">
<h3>Palo Alto Networks Log Forwarding Profile<a class="headerlink" href="networking_and_traffic.html#palo-alto-networks-log-forwarding-profile" title="Permalink to this headline">¶</a></h3>
<p>This feature allows you to specify a ‘Log Forwarding’ profile to better manage
where the firewall logs are sent to.  This is helpful for keeping track of
issues that can arise on the firewall.</p>
<p>To create a ‘Log Forwarding’ profile on the Palo Alto Networks Firewall, do
the following:</p>
<ol class="arabic simple">
<li>Log into the Palo Alto Networks firewall</li>
<li>Navigate to ‘Objects &gt; Log Forwarding’</li>
<li>Click ‘Add’ at the bottom of the page to add a new profile</li>
<li>Give the profile a Name and specify the details you want for the traffic
and threat settings</li>
<li>Click ‘OK’</li>
<li>Click the ‘Commit’ link in the top right of the screen and follow the on
screen instructions</li>
</ol>
<p>Once you have created a profile, you can reference it by Name in the ‘Palo
Alto Log Profile’ field in the ‘Add the Palo Alto Networks Firewall as a
Service Provider’ step.</p>
</div>
</div>
<div class="section" id="id23">
<h2>Limitations<a class="headerlink" href="networking_and_traffic.html#id23" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li>The implementation currently only supports a single public IP range in
CloudStack</li>
<li>Usage tracking is not yet implemented</li>
</ul>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="networking/using_remote_access.html" class="btn btn-neutral float-right" title="Using Remote Access VPN" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="usage.html" class="btn btn-neutral float-left" title="Working with Usage" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Apache Foundation
      
        <span class="commit">
          Revision <code>7c5c9b49</code>.
        </span>
      

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="fa fa-book"> Read the Docs</span>
      v: 4.11.3.0
      <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
      <dl>
        <dt>Versions</dt>
        
          <dd><a href="../../../index.html">latest</a></dd>
        
          <dd><a href="../../4.12.0.0/index.html">4.12.0.0</a></dd>
        
          <dd><a href="../index.html">4.11.3.0</a></dd>
        
          <dd><a href="../../4.11.2.0/index.html">4.11.2.0</a></dd>
        
          <dd><a href="../../4.11.1.0/index.html">4.11.1.0</a></dd>
        
          <dd><a href="http://docs.cloudstack.apache.org/en/master/">master</a></dd>
        
      </dl>
      <dl>
        <dt>Downloads</dt>
        
      </dl>
      <dl>
        <dt>On Read the Docs</dt>
          <dd>
            <a href="http://readthedocs.org/projects/cloudstack-documentation/?fromdocs=cloudstack-documentation">Project Home</a>
          </dd>
          <dd>
            <a href="http://readthedocs.org/builds/cloudstack-documentation/?fromdocs=cloudstack-documentation">Builds</a>
          </dd>
      </dl>
      <hr/>
      Free document hosting provided by <a href="http://www.readthedocs.org">Read the Docs</a>.

    </div>
  </div>



  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
   

</body>
</html>