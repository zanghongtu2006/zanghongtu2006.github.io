

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Allocators &mdash; Apache CloudStack 4.11.3.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
        <script type="text/javascript" src="https://assets.readthedocs.org/static/javascript/readthedocs-doc-embed.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Deploying CloudStack with Ansible" href="ansible.html" />
    <link rel="prev" title="Plugins" href="plugins.html" /> 

<!-- RTD Extra Head -->

<!-- 
Always link to the latest version, as canonical.
http://docs.readthedocs.org/en/latest/canonical.html
-->
<link rel="canonical" href="../../latest/developersguide/alloc.html" />

<link rel="stylesheet" href="https://assets.readthedocs.org/static/css/readthedocs-doc-embed.css" type="text/css" />

<script type="text/javascript" src="../_static/readthedocs-data.js"></script>

<!-- Add page-specific data, which must exist in the page js, not global -->
<script type="text/javascript">
READTHEDOCS_DATA['page'] = "developersguide/alloc"
READTHEDOCS_DATA['source_suffix'] = ".rst"
</script>

<script type="text/javascript" src="https://assets.readthedocs.org/static/javascript/readthedocs-analytics.js"></script>

<!-- end RTD <extrahead> -->
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> Apache CloudStack
          

          
          </a>

          
            
            
            
              <div class="version">
                4.11.3.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../conceptsandterminology/index.html">CloudStack Concepts and Terminology</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickinstallationguide/qig.html">Quick Installation Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installguide/index.html">Installation Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../upgrading/index.html">Upgrading CloudStack</a></li>
<li class="toctree-l1"><a class="reference internal" href="../adminguide/index.html">Usage Guide</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Developers Guide</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="developer_guide.html">CloudStack Installation from GIT repo for Developers</a></li>
<li class="toctree-l2"><a class="reference internal" href="dev.html">Programmer Guide</a></li>
<li class="toctree-l2"><a class="reference internal" href="plugins.html">Plugins</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="alloc.html#">Allocators</a><ul>
<li class="toctree-l3"><a class="reference internal" href="alloc.html#implementing-a-custom-hostallocator">Implementing a custom HostAllocator</a><ul>
<li class="toctree-l4"><a class="reference internal" href="alloc.html#hostallocator-interface">HostAllocator Interface</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="alloc.html#implementing-a-custom-storagepoolallocator">Implementing a custom StoragePoolAllocator</a><ul>
<li class="toctree-l4"><a class="reference internal" href="alloc.html#storagepoolallocator-interface">StoragePoolAllocator Interface</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="ansible.html">Deploying CloudStack with Ansible</a></li>
<li class="toctree-l2"><a class="reference internal" href="get_help.html">Getting Help</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../plugins/index.html">Plugins Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">Release Notes</a></li>
</ul>
<p class="caption"><span class="caption-text">Other Documentation:</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="http://cloudstack.apache.org/api.html">API Documentation</a></li>
<li class="toctree-l1"><a class="reference external" href="https://cwiki.apache.org/confluence/display/CLOUDSTACK/Home">Apache CloudStack Wiki</a></li>
<li class="toctree-l1"><a class="reference external" href="http://cloudstack.apache.org/">Apache CloudStack web site</a></li>
<li class="toctree-l1"><a class="reference external" href="http://cloudstack.apache.org/downloads.html">Apache CloudStack Source Code</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/apache/cloudstack">Apache CloudStack on GitHub</a></li>
</ul>
<p class="caption"><span class="caption-text">Pre 4.11 Documentation:</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="../../../projects/cloudstack-installation.html">Installation Guide</a></li>
<li class="toctree-l1"><a class="reference external" href="../../../projects/cloudstack-administration.html">Administration Guide</a></li>
<li class="toctree-l1"><a class="reference external" href="../../../projects/cloudstack-release-notes.html">Release Notes</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Apache CloudStack</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">Developers Guide</a> &raquo;</li>
        
      <li>Allocators</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            
              <a href="https://github.com/apache/cloudstack-documentation/blob/4.11.3.0/source/developersguide/alloc.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="allocators">
<h1>Allocators<a class="headerlink" href="alloc.html#allocators" title="Permalink to this headline">¶</a></h1>
<p>CloudStack enables administrators to write custom allocators that will
choose the Host to place a new guest and the storage host from which to
allocate guest virtual disk images.</p>
<p>These are following categories of allocators currently supported:</p>
<ul class="simple">
<li>HostAllocators - Allows you to create custom rules to determine which
physical host to allocate the guest virtual machines on.</li>
<li>StoragePoolAllocators - Allows you to create custom rules to
determine which storage pool to allocate the guest virtual machines
on.</li>
</ul>
<div class="section" id="implementing-a-custom-hostallocator">
<h2>Implementing a custom HostAllocator<a class="headerlink" href="alloc.html#implementing-a-custom-hostallocator" title="Permalink to this headline">¶</a></h2>
<p>HostAllocators are written by extending
com.cloud.agent.manager.allocator.HostAllocator interface.</p>
<div class="section" id="hostallocator-interface">
<h3>HostAllocator Interface<a class="headerlink" href="alloc.html#hostallocator-interface" title="Permalink to this headline">¶</a></h3>
<p>The interface defines the following two methods.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>/**
  * Checks if the VM can be upgraded to the specified ServiceOffering
  * @param UserVm vm
  * @param ServiceOffering offering
  * @return boolean true if the VM can be upgraded
**/

publicboolean isVirtualMachineUpgradable(final UserVm vm, final ServiceOffering offering);

/**
  * Determines which physical hosts are suitable to allocate the guest virtual machines on
  *
  * @paramVirtualMachineProfile vmProfile
  * @paramDeploymentPlan plan
  * @paramType type
  * @paramExcludeList avoid
  * @paramint returnUpTo
  * @returnList&lt;Host&gt;List of hosts that are suitable for VM allocation
**/

publicList&lt;Host&gt; allocateTo( VirtualMachineProfile&lt;?extendsVirtualMachine&gt; vmProfile,  DeploymentPlan plan, Type type, ExcludeList avoid, intreturnUpTo);
</pre></div>
</div>
<p>A custom HostAllocator can be written by implementing the ‘allocateTo’
method</p>
<div class="section" id="input-parameters-for-the-method-hostallocator-allocateto">
<h4>Input Parameters for the method ‘HostAllocator :: allocateTo’<a class="headerlink" href="alloc.html#input-parameters-for-the-method-hostallocator-allocateto" title="Permalink to this headline">¶</a></h4>
<p><em>com.cloud.vm.VirtualMachineProfile vmProfile</em></p>
<p>VirtualMachineProfile describes one virtual machine. This allows the
adapters like Allocators to process the information in the virtual
machine and make determinations on what the virtual machine profile
should look like before it is actually started on the hypervisor.</p>
<p>HostAllocators can make use of the following information present in the
VirtualMachineProfile:</p>
<ul class="simple">
<li>The ServiceOffering that specifies configuration like requested CPU
speed, RAM etc necessary for the guest VM.</li>
<li>The VirtualMachineTemplate, the template to be used to start the VM.</li>
</ul>
<p><em>com.cloud.deploy.DeploymentPlan plan</em></p>
<p>DeploymentPlan should specify:</p>
<ul class="simple">
<li>dataCenterId: The data center the VM should deploy in</li>
<li>podId: The pod the Vm should deploy in; null if no preference</li>
<li>clusterId: The cluster the VM should deploy in; null if no preference</li>
<li>poolId: The storage pool the VM should be created in; null if no
preference</li>
</ul>
<p><em>com.cloud.host.Host.Type type</em></p>
<p>Type of the Host needed for this guest VM. Currently
com.cloud.host.Host.Type interface defines the following Host types:</p>
<ul class="simple">
<li>Storage</li>
<li>Routing</li>
<li>SecondaryStorage</li>
<li>ConsoleProxy</li>
<li>ExternalFirewall</li>
<li>ExternalLoadBalancer</li>
</ul>
<p><em>com.cloud.deploy.DeploymentPlanner.ExcludeList avoid</em></p>
<p>The ExcludeList specifies what datacenters, pods, clusters, hosts,
storagePools should not be considered for allocating this guest VM.
HostAllocators should avoid the hosts that are mentioned in
ExcludeList.hostIds.</p>
<ul class="simple">
<li>Set Long dcIds;</li>
<li>Set Long podIds;</li>
<li>Set Long clusterIds;</li>
<li>Set Long hostIds;</li>
<li>Set Long poolIds;</li>
</ul>
<p><em>int returnUpTo</em></p>
<p>This specifies return up to that many available hosts for this guest VM.</p>
<p>To get all possible hosts, set this value to -1.</p>
</div>
<div class="section" id="reference-hostallocator-implementation">
<h4>Reference HostAllocator implementation<a class="headerlink" href="alloc.html#reference-hostallocator-implementation" title="Permalink to this headline">¶</a></h4>
<p>Refer com.cloud.agent.manager.allocator.impl.FirstFitAllocator that
implements the HostAllocator interface. This allocator checks available
hosts in the specified datacenter, Pod, Cluster and considering the
given ServiceOffering requirements.</p>
<p>If returnUpTo = 1, this allocator would return the first Host that fits
the requirements of the guest VM.</p>
</div>
<div class="section" id="loading-a-custom-hostallocator">
<h4>Loading a custom HostAllocator<a class="headerlink" href="alloc.html#loading-a-custom-hostallocator" title="Permalink to this headline">¶</a></h4>
<ol class="arabic">
<li><p class="first">Write a custom HostAllocator class, implementing the interface
described above.</p>
</li>
<li><p class="first">Package the code into a JAR file and make the JAR available in the
classpath of the Management Server/tomcat.</p>
</li>
<li><p class="first">Modify the components.xml and components-premium.xml files found in
/client/ tomcatconf as follows.</p>
</li>
<li><p class="first">Search for ‘HostAllocator’ in these files.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">adapters</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;com.cloud.agent.manager.allocator.HostAllocator&quot;</span><span class="o">&gt;</span>
  <span class="o">&lt;</span><span class="n">adapter</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;FirstFit&quot;</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;com.cloud.agent.manager.allocator.impl.FirstFitAllocator&quot;</span><span class="o">/&gt;</span>
<span class="o">&lt;/</span><span class="n">adapters</span><span class="o">&gt;</span>
</pre></div>
</div>
</li>
<li><p class="first">Replace the FirstFitAllocator with your class name. Optionally, you
can change the name of the adapter as well.</p>
</li>
<li><p class="first">Restart the Management Server.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="section" id="implementing-a-custom-storagepoolallocator">
<h2>Implementing a custom StoragePoolAllocator<a class="headerlink" href="alloc.html#implementing-a-custom-storagepoolallocator" title="Permalink to this headline">¶</a></h2>
<p>StoragePoolAllocators are written by extending
com.cloud.storage.allocator. StoragePoolAllocator interface.</p>
<div class="section" id="storagepoolallocator-interface">
<h3>StoragePoolAllocator Interface<a class="headerlink" href="alloc.html#storagepoolallocator-interface" title="Permalink to this headline">¶</a></h3>
<p>A custom StoragePoolAllocator can be written by implementing the
‘allocateTo’ method.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>/**
  * Determines which storage pools are suitable for the guest virtual machine
  * @param DiskProfile dskCh
  * @param VirtualMachineProfile vmProfile
  * @param DeploymentPlan plan
  * @param ExcludeList avoid
  * @param int returnUpTo
  * @return List&lt;StoragePool&gt; List of storage pools that are suitable for the VM
**/

public List&lt;StoragePool&gt; allocateToPool(DiskProfile dskCh, VirtualMachineProfile&lt;? extends VirtualMachine&gt; vm, DeploymentPlan plan, ExcludeList avoid, int returnUpTo);
</pre></div>
</div>
<p>This interface also contains some other methods to support some legacy
code. However your custom allocator can extend the existing
com.cloud.storage.allocator. AbstractStoragePoolAllocator. This class
provides default implementation for all the other interface methods.</p>
<div class="section" id="input-parameters-for-the-method-storagepoolallocator-allocateto">
<h4>Input Parameters for the method ‘StoragePoolAllocator :: allocateTo’<a class="headerlink" href="alloc.html#input-parameters-for-the-method-storagepoolallocator-allocateto" title="Permalink to this headline">¶</a></h4>
<p><em>com.cloud.vm.DiskProfile dskCh</em></p>
<p>DiskCharacteristics describes a disk and what functionality is required
from it. It specifies the storage pool tags if any to be used while
searching for a storage pool.</p>
<p><em>com.cloud.vm.VirtualMachineProfile vmProfile</em></p>
<p>VirtualMachineProfile describes one virtual machine. This allows the
adapters like Allocators to process the information in the virtual
machine and make determinations on what the virtual machine profile
should look like before it is actually started on the hypervisor.</p>
<p>StoragePoolAllocators can make use of the following information present
in the VirtualMachineProfile:</p>
<ul class="simple">
<li>The VirtualMachine instance that specifies properties of the guest
VM.</li>
<li>The VirtualMachineTemplate, the template to be used to start the VM.</li>
</ul>
<p><em>com.cloud.deploy.DeploymentPlan plan</em></p>
<p>DeploymentPlan should specify:</p>
<ul class="simple">
<li>dataCenterId: The data center the VM should deploy in</li>
<li>podId: The pod the VM should deploy in; null if no preference</li>
<li>clusterId: The cluster the VM should deploy in; null if no preference</li>
<li>poolId: The storage pool the VM should be created in; null if no
preference</li>
</ul>
<p><em>com.cloud.deploy.DeploymentPlanner.ExcludeList avoid</em></p>
<p>The ExcludeList specifies what datacenters, pods, clusters, hosts,
storagePools should not be considered for allocating this guest VM.
StoragePoolAllocators should avoid the pools that are mentioned in
ExcludeList.poolIds</p>
<ul class="simple">
<li>Set Long dcIds;</li>
<li>Set Long podIds;</li>
<li>Set Long clusterIds;</li>
<li>Set Long hostIds;</li>
<li>Set Long poolIds;</li>
</ul>
<p><em>int returnUpTo</em></p>
<p>This specifies return up to that many available pools for this guest VM</p>
<p>To get all possible pools, set this value to -1</p>
</div>
<div class="section" id="reference-storagepoolallocator-implementation">
<h4>Reference StoragePoolAllocator implementation<a class="headerlink" href="alloc.html#reference-storagepoolallocator-implementation" title="Permalink to this headline">¶</a></h4>
<p>Refer com.cloud.storage.allocator.FirstFitStoragePoolAllocator that
implements the StoragePoolAllocator interface. This allocator checks
available pools in the specified datacenter, Pod, Cluster and
considering the given DiskProfile characteristics.</p>
<p>If returnUpTo = 1, this allocator would return the first Storage Pool
that fits the requirements of the guest VM.</p>
</div>
<div class="section" id="loading-a-custom-storagepoolallocator">
<h4>Loading a custom StoragePoolAllocator<a class="headerlink" href="alloc.html#loading-a-custom-storagepoolallocator" title="Permalink to this headline">¶</a></h4>
<ol class="arabic">
<li><p class="first">Write a custom StoragePoolAllocator class, implementing the interface
described above.</p>
</li>
<li><p class="first">Package the code into a JAR file and make the JAR available in the
classpath of the Management Server/tomcat.</p>
</li>
<li><p class="first">Modify the components.xml and components-premium.xml files found in
/client/ tomcatconf as follows.</p>
</li>
<li><p class="first">Search for ‘StoragePoolAllocator’ in these files.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">adapters</span> <span class="n">key</span><span class="o">=</span><span class="s2">&quot;com.cloud.storage.allocator.StoragePoolAllocator&quot;</span><span class="o">&gt;</span>
   <span class="o">&lt;</span><span class="n">adapter</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Storage&quot;</span> <span class="n">class</span><span class="o">=</span><span class="s2">&quot;com.cloud.storage.allocator.FirstFitStoragePoolAllocator&quot;</span><span class="o">/&gt;</span>
<span class="o">&lt;/</span><span class="n">adapters</span><span class="o">&gt;</span>
</pre></div>
</div>
</li>
<li><p class="first">Replace the FirstFitStoragePoolAllocator with your class name.
Optionally, you can change the name of the adapter as well.</p>
</li>
<li><p class="first">Restart the Management Server.</p>
</li>
</ol>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="ansible.html" class="btn btn-neutral float-right" title="Deploying CloudStack with Ansible" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="plugins.html" class="btn btn-neutral float-left" title="Plugins" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Apache Foundation
      
        <span class="commit">
          Revision <code>7c5c9b49</code>.
        </span>
      

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="fa fa-book"> Read the Docs</span>
      v: 4.11.3.0
      <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
      <dl>
        <dt>Versions</dt>
        
          <dd><a href="../../../index.html">latest</a></dd>
        
          <dd><a href="../../4.12.0.0/index.html">4.12.0.0</a></dd>
        
          <dd><a href="../index.html">4.11.3.0</a></dd>
        
          <dd><a href="../../4.11.2.0/index.html">4.11.2.0</a></dd>
        
          <dd><a href="../../4.11.1.0/index.html">4.11.1.0</a></dd>
        
          <dd><a href="http://docs.cloudstack.apache.org/en/master/">master</a></dd>
        
      </dl>
      <dl>
        <dt>Downloads</dt>
        
      </dl>
      <dl>
        <dt>On Read the Docs</dt>
          <dd>
            <a href="http://readthedocs.org/projects/cloudstack-documentation/?fromdocs=cloudstack-documentation">Project Home</a>
          </dd>
          <dd>
            <a href="http://readthedocs.org/builds/cloudstack-documentation/?fromdocs=cloudstack-documentation">Builds</a>
          </dd>
      </dl>
      <hr/>
      Free document hosting provided by <a href="http://www.readthedocs.org">Read the Docs</a>.

    </div>
  </div>



  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
   

</body>
</html>