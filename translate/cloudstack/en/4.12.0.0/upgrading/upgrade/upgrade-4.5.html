

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>基于 4.5.x 升级 &mdash; Apache CloudStack 4.12.0.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
        <script type="text/javascript" src="https://assets.readthedocs.org/static/javascript/readthedocs-doc-embed.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="基于 4.4.x 升级" href="upgrade-4.4.html" />
    <link rel="prev" title="基于 4.6.x 升级" href="upgrade-4.6.html" /> 

<!-- RTD Extra Head -->

<!-- 
Always link to the latest version, as canonical.
http://docs.readthedocs.org/en/latest/canonical.html
-->
<link rel="canonical" href="../../../latest/upgrading/upgrade/upgrade-4.5.html" />

<link rel="stylesheet" href="https://assets.readthedocs.org/static/css/readthedocs-doc-embed.css" type="text/css" />

<script type="text/javascript" src="../../_static/readthedocs-data.js"></script>

<!-- Add page-specific data, which must exist in the page js, not global -->
<script type="text/javascript">
READTHEDOCS_DATA['page'] = "upgrading/upgrade/upgrade-4.5"
READTHEDOCS_DATA['source_suffix'] = ".rst"
</script>

<script type="text/javascript" src="https://assets.readthedocs.org/static/javascript/readthedocs-analytics.js"></script>

<!-- end RTD <extrahead> -->
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Apache CloudStack
          

          
          </a>

          
            
            
            
              <div class="version">
                4.12.0.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../conceptsandterminology/index.html">CloudStack 概念和术语</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quickinstallationguide/qig.html">快速安装向导</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../installguide/index.html">安装指南</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">升级 CloudStack</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="upgrade-4.11.html">基于 4.11.x 升级</a></li>
<li class="toctree-l2"><a class="reference internal" href="upgrade-4.10.html">基于 4.10.x 升级</a></li>
<li class="toctree-l2"><a class="reference internal" href="upgrade-4.9.html">基于 4.9.x 升级</a></li>
<li class="toctree-l2"><a class="reference internal" href="upgrade-4.8.html">基于 4.8.x 升级</a></li>
<li class="toctree-l2"><a class="reference internal" href="upgrade-4.7.html">基于 4.7.x 升级</a></li>
<li class="toctree-l2"><a class="reference internal" href="upgrade-4.6.html">基于 4.6.x 升级</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="upgrade-4.5.html#">基于 4.5.x 升级</a><ul>
<li class="toctree-l3"><a class="reference internal" href="upgrade-4.5.html#packages-repository">软件包存储库</a></li>
<li class="toctree-l3"><a class="reference internal" href="upgrade-4.5.html#update-system-vm-templates">升级系统虚拟机模版</a></li>
<li class="toctree-l3"><a class="reference internal" href="upgrade-4.5.html#database-preparation">Database Preparation</a></li>
<li class="toctree-l3"><a class="reference internal" href="upgrade-4.5.html#management-server-on-ubuntu">管理服务 on Ubuntu</a></li>
<li class="toctree-l3"><a class="reference internal" href="upgrade-4.5.html#java-8-jre-on-ubuntu">Java 8 JRE on Ubuntu</a><ul>
<li class="toctree-l4"><a class="reference internal" href="upgrade-4.5.html#cloudstack-apt-repository">CloudStack apt repository</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="upgrade-4.5.html#management-server-on-centos-rhel">管理服务 on CentOS/RHEL</a><ul>
<li class="toctree-l4"><a class="reference internal" href="upgrade-4.5.html#install-new-mysql-connector">Install new MySQL connector</a></li>
<li class="toctree-l4"><a class="reference internal" href="upgrade-4.5.html#cloudstack-rpm-repository">CloudStack RPM repository</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="upgrade-4.5.html#hypervisor-xenserver">Hypervisor: XenServer</a></li>
<li class="toctree-l3"><a class="reference internal" href="upgrade-4.5.html#hypervisor-vmware">Hypervisor: VMware</a></li>
<li class="toctree-l3"><a class="reference internal" href="upgrade-4.5.html#hypervisor-kvm">Hypervisor: KVM</a><ul>
<li class="toctree-l4"><a class="reference internal" href="upgrade-4.5.html#kvm-on-ubuntu">KVM on Ubuntu</a></li>
<li class="toctree-l4"><a class="reference internal" href="upgrade-4.5.html#kvm-on-centos-rhel">KVM on CentOS/RHEL</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="upgrade-4.5.html#restart-management-services">重启管理服务</a></li>
<li class="toctree-l3"><a class="reference internal" href="upgrade-4.5.html#system-vms-and-virtual-routers">System-VMs and Virtual-Routers</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="upgrade-4.4.html">基于 4.4.x 升级</a></li>
<li class="toctree-l2"><a class="reference internal" href="upgrade-4.3.html">基于 4.3.x 升级</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../adminguide/index.html">使用手册</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developersguide/index.html">开发者手册</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../plugins/index.html">Plugins Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../releasenotes/index.html">发行版本说明</a></li>
</ul>
<p class="caption"><span class="caption-text">其它:</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="http://cloudstack.apache.org/api.html">API 文档</a></li>
<li class="toctree-l1"><a class="reference external" href="https://cwiki.apache.org/confluence/display/CLOUDSTACK/Home">Apache CloudStack Wiki</a></li>
<li class="toctree-l1"><a class="reference external" href="http://cloudstack.apache.org/">Apache CloudStack web site</a></li>
<li class="toctree-l1"><a class="reference external" href="http://cloudstack.apache.org/downloads.html">Apache CloudStack Source Code</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/apache/cloudstack">Apache CloudStack on GitHub</a></li>
</ul>
<p class="caption"><span class="caption-text">Pre 4.11 Documentation:</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="../../../../projects/cloudstack-installation.html">安装指南</a></li>
<li class="toctree-l1"><a class="reference external" href="../../../../projects/cloudstack-administration.html">管理员手册</a></li>
<li class="toctree-l1"><a class="reference external" href="../../../../projects/cloudstack-release-notes.html">发行版本说明</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Apache CloudStack</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">升级 CloudStack</a> &raquo;</li>
        
      <li>基于 4.5.x 升级</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            
              <a href="https://github.com/apache/cloudstack-documentation/blob/4.12.0.0/source/upgrading/upgrade/upgrade-4.5.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="upgrade-instruction-from-version-to-upgrade">
<h1>基于 4.5.x 升级<a class="headerlink" href="upgrade-4.5.html#upgrade-instruction-from-version-to-upgrade" title="Permalink to this headline">¶</a></h1>
<p>This section will guide you from CloudStack 4.5.x to CloudStack
4.12.0.0.</p>
<p>Any steps that are hypervisor-specific will be called out with a note.</p>
<p>We recommend reading through this section once or twice before beginning
your upgrade procedure, and working through it on a test system before
working on a production system.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The following upgrade instructions should be performed regardless of
hypervisor type.</p>
</div>
<p>Upgrade Steps:</p>
<ol class="arabic simple">
<li>Backup CloudStack database (MySQL)</li>
<li>Install new systemvm template</li>
<li>Add package repository for MySQL connector</li>
<li>Upgrade CloudStack management server(s)</li>
<li>Update hypervisors specific dependencies</li>
</ol>
<div class="section" id="packages-repository">
<h2>软件包存储库<a class="headerlink" href="upgrade-4.5.html#packages-repository" title="Permalink to this headline">¶</a></h2>
<p>Most users of CloudStack manage the installation and upgrades of
CloudStack with one of Linux’s predominant package systems, RPM or
APT. This guide assumes you’ll be using RPM and Yum (for Red Hat
Enterprise Linux or CentOS), or APT and Debian packages (for Ubuntu).</p>
<p>Create RPM or Debian packages (as appropriate) and a repository from
the 4.12.0.0 source, or check the Apache CloudStack downloads page at
<a class="reference external" href="http://cloudstack.apache.org/downloads.html">http://cloudstack.apache.org/downloads.html</a>
for package repositories supplied by community members. You will need
them for <a class="reference internal" href="upgrade-4.5.html#ubuntu45"><span class="std std-ref">管理服务 on Ubuntu</span></a> or <a class="reference internal" href="upgrade-4.5.html#rhel45"><span class="std std-ref">管理服务 on CentOS/RHEL</span></a> and <a class="reference internal" href="upgrade-4.5.html#kvm45"><span class="std std-ref">Hypervisor: KVM</span></a> hosts upgrade.</p>
<p>Instructions for creating packages from the CloudStack source are in the
<a class="reference external" href="../../../../projects/cloudstack-installation.html">CloudStack 安装指南</a>.</p>
</div>
<div class="section" id="update-system-vm-templates">
<h2>升级系统虚拟机模版<a class="headerlink" href="upgrade-4.5.html#update-system-vm-templates" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p class="first">While running the existing 4.5.x system, log in to the UI as
root administrator.</p>
</li>
<li><p class="first">In the left navigation bar, click Templates.</p>
</li>
<li><p class="first">In Select view, click Templates.</p>
</li>
<li><p class="first">Click Register template.</p>
<p>The Register template dialog box is displayed.</p>
</li>
<li><p class="first">In the Register template dialog box, specify the following values
(do not change these):</p>
<table border="1" class="table-striped table-bordered table-hover docutils">
<colgroup>
<col width="17%" />
<col width="83%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Hypervisor</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>XenServer</td>
<td><p class="first">Name: systemvm-xenserver-4.11.2</p>
<p>Description: systemvm-xenserver-4.11.2</p>
<p>URL: <a class="reference external" href="http://download.cloudstack.org/systemvm/4.11/systemvmtemplate-4.11.2-xen.vhd.bz2">http://download.cloudstack.org/systemvm/4.11/systemvmtemplate-4.11.2-xen.vhd.bz2</a></p>
<p>Zone: Choose the zone where this hypervisor is used</p>
<p>Hypervisor: XenServer</p>
<p>Format: VHD</p>
<p>OS Type: Debian GNU/Linux 7.0 (64-bit) (or the
highest Debian release number available in the
dropdown)</p>
<p>Extractable: no</p>
<p>Password Enabled: no</p>
<p>Public: no</p>
<p>Featured: no</p>
<p class="last">Routing: no</p>
</td>
</tr>
<tr class="row-odd"><td>KVM</td>
<td><p class="first">Name: systemvm-kvm-4.11.2</p>
<p>Description: systemvm-kvm-4.11.2</p>
<p>URL: <a class="reference external" href="http://download.cloudstack.org/systemvm/4.11/systemvmtemplate-4.11.2-kvm.qcow2.bz2">http://download.cloudstack.org/systemvm/4.11/systemvmtemplate-4.11.2-kvm.qcow2.bz2</a></p>
<p>Zone: Choose the zone where this hypervisor is used</p>
<p>Hypervisor: KVM</p>
<p>Format: QCOW2</p>
<p>OS Type: Debian GNU/Linux 7.0 (64-bit) (or the
highest Debian release number available in the
dropdown)</p>
<p>Extractable: no</p>
<p>Password Enabled: no</p>
<p>Public: no</p>
<p>Featured: no</p>
<p class="last">Routing: no</p>
</td>
</tr>
<tr class="row-even"><td>VMware</td>
<td><p class="first">Name: systemvm-vmware-4.11.2</p>
<p>Description: systemvm-vmware-4.11.2</p>
<p>URL: <a class="reference external" href="http://download.cloudstack.org/systemvm/4.11/systemvmtemplate-4.11.2-vmware.ova">http://download.cloudstack.org/systemvm/4.11/systemvmtemplate-4.11.2-vmware.ova</a></p>
<p>Zone: Choose the zone where this hypervisor is used</p>
<p>Hypervisor: VMware</p>
<p>Format: OVA</p>
<p>OS Type: Other Linux 64-bit</p>
<p>Extractable: no</p>
<p>Password Enabled: no</p>
<p>Public: no</p>
<p>Featured: no</p>
<p class="last">Routing: no</p>
</td>
</tr>
<tr class="row-odd"><td>HyperV</td>
<td><p class="first">Name: systemvm-hyperv-4.11.2</p>
<p>Description: systemvm-hyperv-4.11.2</p>
<p>URL: <a class="reference external" href="http://download.cloudstack.org/systemvm/4.11/systemvmtemplate-4.11.2-hyperv.vhd.zip">http://download.cloudstack.org/systemvm/4.11/systemvmtemplate-4.11.2-hyperv.vhd.zip</a></p>
<p>Zone: Choose the zone where this hypervisor is used</p>
<p>Hypervisor: Hyper-V</p>
<p>Format: VHD</p>
<p>OS Type: Debian GNU/Linux 7.0 (64-bit) (or the
highest Debian release number available in the
dropdown)</p>
<p>Extractable: no</p>
<p>Password Enabled: no</p>
<p>Public: no</p>
<p>Featured: no</p>
<p class="last">Routing: no</p>
</td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">Watch the screen to be sure that the template downloads successfully and
enters the <strong>READY</strong> state. Do not proceed until this is successful.</p>
</li>
</ol>
</div>
<div class="section" id="database-preparation">
<h2>Database Preparation<a class="headerlink" href="upgrade-4.5.html#database-preparation" title="Permalink to this headline">¶</a></h2>
<p>Backup current database</p>
<ol class="arabic">
<li><p class="first">Stop your management server or servers. Run this on all management
server hosts:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo service cloudstack-management stop
</pre></div>
</div>
</li>
<li><p class="first">If you are running a usage server or usage servers, stop those as well:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo service cloudstack-usage stop
</pre></div>
</div>
</li>
<li><p class="first">Make a backup of your MySQL database. If you run into any issues or
need to roll back the upgrade, this will assist in debugging or
restoring your existing environment. You’ll be prompted for your
password.</p>
<pre class="literal-block">
$ mysqldump -u root -p cloud &gt; cloud-backup_`date '+%Y-%m-%d'<cite>.sql
$ mysqldump -u root -p cloud_usage &gt; cloud_usage-backup_`date '+%Y-%m-%d'</cite>.sql
</pre>
</li>
<li><p class="first"><strong>(KVM Only)</strong> If primary storage of type local storage is in use, the
path for this storage needs to be verified to ensure it passes new
validation. Check local storage by querying the cloud.storage_pool
table:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ mysql -u cloud -p -e &quot;select id,name,path from cloud.storage_pool where pool_type=&#39;Filesystem&#39;&quot;
</pre></div>
</div>
<p>If local storage paths are found to have a trailing forward slash,
remove it:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ mysql -u cloud -p -e &#39;update cloud.storage_pool set path=&quot;/var/lib/libvirt/images&quot; where path=&quot;/var/lib/libvirt/images/&quot;&#39;;
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="management-server-on-ubuntu">
<span id="ubuntu45"></span><h2>管理服务 on Ubuntu<a class="headerlink" href="upgrade-4.5.html#management-server-on-ubuntu" title="Permalink to this headline">¶</a></h2>
<p>If you are using Ubuntu, follow this procedure to upgrade your packages. If
not, skip to step <a class="reference internal" href="upgrade-4.5.html#rhel45"><span class="std std-ref">管理服务 on CentOS/RHEL</span></a>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><strong>Community Packages:</strong> This section assumes you’re using the community
supplied packages for CloudStack. If you’ve created your own packages and
APT repository, substitute your own URL for the ones used in these examples.</p>
</div>
<p>The first order of business will be to change the sources list for
each system with CloudStack packages. This means all management
servers, and any hosts that have the KVM agent. (No changes should
be necessary for hosts that are running VMware or Xen.)</p>
<span class="target" id="apt-repo45"></span></div>
<div class="section" id="java-8-jre-on-ubuntu">
<h2>Java 8 JRE on Ubuntu<a class="headerlink" href="upgrade-4.5.html#java-8-jre-on-ubuntu" title="Permalink to this headline">¶</a></h2>
<p>CloudStack 4.12 requires installation of Java 8 JRE from an external PPA
such as openjdk-r for Ubuntu distributions where the openjdk-8 packages are not
available from the main repositories such as on Ubuntu 14.04. The PPA can be
added before installation/upgrade:</p>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo add-apt-repository ppa:openjdk-r/ppa
$ sudo apt-get update
</pre></div>
</div>
</div></blockquote>
<p>Users can also choose to install Java 8 distribution from Oracle, or <a class="reference external" href="http://repos.azulsystems.com/">Xulu-8</a> OpenJDK distribution from Azul.</p>
<div class="section" id="cloudstack-apt-repository">
<h3>CloudStack apt repository<a class="headerlink" href="upgrade-4.5.html#cloudstack-apt-repository" title="Permalink to this headline">¶</a></h3>
<p>Start by opening <code class="docutils literal notranslate"><span class="pre">/etc/apt/sources.list.d/cloudstack.list</span></code> on
any systems that have CloudStack packages installed.</p>
<p>This file should have one line, which contains:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">deb</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">download</span><span class="o">.</span><span class="n">cloudstack</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">ubuntu</span> <span class="n">precise</span> <span class="mf">4.5</span>
</pre></div>
</div>
<p>We’ll change it to point to the new package repository:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">deb</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">download</span><span class="o">.</span><span class="n">cloudstack</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">ubuntu</span> <span class="n">precise</span> <span class="mf">4.9</span>
</pre></div>
</div>
<p>Setup the public key for the above repository:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">wget</span> <span class="o">-</span><span class="n">qO</span> <span class="o">-</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">download</span><span class="o">.</span><span class="n">cloudstack</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">release</span><span class="o">.</span><span class="n">asc</span> <span class="o">|</span> <span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">key</span> <span class="n">add</span> <span class="o">-</span>
</pre></div>
</div>
<p>If you’re using your own package repository, change this line to
read as appropriate for your 4.12 repository.</p>
<ol class="arabic">
<li><p class="first">Now update your apt package list:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo apt-get update
</pre></div>
</div>
</li>
<li><p class="first">Now that you have the repository configured, it’s time to upgrade
the <code class="docutils literal notranslate"><span class="pre">cloudstack-management</span></code> package.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo apt-get upgrade cloudstack-management
</pre></div>
</div>
</li>
<li><p class="first">If you use CloudStack usage server</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo apt-get upgrade cloudstack-usage
</pre></div>
</div>
</li>
</ol>
</div>
</div>
<div class="section" id="management-server-on-centos-rhel">
<span id="rhel45"></span><h2>管理服务 on CentOS/RHEL<a class="headerlink" href="upgrade-4.5.html#management-server-on-centos-rhel" title="Permalink to this headline">¶</a></h2>
<p>If you are using CentOS or RHEL, follow this procedure to upgrade your
packages. If not, skip to hypervisors section <a class="reference internal" href="upgrade-4.5.html#upg-hyp-45"><span class="std std-ref">Hypervisor: XenServer</span></a>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><strong>Community Packages:</strong> This section assumes you’re using the community
supplied packages for CloudStack. If you’ve created your own packages and
yum repository, substitute your own URL for the ones used in these examples.</p>
</div>
<div class="section" id="install-new-mysql-connector">
<h3>Install new MySQL connector<a class="headerlink" href="upgrade-4.5.html#install-new-mysql-connector" title="Permalink to this headline">¶</a></h3>
<p>Starting with 4.9.0, cloudstack-management RPM’s now depend on the
<code class="docutils literal notranslate"><span class="pre">mysql-connector-python</span></code> package. Therefore Apache CloudStack
4.12.0.0 requires the instalation of the MySQL connector on CentOS.</p>
<div class="section" id="mysql-connector-rpm-repository">
<h4>MySQL connector RPM repository<a class="headerlink" href="upgrade-4.5.html#mysql-connector-rpm-repository" title="Permalink to this headline">¶</a></h4>
<p>Add a new yum repo <code class="docutils literal notranslate"><span class="pre">/etc/yum.repos.d/mysql.repo</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>[mysql-community]
name=MySQL Community connectors
baseurl=http://repo.mysql.com/yum/mysql-connectors-community/el/$releasever/$basearch/
enabled=1
gpgcheck=1
</pre></div>
</div>
<p>Import GPG public key from MySQL:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rpm</span> <span class="o">--</span><span class="kn">import</span> <span class="nn">http</span><span class="p">:</span><span class="o">//</span><span class="n">repo</span><span class="o">.</span><span class="n">mysql</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">RPM</span><span class="o">-</span><span class="n">GPG</span><span class="o">-</span><span class="n">KEY</span><span class="o">-</span><span class="n">mysql</span>
</pre></div>
</div>
<p>Install mysql-connector</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">yum</span> <span class="n">install</span> <span class="n">mysql</span><span class="o">-</span><span class="n">connector</span><span class="o">-</span><span class="n">python</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="cloudstack-rpm-repository">
<span id="rpm-repo45"></span><h3>CloudStack RPM repository<a class="headerlink" href="upgrade-4.5.html#cloudstack-rpm-repository" title="Permalink to this headline">¶</a></h3>
<p>The first order of business will be to change the yum repository
for each system with CloudStack packages. This means all
management servers, and any hosts that have the KVM agent.</p>
<p>(No changes should be necessary for hosts that are running VMware
or Xen.)</p>
<p>Start by opening <code class="docutils literal notranslate"><span class="pre">/etc/yum.repos.d/cloudstack.repo</span></code> on any
systems that have CloudStack packages installed.</p>
<p>This file should have content similar to the following:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">apache</span><span class="o">-</span><span class="n">cloudstack</span><span class="p">]</span>
<span class="n">name</span><span class="o">=</span><span class="n">Apache</span> <span class="n">CloudStack</span>
<span class="n">baseurl</span><span class="o">=</span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">download</span><span class="o">.</span><span class="n">cloudstack</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">rhel</span><span class="o">/</span><span class="mf">4.5</span><span class="o">/</span>
<span class="n">enabled</span><span class="o">=</span><span class="mi">1</span>
<span class="n">gpgcheck</span><span class="o">=</span><span class="mi">0</span>
</pre></div>
</div>
<p>If you are using the community provided package repository, change
the base url to <code class="docutils literal notranslate"><span class="pre">http://download.cloudstack.org/centos/$releasever/4.9/</span></code>.</p>
<p>Setup the GPG public key if you wish to enable <code class="docutils literal notranslate"><span class="pre">gpgcheck=1</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rpm</span> <span class="o">--</span><span class="kn">import</span> <span class="nn">http</span><span class="p">:</span><span class="o">//</span><span class="n">download</span><span class="o">.</span><span class="n">cloudstack</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">RPM</span><span class="o">-</span><span class="n">GPG</span><span class="o">-</span><span class="n">KEY</span>
</pre></div>
</div>
<p>If you’re using your own package repository, change this line to
read as appropriate for your 4.12 repository.</p>
<ol class="arabic">
<li><p class="first">Remove the deprecated dependency for awsapi.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo rpm -e --nodeps cloudstack-awsapi
</pre></div>
</div>
</li>
<li><p class="first">Now that you have the repository configured, it’s time to upgrade the
<code class="docutils literal notranslate"><span class="pre">cloudstack-management</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo yum upgrade cloudstack-management
</pre></div>
</div>
</li>
<li><p class="first">If you use CloudStack usage server</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo yum upgrade cloudstack-usage
</pre></div>
</div>
</li>
</ol>
</div>
</div>
<div class="section" id="hypervisor-xenserver">
<span id="upg-hyp-45"></span><h2>Hypervisor: XenServer<a class="headerlink" href="upgrade-4.5.html#hypervisor-xenserver" title="Permalink to this headline">¶</a></h2>
<p><strong>(XenServer only)</strong> Copy vhd-utils file on CloudStack management servers.
Copy the file <a class="reference external" href="http://download.cloudstack.org/tools/vhd-util">vhd-utils</a>
to <code class="docutils literal notranslate"><span class="pre">/usr/share/cloudstack-common/scripts/vm/hypervisor/xenserver</span></code>.</p>
<pre class="literal-block">
wget -P /usr/share/cloudstack-common/scripts/vm/hypervisor/xenserver <a class="reference external" href="http://download.cloudstack.org/tools/vhd-util">http://download.cloudstack.org/tools/vhd-util</a>
</pre>
</div>
<div class="section" id="hypervisor-vmware">
<h2>Hypervisor: VMware<a class="headerlink" href="upgrade-4.5.html#hypervisor-vmware" title="Permalink to this headline">¶</a></h2>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">For VMware hypervisor CloudStack management server packages must be
build using “noredist”. Refer to <a class="reference internal" href="../../installguide/building_from_source.html#building-noredist"><span class="std std-ref">打包 Non-OSS</span></a></p>
</div>
<p><strong>(VMware only)</strong> Additional steps are required for each VMware cluster.
These steps will not affect running guests in the cloud. These steps
are required only for clouds using VMware clusters:</p>
<ol class="arabic">
<li><p class="first">Stop the 管理服务:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo service cloudstack-management stop
</pre></div>
</div>
</li>
<li><p class="first">Generate the encrypted equivalent of your vCenter password:</p>
<pre class="literal-block">
$ java -classpath /usr/share/cloudstack-common/lib/jasypt-1.9.2.jar org.jasypt.intf.cli.JasyptPBEStringEncryptionCLI encrypt.sh input=&quot;_your_vCenter_password_&quot; password=&quot;<cite>cat /etc/cloudstack/management/key</cite>&quot; verbose=false
</pre>
</li>
</ol>
<p>Store the output from this step, we need to add this in
cluster_details table and vmware_data_center tables in place of
the plain text password</p>
<ol class="arabic">
<li><p class="first">Find the ID of the row of cluster_details table that you have to
update:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ mysql -u &lt;username&gt; -p&lt;password&gt;
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">select</span> <span class="o">*</span> <span class="kn">from</span> <span class="nn">cloud.cluster_details</span><span class="p">;</span>
</pre></div>
</div>
</li>
<li><p class="first">Update the plain text password with the encrypted one</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">update</span> <span class="n">cloud</span><span class="o">.</span><span class="n">cluster_details</span> <span class="nb">set</span> <span class="n">value</span> <span class="o">=</span> <span class="s1">&#39;_ciphertext_from_step_1_&#39;</span>
<span class="n">where</span> <span class="nb">id</span> <span class="o">=</span> <span class="n">_id_from_step_2_</span><span class="p">;</span>
</pre></div>
</div>
</li>
<li><p class="first">Confirm that the table is updated:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">select</span> <span class="o">*</span> <span class="kn">from</span> <span class="nn">cloud.cluster_details</span><span class="p">;</span>
</pre></div>
</div>
</li>
<li><dl class="first docutils">
<dt>Find the ID of the correct row of vmware_data_center that you</dt>
<dd><p class="first last">want to update</p>
</dd>
</dl>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">select</span> <span class="o">*</span> <span class="kn">from</span> <span class="nn">cloud.vmware_data_center</span><span class="p">;</span>
</pre></div>
</div>
</li>
<li><p class="first">update the plain text password with the encrypted one:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">update</span> <span class="n">cloud</span><span class="o">.</span><span class="n">vmware_data_center</span> <span class="nb">set</span> <span class="n">password</span> <span class="o">=</span> <span class="s1">&#39;_ciphertext_from_step_1_&#39;</span>
<span class="n">where</span> <span class="nb">id</span> <span class="o">=</span> <span class="n">_id_from_step_5_</span><span class="p">;</span>
</pre></div>
</div>
</li>
<li><p class="first">Confirm that the table is updated:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">select</span> <span class="o">*</span> <span class="kn">from</span> <span class="nn">cloud.vmware_data_center</span><span class="p">;</span>
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="hypervisor-kvm">
<span id="kvm45"></span><h2>Hypervisor: KVM<a class="headerlink" href="upgrade-4.5.html#hypervisor-kvm" title="Permalink to this headline">¶</a></h2>
<div class="section" id="kvm-on-ubuntu">
<h3>KVM on Ubuntu<a class="headerlink" href="upgrade-4.5.html#kvm-on-ubuntu" title="Permalink to this headline">¶</a></h3>
<p>(KVM only) Additional steps are required for each KVM host. These
steps will not affect running guests in the cloud. These steps are
required only for clouds using KVM as hosts and only on the KVM
hosts.</p>
<ol class="arabic">
<li><p class="first">Configure the <a class="reference internal" href="upgrade-4.5.html#apt-repo45"><span class="std std-ref">APT repo</span></a> as detailed above.</p>
</li>
<li><p class="first">Stop the running agent.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo service cloudstack-agent stop
</pre></div>
</div>
</li>
<li><p class="first">Update the agent software.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo apt-get upgrade cloudstack-agent
</pre></div>
</div>
</li>
<li><dl class="first docutils">
<dt>Verify that the file <code class="docutils literal notranslate"><span class="pre">/etc/cloudstack/agent/environment.properties</span></code> has a</dt>
<dd><p class="first last">line that reads:</p>
</dd>
</dl>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">paths</span><span class="o">.</span><span class="n">script</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">cloudstack</span><span class="o">-</span><span class="n">common</span>
</pre></div>
</div>
<p>If not, add the line.</p>
</li>
<li><p class="first">Start the agent.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo service cloudstack-agent start
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="kvm-on-centos-rhel">
<h3>KVM on CentOS/RHEL<a class="headerlink" href="upgrade-4.5.html#kvm-on-centos-rhel" title="Permalink to this headline">¶</a></h3>
<p>For KVM hosts, upgrade the <code class="docutils literal notranslate"><span class="pre">cloudstack-agent</span></code> package</p>
<ol class="arabic">
<li><p class="first">Configure the <a class="reference internal" href="upgrade-4.5.html#rpm-repo45"><span class="std std-ref">CloudStack RPM repository</span></a> as detailed above.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo yum upgrade cloudstack-agent
</pre></div>
</div>
</li>
<li><p class="first">Verify that the file <code class="docutils literal notranslate"><span class="pre">/etc/cloudstack/agent/environment.properties</span></code> has a
line that reads:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">paths</span><span class="o">.</span><span class="n">script</span><span class="o">=/</span><span class="n">usr</span><span class="o">/</span><span class="n">share</span><span class="o">/</span><span class="n">cloudstack</span><span class="o">-</span><span class="n">common</span>
</pre></div>
</div>
<p>If not, add the line.</p>
</li>
<li><p class="first">Restart the agent:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo service cloudstack-agent stop
$ sudo killall jsvc
$ sudo service cloudstack-agent start
</pre></div>
</div>
</li>
</ol>
</div>
</div>
<div class="section" id="restart-management-services">
<h2>重启管理服务<a class="headerlink" href="upgrade-4.5.html#restart-management-services" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p class="first">Now it’s time to start the management server</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo service cloudstack-management start
</pre></div>
</div>
</li>
<li><p class="first">If you use it, start the usage server</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ sudo service cloudstack-usage start
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="system-vms-and-virtual-routers">
<span id="upg-sysvm45"></span><h2>System-VMs and Virtual-Routers<a class="headerlink" href="upgrade-4.5.html#system-vms-and-virtual-routers" title="Permalink to this headline">¶</a></h2>
<p>Once you’ve upgraded the packages on your management servers, you’ll
need to restart the system VMs. Ensure that the admin port is set to
8096 by using the “integration.api.port” global parameter. This port
is used by the cloud-sysvmadm script at the end of the upgrade
procedure. For information about how to set this parameter, see <a class="reference internal" href="../../installguide/configuration.html#configuration-parameters"><span class="std std-ref">configuration parameters</span></a>
Changing this parameter will require management server restart. Also
make sure port 8096 is open in your local host firewall to do this.</p>
<p>There is a script that will do this for you, all you need to do is
run the script and supply the IP address for your MySQL instance and
your MySQL credentials:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># nohup cloudstack-sysvmadm -d IPaddress -u cloud -p password -a &gt; sysvm.log 2&gt;&amp;1 &amp;</span>
</pre></div>
</div>
<p>You can monitor the log for progress. The process of restarting the
system VMs can take an hour or more.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># tail -f sysvm.log</span>
</pre></div>
</div>
<p>The output to <code class="docutils literal notranslate"><span class="pre">sysvm.log</span></code> will look something like this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Stopping</span> <span class="ow">and</span> <span class="n">starting</span> <span class="mi">1</span> <span class="n">secondary</span> <span class="n">storage</span> <span class="n">vm</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">...</span>
<span class="n">Done</span> <span class="n">stopping</span> <span class="ow">and</span> <span class="n">starting</span> <span class="n">secondary</span> <span class="n">storage</span> <span class="n">vm</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
<span class="n">Stopping</span> <span class="ow">and</span> <span class="n">starting</span> <span class="mi">1</span> <span class="n">console</span> <span class="n">proxy</span> <span class="n">vm</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">...</span>
<span class="n">Done</span> <span class="n">stopping</span> <span class="ow">and</span> <span class="n">starting</span> <span class="n">console</span> <span class="n">proxy</span> <span class="n">vm</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">.</span>
<span class="n">Stopping</span> <span class="ow">and</span> <span class="n">starting</span> <span class="mi">4</span> <span class="n">running</span> <span class="n">routing</span> <span class="n">vm</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">...</span>
<span class="n">Done</span> <span class="n">restarting</span> <span class="n">router</span><span class="p">(</span><span class="n">s</span><span class="p">)</span><span class="o">.</span>
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="upgrade-4.4.html" class="btn btn-neutral float-right" title="基于 4.4.x 升级" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="upgrade-4.6.html" class="btn btn-neutral float-left" title="基于 4.6.x 升级" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Apache Foundation
      
        <span class="commit">
          Revision <code>af137188</code>.
        </span>
      

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="fa fa-book"> Read the Docs</span>
      v: 4.12.0.0
      <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
      <dl>
        <dt>Versions</dt>
        
          <dd><a href="http://docs.cloudstack.apache.org/en/master/">master</a></dd>
        
          <dd><a href="../../../../index.html">latest</a></dd>
        
          <dd><a href="../../../4.13.0.0/index.html">4.13.0.0</a></dd>
        
          <dd><a href="../../index.html">4.12.0.0</a></dd>
        
          <dd><a href="../../../4.11.3.0/index.html">4.11.3.0</a></dd>
        
          <dd><a href="../../../4.11.2.0/index.html">4.11.2.0</a></dd>
        
          <dd><a href="../../../4.11.1.0/index.html">4.11.1.0</a></dd>
        
      </dl>
      <dl>
        <dt>Downloads</dt>
        
          <dd><a href="http://readthedocs.org/projects/cloudstack-documentation/downloads/htmlzip/4.12.0.0/">html</a></dd>
        
      </dl>
      <dl>
        <dt>On Read the Docs</dt>
          <dd>
            <a href="http://readthedocs.org/projects/cloudstack-documentation/?fromdocs=cloudstack-documentation">Project Home</a>
          </dd>
          <dd>
            <a href="http://readthedocs.org/builds/cloudstack-documentation/?fromdocs=cloudstack-documentation">Builds</a>
          </dd>
      </dl>
      <hr/>
      Free document hosting provided by <a href="http://www.readthedocs.org">Read the Docs</a>.

    </div>
  </div>



  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
   

</body>
</html>