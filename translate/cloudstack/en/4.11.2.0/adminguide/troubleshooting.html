

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>故障排除 &mdash; Apache CloudStack 4.11.2.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/language_data.js"></script>
        <script type="text/javascript" src="https://assets.readthedocs.org/static/javascript/readthedocs-doc-embed.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="开发者手册" href="../developersguide/index.html" />
    <link rel="prev" title="Event Notification" href="events.html" /> 

<!-- RTD Extra Head -->

<!-- 
Always link to the latest version, as canonical.
http://docs.readthedocs.org/en/latest/canonical.html
-->
<link rel="canonical" href="troubleshooting.html" />

<link rel="stylesheet" href="https://assets.readthedocs.org/static/css/readthedocs-doc-embed.css" type="text/css" />

<script type="text/javascript" src="../_static/readthedocs-data.js"></script>

<!-- Add page-specific data, which must exist in the page js, not global -->
<script type="text/javascript">
READTHEDOCS_DATA['page'] = 'adminguide/troubleshooting'
READTHEDOCS_DATA['source_suffix'] = '.rst'
</script>

<script type="text/javascript" src="https://assets.readthedocs.org/static/javascript/readthedocs-analytics.js"></script>

<!-- end RTD <extrahead> -->
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> Apache CloudStack
          

          
          </a>

          
            
            
            
              <div class="version">
                4.11.2.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">目录:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../conceptsandterminology/index.html">CloudStack 概念和术语</a></li>
<li class="toctree-l1"><a class="reference internal" href="../quickinstallationguide/qig.html">快速入门指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../installguide/index.html">安装指南</a></li>
<li class="toctree-l1"><a class="reference internal" href="../upgrading/index.html">升级 CloudStack</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">使用手册</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="index.html#user-interface">用户界面</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#managing-accounts-users-and-domains">账户、用户和域</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#using-projects-to-organize-user-resources">用项目来管理用户资源</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#service-offerings">计算方案</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#setting-up-networking-for-users">设置用户网络</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#working-with-virtual-machines">虚拟机</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#working-with-templates">模板</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#working-with-hosts">主机</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#working-with-storage">存储</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#working-with-system-virtual-machines">系统虚拟机</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#working-with-usage">Working with Usage</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#managing-networks-and-traffic">Managing Networks and Traffic</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#managing-the-cloud">管理云</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#system-reliability-and-availability">系统的可靠性和可用性</a></li>
<li class="toctree-l2"><a class="reference internal" href="index.html#tuning">调优</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="index.html#events-and-troubleshooting">Events and Troubleshooting</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="events.html">Event Notification</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="troubleshooting.html#">故障排除</a><ul>
<li class="toctree-l4"><a class="reference internal" href="troubleshooting.html#working-with-server-logs">Working with Server Logs</a></li>
<li class="toctree-l4"><a class="reference internal" href="troubleshooting.html#data-loss-on-exported-primary-storage">Data Loss on Exported 主存储</a></li>
<li class="toctree-l4"><a class="reference internal" href="troubleshooting.html#recovering-a-lost-virtual-router">Recovering a Lost 虚拟路由器</a></li>
<li class="toctree-l4"><a class="reference internal" href="troubleshooting.html#maintenance-mode-not-working-on-vcenter">Maintenance mode not working on vCenter</a></li>
<li class="toctree-l4"><a class="reference internal" href="troubleshooting.html#unable-to-deploy-vms-from-uploaded-vsphere-template">Unable to deploy VMs from uploaded vSphere template</a></li>
<li class="toctree-l4"><a class="reference internal" href="troubleshooting.html#unable-to-power-on-virtual-machine-on-vmware">Unable to power on virtual machine on VMware</a></li>
<li class="toctree-l4"><a class="reference internal" href="troubleshooting.html#load-balancer-rules-fail-after-changing-network-offering">Load balancer rules fail after changing network offering</a></li>
<li class="toctree-l4"><a class="reference internal" href="troubleshooting.html#troubleshooting-internet-traffic">Troubleshooting Internet Traffic</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../developersguide/index.html">开发者手册</a></li>
<li class="toctree-l1"><a class="reference internal" href="../plugins/index.html">插件使用手册</a></li>
<li class="toctree-l1"><a class="reference internal" href="../releasenotes/index.html">发行版本说明</a></li>
</ul>
<p class="caption"><span class="caption-text">其它:</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="http://cloudstack.apache.org/api.html">API 文档</a></li>
<li class="toctree-l1"><a class="reference external" href="https://cwiki.apache.org/confluence/display/CLOUDSTACK/Home">Apache CloudStack Wiki</a></li>
<li class="toctree-l1"><a class="reference external" href="http://cloudstack.apache.org/">Apache CloudStack 官网</a></li>
<li class="toctree-l1"><a class="reference external" href="http://cloudstack.apache.org/downloads.html">Apache CloudStack 源码</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/apache/cloudstack">Apache CloudStack on GitHub</a></li>
</ul>
<p class="caption"><span class="caption-text">Pre 4.11 Documentation:</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="../../../projects/cloudstack-installation.html">安装指南</a></li>
<li class="toctree-l1"><a class="reference external" href="../../../projects/cloudstack-administration.html">管理员手册</a></li>
<li class="toctree-l1"><a class="reference external" href="../../../projects/cloudstack-release-notes.html">发行版本说明</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Apache CloudStack</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
          <li><a href="index.html">使用手册</a> &raquo;</li>
        
      <li>故障排除</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            
              <a href="https://github.com/apache/cloudstack-documentation/blob/4.11.2.0/source/adminguide/troubleshooting.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="troubleshooting">
<h1>故障排除<a class="headerlink" href="troubleshooting.html#troubleshooting" title="Permalink to this headline">¶</a></h1>
<div class="section" id="working-with-server-logs">
<h2>Working with Server Logs<a class="headerlink" href="troubleshooting.html#working-with-server-logs" title="Permalink to this headline">¶</a></h2>
<p>The CloudStack 管理服务 logs all web site, middle tier, and
database activities for diagnostics purposes in
<cite>/var/log/cloudstack/management/</cite>. The CloudStack logs a variety of error
messages. We recommend this command to find the problematic output in
the 管理服务 log:.</p>
<div class="admonition note">
<p class="first admonition-title">提示</p>
<p class="last">When copying and pasting a command, be sure the command has pasted as a
single line before executing. Some document viewers may introduce
unwanted line breaks in copied text.</p>
</div>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">grep</span> <span class="o">-</span><span class="n">i</span> <span class="o">-</span><span class="n">E</span> <span class="s1">&#39;exception|unable|fail|invalid|leak|warn|error&#39;</span> <span class="o">/</span><span class="n">var</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">cloudstack</span><span class="o">/</span><span class="n">management</span><span class="o">/</span><span class="n">management</span><span class="o">-</span><span class="n">server</span><span class="o">.</span><span class="n">log</span>
</pre></div>
</div>
<p>The CloudStack processes requests with a Job ID. If you find an error in
the logs and you are interested in debugging the issue you can grep for
this job ID in the management server log. For example, suppose that you
find the following ERROR message:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">2010</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">04</span> <span class="mi">13</span><span class="p">:</span><span class="mi">49</span><span class="p">:</span><span class="mi">32</span><span class="p">,</span><span class="mi">595</span> <span class="n">ERROR</span> <span class="p">[</span><span class="n">cloud</span><span class="o">.</span><span class="n">vm</span><span class="o">.</span><span class="n">UserVmManagerImpl</span><span class="p">]</span> <span class="p">(</span><span class="n">Job</span><span class="o">-</span><span class="n">Executor</span><span class="o">-</span><span class="mi">11</span><span class="p">:</span><span class="n">job</span><span class="o">-</span><span class="mi">1076</span><span class="p">)</span> <span class="n">Unable</span> <span class="n">to</span> <span class="n">find</span> <span class="nb">any</span> <span class="n">host</span> <span class="k">for</span> <span class="p">[</span><span class="n">User</span><span class="o">|</span><span class="n">i</span><span class="o">-</span><span class="mi">8</span><span class="o">-</span><span class="mi">42</span><span class="o">-</span><span class="n">VM</span><span class="o">-</span><span class="n">untagged</span><span class="p">]</span>
</pre></div>
</div>
<p>Note that the job ID is 1076. You can track back the events relating to
job 1076 with the following grep:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">grep</span> <span class="s2">&quot;job-1076)&quot;</span> <span class="n">management</span><span class="o">-</span><span class="n">server</span><span class="o">.</span><span class="n">log</span>
</pre></div>
</div>
<p>The CloudStack Agent Server logs its activities in <cite>/var/log/cloudstack/agent/</cite>.</p>
</div>
<div class="section" id="data-loss-on-exported-primary-storage">
<h2>Data Loss on Exported 主存储<a class="headerlink" href="troubleshooting.html#data-loss-on-exported-primary-storage" title="Permalink to this headline">¶</a></h2>
<div class="section" id="symptom">
<h3>Symptom<a class="headerlink" href="troubleshooting.html#symptom" title="Permalink to this headline">¶</a></h3>
<p>Loss of existing data on primary storage which has been exposed as a
Linux NFS server export on an iSCSI volume.</p>
</div>
<div class="section" id="cause">
<h3>Cause<a class="headerlink" href="troubleshooting.html#cause" title="Permalink to this headline">¶</a></h3>
<p>It is possible that a client from outside the intended pool has mounted
the storage. When this occurs, the LVM is wiped and all data in the
volume is lost</p>
</div>
<div class="section" id="solution">
<h3>Solution<a class="headerlink" href="troubleshooting.html#solution" title="Permalink to this headline">¶</a></h3>
<p>When setting up LUN exports, restrict the range of IP addresses that are
allowed access by specifying a subnet mask. For example:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span>echo “/export 192.168.1.0/24(rw,async,no_root_squash,no_subtree_check)” &gt; /etc/exports
</pre></div>
</div>
<p>Adjust the above command to suit your deployment needs.</p>
</div>
<div class="section" id="more-information">
<h3>More Information<a class="headerlink" href="troubleshooting.html#more-information" title="Permalink to this headline">¶</a></h3>
<p>See the export procedure in the “二级存储” section of the
CloudStack 安装指南</p>
</div>
</div>
<div class="section" id="recovering-a-lost-virtual-router">
<h2>Recovering a Lost 虚拟路由器<a class="headerlink" href="troubleshooting.html#recovering-a-lost-virtual-router" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id1">
<h3>Symptom<a class="headerlink" href="troubleshooting.html#id1" title="Permalink to this headline">¶</a></h3>
<p>A virtual router is running, but the host is disconnected. A virtual
router no longer functions as expected.</p>
</div>
<div class="section" id="id2">
<h3>Cause<a class="headerlink" href="troubleshooting.html#id2" title="Permalink to this headline">¶</a></h3>
<p>The Virtual router is lost or down.</p>
</div>
<div class="section" id="id3">
<h3>Solution<a class="headerlink" href="troubleshooting.html#id3" title="Permalink to this headline">¶</a></h3>
<p>If you are sure that a virtual router is down forever, or no longer
functions as expected, destroy it. You must create one afresh while
keeping the backup router up and running (it is assumed this is in a
redundant router setup):</p>
<ul class="simple">
<li>Force stop the router. Use the stopRouter API with forced=true
parameter to do so.</li>
<li>Before you continue with destroying this router, ensure that the
backup router is running. Otherwise the network connection will be
lost.</li>
<li>Destroy the router by using the destroyRouter API.</li>
</ul>
<p>Recreate the missing router by using the restartNetwork API with
cleanup=false parameter. For more information about redundant router
setup, see Creating a New Network Offering.</p>
<p>For more information about the API syntax, see the API Reference at
<a class="reference external" href="http://cloudstack.apache.org/docs/api/">http://cloudstack.apache.org/docs/api/</a>.</p>
</div>
</div>
<div class="section" id="maintenance-mode-not-working-on-vcenter">
<h2>Maintenance mode not working on vCenter<a class="headerlink" href="troubleshooting.html#maintenance-mode-not-working-on-vcenter" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id4">
<h3>Symptom<a class="headerlink" href="troubleshooting.html#id4" title="Permalink to this headline">¶</a></h3>
<p>Host was placed in maintenance mode, but still appears live in vCenter.</p>
</div>
<div class="section" id="id5">
<h3>Cause<a class="headerlink" href="troubleshooting.html#id5" title="Permalink to this headline">¶</a></h3>
<p>The CloudStack administrator UI was used to place the host in scheduled
maintenance mode. This mode is separate from vCenter’s maintenance mode.</p>
</div>
<div class="section" id="id6">
<h3>Solution<a class="headerlink" href="troubleshooting.html#id6" title="Permalink to this headline">¶</a></h3>
<p>Use vCenter to place the host in maintenance mode.</p>
</div>
</div>
<div class="section" id="unable-to-deploy-vms-from-uploaded-vsphere-template">
<h2>Unable to deploy VMs from uploaded vSphere template<a class="headerlink" href="troubleshooting.html#unable-to-deploy-vms-from-uploaded-vsphere-template" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id7">
<h3>Symptom<a class="headerlink" href="troubleshooting.html#id7" title="Permalink to this headline">¶</a></h3>
<p>When attempting to create a VM, the VM will not deploy.</p>
</div>
<div class="section" id="id8">
<h3>Cause<a class="headerlink" href="troubleshooting.html#id8" title="Permalink to this headline">¶</a></h3>
<p>If the template was created by uploading an OVA file that was created
using vSphere Client, it is possible the OVA contained an ISO image. If
it does, the deployment of VMs from the template will fail.</p>
</div>
<div class="section" id="id9">
<h3>Solution<a class="headerlink" href="troubleshooting.html#id9" title="Permalink to this headline">¶</a></h3>
<p>Remove the ISO and re-upload the template.</p>
</div>
</div>
<div class="section" id="unable-to-power-on-virtual-machine-on-vmware">
<h2>Unable to power on virtual machine on VMware<a class="headerlink" href="troubleshooting.html#unable-to-power-on-virtual-machine-on-vmware" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id10">
<h3>Symptom<a class="headerlink" href="troubleshooting.html#id10" title="Permalink to this headline">¶</a></h3>
<p>Virtual machine does not power on. You might see errors like:</p>
<ul class="simple">
<li>Unable to open Swap File</li>
<li>Unable to access a file since it is locked</li>
<li>Unable to access Virtual machine configuration</li>
</ul>
</div>
<div class="section" id="id11">
<h3>Cause<a class="headerlink" href="troubleshooting.html#id11" title="Permalink to this headline">¶</a></h3>
<p>A known issue on VMware machines. ESX hosts lock certain critical
virtual machine files and file systems to prevent concurrent changes.
Sometimes the files are not unlocked when the virtual machine is powered
off. When a virtual machine attempts to power on, it can not access
these critical files, and the virtual machine is unable to power on.</p>
</div>
<div class="section" id="id12">
<h3>Solution<a class="headerlink" href="troubleshooting.html#id12" title="Permalink to this headline">¶</a></h3>
<p>See the following:</p>
<p><a class="reference external" href="http://kb.vmware.com/selfservice/microsites/search.do?language=en_US&amp;cmd=displayKC&amp;externalId=10051/">VMware Knowledge Base Article</a></p>
</div>
</div>
<div class="section" id="load-balancer-rules-fail-after-changing-network-offering">
<h2>Load balancer rules fail after changing network offering<a class="headerlink" href="troubleshooting.html#load-balancer-rules-fail-after-changing-network-offering" title="Permalink to this headline">¶</a></h2>
<div class="section" id="id13">
<h3>Symptom<a class="headerlink" href="troubleshooting.html#id13" title="Permalink to this headline">¶</a></h3>
<p>After changing the network offering on a network, load balancer rules
stop working.</p>
</div>
<div class="section" id="id14">
<h3>Cause<a class="headerlink" href="troubleshooting.html#id14" title="Permalink to this headline">¶</a></h3>
<p>Load balancing rules were created while using a network service offering
that includes an external load balancer device such as NetScaler, and
later the network service offering changed to one that uses the
CloudStack virtual router.</p>
</div>
<div class="section" id="id15">
<h3>Solution<a class="headerlink" href="troubleshooting.html#id15" title="Permalink to this headline">¶</a></h3>
<p>Create a firewall rule on the virtual router for each of your existing
load balancing rules so that they continue to function.</p>
</div>
</div>
<div class="section" id="troubleshooting-internet-traffic">
<h2>Troubleshooting Internet Traffic<a class="headerlink" href="troubleshooting.html#troubleshooting-internet-traffic" title="Permalink to this headline">¶</a></h2>
<p>Below are a few troubleshooting steps to check whats going wrong with your
network…</p>
<div class="section" id="trouble-shooting-steps">
<h3>Trouble Shooting Steps<a class="headerlink" href="troubleshooting.html#trouble-shooting-steps" title="Permalink to this headline">¶</a></h3>
<ol class="arabic">
<li><p class="first">The switches have to be configured correctly to pass VLAN traffic. You can
verify if VLAN traffic is working by bringing up a tagged interface on the
hosts and pinging between them as below…</p>
<p>On <em>host1 (kvm1)</em></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>kvm1 ~$ vconfig add eth0 64
kvm1 ~$ ifconfig eth0.64 1.2.3.4 netmask 255.255.255.0 up
kvm1 ~$ ping 1.2.3.5
</pre></div>
</div>
<p>On <em>host2 (kvm2)</em></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>kvm2 ~$ vconfig add eth0 64
kvm2 ~$ ifconfig eth0.64 1.2.3.5 netmask 255.255.255.0 up
kvm2 ~$ ping 1.2.3.4
</pre></div>
</div>
<p>If the pings dont work, run <em>tcpdump(8)</em> all over the place to check
who is gobbling up the packets. Ultimately, if the switches are not
configured correctly, CloudStack networking wont work so fix the
physical networking issues before you proceed to the next steps</p>
</li>
<li><p class="first">Ensure <a class="reference external" href="http://cloudstack.apache.org/docs/en-US/Apache_CloudStack/4.2.0/html/Installation_Guide/about-physical-networks.html">Traffic Labels</a> are set for the Zone.</p>
<p>Traffic labels need to be set for all hypervisors including
XenServer, KVM and VMware types. You can configure traffic labels when
you creating a new zone from the <em>Add Zone Wizard</em>.</p>
<img alt="../_images/networking-zone-traffic-labels.png" src="../_images/networking-zone-traffic-labels.png" />
<p>On an existing zone, you can modify the traffic labels by going to
<em>Infrastructure, Zones, Physical Network</em> tab.</p>
<img alt="../_images/networking-infra-traffic-labels.png" src="../_images/networking-infra-traffic-labels.png" />
<p>List labels using <em>CloudMonkey</em></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>acs-manager ~$ cloudmonkey list traffictypes physicalnetworkid=41cb7ff6-8eb2-4630-b577-1da25e0e1145
count = 4
traffictype:
id = cd0915fe-a660-4a82-9df7-34aebf90003e
kvmnetworklabel = cloudbr0
physicalnetworkid = 41cb7ff6-8eb2-4630-b577-1da25e0e1145
traffictype = Guest
xennetworklabel = MGMT
========================================================
id = f5524b8f-6605-41e4-a982-81a356b2a196
kvmnetworklabel = cloudbr0
physicalnetworkid = 41cb7ff6-8eb2-4630-b577-1da25e0e1145
traffictype = Management
xennetworklabel = MGMT
========================================================
id = 266bad0e-7b68-4242-b3ad-f59739346cfd
kvmnetworklabel = cloudbr0
physicalnetworkid = 41cb7ff6-8eb2-4630-b577-1da25e0e1145
traffictype = Public
xennetworklabel = MGMT
========================================================
id = a2baad4f-7ce7-45a8-9caf-a0b9240adf04
kvmnetworklabel = cloudbr0
physicalnetworkid = 41cb7ff6-8eb2-4630-b577-1da25e0e1145
traffictype = Storage
xennetworklabel = MGMT
=========================================================
</pre></div>
</div>
</li>
<li><p class="first">KVM traffic labels require to be named as <em>“cloudbr0”</em>, <em>“cloudbr2”</em>,
<em>“cloudbrN”</em> etc and the corresponding bridge must exist on the KVM
hosts. If you create labels/bridges with any other names, CloudStack
(atleast earlier versions did) seems to ignore them. CloudStack does not
create the physical bridges on the KVM hosts, you need to create them
<strong>before</strong> before adding the host to Cloudstack.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>kvm1 ~$ ifconfig cloudbr0
cloudbr0  Link encap:Ethernet  HWaddr 00:0C:29:EF:7D:78
   inet addr:192.168.44.22  Bcast:192.168.44.255  Mask:255.255.255.0
   inet6 addr: fe80::20c:29ff:feef:7d78/64 Scope:Link
   UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
   RX packets:92435 errors:0 dropped:0 overruns:0 frame:0
   TX packets:50596 errors:0 dropped:0 overruns:0 carrier:0
   collisions:0 txqueuelen:0
   RX bytes:94985932 (90.5 MiB)  TX bytes:61635793 (58.7 MiB)
</pre></div>
</div>
</li>
<li><p class="first">The 虚拟路由器, SSVM, CPVM <em>public</em> interface would be bridged to
a physical interface on the host. In the example below, <em>cloudbr0</em> is
the public interface and CloudStack has correctly created the virtual
interfaces bridge. This virtual interface to physical interface mapping
is done automatically by CloudStack using the traffic label settings for
the Zone. If you have provided correct settings and still dont have a
working working Internet, check the switching layer before you debug any
further. You can verify traffic using tcpdump on the virtual, physical
and bridge interfaces.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>kvm-host1 ~$ brctl show
bridge name  bridge id           STP enabled interfaces
breth0-64    8000.000c29ef7d78   no          eth0.64
                                             vnet2
cloud0       8000.fe00a9fe0219   no          vnet0
cloudbr0     8000.000c29ef7d78   no          eth0
                                             vnet1
                                             vnet3
virbr0       8000.5254008e321a   yes         virbr0-nic
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>xenserver1 ~$ brctl show
bridge name  bridge id           STP enabled interfaces
xapi0    0000.e2b76d0a1149       no          vif1.0
xenbr0   0000.000c299b54dc       no          eth0
                                            xapi1
                                            vif1.1
                                            vif1.2
</pre></div>
</div>
</li>
<li><p class="first">Pre-create labels on the XenServer Hosts. Similar to KVM bridge
setup, traffic labels must also be pre-created on the XenServer hosts
before adding them to CloudStack.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>xenserver1 ~$ xe network-list
uuid ( RO)                : aaa-bbb-ccc-ddd
          name-label ( RW): MGMT
    name-description ( RW):
              bridge ( RO): xenbr0
</pre></div>
</div>
</li>
<li><p class="first">The Internet would be accessible from both the SSVM and CPVM
instances by default. Their public IPs will also be directly pingable
from the Internet. Please note that these test would work only if your
switches and traffic labels are configured correctly for your
environment. If your SSVM/CPVM cant reach the Internet, its very
unlikely that the 虚拟路由器 (VR) can also the reach the Internet
suggesting that its either a switching issue or incorrectly assigned
traffic labels. Fix the SSVM/CPVM issues before you debug VR issues.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">root</span><span class="nd">@s</span><span class="o">-</span><span class="mi">1</span><span class="o">-</span><span class="n">VM</span><span class="p">:</span><span class="o">~</span><span class="c1"># ping -c 3 google.com</span>
<span class="n">PING</span> <span class="n">google</span><span class="o">.</span><span class="n">com</span> <span class="p">(</span><span class="mf">74.125</span><span class="o">.</span><span class="mf">236.164</span><span class="p">):</span> <span class="mi">56</span> <span class="n">data</span> <span class="nb">bytes</span>
<span class="mi">64</span> <span class="nb">bytes</span> <span class="kn">from</span> <span class="mf">74.125</span><span class="o">.</span><span class="mf">236.164</span><span class="p">:</span> <span class="n">icmp_seq</span><span class="o">=</span><span class="mi">0</span> <span class="n">ttl</span><span class="o">=</span><span class="mi">55</span> <span class="n">time</span><span class="o">=</span><span class="mf">26.932</span> <span class="n">ms</span>
<span class="mi">64</span> <span class="nb">bytes</span> <span class="kn">from</span> <span class="mf">74.125</span><span class="o">.</span><span class="mf">236.164</span><span class="p">:</span> <span class="n">icmp_seq</span><span class="o">=</span><span class="mi">1</span> <span class="n">ttl</span><span class="o">=</span><span class="mi">55</span> <span class="n">time</span><span class="o">=</span><span class="mf">29.156</span> <span class="n">ms</span>
<span class="mi">64</span> <span class="nb">bytes</span> <span class="kn">from</span> <span class="mf">74.125</span><span class="o">.</span><span class="mf">236.164</span><span class="p">:</span> <span class="n">icmp_seq</span><span class="o">=</span><span class="mi">2</span> <span class="n">ttl</span><span class="o">=</span><span class="mi">55</span> <span class="n">time</span><span class="o">=</span><span class="mf">25.000</span> <span class="n">ms</span>
<span class="o">---</span> <span class="n">google</span><span class="o">.</span><span class="n">com</span> <span class="n">ping</span> <span class="n">statistics</span> <span class="o">---</span>
<span class="mi">3</span> <span class="n">packets</span> <span class="n">transmitted</span><span class="p">,</span> <span class="mi">3</span> <span class="n">packets</span> <span class="n">received</span><span class="p">,</span> <span class="mi">0</span><span class="o">%</span> <span class="n">packet</span> <span class="n">loss</span>
<span class="nb">round</span><span class="o">-</span><span class="n">trip</span> <span class="nb">min</span><span class="o">/</span><span class="n">avg</span><span class="o">/</span><span class="nb">max</span><span class="o">/</span><span class="n">stddev</span> <span class="o">=</span> <span class="mf">25.000</span><span class="o">/</span><span class="mf">27.029</span><span class="o">/</span><span class="mf">29.156</span><span class="o">/</span><span class="mf">1.698</span> <span class="n">ms</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">root</span><span class="nd">@v</span><span class="o">-</span><span class="mi">2</span><span class="o">-</span><span class="n">VM</span><span class="p">:</span><span class="o">~</span><span class="c1"># ping -c 3 google.com</span>
<span class="n">PING</span> <span class="n">google</span><span class="o">.</span><span class="n">com</span> <span class="p">(</span><span class="mf">74.125</span><span class="o">.</span><span class="mf">236.164</span><span class="p">):</span> <span class="mi">56</span> <span class="n">data</span> <span class="nb">bytes</span>
<span class="mi">64</span> <span class="nb">bytes</span> <span class="kn">from</span> <span class="mf">74.125</span><span class="o">.</span><span class="mf">236.164</span><span class="p">:</span> <span class="n">icmp_seq</span><span class="o">=</span><span class="mi">0</span> <span class="n">ttl</span><span class="o">=</span><span class="mi">55</span> <span class="n">time</span><span class="o">=</span><span class="mf">32.125</span> <span class="n">ms</span>
<span class="mi">64</span> <span class="nb">bytes</span> <span class="kn">from</span> <span class="mf">74.125</span><span class="o">.</span><span class="mf">236.164</span><span class="p">:</span> <span class="n">icmp_seq</span><span class="o">=</span><span class="mi">1</span> <span class="n">ttl</span><span class="o">=</span><span class="mi">55</span> <span class="n">time</span><span class="o">=</span><span class="mf">26.324</span> <span class="n">ms</span>
<span class="mi">64</span> <span class="nb">bytes</span> <span class="kn">from</span> <span class="mf">74.125</span><span class="o">.</span><span class="mf">236.164</span><span class="p">:</span> <span class="n">icmp_seq</span><span class="o">=</span><span class="mi">2</span> <span class="n">ttl</span><span class="o">=</span><span class="mi">55</span> <span class="n">time</span><span class="o">=</span><span class="mf">37.001</span> <span class="n">ms</span>
<span class="o">---</span> <span class="n">google</span><span class="o">.</span><span class="n">com</span> <span class="n">ping</span> <span class="n">statistics</span> <span class="o">---</span>
<span class="mi">3</span> <span class="n">packets</span> <span class="n">transmitted</span><span class="p">,</span> <span class="mi">3</span> <span class="n">packets</span> <span class="n">received</span><span class="p">,</span> <span class="mi">0</span><span class="o">%</span> <span class="n">packet</span> <span class="n">loss</span>
<span class="nb">round</span><span class="o">-</span><span class="n">trip</span> <span class="nb">min</span><span class="o">/</span><span class="n">avg</span><span class="o">/</span><span class="nb">max</span><span class="o">/</span><span class="n">stddev</span> <span class="o">=</span> <span class="mf">26.324</span><span class="o">/</span><span class="mf">31.817</span><span class="o">/</span><span class="mf">37.001</span><span class="o">/</span><span class="mf">4.364</span> <span class="n">ms</span>
</pre></div>
</div>
</li>
<li><p class="first">The 虚拟路由器 (VR) should also be able to reach the Internet
without having any Egress rules. The Egress rules only control forwarded
traffic and not traffic that originates on the VR itself.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">root</span><span class="nd">@r</span><span class="o">-</span><span class="mi">4</span><span class="o">-</span><span class="n">VM</span><span class="p">:</span><span class="o">~</span><span class="c1"># ping -c 3 google.com</span>
<span class="n">PING</span> <span class="n">google</span><span class="o">.</span><span class="n">com</span> <span class="p">(</span><span class="mf">74.125</span><span class="o">.</span><span class="mf">236.164</span><span class="p">):</span> <span class="mi">56</span> <span class="n">data</span> <span class="nb">bytes</span>
<span class="mi">64</span> <span class="nb">bytes</span> <span class="kn">from</span> <span class="mf">74.125</span><span class="o">.</span><span class="mf">236.164</span><span class="p">:</span> <span class="n">icmp_seq</span><span class="o">=</span><span class="mi">0</span> <span class="n">ttl</span><span class="o">=</span><span class="mi">55</span> <span class="n">time</span><span class="o">=</span><span class="mf">28.098</span> <span class="n">ms</span>
<span class="mi">64</span> <span class="nb">bytes</span> <span class="kn">from</span> <span class="mf">74.125</span><span class="o">.</span><span class="mf">236.164</span><span class="p">:</span> <span class="n">icmp_seq</span><span class="o">=</span><span class="mi">1</span> <span class="n">ttl</span><span class="o">=</span><span class="mi">55</span> <span class="n">time</span><span class="o">=</span><span class="mf">34.785</span> <span class="n">ms</span>
<span class="mi">64</span> <span class="nb">bytes</span> <span class="kn">from</span> <span class="mf">74.125</span><span class="o">.</span><span class="mf">236.164</span><span class="p">:</span> <span class="n">icmp_seq</span><span class="o">=</span><span class="mi">2</span> <span class="n">ttl</span><span class="o">=</span><span class="mi">55</span> <span class="n">time</span><span class="o">=</span><span class="mf">69.179</span> <span class="n">ms</span>
<span class="o">---</span> <span class="n">google</span><span class="o">.</span><span class="n">com</span> <span class="n">ping</span> <span class="n">statistics</span> <span class="o">---</span>
<span class="mi">3</span> <span class="n">packets</span> <span class="n">transmitted</span><span class="p">,</span> <span class="mi">3</span> <span class="n">packets</span> <span class="n">received</span><span class="p">,</span> <span class="mi">0</span><span class="o">%</span> <span class="n">packet</span> <span class="n">loss</span>
<span class="nb">round</span><span class="o">-</span><span class="n">trip</span> <span class="nb">min</span><span class="o">/</span><span class="n">avg</span><span class="o">/</span><span class="nb">max</span><span class="o">/</span><span class="n">stddev</span> <span class="o">=</span> <span class="mf">28.098</span><span class="o">/</span><span class="mf">44.021</span><span class="o">/</span><span class="mf">69.179</span><span class="o">/</span><span class="mf">17.998</span> <span class="n">ms</span>
</pre></div>
</div>
</li>
<li><p class="first">However, the 虚拟路由器’s (VR) Source NAT Public IP address
<strong>WONT</strong> be reachable until appropriate Ingress rules are
in place. You can add <em>Ingress</em> rules under <em>Network, Guest Network, IP
Address, Firewall</em> setting page.</p>
<img alt="../_images/networking-ingress-rule.png" src="../_images/networking-ingress-rule.png" />
</li>
<li><p class="first">The VM Instances by default wont be able to access the Internet. Add
Egress rules to permit traffic.</p>
<img alt="../_images/networking-egress-rule.png" src="../_images/networking-egress-rule.png" />
</li>
<li><p class="first">Some users have reported that flushing IPTables rules (or changing
routes) on the SSVM, CPVM or the 虚拟路由器 makes the Internet work.
This is not expected behaviour and suggests that your networking
settings are incorrect. No IPtables/route changes are required on the
SSVM, CPVM or the VR. Go back and double check all your settings.</p>
</li>
</ol>
<p>In a vast majority of the cases, the problem has turned out to be at the
switching layer where the L3 switches were configured incorrectly.</p>
<p>This section was contibuted by Shanker Balan and was originally published on
<a class="reference external" href="http://shankerbalan.net/blog/internet-not-working-on-cloudstack-vms/">Shapeblue’s blog</a></p>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../developersguide/index.html" class="btn btn-neutral float-right" title="开发者手册" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="events.html" class="btn btn-neutral float-left" title="Event Notification" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Apache Foundation
      
        <span class="commit">
          Revision <code>6d954f27</code>.
        </span>
      

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="fa fa-book"> Read the Docs</span>
      v: 4.11.2.0
      <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
      <dl>
        <dt>Versions</dt>
        
          <dd><a href="../../../index.html">latest</a></dd>
        
          <dd><a href="../index.html">4.11.2.0</a></dd>
        
          <dd><a href="../../4.11.1.0/index.html">4.11.1.0</a></dd>
        
          <dd><a href="http://docs.cloudstack.apache.org/en/master/">master</a></dd>
        
      </dl>
      <dl>
        <dt>Downloads</dt>
        
          <dd><a href="http://readthedocs.org/projects/cloudstack-documentation/downloads/htmlzip/4.11.2.0/">htmlzip</a></dd>
        
      </dl>
      <dl>
        <dt>On Read the Docs</dt>
          <dd>
            <a href="http://readthedocs.org/projects/cloudstack-documentation/?fromdocs=cloudstack-documentation">Project Home</a>
          </dd>
          <dd>
            <a href="http://readthedocs.org/builds/cloudstack-documentation/?fromdocs=cloudstack-documentation">Builds</a>
          </dd>
      </dl>
      <hr/>
      Free document hosting provided by <a href="http://www.readthedocs.org">Read the Docs</a>.

    </div>
  </div>



  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
   

</body>
</html>