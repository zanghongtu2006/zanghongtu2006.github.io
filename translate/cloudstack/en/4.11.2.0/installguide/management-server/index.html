

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>安装管理服务 &mdash; Apache CloudStack 4.11.2.0 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script type="text/javascript" src="../../_static/jquery.js"></script>
        <script type="text/javascript" src="../../_static/underscore.js"></script>
        <script type="text/javascript" src="../../_static/doctools.js"></script>
        <script type="text/javascript" src="../../_static/language_data.js"></script>
        <script type="text/javascript" src="https://assets.readthedocs.org/static/javascript/readthedocs-doc-embed.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="安装配置 CloudStack " href="../configuration.html" />
    <link rel="prev" title="安装概述" href="../overview/index.html" /> 

<!-- RTD Extra Head -->

<!-- 
Always link to the latest version, as canonical.
http://docs.readthedocs.org/en/latest/canonical.html
-->
<link rel="canonical" href="index.html" />

<link rel="stylesheet" href="https://assets.readthedocs.org/static/css/readthedocs-doc-embed.css" type="text/css" />

<script type="text/javascript" src="../../_static/readthedocs-data.js"></script>

<!-- Add page-specific data, which must exist in the page js, not global -->
<script type="text/javascript">
READTHEDOCS_DATA['page'] = 'installguide/management-server/index'
READTHEDOCS_DATA['source_suffix'] = '.rst'
</script>

<script type="text/javascript" src="https://assets.readthedocs.org/static/javascript/readthedocs-analytics.js"></script>

<!-- end RTD <extrahead> -->
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> Apache CloudStack
          

          
          </a>

          
            
            
            
              <div class="version">
                4.11.2.0
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">目录:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../conceptsandterminology/index.html">CloudStack 概念和术语</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../quickinstallationguide/qig.html">快速入门指南</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">安装指南</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../index.html#building-from-source">从源码编译安装</a></li>
<li class="toctree-l2 current"><a class="reference internal" href="../index.html#general-installation">通用安装指南</a><ul class="current">
<li class="toctree-l3"><a class="reference internal" href="../overview/index.html">安装概述</a></li>
<li class="toctree-l3 current"><a class="current reference internal" href="index.html#">安装管理服务</a><ul>
<li class="toctree-l4"><a class="reference internal" href="index.html#overview">概述</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#prepare-the-operating-system">Prepare the 操作系统</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#install-the-management-server-on-the-first-host">Install the 管理服务 on the First Host</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#downloading-vhd-util">Downloading vhd-util</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#install-the-database-server">Install the database server</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#prepare-nfs-shares">Prepare NFS Shares</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#additional-management-servers">Additional Management Servers</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#prepare-the-system-vm-template">Prepare the System VM Template</a></li>
<li class="toctree-l4"><a class="reference internal" href="index.html#installation-complete-next-steps">安装 Complete! Next Steps</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#configuration">Configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#hypervisor-setup">Hypervisor 安装和设置</a></li>
<li class="toctree-l2"><a class="reference internal" href="../index.html#optional-installation">Optional 安装</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../upgrading/index.html">升级 CloudStack</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../adminguide/index.html">使用手册</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../developersguide/index.html">开发者手册</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../plugins/index.html">插件使用手册</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../releasenotes/index.html">发行版本说明</a></li>
</ul>
<p class="caption"><span class="caption-text">其它:</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="http://cloudstack.apache.org/api.html">API 文档</a></li>
<li class="toctree-l1"><a class="reference external" href="https://cwiki.apache.org/confluence/display/CLOUDSTACK/Home">Apache CloudStack Wiki</a></li>
<li class="toctree-l1"><a class="reference external" href="http://cloudstack.apache.org/">Apache CloudStack 官网</a></li>
<li class="toctree-l1"><a class="reference external" href="http://cloudstack.apache.org/downloads.html">Apache CloudStack 源码</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/apache/cloudstack">Apache CloudStack on GitHub</a></li>
</ul>
<p class="caption"><span class="caption-text">Pre 4.11 Documentation:</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="../../../../projects/cloudstack-installation.html">安装指南</a></li>
<li class="toctree-l1"><a class="reference external" href="../../../../projects/cloudstack-administration.html">管理员手册</a></li>
<li class="toctree-l1"><a class="reference external" href="../../../../projects/cloudstack-release-notes.html">发行版本说明</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">Apache CloudStack</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">安装指南</a> &raquo;</li>
        
      <li>安装管理服务</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            
              <a href="https://github.com/apache/cloudstack-documentation/blob/4.11.2.0/source/installguide/management-server/index.rst" class="fa fa-github"> Edit on GitHub</a>
            
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="management-server-installation">
<span id="install-mgt"></span><h1>安装管理服务<a class="headerlink" href="index.html#management-server-installation" title="Permalink to this headline">¶</a></h1>
<div class="section" id="overview">
<h2>概述<a class="headerlink" href="index.html#overview" title="Permalink to this headline">¶</a></h2>
<p>This section describes installing the 管理服务. There are two
slightly different installation flows, depending on how many Management
Server nodes will be in your cloud:</p>
<ul class="simple">
<li>A single 管理服务 node, with MySQL on the same node.</li>
<li>Multiple 管理服务 nodes, with MySQL on a node separate from
the Management Servers.</li>
</ul>
<p>In either case, each machine must meet the system requirements described
in <a class="reference internal" href="../overview/index.html#minimum-system-requirements"><span class="std std-ref">Minimum System Requirements</span></a>.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">For the sake of security, be sure the public Internet can not access port
8096 or port 8250 on the 管理服务.</p>
</div>
<p>The procedure for installing the 管理服务 is:</p>
<ol class="arabic simple">
<li>Prepare the 操作系统</li>
<li>(XenServer only) Download and install vhd-util.</li>
<li>Install the First 管理服务</li>
<li>Install and Configure the MySQL database</li>
<li>Prepare NFS Shares</li>
<li>Prepare and Start Additional Management Servers (optional)</li>
<li>Prepare the System VM Template</li>
</ol>
</div>
<div class="section" id="prepare-the-operating-system">
<h2>Prepare the 操作系统<a class="headerlink" href="index.html#prepare-the-operating-system" title="Permalink to this headline">¶</a></h2>
<p>The OS must be prepared to host the 管理服务 using the
following steps. These steps must be performed on each 管理服务
node.</p>
<ol class="arabic">
<li><p class="first">Log in to your OS as root.</p>
</li>
<li><p class="first">Check for a fully qualified hostname.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">hostname</span> <span class="o">--</span><span class="n">fqdn</span>
</pre></div>
</div>
<p>This should return a fully qualified hostname such as
“management1.lab.example.org”. If it does not, edit /etc/hosts so
that it does.</p>
</li>
<li><p class="first">Make sure that the machine can reach the Internet.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ping</span> <span class="n">cloudstack</span><span class="o">.</span><span class="n">apache</span><span class="o">.</span><span class="n">org</span>
</pre></div>
</div>
</li>
<li><p class="first">Turn on NTP for time synchronization.</p>
<div class="admonition note">
<p class="first admonition-title">提示</p>
<p class="last">NTP is required to synchronize the clocks of the servers in your cloud.</p>
</div>
<p>Install NTP.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">yum</span> <span class="n">install</span> <span class="n">ntp</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">openntpd</span>
</pre></div>
</div>
</li>
<li><p class="first">Repeat all of these steps on every host where the 管理服务
will be installed.</p>
</li>
</ol>
</div>
<div class="section" id="install-the-management-server-on-the-first-host">
<h2>Install the 管理服务 on the First Host<a class="headerlink" href="index.html#install-the-management-server-on-the-first-host" title="Permalink to this headline">¶</a></h2>
<p>The first step in installation, whether you are installing the
管理服务 on one host or many, is to install the software on a
single node.</p>
<div class="admonition note">
<p class="first admonition-title">提示</p>
<p class="last">If you are planning to install the 管理服务 on multiple nodes for
high availability, do not proceed to the additional nodes yet. That step
will come later.</p>
</div>
<p>The CloudStack Management server can be installed using either RPM or
DEB packages. These packages will depend on everything you need to run
the Management server.</p>
<div class="section" id="configure-package-repository">
<h3>Configure package repository<a class="headerlink" href="index.html#configure-package-repository" title="Permalink to this headline">¶</a></h3>
<p>CloudStack is only distributed from source from the official mirrors.
However, members of the CloudStack community may build convenience
binaries so that users can install Apache CloudStack without needing to
build from source.</p>
<p>If you didn’t follow the steps to build your own packages from source in
the sections for <a class="reference external" href="../building_from_source.html#building-rpms-from-source">“Building RPMs from Source”</a> or
<a class="reference external" href="../building_from_source.html#building-deb-packages">“打包成 DEB”</a>
you may find pre-built DEB and RPM packages for your convenience linked from
the <a class="reference external" href="http://cloudstack.apache.org/downloads.html">downloads</a> page.</p>
<div class="admonition note">
<p class="first admonition-title">提示</p>
<p class="last">These repositories contain both the 管理服务 and KVM Hypervisor
packages.</p>
</div>
<div class="section" id="rpm-package-repository">
<h4>RPM package repository<a class="headerlink" href="index.html#rpm-package-repository" title="Permalink to this headline">¶</a></h4>
<p>There is a RPM package repository for CloudStack so you can easily
install on RHEL based platforms.</p>
<p>If you’re using an RPM-based system, you’ll want to add the Yum
repository so that you can install CloudStack with Yum.</p>
<p>Yum repository information is found under <code class="docutils literal notranslate"><span class="pre">/etc/yum.repos.d</span></code>. You’ll
see several <code class="docutils literal notranslate"><span class="pre">.repo</span></code> files in this directory, each one denoting a
specific repository.</p>
<p>To add the CloudStack repository, create
<code class="docutils literal notranslate"><span class="pre">/etc/yum.repos.d/cloudstack.repo</span></code> and insert the following
information.</p>
<pre class="literal-block">
[cloudstack]
name=cloudstack
baseurl=http://download.cloudstack.org/centos/$releasever/4.11/
enabled=1
gpgcheck=0
</pre>
<p>Now you should now be able to install CloudStack using Yum.</p>
</div>
<div class="section" id="deb-package-repository">
<h4>DEB package repository<a class="headerlink" href="index.html#deb-package-repository" title="Permalink to this headline">¶</a></h4>
<p>You can add a DEB package repository to your apt sources with the
following commands. Please note that only packages for Ubuntu 14.04 LTS
(Trusty) and Ubuntu 16.04 (Xenial) are being built at this time. DISCLAIMER: Ubuntu 12.04 (Precise) is no longer supported.</p>
<p>Use your preferred editor and open (or create)
<code class="docutils literal notranslate"><span class="pre">/etc/apt/sources.list.d/cloudstack.list</span></code>. Add the community provided
repository to the file:</p>
<pre class="literal-block">
deb <a class="reference external" href="http://download.cloudstack.org/ubuntu">http://download.cloudstack.org/ubuntu</a> trusty 4.11
</pre>
<p>We now have to add the public key to the trusted keys.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">wget</span> <span class="o">-</span><span class="n">O</span> <span class="o">-</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">download</span><span class="o">.</span><span class="n">cloudstack</span><span class="o">.</span><span class="n">org</span><span class="o">/</span><span class="n">release</span><span class="o">.</span><span class="n">asc</span><span class="o">|</span><span class="n">apt</span><span class="o">-</span><span class="n">key</span> <span class="n">add</span> <span class="o">-</span>
</pre></div>
</div>
<p>Now update your local apt cache.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">update</span>
</pre></div>
</div>
<p>Your DEB package repository should now be configured and ready for use.</p>
</div>
</div>
<div class="section" id="install-on-centos-rhel">
<h3>Install on CentOS/RHEL<a class="headerlink" href="index.html#install-on-centos-rhel" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">yum</span> <span class="n">install</span> <span class="n">cloudstack</span><span class="o">-</span><span class="n">management</span>
</pre></div>
</div>
</div>
<div class="section" id="install-on-ubuntu">
<h3>Install on Ubuntu<a class="headerlink" href="index.html#install-on-ubuntu" title="Permalink to this headline">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">cloudstack</span><span class="o">-</span><span class="n">management</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="downloading-vhd-util">
<h2>Downloading vhd-util<a class="headerlink" href="index.html#downloading-vhd-util" title="Permalink to this headline">¶</a></h2>
<p>This procedure is required only for installations where XenServer is
installed on the hypervisor hosts.</p>
<p>Before setting up the 管理服务, download
<a class="reference external" href="http://download.cloudstack.org/tools/vhd-util">vhd-util</a> from
<a class="reference external" href="http://download.cloudstack.org/tools/vhd-util">http://download.cloudstack.org/tools/vhd-util</a>.
and copy it into <code class="docutils literal notranslate"><span class="pre">/usr/share/cloudstack-common/scripts/vm/hypervisor/xenserver</span></code>
of the 管理服务.</p>
</div>
<div class="section" id="install-the-database-server">
<h2>Install the database server<a class="headerlink" href="index.html#install-the-database-server" title="Permalink to this headline">¶</a></h2>
<p>The CloudStack management server uses a MySQL database server to store
its data. When you are installing the management server on a single
node, you can install the MySQL server locally. For an installation that
has multiple management server nodes, we assume the MySQL database also
runs on a separate node.</p>
<p>CloudStack has been tested with MySQL 5.1 and 5.5. These versions are
included in RHEL/CentOS and Ubuntu.</p>
<div class="section" id="install-the-database-on-the-management-server-node">
<h3>Install the Database on the 管理服务 Node<a class="headerlink" href="index.html#install-the-database-on-the-management-server-node" title="Permalink to this headline">¶</a></h3>
<p>This section describes how to install MySQL on the same machine with the
管理服务. This technique is intended for a simple deployment
that has a single 管理服务 node. If you have a multi-node
管理服务 deployment, you will typically use a separate node for
MySQL. See <a class="reference internal" href="index.html#install-database-on-separate-node"><span class="std std-ref">Install the Database on a Separate Node</span></a>.</p>
<ol class="arabic">
<li><p class="first">Install MySQL from the package repository of your distribution:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">yum</span> <span class="n">install</span> <span class="n">mysql</span><span class="o">-</span><span class="n">server</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">mysql</span><span class="o">-</span><span class="n">server</span>
</pre></div>
</div>
</li>
<li><p class="first">Open the MySQL configuration file. The configuration file is
<code class="docutils literal notranslate"><span class="pre">/etc/my.cnf</span></code> or <code class="docutils literal notranslate"><span class="pre">/etc/mysql/my.cnf</span></code>, depending on your OS.</p>
<p>Insert the following lines in the <code class="docutils literal notranslate"><span class="pre">[mysqld]</span></code> section.</p>
<p>You can put these lines below the datadir line. The max_connections
parameter should be set to 350 multiplied by the number of Management
Servers you are deploying. This example assumes one Management
Server.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">innodb_rollback_on_timeout</span><span class="o">=</span><span class="mi">1</span>
<span class="n">innodb_lock_wait_timeout</span><span class="o">=</span><span class="mi">600</span>
<span class="n">max_connections</span><span class="o">=</span><span class="mi">350</span>
<span class="n">log</span><span class="o">-</span><span class="nb">bin</span><span class="o">=</span><span class="n">mysql</span><span class="o">-</span><span class="nb">bin</span>
<span class="n">binlog</span><span class="o">-</span><span class="nb">format</span> <span class="o">=</span> <span class="s1">&#39;ROW&#39;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">提示</p>
<p class="last">You can also create a file <code class="docutils literal notranslate"><span class="pre">/etc/mysql/conf.d/cloudstack.cnf</span></code>
and add these directives there. Don’t forget to add <code class="docutils literal notranslate"><span class="pre">[mysqld]</span></code> on the
first line of the file.</p>
</div>
</li>
<li><p class="first">Start or restart MySQL to put the new configuration into effect.</p>
<p>On RHEL/CentOS, MySQL doesn’t automatically start after installation.
Start it manually.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">service</span> <span class="n">mysqld</span> <span class="n">start</span>
</pre></div>
</div>
<p>On Ubuntu, restart MySQL.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">service</span> <span class="n">mysql</span> <span class="n">restart</span>
</pre></div>
</div>
</li>
<li><p class="first">(CentOS and RHEL only; not required on Ubuntu)</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">On RHEL and CentOS, MySQL does not set a root password by default. It is
very strongly recommended that you set a root password as a security
precaution.</p>
</div>
<p>Run the following command to secure your installation. You can answer “Y”
to all questions.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mysql_secure_installation</span>
</pre></div>
</div>
</li>
<li><p class="first">CloudStack can be blocked by security mechanisms, such as SELinux.
Disable SELinux to ensure + that the Agent has all the required
permissions.</p>
<p>Configure SELinux (RHEL and CentOS):</p>
<ol class="arabic">
<li><p class="first">Check whether SELinux is installed on your machine. If not, you
can skip this section.</p>
<p>In RHEL or CentOS, SELinux is installed and enabled by default.
You can verify this with:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">rpm</span> <span class="o">-</span><span class="n">qa</span> <span class="o">|</span> <span class="n">grep</span> <span class="n">selinux</span>
</pre></div>
</div>
</li>
<li><p class="first">Set the SELINUX variable in <code class="docutils literal notranslate"><span class="pre">/etc/selinux/config</span></code> to
“permissive”. This ensures that the permissive setting will be
maintained after a system reboot.</p>
<p>In RHEL or CentOS:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vi</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">selinux</span><span class="o">/</span><span class="n">config</span>
</pre></div>
</div>
<p>Change the following line</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELINUX</span><span class="o">=</span><span class="n">enforcing</span>
</pre></div>
</div>
<p>to this:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELINUX</span><span class="o">=</span><span class="n">permissive</span>
</pre></div>
</div>
</li>
<li><p class="first">Set SELinux to permissive starting immediately, without requiring
a system reboot.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">setenforce</span> <span class="n">permissive</span>
</pre></div>
</div>
</li>
</ol>
</li>
<li><p class="first">Set up the database. The following command creates the “cloud” user
on the database.</p>
<pre class="literal-block">
cloudstack-setup-databases cloud:&lt;dbpassword&gt;&#64;localhost --deploy-as=root:&lt;password&gt; -e &lt;encryption_type&gt; -m &lt;management_server_key&gt; -k &lt;database_key&gt; -i &lt;management_server_ip&gt;
</pre>
<ul class="simple">
<li>In dbpassword, specify the password to be assigned to the “cloud”
user. You can choose to provide no password although that is not
recommended.</li>
<li>In deploy-as, specify the username and password of the user
deploying the database. In the following command, it is assumed
the root user is deploying the database and creating the “cloud”
user.</li>
<li>（可选） For encryption_type, use file or web to indicate the
technique used to pass in the database encryption password.
Default: file. See <a class="reference internal" href="../encryption.html#about-password-key-encryption"><span class="std std-ref">密码和加密密钥</span></a>.</li>
<li>（可选） For management_server_key, substitute the default key
that is used to encrypt confidential parameters in the CloudStack
properties file. Default: password. It is highly recommended that
you replace this with a more secure value. See
<a class="reference internal" href="../encryption.html#about-password-key-encryption"><span class="std std-ref">密码和加密密钥</span></a>.</li>
<li>（可选） For database_key, substitute the default key that is
used to encrypt confidential parameters in the CloudStack
database. Default: password. It is highly recommended that you
replace this with a more secure value. See
<a class="reference internal" href="../encryption.html#about-password-key-encryption"><span class="std std-ref">密码和加密密钥</span></a>.</li>
<li>（可选） For management_server_ip, you may explicitly specify
cluster management server node IP. If not specified, the local IP
address will be used.</li>
</ul>
<p>When this script is finished, you should see a message like
“Successfully initialized the database.”</p>
<div class="admonition note">
<p class="first admonition-title">提示</p>
<p class="last">If the script is unable to connect to the MySQL database, check the
“localhost” loopback address in <code class="docutils literal notranslate"><span class="pre">/etc/hosts</span></code>. It should be pointing to
the IPv4 loopback address “127.0.0.1” and not the IPv6 loopback address
<code class="docutils literal notranslate"><span class="pre">::1</span></code>. Alternatively, reconfigure MySQL to bind to the IPv6 loopback
interface.</p>
</div>
</li>
<li><p class="first">If you are running the KVM hypervisor on the same machine with the
管理服务, edit /etc/sudoers and add the following line:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Defaults:cloud !requiretty
</pre></div>
</div>
</li>
<li><p class="first">Now that the database is set up, you can finish configuring the OS
for the 管理服务. This command will set up iptables,
sudoers, and start the 管理服务.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cloudstack</span><span class="o">-</span><span class="n">setup</span><span class="o">-</span><span class="n">management</span>
</pre></div>
</div>
<p>You should get the output message “CloudStack 管理服务 setup is
done.”
If the servlet container is Tomcat7 the argument –tomcat7 must be used.</p>
</li>
</ol>
</div>
<div class="section" id="install-the-database-on-a-separate-node">
<span id="install-database-on-separate-node"></span><h3>Install the Database on a Separate Node<a class="headerlink" href="index.html#install-the-database-on-a-separate-node" title="Permalink to this headline">¶</a></h3>
<p>This section describes how to install MySQL on a standalone machine,
separate from the 管理服务. This technique is intended for a
deployment that includes several 管理服务 nodes. If you have a
single-node 管理服务 deployment, you will typically use the
same node for MySQL. See <a class="reference external" href="index.html#install-the-database-on-the-management-server-node">“Install the Database on the 管理服务 Node”</a>.</p>
<div class="admonition note">
<p class="first admonition-title">提示</p>
<p class="last">The management server doesn’t require a specific distribution for the MySQL
node. You can use a distribution or 操作系统 of your choice. Using
the same distribution as the management server is recommended, but not
required. See <a class="reference external" href="index.html#management-server-database-and-storage-system-requirements">“管理服务, Database, and Storage System Requirements”</a>.</p>
</div>
<ol class="arabic">
<li><p class="first">Install MySQL from the package repository from your distribution:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">yum</span> <span class="n">install</span> <span class="n">mysql</span><span class="o">-</span><span class="n">server</span>
</pre></div>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">mysql</span><span class="o">-</span><span class="n">server</span>
</pre></div>
</div>
</li>
<li><p class="first">Edit the MySQL configuration (/etc/my.cnf or /etc/mysql/my.cnf,
depending on your OS) and insert the following lines in the [mysqld]
section. You can put these lines below the datadir line. The
max_connections parameter should be set to 350 multiplied by the
number of Management Servers you are deploying. This example assumes
two Management Servers.</p>
<div class="admonition note">
<p class="first admonition-title">提示</p>
<p class="last">On Ubuntu, you can also create /etc/mysql/conf.d/cloudstack.cnf file and
add these directives there. Don’t forget to add [mysqld] on the first
line of the file.</p>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">innodb_rollback_on_timeout</span><span class="o">=</span><span class="mi">1</span>
<span class="n">innodb_lock_wait_timeout</span><span class="o">=</span><span class="mi">600</span>
<span class="n">max_connections</span><span class="o">=</span><span class="mi">700</span>
<span class="n">log</span><span class="o">-</span><span class="nb">bin</span><span class="o">=</span><span class="n">mysql</span><span class="o">-</span><span class="nb">bin</span>
<span class="n">binlog</span><span class="o">-</span><span class="nb">format</span> <span class="o">=</span> <span class="s1">&#39;ROW&#39;</span>
<span class="n">bind</span><span class="o">-</span><span class="n">address</span> <span class="o">=</span> <span class="mf">0.0</span><span class="o">.</span><span class="mf">0.0</span>
</pre></div>
</div>
</li>
<li><p class="first">Start or restart MySQL to put the new configuration into effect.</p>
<p>On RHEL/CentOS, MySQL doesn’t automatically start after installation.
Start it manually.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">service</span> <span class="n">mysqld</span> <span class="n">start</span>
</pre></div>
</div>
<p>On Ubuntu, restart MySQL.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">service</span> <span class="n">mysql</span> <span class="n">restart</span>
</pre></div>
</div>
</li>
<li><p class="first">(CentOS and RHEL only; not required on Ubuntu)</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">On RHEL and CentOS, MySQL does not set a root password by default. It is
very strongly recommended that you set a root password as a security
precaution. Run the following command to secure your installation. You
can answer “Y” to all questions except “Disallow root login remotely?”.
Remote root login is required to set up the databases.</p>
</div>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mysql_secure_installation</span>
</pre></div>
</div>
</li>
<li><p class="first">If a firewall is present on the system, open TCP port 3306 so
external MySQL connections can be established.</p>
<p>On Ubuntu, UFW is the default firewall. Open the port with this
command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ufw</span> <span class="n">allow</span> <span class="n">mysql</span>
</pre></div>
</div>
<p>On RHEL/CentOS:</p>
<ol class="arabic">
<li><p class="first">Edit the /etc/sysconfig/iptables file and add the following line
at the beginning of the INPUT chain.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">--</span><span class="n">dport</span> <span class="mi">3306</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
</pre></div>
</div>
</li>
<li><p class="first">Now reload the iptables rules.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">service</span> <span class="n">iptables</span> <span class="n">restart</span>
</pre></div>
</div>
</li>
</ol>
</li>
<li><p class="first">Return to the root shell on your first 管理服务.</p>
</li>
<li><p class="first">Set up the database. The following command creates the cloud user on
the database.</p>
<ul class="simple">
<li>In dbpassword, specify the password to be assigned to the cloud
user. You can choose to provide no password.</li>
<li>In deploy-as, specify the username and password of the user
deploying the database. In the following command, it is assumed
the root user is deploying the database and creating the cloud
user.</li>
<li>（可选） For encryption_type, use file or web to indicate the
technique used to pass in the database encryption password.
Default: file. See <a class="reference internal" href="../encryption.html#about-password-key-encryption"><span class="std std-ref">密码和加密密钥</span></a>.</li>
<li>（可选） For management_server_key, substitute the default key
that is used to encrypt confidential parameters in the CloudStack
properties file. Default: password. It is highly recommended that
you replace this with a more secure value. See About Password and
Key Encryption.</li>
<li>（可选） For database_key, substitute the default key that is
used to encrypt confidential parameters in the CloudStack
database. Default: password. It is highly recommended that you
replace this with a more secure value. See
<a class="reference internal" href="../encryption.html#about-password-key-encryption"><span class="std std-ref">密码和加密密钥</span></a>.</li>
<li>（可选） For management_server_ip, you may explicitly specify
cluster management server node IP. If not specified, the local IP
address will be used.</li>
</ul>
<pre class="literal-block">
cloudstack-setup-databases cloud:&lt;dbpassword&gt;&#64;&lt;ip address mysql server&gt; --deploy-as=root:&lt;password&gt; -e &lt;encryption_type&gt; -m &lt;management_server_key&gt; -k &lt;database_key&gt; -i &lt;management_server_ip&gt;
</pre>
<p>When this script is finished, you should see a message like
“Successfully initialized the database.”</p>
</li>
<li><p class="first">Now that the database is set up, you can finish configuring the OS
for the 管理服务. This command will set up iptables,
sudoers, and start the 管理服务.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cloudstack</span><span class="o">-</span><span class="n">setup</span><span class="o">-</span><span class="n">management</span>
</pre></div>
</div>
<p>You should get the output message “CloudStack 管理服务 setup is
done.”</p>
</li>
</ol>
</div>
</div>
<div class="section" id="prepare-nfs-shares">
<span id="id2"></span><h2>Prepare NFS Shares<a class="headerlink" href="index.html#prepare-nfs-shares" title="Permalink to this headline">¶</a></h2>
<p>CloudStack needs a place to keep primary and secondary storage (see
Cloud 基础设施概述). Both of these can be NFS shares. This
section tells how to set up the NFS shares before adding the storage to
CloudStack.</p>
<div class="admonition note">
<p class="first admonition-title">提示</p>
<p class="last">NFS is not the only option for primary or secondary storage. For example,
you may use Ceph RBD, GlusterFS, iSCSI, and others. The choice of storage
system will depend on the choice of hypervisor and whether you are dealing
with primary or secondary storage.</p>
</div>
<p>The requirements for primary and secondary storage are described in:</p>
<ul class="simple">
<li><a class="reference internal" href="../../conceptsandterminology/storage_setup.html#about-primary-storage"><span class="std std-ref">主存储</span></a></li>
<li><a class="reference internal" href="../../conceptsandterminology/storage_setup.html#about-secondary-storage"><span class="std std-ref">二级存储</span></a></li>
</ul>
<p>A production installation typically uses a separate NFS server.
See <a class="reference internal" href="index.html#using-a-separage-nfs-server"><span class="std std-ref">Using a Separate NFS Server</span></a>.</p>
<p>You can also use the 管理服务 node as the NFS server. This is
more typical of a trial installation, but is technically possible in a
larger deployment. See <a class="reference internal" href="index.html#using-the-management-server-as-the-nfs-server"><span class="std std-ref">Using the 管理服务 as the NFS Server</span></a>.</p>
<div class="section" id="using-a-separate-nfs-server">
<span id="using-a-separage-nfs-server"></span><h3>Using a Separate NFS Server<a class="headerlink" href="index.html#using-a-separate-nfs-server" title="Permalink to this headline">¶</a></h3>
<p>This section tells how to set up NFS shares for secondary and
(optionally) primary storage on an NFS server running on a separate node
from the 管理服务.</p>
<p>The exact commands for the following steps may vary depending on your
operating system version.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">(KVM only) Ensure that no volume is already mounted at your NFS mount point.</p>
</div>
<ol class="arabic">
<li><p class="first">On the storage server, create an NFS share for secondary storage and,
if you are using NFS for primary storage as well, create a second NFS
share. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="o">/</span><span class="n">export</span><span class="o">/</span><span class="n">primary</span>
<span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="o">/</span><span class="n">export</span><span class="o">/</span><span class="n">secondary</span>
</pre></div>
</div>
</li>
<li><p class="first">To configure the new directories as NFS exports, edit /etc/exports.
Export the NFS share(s) with
rw,async,no_root_squash,no_subtree_check. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vi</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">exports</span>
</pre></div>
</div>
<p>Insert the following line.</p>
<pre class="literal-block">
/export  *(rw,async,no_root_squash,no_subtree_check)
</pre>
</li>
<li><p class="first">Export the /export directory.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">exportfs</span> <span class="o">-</span><span class="n">a</span>
</pre></div>
</div>
</li>
<li><p class="first">On the management server, create a mount point for secondary storage.
For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">secondary</span>
</pre></div>
</div>
</li>
<li><p class="first">Mount the secondary storage on your 管理服务. Replace the
example NFS server name and NFS share paths below with your own.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mount</span> <span class="o">-</span><span class="n">t</span> <span class="n">nfs</span> <span class="n">nfsservername</span><span class="p">:</span><span class="o">/</span><span class="n">export</span><span class="o">/</span><span class="n">secondary</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">secondary</span>
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="using-the-management-server-as-the-nfs-server">
<span id="id3"></span><h3>Using the 管理服务 as the NFS Server<a class="headerlink" href="index.html#using-the-management-server-as-the-nfs-server" title="Permalink to this headline">¶</a></h3>
<p>This section tells how to set up NFS shares for primary and secondary
storage on the same node with the 管理服务. This is more
typical of a trial installation, but is technically possible in a larger
deployment. It is assumed that you will have less than 16TB of storage
on the host.</p>
<p>The exact commands for the following steps may vary depending on your
operating system version.</p>
<ol class="arabic">
<li><p class="first">On RHEL/CentOS systems, you’ll need to install the nfs-utils package:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">yum</span> <span class="n">install</span> <span class="n">nfs</span><span class="o">-</span><span class="n">utils</span>
</pre></div>
</div>
</li>
<li><p class="first">On the 管理服务 host, create two directories that you will
use for primary and secondary storage. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="o">/</span><span class="n">export</span><span class="o">/</span><span class="n">primary</span>
<span class="n">mkdir</span> <span class="o">-</span><span class="n">p</span> <span class="o">/</span><span class="n">export</span><span class="o">/</span><span class="n">secondary</span>
</pre></div>
</div>
</li>
<li><p class="first">To configure the new directories as NFS exports, edit /etc/exports.
Export the NFS share(s) with
rw,async,no_root_squash,no_subtree_check. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vi</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">exports</span>
</pre></div>
</div>
<p>Insert the following line.</p>
<pre class="literal-block">
/export  *(rw,async,no_root_squash,no_subtree_check)
</pre>
</li>
<li><p class="first">Export the /export directory.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">exportfs</span> <span class="o">-</span><span class="n">a</span>
</pre></div>
</div>
</li>
<li><p class="first">Edit the /etc/sysconfig/nfs file.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vi</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">sysconfig</span><span class="o">/</span><span class="n">nfs</span>
</pre></div>
</div>
<p>Uncomment the following lines:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">LOCKD_TCPPORT</span><span class="o">=</span><span class="mi">32803</span>
<span class="n">LOCKD_UDPPORT</span><span class="o">=</span><span class="mi">32769</span>
<span class="n">MOUNTD_PORT</span><span class="o">=</span><span class="mi">892</span>
<span class="n">RQUOTAD_PORT</span><span class="o">=</span><span class="mi">875</span>
<span class="n">STATD_PORT</span><span class="o">=</span><span class="mi">662</span>
<span class="n">STATD_OUTGOING_PORT</span><span class="o">=</span><span class="mi">2020</span>
</pre></div>
</div>
</li>
<li><p class="first">Edit the /etc/sysconfig/iptables file.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vi</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">sysconfig</span><span class="o">/</span><span class="n">iptables</span>
</pre></div>
</div>
<p>Add the following lines at the beginning of the INPUT chain, where
&lt;NETWORK&gt; is the network that you’ll be using:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">s</span> <span class="o">&lt;</span><span class="n">NETWORK</span><span class="o">&gt;</span> <span class="o">-</span><span class="n">m</span> <span class="n">state</span> <span class="o">--</span><span class="n">state</span> <span class="n">NEW</span> <span class="o">-</span><span class="n">p</span> <span class="n">udp</span> <span class="o">--</span><span class="n">dport</span> <span class="mi">111</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
<span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">s</span> <span class="o">&lt;</span><span class="n">NETWORK</span><span class="o">&gt;</span> <span class="o">-</span><span class="n">m</span> <span class="n">state</span> <span class="o">--</span><span class="n">state</span> <span class="n">NEW</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">--</span><span class="n">dport</span> <span class="mi">111</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
<span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">s</span> <span class="o">&lt;</span><span class="n">NETWORK</span><span class="o">&gt;</span> <span class="o">-</span><span class="n">m</span> <span class="n">state</span> <span class="o">--</span><span class="n">state</span> <span class="n">NEW</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">--</span><span class="n">dport</span> <span class="mi">2049</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
<span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">s</span> <span class="o">&lt;</span><span class="n">NETWORK</span><span class="o">&gt;</span> <span class="o">-</span><span class="n">m</span> <span class="n">state</span> <span class="o">--</span><span class="n">state</span> <span class="n">NEW</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">--</span><span class="n">dport</span> <span class="mi">32803</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
<span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">s</span> <span class="o">&lt;</span><span class="n">NETWORK</span><span class="o">&gt;</span> <span class="o">-</span><span class="n">m</span> <span class="n">state</span> <span class="o">--</span><span class="n">state</span> <span class="n">NEW</span> <span class="o">-</span><span class="n">p</span> <span class="n">udp</span> <span class="o">--</span><span class="n">dport</span> <span class="mi">32769</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
<span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">s</span> <span class="o">&lt;</span><span class="n">NETWORK</span><span class="o">&gt;</span> <span class="o">-</span><span class="n">m</span> <span class="n">state</span> <span class="o">--</span><span class="n">state</span> <span class="n">NEW</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">--</span><span class="n">dport</span> <span class="mi">892</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
<span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">s</span> <span class="o">&lt;</span><span class="n">NETWORK</span><span class="o">&gt;</span> <span class="o">-</span><span class="n">m</span> <span class="n">state</span> <span class="o">--</span><span class="n">state</span> <span class="n">NEW</span> <span class="o">-</span><span class="n">p</span> <span class="n">udp</span> <span class="o">--</span><span class="n">dport</span> <span class="mi">892</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
<span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">s</span> <span class="o">&lt;</span><span class="n">NETWORK</span><span class="o">&gt;</span> <span class="o">-</span><span class="n">m</span> <span class="n">state</span> <span class="o">--</span><span class="n">state</span> <span class="n">NEW</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">--</span><span class="n">dport</span> <span class="mi">875</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
<span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">s</span> <span class="o">&lt;</span><span class="n">NETWORK</span><span class="o">&gt;</span> <span class="o">-</span><span class="n">m</span> <span class="n">state</span> <span class="o">--</span><span class="n">state</span> <span class="n">NEW</span> <span class="o">-</span><span class="n">p</span> <span class="n">udp</span> <span class="o">--</span><span class="n">dport</span> <span class="mi">875</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
<span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">s</span> <span class="o">&lt;</span><span class="n">NETWORK</span><span class="o">&gt;</span> <span class="o">-</span><span class="n">m</span> <span class="n">state</span> <span class="o">--</span><span class="n">state</span> <span class="n">NEW</span> <span class="o">-</span><span class="n">p</span> <span class="n">tcp</span> <span class="o">--</span><span class="n">dport</span> <span class="mi">662</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
<span class="o">-</span><span class="n">A</span> <span class="n">INPUT</span> <span class="o">-</span><span class="n">s</span> <span class="o">&lt;</span><span class="n">NETWORK</span><span class="o">&gt;</span> <span class="o">-</span><span class="n">m</span> <span class="n">state</span> <span class="o">--</span><span class="n">state</span> <span class="n">NEW</span> <span class="o">-</span><span class="n">p</span> <span class="n">udp</span> <span class="o">--</span><span class="n">dport</span> <span class="mi">662</span> <span class="o">-</span><span class="n">j</span> <span class="n">ACCEPT</span>
</pre></div>
</div>
</li>
<li><p class="first">Run the following commands:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">service</span> <span class="n">iptables</span> <span class="n">restart</span>
<span class="n">service</span> <span class="n">iptables</span> <span class="n">save</span>
</pre></div>
</div>
</li>
<li><p class="first">If NFS v4 communication is used between client and server, add your
domain to /etc/idmapd.conf on both the hypervisor host and Management
Server.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">vi</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">idmapd</span><span class="o">.</span><span class="n">conf</span>
</pre></div>
</div>
<p>Remove the character # from the beginning of the Domain line in
idmapd.conf and replace the value in the file with your own domain.
In the example below, the domain is company.com.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Domain</span> <span class="o">=</span> <span class="n">company</span><span class="o">.</span><span class="n">com</span>
</pre></div>
</div>
</li>
<li><p class="first">Reboot the 管理服务 host.</p>
<p>Two NFS shares called /export/primary and /export/secondary are now
set up.</p>
</li>
<li><p class="first">It is recommended that you test to be sure the previous steps have
been successful.</p>
<ol class="arabic">
<li><p class="first">Log in to the hypervisor host.</p>
</li>
<li><p class="first">Be sure NFS and rpcbind are running. The commands might be
different depending on your OS. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">service</span> <span class="n">rpcbind</span> <span class="n">start</span>
<span class="n">service</span> <span class="n">nfs</span> <span class="n">start</span>
<span class="n">chkconfig</span> <span class="n">nfs</span> <span class="n">on</span>
<span class="n">chkconfig</span> <span class="n">rpcbind</span> <span class="n">on</span>
<span class="n">reboot</span>
</pre></div>
</div>
</li>
<li><p class="first">Log back in to the hypervisor host and try to mount the /export
directories. For example, substitute your own management server
name:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mkdir</span> <span class="o">/</span><span class="n">primary</span>
<span class="n">mount</span> <span class="o">-</span><span class="n">t</span> <span class="n">nfs</span> <span class="o">&lt;</span><span class="n">management</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="n">name</span><span class="o">&gt;</span><span class="p">:</span><span class="o">/</span><span class="n">export</span><span class="o">/</span><span class="n">primary</span>
<span class="n">umount</span> <span class="o">/</span><span class="n">primary</span>
<span class="n">mkdir</span> <span class="o">/</span><span class="n">secondary</span>
<span class="n">mount</span> <span class="o">-</span><span class="n">t</span> <span class="n">nfs</span> <span class="o">&lt;</span><span class="n">management</span><span class="o">-</span><span class="n">server</span><span class="o">-</span><span class="n">name</span><span class="o">&gt;</span><span class="p">:</span><span class="o">/</span><span class="n">export</span><span class="o">/</span><span class="n">secondary</span>
<span class="n">umount</span> <span class="o">/</span><span class="n">secondary</span>
</pre></div>
</div>
</li>
</ol>
</li>
</ol>
</div>
</div>
<div class="section" id="additional-management-servers">
<h2>Additional Management Servers<a class="headerlink" href="index.html#additional-management-servers" title="Permalink to this headline">¶</a></h2>
<p>For your second and subsequent Management Servers, you will install the
管理服务 software, connect it to the database, and set up the
OS for the 管理服务.</p>
<ol class="arabic">
<li><p class="first">Perform the steps in <a class="reference external" href="index.html#prepare-the-operating-system">“Prepare the 操作系统”</a> and <a class="reference external" href="http://docs.cloudstack.apache.org/en/4.11.2.0/installguide/management-server/building_from_source.html#building-rpms-from-source">“打包成 RPM”</a> or
<a class="reference external" href="http://docs.cloudstack.apache.org/en/4.11.2.0/installguide/management-server/building_from_source.html#building-deb-packages">“打包成 DEB”</a> as appropriate.</p>
</li>
<li><p class="first">This step is required only for installations where XenServer is
installed on the hypervisor hosts.</p>
<p>Download vhd-util from
<a class="reference external" href="http://download.cloudstack.org/tools/vhd-util">vhd-util</a></p>
<p>Copy vhd-util to
<code class="docutils literal notranslate"><span class="pre">/usr/share/cloudstack-common/scripts/vm/hypervisor/xenserver</span></code>.</p>
</li>
<li><p class="first">Ensure that necessary services are started and set to start on boot.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">service</span> <span class="n">rpcbind</span> <span class="n">start</span>
<span class="n">service</span> <span class="n">nfs</span> <span class="n">start</span>
<span class="n">chkconfig</span> <span class="n">nfs</span> <span class="n">on</span>
<span class="n">chkconfig</span> <span class="n">rpcbind</span> <span class="n">on</span>
</pre></div>
</div>
</li>
<li><p class="first">Configure the database client. Note the absence of the –deploy-as
argument in this case. (For more details about the arguments to this
command, see <a class="reference internal" href="index.html#install-database-on-separate-node"><span class="std std-ref">Install the Database on a Separate Node</span></a>.)</p>
<pre class="literal-block">
cloudstack-setup-databases cloud:dbpassword&#64;dbhost -e encryption_type -m management_server_key -k database_key -i management_server_ip
</pre>
</li>
<li><p class="first">Configure the OS and start the 管理服务:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">cloudstack</span><span class="o">-</span><span class="n">setup</span><span class="o">-</span><span class="n">management</span>
</pre></div>
</div>
<p>The 管理服务 on this node should now be running.
If the servlet container is Tomcat7 the argument –tomcat7 must be used.</p>
</li>
<li><p class="first">Repeat these steps on each additional 管理服务.</p>
</li>
<li><p class="first">Be sure to configure a load balancer for the Management Servers. See <a class="reference internal" href="../../adminguide/reliability.html#management-server-load-balancing"><span class="std std-ref">管理节点负载均衡</span></a></p>
</li>
</ol>
</div>
<div class="section" id="prepare-the-system-vm-template">
<h2>Prepare the System VM Template<a class="headerlink" href="index.html#prepare-the-system-vm-template" title="Permalink to this headline">¶</a></h2>
<p>Secondary storage must be seeded with a template that is used for
CloudStack system VMs.</p>
<div class="admonition note">
<p class="first admonition-title">提示</p>
<p class="last">When copying and pasting a command, be sure the command has pasted as a
single line before executing. Some document viewers may introduce unwanted
line breaks in copied text.</p>
</div>
<ol class="arabic">
<li><p class="first">On the 管理服务, run one or more of the following
<code class="docutils literal notranslate"><span class="pre">cloud-install-sys-tmplt</span></code> commands to retrieve and decompress the
system VM template. Run the command for each hypervisor type that you
expect end users to run in this Zone.</p>
<p>If your secondary storage mount point is not named <code class="docutils literal notranslate"><span class="pre">/mnt/secondary</span></code>,
substitute your own mount point name.</p>
<p>If you set the CloudStack database encryption type to “web” when you
set up the database, you must now add the parameter <code class="docutils literal notranslate"><span class="pre">-s</span>
<span class="pre">&lt;management-server-secret-key&gt;</span></code>. See <a class="reference internal" href="../encryption.html#about-password-key-encryption"><span class="std std-ref">密码和加密密钥</span></a>.</p>
<p>This process will require approximately 5 GB of free space on the
local file system and up to 30 minutes each time it runs.</p>
<ul>
<li><p class="first">For Hyper-V</p>
<pre class="literal-block">
/usr/share/cloudstack-common/scripts/storage/secondary/cloud-install-sys-tmplt -m /mnt/secondary -u <a class="reference external" href="http://download.cloudstack.org/systemvm/4.11/systemvmtemplate-4.11.2-hyperv.vhd.zip">http://download.cloudstack.org/systemvm/4.11/systemvmtemplate-4.11.2-hyperv.vhd.zip</a> -h hyperv -s &lt;optional-management-server-secret-key&gt; -F
</pre>
</li>
<li><p class="first">For XenServer:</p>
<pre class="literal-block">
/usr/share/cloudstack-common/scripts/storage/secondary/cloud-install-sys-tmplt -m /mnt/secondary -u <a class="reference external" href="http://download.cloudstack.org/systemvm/4.11/systemvmtemplate-4.11.2-xen.vhd.bz2">http://download.cloudstack.org/systemvm/4.11/systemvmtemplate-4.11.2-xen.vhd.bz2</a> -h xenserver -s &lt;optional-management-server-secret-key&gt; -F
</pre>
</li>
<li><p class="first">For vSphere:</p>
<pre class="literal-block">
/usr/share/cloudstack-common/scripts/storage/secondary/cloud-install-sys-tmplt -m /mnt/secondary -u <a class="reference external" href="http://download.cloudstack.org/systemvm/4.11/systemvmtemplate-4.11.2-vmware.ova">http://download.cloudstack.org/systemvm/4.11/systemvmtemplate-4.11.2-vmware.ova</a> -h vmware -s &lt;optional-management-server-secret-key&gt; -F
</pre>
</li>
<li><p class="first">For KVM:</p>
<pre class="literal-block">
/usr/share/cloudstack-common/scripts/storage/secondary/cloud-install-sys-tmplt -m /mnt/secondary -u systemvm-kvm-4.11.2 -h kvm -s &lt;optional-management-server-secret-key&gt; -F
</pre>
</li>
<li><p class="first">For LXC:</p>
<pre class="literal-block">
/usr/share/cloudstack-common/scripts/storage/secondary/cloud-install-sys-tmplt -m /mnt/secondary -u systemvm-kvm-4.11.2 -h lxc -s &lt;optional-management-server-secret-key&gt; -F
</pre>
</li>
<li><p class="first">For OVM3:</p>
<pre class="literal-block">
/usr/share/cloudstack-common/scripts/storage/secondary/cloud-install-sys-tmplt -m /mnt/secondary -u <a class="reference external" href="http://download.cloudstack.org/systemvm/4.11/systemvmtemplate-4.11.2-ovm.raw.bz2">http://download.cloudstack.org/systemvm/4.11/systemvmtemplate-4.11.2-ovm.raw.bz2</a> -h ovm3 -s &lt;optional-management-server-secret-key&gt; -F
</pre>
</li>
</ul>
</li>
<li><p class="first">If you are using a separate NFS server, perform this step. If you are
using the 管理服务 as the NFS server, you MUST NOT perform
this step.</p>
<p>When the script has finished, unmount secondary storage and remove
the created directory.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">umount</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">secondary</span>
<span class="n">rmdir</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">secondary</span>
</pre></div>
</div>
</li>
<li><p class="first">Repeat these steps for each secondary storage server.</p>
</li>
</ol>
</div>
<div class="section" id="installation-complete-next-steps">
<h2>安装 Complete! Next Steps<a class="headerlink" href="index.html#installation-complete-next-steps" title="Permalink to this headline">¶</a></h2>
<p>Congratulations! You have now installed CloudStack 管理服务 and
the database it uses to persist system data.</p>
<p><img alt="installation-complete.png: Finished installs with single 管理服务 and multiple Management Servers" src="../../_images/installation-complete.png" /></p>
<p>What should you do next?</p>
<ul class="simple">
<li>Even without adding any cloud infrastructure, you can run the UI to
get a feel for what’s offered and how you will interact with
CloudStack on an ongoing basis. See 登录 UI.</li>
<li>When you’re ready, add the cloud infrastructure and try running some
virtual machines on it, so you can watch how CloudStack manages the
infrastructure. See Provision Your Cloud Infrastructure.</li>
</ul>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="../configuration.html" class="btn btn-neutral float-right" title="安装配置 CloudStack " accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../overview/index.html" class="btn btn-neutral float-left" title="安装概述" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2018, Apache Foundation
      
        <span class="commit">
          Revision <code>6d954f27</code>.
        </span>
      

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <div class="rst-versions" data-toggle="rst-versions" role="note" aria-label="versions">
    <span class="rst-current-version" data-toggle="rst-current-version">
      <span class="fa fa-book"> Read the Docs</span>
      v: 4.11.2.0
      <span class="fa fa-caret-down"></span>
    </span>
    <div class="rst-other-versions">
      <dl>
        <dt>Versions</dt>
        
          <dd><a href="../../../../index.html">latest</a></dd>
        
          <dd><a href="../../index.html">4.11.2.0</a></dd>
        
          <dd><a href="../../../4.11.1.0/index.html">4.11.1.0</a></dd>
        
          <dd><a href="http://docs.cloudstack.apache.org/en/master/">master</a></dd>
        
      </dl>
      <dl>
        <dt>Downloads</dt>
        
          <dd><a href="http://readthedocs.org/projects/cloudstack-documentation/downloads/htmlzip/4.11.2.0/">htmlzip</a></dd>
        
      </dl>
      <dl>
        <dt>On Read the Docs</dt>
          <dd>
            <a href="http://readthedocs.org/projects/cloudstack-documentation/?fromdocs=cloudstack-documentation">Project Home</a>
          </dd>
          <dd>
            <a href="http://readthedocs.org/builds/cloudstack-documentation/?fromdocs=cloudstack-documentation">Builds</a>
          </dd>
      </dl>
      <hr/>
      Free document hosting provided by <a href="http://www.readthedocs.org">Read the Docs</a>.

    </div>
  </div>



  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
   

</body>
</html>