<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>LXC 安装 &#8212; CloudStack 安装手册 4.11.0.0 documentation</title>
    <link rel="stylesheet" href="../_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="https://media.readthedocs.org/css/badge_only.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootswatch-3.2.0/spacelab/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootstrap-sphinx.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="https://media.readthedocs.org/javascript/jquery/jquery-2.0.3.min.js"></script>
    <script type="text/javascript" src="https://media.readthedocs.org/javascript/jquery/jquery-migrate-1.2.1.min.js"></script>
    <script type="text/javascript" src="https://media.readthedocs.org/javascript/underscore.js"></script>
    <script type="text/javascript" src="https://media.readthedocs.org/javascript/doctools.js"></script>
    <script type="text/javascript" src="https://media.readthedocs.org/javascript/readthedocs-doc-embed.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-3.2.0/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-sphinx.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="VMware vSphere 安装" href="vsphere.html" />
    <link rel="prev" title="KVM 安装" href="kvm.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  
<!-- RTD Extra Head -->

<!-- 
Always link to the latest version, as canonical.
http://docs.readthedocs.org/en/latest/canonical.html
-->
<link rel="canonical" href="lxc.html" />

<link rel="stylesheet" href="https://media.readthedocs.org/css/readthedocs-doc-embed.css" type="text/css" />

<script type="text/javascript" src="../_static/readthedocs-data.js"></script>

<!-- Add page-specific data, which must exist in the page js, not global -->
<script type="text/javascript">
READTHEDOCS_DATA['page'] = 'hypervisor/lxc'
READTHEDOCS_DATA['source_suffix'] = '.rst'
</script>

<script type="text/javascript" src="https://media.readthedocs.org/javascript/readthedocs-analytics.js"></script>

<!-- end RTD <extrahead> -->
</head><body>

  <div id="navbar" class="navbar navbar-inverse navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../index.html">
          安装指南</a>
        <span class="navbar-text navbar-version pull-left"><b>4.11</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
            
              <li class="dropdown globaltoc-container">
                <a role="button"
                   id="dLabelGlobalToc"
                   data-toggle="dropdown"
                   data-target="#"
                   href="../index.html">Sections <b class="caret"></b></a>
                <ul class="dropdown-menu globaltoc"
                    role="menu"
                    aria-labelledby="dLabelGlobalToc">
                     <ul>
<li class="toctree-l1"><a class="reference internal" href="../choosing_deployment_architecture.html">架构选型</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../qig.html">快速入门指南 for CentOS 6</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../building_from_source.html">从源码编译安装</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../overview/index.html">安装概述</a></li>
<li class="toctree-l1"><a class="reference internal" href="../management-server/index.html">安装管理服务</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../configuration.html">安装配置 CloudStack </a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="hyperv.html">Hyper-V 安装</a></li>
<li class="toctree-l1"><a class="reference internal" href="kvm.html">KVM 安装</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="lxc.html#">LXC 安装</a></li>
<li class="toctree-l1"><a class="reference internal" href="vsphere.html">VMware vSphere 安装</a></li>
<li class="toctree-l1"><a class="reference internal" href="xenserver.html">Citrix XenServer 安装</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../network_setup.html">网络配置</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../storage_setup.html">存储配置</a></li>
<li class="toctree-l1"><a class="reference internal" href="../storage_setup.html#small-scale-setup">Small-Scale Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../storage_setup.html#large-scale-setup">Large-Scale Setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../storage_setup.html#storage-architecture">存储架构</a></li>
<li class="toctree-l1"><a class="reference internal" href="../storage_setup.html#network-configuration-for-storage">Network Configuration For Storage</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../optional_installation.html">其它安装选项</a></li>
<li class="toctree-l1"><a class="reference internal" href="../encryption.html">密码和加密密钥</a></li>
</ul>


                </ul>
              </li>
              
                
              
            
            
              
                
  <li>
    <a href="kvm.html" title="Previous Chapter: KVM 安装"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; KVM 安装</span>
    </a>
  </li>
  <li>
    <a href="vsphere.html" title="Next Chapter: VMware vSphere 安装"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">VMware vSphere 安装 &raquo;</span>
    </a>
  </li>
              
            
            
            
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
      <div class="col-md-3">
        <div id="sidebar" class="bs-sidenav" role="complementary"><ul>
<li><a class="reference internal" href="lxc.html#">LXC 安装</a><ul>
<li><a class="reference internal" href="lxc.html#system-requirements-for-lxc-hosts">System Requirements for LXC Hosts</a></li>
<li><a class="reference internal" href="lxc.html#lxc-installation-overview">LXC 安装 概述</a></li>
<li><a class="reference internal" href="lxc.html#prepare-the-operating-system">Prepare the 操作系统</a></li>
<li><a class="reference internal" href="lxc.html#install-and-configure-the-agent">Install and configure the Agent</a></li>
<li><a class="reference internal" href="lxc.html#install-and-configure-libvirt">Install and Configure libvirt</a></li>
<li><a class="reference internal" href="lxc.html#configure-the-security-policies">Configure the 安全 Policies</a></li>
<li><a class="reference internal" href="lxc.html#configure-the-network-bridges">Configure the network bridges</a><ul>
<li><a class="reference internal" href="lxc.html#network-example">Network example</a></li>
<li><a class="reference internal" href="lxc.html#configuring-the-network-bridges">Configuring the network bridges</a><ul>
<li><a class="reference internal" href="lxc.html#configure-in-rhel-or-centos">Configure in RHEL or CentOS</a></li>
<li><a class="reference internal" href="lxc.html#configure-in-ubuntu">Configure in Ubuntu</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="lxc.html#configuring-the-firewall">Configuring the firewall</a><ul>
<li><a class="reference internal" href="lxc.html#open-ports-in-rhel-centos">Open ports in RHEL/CentOS</a></li>
<li><a class="reference internal" href="lxc.html#open-ports-in-ubuntu">Open ports in Ubuntu</a></li>
</ul>
</li>
<li><a class="reference internal" href="lxc.html#add-the-host-to-cloudstack">Add the host to CloudStack</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    <div class="col-md-9">
      
  <div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>NOTICE: THIS DOCUMENTATION SITE HAS BEEN SUPERSEDED.</p>
<p class="last">For the current documentation site goto: <a class="reference external" href="../../../../../index.html">http://docs.cloudstack.apache.org</a></p>
</div>
<div class="section" id="host-lxc-installation">
<h1>LXC 安装<a class="headerlink" href="lxc.html#host-lxc-installation" title="Permalink to this headline">¶</a></h1>
<div class="section" id="system-requirements-for-lxc-hosts">
<h2>System Requirements for LXC Hosts<a class="headerlink" href="lxc.html#system-requirements-for-lxc-hosts" title="Permalink to this headline">¶</a></h2>
<p>LXC requires the Linux kernel cgroups functionality which is available
starting 2.6.24. Although you are not required to run these
distributions, the following are recommended:</p>
<ul class="simple">
<li>CentOS / RHEL: 6.3</li>
<li>Ubuntu: 12.04(.1)</li>
</ul>
<p>The main requirement for LXC hypervisors is the libvirt and Qemu
version. No matter what Linux distribution you are using, make sure the
following requirements are met:</p>
<ul class="simple">
<li>libvirt: 1.0.0 or higher</li>
<li>Qemu/KVM: 1.0 or higher</li>
</ul>
<p>The default bridge in CloudStack is the Linux native bridge
implementation (bridge module). CloudStack includes an option to work
with OpenVswitch, the requirements are listed below</p>
<ul class="simple">
<li>libvirt: 1.0.0 or higher</li>
<li>openvswitch: 1.7.1 or higher</li>
</ul>
<p>In addition, the following hardware requirements apply:</p>
<ul class="simple">
<li>Within a single cluster, the hosts must be of the same distribution
version.</li>
<li>All hosts within a cluster must be homogenous. The CPUs must be of
the same type, count, and feature flags.</li>
<li>Must support HVM (Intel-VT or AMD-V enabled)</li>
<li>64-bit x86 CPU (more cores results in better performance)</li>
<li>4 GB of memory</li>
<li>At least 1 NIC</li>
<li>When you deploy CloudStack, the hypervisor host must not have any VMs
already running</li>
</ul>
</div>
<div class="section" id="lxc-installation-overview">
<h2>LXC 安装 概述<a class="headerlink" href="lxc.html#lxc-installation-overview" title="Permalink to this headline">¶</a></h2>
<p>LXC does not have any native system VMs, instead KVM will be used to run
system VMs. This means that your host will need to support both LXC and
KVM, thus most of the installation and configuration will be identical
to the KVM installation. The material in this section doesn’t duplicate
KVM installation docs. It provides the CloudStack-specific steps that
are needed to prepare a KVM host to work with CloudStack.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Before continuing, make sure that you have applied the latest updates to
your host.</p>
</div>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">It is NOT recommended to run services on this host not controlled by
CloudStack.</p>
</div>
<p>The procedure for installing an LXC Host is:</p>
<ol class="arabic simple">
<li>Prepare the 操作系统</li>
<li>Install and configure libvirt</li>
<li>Configure 安全 Policies (AppArmor and SELinux)</li>
<li>Install and configure the Agent</li>
</ol>
</div>
<div class="section" id="prepare-the-operating-system">
<h2>Prepare the 操作系统<a class="headerlink" href="lxc.html#prepare-the-operating-system" title="Permalink to this headline">¶</a></h2>
<p>The OS of the Host must be prepared to host the CloudStack Agent and run
KVM instances.</p>
<ol class="arabic">
<li><p class="first">Log in to your OS as root.</p>
</li>
<li><p class="first">Check for a fully qualified hostname.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ hostname --fqdn
</pre></div>
</div>
<p>This should return a fully qualified hostname such as
“kvm1.lab.example.org”. If it does not, edit /etc/hosts so that it
does.</p>
</li>
<li><p class="first">Make sure that the machine can reach the Internet.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ ping www.cloudstack.org
</pre></div>
</div>
</li>
<li><p class="first">Turn on NTP for time synchronization.</p>
<div class="admonition note">
<p class="first admonition-title">提示</p>
<p class="last">NTP is required to synchronize the clocks of the servers in your
cloud. Unsynchronized clocks can cause unexpected problems.</p>
</div>
<ol class="arabic">
<li><p class="first">Install NTP</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ yum install ntp
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ apt-get install openntpd
</pre></div>
</div>
</li>
</ol>
</li>
<li><p class="first">Repeat all of these steps on every hypervisor host.</p>
</li>
</ol>
</div>
<div class="section" id="install-and-configure-the-agent">
<h2>Install and configure the Agent<a class="headerlink" href="lxc.html#install-and-configure-the-agent" title="Permalink to this headline">¶</a></h2>
<p>To manage LXC instances on the host CloudStack uses a Agent. This Agent
communicates with the Management server and controls all the instances
on the host.</p>
<p>First we start by installing the agent:</p>
<p>In RHEL or CentOS:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ yum install cloudstack-agent
</pre></div>
</div>
<p>In Ubuntu:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ apt-get install cloudstack-agent
</pre></div>
</div>
<p>Next step is to update the Agent configuration setttings. The settings
are in <code class="docutils literal notranslate"><span class="pre">/etc/cloudstack/agent/agent.properties</span></code></p>
<ol class="arabic">
<li><p class="first">Set the Agent to run in LXC mode:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>hypervisor.type<span class="o">=</span>lxc
</pre></div>
</div>
</li>
<li><p class="first">Optional: If you would like to use direct networking (instead of the
default bridge networking), configure these lines:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>libvirt.vif.driver<span class="o">=</span>com.cloud.hypervisor.kvm.resource.DirectVifDriver
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>network.direct.source.mode<span class="o">=</span>private
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>network.direct.device<span class="o">=</span>eth0
</pre></div>
</div>
</li>
</ol>
<p>The host is now ready to be added to a cluster. This is covered in a
later section, see <a class="reference internal" href="../configuration.html#adding-a-host"><span class="std std-ref">Adding a Host</span></a>. It is
recommended that you continue to read the documentation before adding
the host!</p>
</div>
<div class="section" id="install-and-configure-libvirt">
<h2>Install and Configure libvirt<a class="headerlink" href="lxc.html#install-and-configure-libvirt" title="Permalink to this headline">¶</a></h2>
<p>CloudStack uses libvirt for managing virtual machines. Therefore it is
vital that libvirt is configured correctly. Libvirt is a dependency of
cloudstack-agent and should already be installed.</p>
<ol class="arabic">
<li><p class="first">In order to have live migration working libvirt has to listen for
unsecured TCP connections. We also need to turn off libvirts attempt
to use Multicast DNS advertising. Both of these settings are in
<code class="docutils literal notranslate"><span class="pre">/etc/libvirt/libvirtd.conf</span></code></p>
<p>Set the following parameters:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">listen_tls</span> <span class="o">=</span> <span class="m">0</span>
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">listen_tcp</span> <span class="o">=</span> <span class="m">1</span>
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">tcp_port</span> <span class="o">=</span> <span class="s2">&quot;16509&quot;</span>
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">auth_tcp</span> <span class="o">=</span> <span class="s2">&quot;none&quot;</span>
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">mdns_adv</span> <span class="o">=</span> <span class="m">0</span>
</pre></div>
</div>
</li>
<li><p class="first">Turning on “listen_tcp” in libvirtd.conf is not enough, we have to
change the parameters as well:</p>
<p>On RHEL or CentOS modify <code class="docutils literal notranslate"><span class="pre">/etc/sysconfig/libvirtd</span></code>:</p>
<p>Uncomment the following line:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1">#LIBVIRTD_ARGS=&quot;--listen&quot;</span>
</pre></div>
</div>
<p>On Ubuntu: modify <code class="docutils literal notranslate"><span class="pre">/etc/default/libvirt-bin</span></code></p>
<p>Add “-l” to the following line</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">libvirtd_opts</span><span class="o">=</span><span class="s2">&quot;-d&quot;</span>
</pre></div>
</div>
<p>so it looks like:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">libvirtd_opts</span><span class="o">=</span><span class="s2">&quot;-d -l&quot;</span>
</pre></div>
</div>
</li>
<li><p class="first">In order to have the VNC Console work we have to make sure it will
bind on 0.0.0.0. We do this by editing <code class="docutils literal notranslate"><span class="pre">/etc/libvirt/qemu.conf</span></code></p>
<p>Make sure this parameter is set:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">vnc_listen</span> <span class="o">=</span> <span class="s2">&quot;0.0.0.0&quot;</span>
</pre></div>
</div>
</li>
<li><p class="first">Restart libvirt</p>
<p>In RHEL or CentOS:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ service libvirtd restart
</pre></div>
</div>
<p>In Ubuntu:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ service libvirt-bin restart
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="configure-the-security-policies">
<h2>Configure the 安全 Policies<a class="headerlink" href="lxc.html#configure-the-security-policies" title="Permalink to this headline">¶</a></h2>
<p>CloudStack does various things which can be blocked by security
mechanisms like AppArmor and SELinux. These have to be disabled to
ensure the Agent has all the required permissions.</p>
<ol class="arabic">
<li><p class="first">Configure SELinux (RHEL and CentOS)</p>
<ol class="arabic">
<li><p class="first">Check to see whether SELinux is installed on your machine. If not,
you can skip this section.</p>
<p>In RHEL or CentOS, SELinux is installed and enabled by default.
You can verify this with:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ rpm -qa <span class="p">|</span> grep selinux
</pre></div>
</div>
</li>
<li><p class="first">Set the SELINUX variable in <code class="docutils literal notranslate"><span class="pre">/etc/selinux/config</span></code> to
“permissive”. This ensures that the permissive setting will be
maintained after a system reboot.</p>
<p>In RHEL or CentOS:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ vi /etc/selinux/config
</pre></div>
</div>
<p>Change the following line</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">SELINUX</span><span class="o">=</span>enforcing
</pre></div>
</div>
<p>to this</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">SELINUX</span><span class="o">=</span>permissive
</pre></div>
</div>
</li>
<li><p class="first">Then set SELinux to permissive starting immediately, without
requiring a system reboot.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ setenforce permissive
</pre></div>
</div>
</li>
</ol>
</li>
<li><p class="first">Configure Apparmor (Ubuntu)</p>
<ol class="arabic">
<li><p class="first">Check to see whether AppArmor is installed on your machine. If
not, you can skip this section.</p>
<p>In Ubuntu AppArmor is installed and enabled by default. You can
verify this with:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ dpkg --list <span class="s1">&#39;apparmor&#39;</span>
</pre></div>
</div>
</li>
<li><p class="first">Disable the AppArmor profiles for libvirt</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ ln -s /etc/apparmor.d/usr.sbin.libvirtd /etc/apparmor.d/disable/
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ ln -s /etc/apparmor.d/usr.lib.libvirt.virt-aa-helper /etc/apparmor.d/disable/
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ apparmor_parser -R /etc/apparmor.d/usr.sbin.libvirtd
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ apparmor_parser -R /etc/apparmor.d/usr.lib.libvirt.virt-aa-helper
</pre></div>
</div>
</li>
</ol>
</li>
</ol>
</div>
<div class="section" id="configure-the-network-bridges">
<h2>Configure the network bridges<a class="headerlink" href="lxc.html#configure-the-network-bridges" title="Permalink to this headline">¶</a></h2>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">This is a very important section, please make sure you read this thoroughly.</p>
</div>
<div class="admonition note">
<p class="first admonition-title">提示</p>
<p class="last">This section details how to configure bridges using the native
implementation in Linux. Please refer to the next section if you intend to
use OpenVswitch</p>
</div>
<p>In order to forward traffic to your instances you will need at least two
bridges: <em>public</em> and <em>private</em>.</p>
<p>By default these bridges are called <em>cloudbr0</em> and <em>cloudbr1</em>, but you
do have to make sure they are available on each hypervisor.</p>
<p>The most important factor is that you keep the configuration consistent
on all your hypervisors.</p>
<div class="section" id="network-example">
<h3>Network example<a class="headerlink" href="lxc.html#network-example" title="Permalink to this headline">¶</a></h3>
<p>There are many ways to configure your network. In the Basic networking
mode you should have two (V)LAN’s, one for your private network and one
for the public network.</p>
<p>We assume that the hypervisor has one NIC (eth0) with three tagged
VLAN’s:</p>
<ol class="arabic simple">
<li>VLAN 100 for management of the hypervisor</li>
<li>VLAN 200 for public network of the instances (cloudbr0)</li>
<li>VLAN 300 for private network of the instances (cloudbr1)</li>
</ol>
<p>On VLAN 100 we give the Hypervisor the IP-Address 192.168.42.11/24 with
the gateway 192.168.42.1</p>
<div class="admonition note">
<p class="first admonition-title">提示</p>
<p class="last">The Hypervisor and Management server don’t have to be in the same subnet!</p>
</div>
</div>
<div class="section" id="configuring-the-network-bridges">
<h3>Configuring the network bridges<a class="headerlink" href="lxc.html#configuring-the-network-bridges" title="Permalink to this headline">¶</a></h3>
<p>It depends on the distribution you are using how to configure these,
below you’ll find examples for RHEL/CentOS and Ubuntu.</p>
<div class="admonition note">
<p class="first admonition-title">提示</p>
<p class="last">The goal is to have two bridges called ‘cloudbr0’ and ‘cloudbr1’ after this
section. This should be used as a guideline only. The exact configuration
will depend on your network layout.</p>
</div>
<div class="section" id="configure-in-rhel-or-centos">
<h4>Configure in RHEL or CentOS<a class="headerlink" href="lxc.html#configure-in-rhel-or-centos" title="Permalink to this headline">¶</a></h4>
<p>The required packages were installed when libvirt was installed, we can
proceed to configuring the network.</p>
<p>First we configure eth0</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ vi /etc/sysconfig/network-scripts/ifcfg-eth0
</pre></div>
</div>
<p>Make sure it looks similar to:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">DEVICE</span><span class="o">=</span>eth0
<span class="nv">HWADDR</span><span class="o">=</span><span class="m">00</span>:04:xx:xx:xx:xx
<span class="nv">ONBOOT</span><span class="o">=</span>yes
<span class="nv">HOTPLUG</span><span class="o">=</span>no
<span class="nv">BOOTPROTO</span><span class="o">=</span>none
<span class="nv">TYPE</span><span class="o">=</span>Ethernet
</pre></div>
</div>
<p>We now have to configure the three VLAN interfaces:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ vi /etc/sysconfig/network-scripts/ifcfg-eth0.100
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">DEVICE</span><span class="o">=</span>eth0.100
<span class="nv">HWADDR</span><span class="o">=</span><span class="m">00</span>:04:xx:xx:xx:xx
<span class="nv">ONBOOT</span><span class="o">=</span>yes
<span class="nv">HOTPLUG</span><span class="o">=</span>no
<span class="nv">BOOTPROTO</span><span class="o">=</span>none
<span class="nv">TYPE</span><span class="o">=</span>Ethernet
<span class="nv">VLAN</span><span class="o">=</span>yes
<span class="nv">IPADDR</span><span class="o">=</span><span class="m">192</span>.168.42.11
<span class="nv">GATEWAY</span><span class="o">=</span><span class="m">192</span>.168.42.1
<span class="nv">NETMASK</span><span class="o">=</span><span class="m">255</span>.255.255.0
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ vi /etc/sysconfig/network-scripts/ifcfg-eth0.200
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">DEVICE</span><span class="o">=</span>eth0.200
<span class="nv">HWADDR</span><span class="o">=</span><span class="m">00</span>:04:xx:xx:xx:xx
<span class="nv">ONBOOT</span><span class="o">=</span>yes
<span class="nv">HOTPLUG</span><span class="o">=</span>no
<span class="nv">BOOTPROTO</span><span class="o">=</span>none
<span class="nv">TYPE</span><span class="o">=</span>Ethernet
<span class="nv">VLAN</span><span class="o">=</span>yes
<span class="nv">BRIDGE</span><span class="o">=</span>cloudbr0
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ vi /etc/sysconfig/network-scripts/ifcfg-eth0.300
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">DEVICE</span><span class="o">=</span>eth0.300
<span class="nv">HWADDR</span><span class="o">=</span><span class="m">00</span>:04:xx:xx:xx:xx
<span class="nv">ONBOOT</span><span class="o">=</span>yes
<span class="nv">HOTPLUG</span><span class="o">=</span>no
<span class="nv">BOOTPROTO</span><span class="o">=</span>none
<span class="nv">TYPE</span><span class="o">=</span>Ethernet
<span class="nv">VLAN</span><span class="o">=</span>yes
<span class="nv">BRIDGE</span><span class="o">=</span>cloudbr1
</pre></div>
</div>
<p>Now we have the VLAN interfaces configured we can add the bridges on top
of them.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ vi /etc/sysconfig/network-scripts/ifcfg-cloudbr0
</pre></div>
</div>
<p>Now we just configure it is a plain bridge without an IP-Address</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">DEVICE</span><span class="o">=</span>cloudbr0
<span class="nv">TYPE</span><span class="o">=</span>Bridge
<span class="nv">ONBOOT</span><span class="o">=</span>yes
<span class="nv">BOOTPROTO</span><span class="o">=</span>none
<span class="nv">IPV6INIT</span><span class="o">=</span>no
<span class="nv">IPV6_AUTOCONF</span><span class="o">=</span>no
<span class="nv">DELAY</span><span class="o">=</span><span class="m">5</span>
<span class="nv">STP</span><span class="o">=</span>yes
</pre></div>
</div>
<p>We do the same for cloudbr1</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ vi /etc/sysconfig/network-scripts/ifcfg-cloudbr1
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nv">DEVICE</span><span class="o">=</span>cloudbr1
<span class="nv">TYPE</span><span class="o">=</span>Bridge
<span class="nv">ONBOOT</span><span class="o">=</span>yes
<span class="nv">BOOTPROTO</span><span class="o">=</span>none
<span class="nv">IPV6INIT</span><span class="o">=</span>no
<span class="nv">IPV6_AUTOCONF</span><span class="o">=</span>no
<span class="nv">DELAY</span><span class="o">=</span><span class="m">5</span>
<span class="nv">STP</span><span class="o">=</span>yes
</pre></div>
</div>
<p>With this configuration you should be able to restart the network,
although a reboot is recommended to see if everything works properly.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Make sure you have an alternative way like IPMI or ILO to reach the machine
in case you made a configuration error and the network stops functioning!</p>
</div>
</div>
<div class="section" id="configure-in-ubuntu">
<h4>Configure in Ubuntu<a class="headerlink" href="lxc.html#configure-in-ubuntu" title="Permalink to this headline">¶</a></h4>
<p>All the required packages were installed when you installed libvirt, so
we only have to configure the network.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ vi /etc/network/interfaces
</pre></div>
</div>
<p>Modify the interfaces file to look like this:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>auto lo
iface lo inet loopback

<span class="c1"># The primary network interface</span>
auto eth0.100
iface eth0.100 inet static
    address <span class="m">192</span>.168.42.11
    netmask <span class="m">255</span>.255.255.240
    gateway <span class="m">192</span>.168.42.1
    dns-nameservers <span class="m">8</span>.8.8.8 <span class="m">8</span>.8.4.4
    dns-domain lab.example.org

<span class="c1"># Public network</span>
auto cloudbr0
iface cloudbr0 inet manual
    bridge_ports eth0.200
    bridge_fd <span class="m">5</span>
    bridge_stp off
    bridge_maxwait <span class="m">1</span>

<span class="c1"># Private network</span>
auto cloudbr1
iface cloudbr1 inet manual
    bridge_ports eth0.300
    bridge_fd <span class="m">5</span>
    bridge_stp off
    bridge_maxwait <span class="m">1</span>
</pre></div>
</div>
<p>With this configuration you should be able to restart the network,
although a reboot is recommended to see if everything works properly.</p>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">Make sure you have an alternative way like IPMI or ILO to reach the machine
in case you made a configuration error and the network stops functioning!</p>
</div>
</div>
</div>
</div>
<div class="section" id="configuring-the-firewall">
<h2>Configuring the firewall<a class="headerlink" href="lxc.html#configuring-the-firewall" title="Permalink to this headline">¶</a></h2>
<p>The hypervisor needs to be able to communicate with other hypervisors
and the management server needs to be able to reach the hypervisor.</p>
<p>In order to do so we have to open the following TCP ports (if you are
using a firewall):</p>
<ol class="arabic simple">
<li>22 (SSH)</li>
<li>1798</li>
<li>16509 (libvirt)</li>
<li>5900 - 6100 (VNC consoles)</li>
<li>49152 - 49216 (libvirt live migration)</li>
</ol>
<p>It depends on the firewall you are using how to open these ports. Below
you’ll find examples how to open these ports in RHEL/CentOS and Ubuntu.</p>
<div class="section" id="open-ports-in-rhel-centos">
<h3>Open ports in RHEL/CentOS<a class="headerlink" href="lxc.html#open-ports-in-rhel-centos" title="Permalink to this headline">¶</a></h3>
<p>RHEL and CentOS use iptables for firewalling the system, you can open
extra ports by executing the following iptable commands:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ iptables -I INPUT -p tcp -m tcp --dport <span class="m">22</span> -j ACCEPT
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ iptables -I INPUT -p tcp -m tcp --dport <span class="m">1798</span> -j ACCEPT
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ iptables -I INPUT -p tcp -m tcp --dport <span class="m">16509</span> -j ACCEPT
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ iptables -I INPUT -p tcp -m tcp --dport <span class="m">5900</span>:6100 -j ACCEPT
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ iptables -I INPUT -p tcp -m tcp --dport <span class="m">49152</span>:49216 -j ACCEPT
</pre></div>
</div>
<p>These iptable settings are not persistent accross reboots, we have to
save them first.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ iptables-save &gt; /etc/sysconfig/iptables
</pre></div>
</div>
</div>
<div class="section" id="open-ports-in-ubuntu">
<h3>Open ports in Ubuntu<a class="headerlink" href="lxc.html#open-ports-in-ubuntu" title="Permalink to this headline">¶</a></h3>
<p>The default firewall under Ubuntu is UFW (Uncomplicated FireWall), which
is a Python wrapper around iptables.</p>
<p>To open the required ports, execute the following commands:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ ufw allow proto tcp from any to any port <span class="m">22</span>
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ ufw allow proto tcp from any to any port <span class="m">1798</span>
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ ufw allow proto tcp from any to any port <span class="m">16509</span>
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ ufw allow proto tcp from any to any port <span class="m">5900</span>:6100
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ ufw allow proto tcp from any to any port <span class="m">49152</span>:49216
</pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">提示</p>
<p class="last">By default UFW is not enabled on Ubuntu. Executing these commands with the
firewall disabled does not enable the firewall.</p>
</div>
</div>
</div>
<div class="section" id="add-the-host-to-cloudstack">
<h2>Add the host to CloudStack<a class="headerlink" href="lxc.html#add-the-host-to-cloudstack" title="Permalink to this headline">¶</a></h2>
<p>The host is now ready to be added to a cluster. This is covered in a
later section, see <a class="reference internal" href="../configuration.html#adding-a-host"><span class="std std-ref">Adding a Host</span></a>. It is
recommended that you continue to read the documentation before adding
the host!</p>
</div>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="lxc.html#">Back to top</a>
          | <a href="kvm.html" title="Previous Chapter: KVM 安装"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; KVM 安装</span>
          </a>
          | <a href="vsphere.html" title="Next Chapter: VMware vSphere 安装"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">VMware vSphere 安装 &raquo;</span>
          </a>
      
        <br/>
        
<div id="sourcelink">
  <a href="../_sources/hypervisor/lxc.rst.txt"
     rel="nofollow">Source</a>
</div>
      
    </p>
    <p>
        &copy; Copyright 2018, Apache Software Foundation.<br/>
    </p>
  </div>
</footer>
  </body>
</html>