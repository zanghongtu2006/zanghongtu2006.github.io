<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>System Reliability and 高可用 &#8212; Apache CloudStack Administration Documentation 4.11.0.0 documentation</title>
    <link rel="stylesheet" href="static/basic.css" type="text/css" />
    <link rel="stylesheet" href="static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="https://assets.readthedocs.org/static/css/badge_only.css" type="text/css" />
    <link rel="stylesheet" href="static/bootswatch-3.2.0/spacelab/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="static/bootstrap-sphinx.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="static/documentation_options.js"></script>
    <script type="text/javascript" src="static/jquery.js"></script>
    <script type="text/javascript" src="static/underscore.js"></script>
    <script type="text/javascript" src="static/doctools.js"></script>
    <script type="text/javascript" src="https://assets.readthedocs.org/static/javascript/readthedocs-doc-embed.js"></script>
    <script type="text/javascript" src="static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="static/bootstrap-3.2.0/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="static/bootstrap-sphinx.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Quota Plugin" href="plugins/quota.html" />
    <link rel="prev" title="管理云" href="management.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  
<!-- RTD Extra Head -->

<!-- 
Always link to the latest version, as canonical.
http://docs.readthedocs.org/en/latest/canonical.html
-->
<link rel="canonical" href="reliability.html" />

<link rel="stylesheet" href="https://assets.readthedocs.org/static/css/readthedocs-doc-embed.css" type="text/css" />

<script type="text/javascript" src="static/readthedocs-data.js"></script>

<!-- Add page-specific data, which must exist in the page js, not global -->
<script type="text/javascript">
READTHEDOCS_DATA['page'] = 'reliability'
READTHEDOCS_DATA['source_suffix'] = '.rst'
</script>

<script type="text/javascript" src="https://assets.readthedocs.org/static/javascript/readthedocs-analytics.js"></script>

<!-- end RTD <extrahead> -->
</head><body>

  <div id="navbar" class="navbar navbar-inverse navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="index.html">
          管理员手册</a>
        <span class="navbar-text navbar-version pull-left"><b>4.11</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
            
              <li class="dropdown globaltoc-container">
                <a role="button"
                   id="dLabelGlobalToc"
                   data-toggle="dropdown"
                   data-target="#"
                   href="index.html">Sections <b class="caret"></b></a>
                <ul class="dropdown-menu globaltoc"
                    role="menu"
                    aria-labelledby="dLabelGlobalToc">
                     <ul>
<li class="toctree-l1"><a class="reference internal" href="ui.html">用户界面</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="accounts.html">管理角色、账户、用户和域</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="projects.html">用项目来管理用户和资源</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="service_offerings.html">计算方案</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="networking.html">为用户设置网络</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="virtual_machines.html">虚拟机</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="templates.html">模板</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="hosts.html">主机</a></li>
<li class="toctree-l1"><a class="reference internal" href="hosts.html#security">安全</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="storage.html">存储</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="systemvm.html">系统虚拟机</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="usage.html">Working with Usage</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="networking_and_traffic.html">Managing Networks and Traffic</a></li>
<li class="toctree-l1"><a class="reference internal" href="networking/using_remote_access.html">Using Remote Access VPN</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="management.html">管理云</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="reliability.html#">System Reliability and 高可用</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="plugins/quota.html">Quota Plugin</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="tuning.html">调优</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="events.html">Event Notification</a></li>
<li class="toctree-l1"><a class="reference internal" href="troubleshooting.html">故障排除</a></li>
</ul>


                </ul>
              </li>
              
                
              
            
            
              
                
  <li>
    <a href="management.html" title="Previous Chapter: 管理云"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; 管理云</span>
    </a>
  </li>
  <li>
    <a href="plugins/quota.html" title="Next Chapter: Quota Plugin"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">Quota Plugin &raquo;</span>
    </a>
  </li>
              
            
            
            
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
      <div class="col-md-3">
        <div id="sidebar" class="bs-sidenav" role="complementary"><ul>
<li><a class="reference internal" href="reliability.html#">System Reliability and 高可用</a><ul>
<li><a class="reference internal" href="reliability.html#ha-for-management-server">管理服务高可用</a></li>
<li><a class="reference internal" href="reliability.html#management-server-load-balancing">管理节点负载均衡</a></li>
<li><a class="reference internal" href="reliability.html#ha-enabled-virtual-machines">虚拟机高可用</a></li>
<li><a class="reference internal" href="reliability.html#ha-for-hosts">主机高可用</a><ul>
<li><a class="reference internal" href="reliability.html#dedicated-ha-hosts">Dedicated HA Hosts</a></li>
</ul>
</li>
<li><a class="reference internal" href="reliability.html#primary-storage-outage-and-data-loss">主存储断电和数据丢失</a></li>
<li><a class="reference internal" href="reliability.html#secondary-storage-outage-and-data-loss">二级存储断电和数据丢失</a></li>
<li><a class="reference internal" href="reliability.html#database-high-availability">数据库高可用</a><ul>
<li><a class="reference internal" href="reliability.html#how-to-set-up-database-replication">How to Set Up Database Replication</a></li>
<li><a class="reference internal" href="reliability.html#configuring-database-high-availability">Configuring 数据库高可用</a></li>
<li><a class="reference internal" href="reliability.html#limitations-on-database-high-availability">Limitations on 数据库高可用</a></li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
      </div>
    <div class="col-md-9">
      
  <div class="admonition warning">
<p class="first admonition-title">警告</p>
<p>NOTICE: THIS DOCUMENTATION SITE HAS BEEN SUPERSEDED.</p>
<p class="last">For the current documentation site goto: <a class="reference external" href="../../../../index.html">http://docs.cloudstack.apache.org</a></p>
</div>
<div class="section" id="system-reliability-and-high-availability">
<h1>System Reliability and 高可用<a class="headerlink" href="reliability.html#system-reliability-and-high-availability" title="Permalink to this headline">¶</a></h1>
<div class="section" id="ha-for-management-server">
<h2>管理服务高可用<a class="headerlink" href="reliability.html#ha-for-management-server" title="Permalink to this headline">¶</a></h2>
<p>The CloudStack 管理服务 should be deployed in a multi-node
configuration such that it is not susceptible to individual server
failures. The 管理服务 itself (as distinct from the MySQL
database) is stateless and may be placed behind a load balancer.</p>
<p>Normal operation of Hosts is not impacted by an outage of all Management
Serves. All guest VMs will continue to work.</p>
<p>When the 管理服务 is down, no new VMs can be created, and the
end user and admin UI, API, dynamic load distribution, and HA will cease
to work.</p>
</div>
<div class="section" id="management-server-load-balancing">
<h2>管理节点负载均衡<a class="headerlink" href="reliability.html#management-server-load-balancing" title="Permalink to this headline">¶</a></h2>
<p>CloudStack can use a load balancer to provide a virtual IP for multiple
Management Servers. The administrator is responsible for creating the
load balancer rules for the Management Servers. The application requires
persistence or stickiness across multiple sessions. The following chart
lists the ports that should be load balanced and whether or not
persistence is required.</p>
<p>Even if persistence is not required, enabling it is permitted.</p>
<table border="1" class="table-striped table-bordered table-hover docutils">
<colgroup>
<col width="19%" />
<col width="32%" />
<col width="21%" />
<col width="28%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Source Port</th>
<th class="head">Destination Port</th>
<th class="head">Protocol</th>
<th class="head">Persistence Required?</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>80 or 443</td>
<td>8080 (or 20400 with AJP)</td>
<td>HTTP (or AJP)</td>
<td>Yes</td>
</tr>
<tr class="row-odd"><td>8250</td>
<td>8250</td>
<td>TCP</td>
<td>Yes</td>
</tr>
<tr class="row-even"><td>8096</td>
<td>8096</td>
<td>HTTP</td>
<td>No</td>
</tr>
</tbody>
</table>
<p>In addition to above settings, the administrator is responsible for
setting the ‘host’ global config value from the management server IP to
load balancer virtual IP address. If the ‘host’ value is not set to the
VIP for Port 8250 and one of your management servers crashes, the UI is
still available but the system VMs will not be able to contact the
management server.</p>
</div>
<div class="section" id="ha-enabled-virtual-machines">
<h2>虚拟机高可用<a class="headerlink" href="reliability.html#ha-enabled-virtual-machines" title="Permalink to this headline">¶</a></h2>
<p>The user can specify a virtual machine as HA-enabled. By default, all
virtual router VMs and Elastic 负载均衡 VMs are automatically
configured as HA-enabled. When an HA-enabled VM crashes, CloudStack
detects the crash and restarts the VM automatically within the same
Availability Zone. HA is never performed across different Availability
Zones. CloudStack has a conservative policy towards restarting VMs and
ensures that there will never be two instances of the same VM running at
the same time. The 管理服务 attempts to start the VM on another
Host in the same cluster.</p>
<p>HA features work with iSCSI or NFS primary storage. HA with local
storage is not supported.</p>
</div>
<div class="section" id="ha-for-hosts">
<h2>主机高可用<a class="headerlink" href="reliability.html#ha-for-hosts" title="Permalink to this headline">¶</a></h2>
<p>The user can specify a virtual machine as HA-enabled. By default, all
virtual router VMs and Elastic 负载均衡 VMs are automatically
configured as HA-enabled. When an HA-enabled VM crashes, CloudStack
detects the crash and restarts the VM automatically within the same
Availability Zone. HA is never performed across different Availability
Zones. CloudStack has a conservative policy towards restarting VMs and
ensures that there will never be two instances of the same VM running at
the same time. The 管理服务 attempts to start the VM on another
Host in the same cluster.</p>
<p>HA features work with iSCSI or NFS primary storage. HA with local
storage is not supported.</p>
<div class="section" id="dedicated-ha-hosts">
<h3>Dedicated HA Hosts<a class="headerlink" href="reliability.html#dedicated-ha-hosts" title="Permalink to this headline">¶</a></h3>
<p>One or more hosts can be designated for use only by HA-enabled VMs that
are restarting due to a host failure. Setting up a pool of such
dedicated HA hosts as the recovery destination for all HA-enabled VMs is
useful to:</p>
<ul class="simple">
<li>Make it easier to determine which VMs have been restarted as part of
the CloudStack high-availability function. If a VM is running on a
dedicated HA host, then it must be an HA-enabled VM whose original
host failed. (With one exception: It is possible for an administrator
to manually migrate any VM to a dedicated HA host.).</li>
<li>Keep HA-enabled VMs from restarting on hosts which may be reserved
for other purposes.</li>
</ul>
<p>The dedicated HA option is set through a special host tag when the host
is created. To allow the administrator to dedicate hosts to only
HA-enabled VMs, set the global configuration variable ha.tag to the
desired tag (for example, “ha_host”), and restart the Management
Server. Enter the value in the Host Tags field when adding the host(s)
that you want to dedicate to HA-enabled VMs.</p>
<div class="admonition note">
<p class="first admonition-title">提示</p>
<p class="last">If you set ha.tag, be sure to actually use that tag on at least one
host in your cloud. If the tag specified in ha.tag is not set for
any host in the cloud, the HA-enabled VMs will fail to restart after
a crash.</p>
</div>
</div>
</div>
<div class="section" id="primary-storage-outage-and-data-loss">
<h2>主存储断电和数据丢失<a class="headerlink" href="reliability.html#primary-storage-outage-and-data-loss" title="Permalink to this headline">¶</a></h2>
<p>When a primary storage outage occurs the hypervisor immediately stops
all VMs stored on that storage device. Guests that are marked for HA
will be restarted as soon as practical when the primary storage comes
back on line. With NFS, the hypervisor may allow the virtual machines to
continue running depending on the nature of the issue. For example, an
NFS hang will cause the guest VMs to be suspended until storage
connectivity is restored.Primary storage is not designed to be backed
up. Individual volumes in primary storage can be backed up using
snapshots.</p>
</div>
<div class="section" id="secondary-storage-outage-and-data-loss">
<h2>二级存储断电和数据丢失<a class="headerlink" href="reliability.html#secondary-storage-outage-and-data-loss" title="Permalink to this headline">¶</a></h2>
<p>For a Zone that has only one secondary storage server, a secondary
storage outage will have feature level impact to the system but will not
impact running guest VMs. It may become impossible to create a VM with
the selected template for a user. A user may also not be able to save
snapshots or examine/restore saved snapshots. These features will
automatically be available when the secondary storage comes back online.</p>
<p>Secondary storage data loss will impact recently added user data
including templates, snapshots, and ISO. Secondary storage should
be backed up periodically. Multiple secondary storage servers can be
provisioned within each zone to increase the scalability of the system.</p>
</div>
<div class="section" id="database-high-availability">
<h2>数据库高可用<a class="headerlink" href="reliability.html#database-high-availability" title="Permalink to this headline">¶</a></h2>
<p>To help ensure high availability of the databases that store the
internal data for CloudStack, you can set up database replication. This
covers both the main CloudStack database and the Usage database.
Replication is achieved using the MySQL connector parameters and two-way
replication. Tested with MySQL 5.1 and 5.5.</p>
<div class="section" id="how-to-set-up-database-replication">
<h3>How to Set Up Database Replication<a class="headerlink" href="reliability.html#how-to-set-up-database-replication" title="Permalink to this headline">¶</a></h3>
<p>Database replication in CloudStack is provided using the MySQL
replication capabilities. The steps to set up replication can be found
in the MySQL documentation (links are provided below). It is suggested
that you set up two-way replication, which involves two database nodes.
In this case, for example, you might have node1 and node2.</p>
<p>You can also set up chain replication, which involves more than two
nodes. In this case, you would first set up two-way replication with
node1 and node2. Next, set up one-way replication from node2 to node3.
Then set up one-way replication from node3 to node4, and so on for all
the additional nodes.</p>
<p>References:</p>
<ul class="simple">
<li><a class="reference external" href="http://dev.mysql.com/doc/refman/5.0/en/replication-howto.html">http://dev.mysql.com/doc/refman/5.0/en/replication-howto.html</a></li>
<li><a class="reference external" href="https://wikis.oracle.com/display/CommSuite/MySQL+High+Availability+and+Replication+Information+For+Calendar+Server">https://wikis.oracle.com/display/CommSuite/MySQL+High+Availability+and+Replication+Information+For+Calendar+Server</a></li>
</ul>
</div>
<div class="section" id="configuring-database-high-availability">
<h3>Configuring 数据库高可用<a class="headerlink" href="reliability.html#configuring-database-high-availability" title="Permalink to this headline">¶</a></h3>
<p>To control the database high availability behavior, use the following
configuration settings in the file
/etc/cloudstack/management/db.properties.</p>
<p><strong>Required Settings</strong></p>
<p>Be sure you have set the following in db.properties:</p>
<ul>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">db.ha.enabled</span></code>: set to true if you want to use the replication
feature.</p>
<p>Example: <code class="docutils literal notranslate"><span class="pre">db.ha.enabled=true</span></code></p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">db.cloud.slaves</span></code>: set to a comma-delimited set of slave hosts for the
cloud database. This is the list of nodes set up with replication.
The master node is not in the list, since it is already mentioned
elsewhere in the properties file.</p>
<p>Example: <code class="docutils literal notranslate"><span class="pre">db.cloud.slaves=node2,node3,node4</span></code></p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">db.usage.slaves</span></code>: set to a comma-delimited set of slave hosts for the
usage database. This is the list of nodes set up with replication.
The master node is not in the list, since it is already mentioned
elsewhere in the properties file.</p>
<p>Example: <code class="docutils literal notranslate"><span class="pre">db.usage.slaves=node2,node3,node4</span></code></p>
</li>
</ul>
<p><strong>Optional Settings</strong></p>
<p>The following settings must be present in db.properties, but you are not
required to change the default values unless you wish to do so for
tuning purposes:</p>
<ul>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">db.cloud.secondsBeforeRetryMaster</span></code>: The number of seconds the MySQL
connector should wait before trying again to connect to the master
after the master went down. Default is 1 hour. The retry might happen
sooner if db.cloud.queriesBeforeRetryMaster is reached first.</p>
<p>Example: <code class="docutils literal notranslate"><span class="pre">db.cloud.secondsBeforeRetryMaster=3600</span></code></p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">db.cloud.queriesBeforeRetryMaster</span></code>: The minimum number of queries to
be sent to the database before trying again to connect to the master
after the master went down. Default is 5000. The retry might happen
sooner if db.cloud.secondsBeforeRetryMaster is reached first.</p>
<p>Example: <code class="docutils literal notranslate"><span class="pre">db.cloud.queriesBeforeRetryMaster=5000</span></code></p>
</li>
<li><p class="first"><code class="docutils literal notranslate"><span class="pre">db.cloud.initialTimeout</span></code>: Initial time the MySQL connector should wait
before trying again to connect to the master. Default is 3600.</p>
<p>Example: <code class="docutils literal notranslate"><span class="pre">db.cloud.initialTimeout=3600</span></code></p>
</li>
</ul>
</div>
<div class="section" id="limitations-on-database-high-availability">
<h3>Limitations on 数据库高可用<a class="headerlink" href="reliability.html#limitations-on-database-high-availability" title="Permalink to this headline">¶</a></h3>
<p>The following limitations exist in the current implementation of this
feature.</p>
<ul class="simple">
<li>Slave hosts can not be monitored through CloudStack. You will need to
have a separate means of monitoring.</li>
<li>Events from the database side are not integrated with the CloudStack
管理服务 events system.</li>
<li>You must periodically perform manual clean-up of bin log files
generated by replication on database nodes. If you do not clean up
the log files, the disk can become full.</li>
</ul>
</div>
</div>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="reliability.html#">Back to top</a>
          | <a href="management.html" title="Previous Chapter: 管理云"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; 管理云</span>
          </a>
          | <a href="plugins/quota.html" title="Next Chapter: Quota Plugin"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">Quota Plugin &raquo;</span>
          </a>
      
        <br/>
        
<div id="sourcelink">
  <a href="_sources/reliability.rst.txt"
     rel="nofollow">Source</a>
</div>
      
    </p>
    <p>
        &copy; Copyright 2016, Apache Software Foundation.<br/>
    </p>
  </div>
</footer>
  </body>
</html>