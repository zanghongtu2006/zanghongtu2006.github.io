<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>存储 &#8212; Apache CloudStack Administration Documentation 4.11.0.0 documentation</title>
    <link rel="stylesheet" href="static/basic.css" type="text/css" />
    <link rel="stylesheet" href="static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="https://assets.readthedocs.org/static/css/badge_only.css" type="text/css" />
    <link rel="stylesheet" href="static/bootswatch-3.2.0/spacelab/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="static/bootstrap-sphinx.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="static/documentation_options.js"></script>
    <script type="text/javascript" src="static/jquery.js"></script>
    <script type="text/javascript" src="static/underscore.js"></script>
    <script type="text/javascript" src="static/doctools.js"></script>
    <script type="text/javascript" src="https://assets.readthedocs.org/static/javascript/readthedocs-doc-embed.js"></script>
    <script type="text/javascript" src="static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="static/bootstrap-3.2.0/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="static/bootstrap-sphinx.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="系统虚拟机" href="systemvm.html" />
    <link rel="prev" title="主机" href="hosts.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  
<!-- RTD Extra Head -->

<!-- 
Always link to the latest version, as canonical.
http://docs.readthedocs.org/en/latest/canonical.html
-->
<link rel="canonical" href="storage.html" />

<link rel="stylesheet" href="https://assets.readthedocs.org/static/css/readthedocs-doc-embed.css" type="text/css" />

<script type="text/javascript" src="static/readthedocs-data.js"></script>

<!-- Add page-specific data, which must exist in the page js, not global -->
<script type="text/javascript">
READTHEDOCS_DATA['page'] = 'storage'
READTHEDOCS_DATA['source_suffix'] = '.rst'
</script>

<script type="text/javascript" src="https://assets.readthedocs.org/static/javascript/readthedocs-analytics.js"></script>

<!-- end RTD <extrahead> -->
</head><body>

  <div id="navbar" class="navbar navbar-inverse navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="index.html">
          管理员手册</a>
        <span class="navbar-text navbar-version pull-left"><b>4.11</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
            
              <li class="dropdown globaltoc-container">
                <a role="button"
                   id="dLabelGlobalToc"
                   data-toggle="dropdown"
                   data-target="#"
                   href="index.html">Sections <b class="caret"></b></a>
                <ul class="dropdown-menu globaltoc"
                    role="menu"
                    aria-labelledby="dLabelGlobalToc">
                     <ul>
<li class="toctree-l1"><a class="reference internal" href="ui.html">用户界面</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="accounts.html">管理角色、账户、用户和域</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="projects.html">用项目来管理用户和资源</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="service_offerings.html">计算方案</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="networking.html">为用户设置网络</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="virtual_machines.html">虚拟机</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="templates.html">模板</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="hosts.html">主机</a></li>
<li class="toctree-l1"><a class="reference internal" href="hosts.html#security">安全</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="storage.html#">存储</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="systemvm.html">系统虚拟机</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="usage.html">Working with Usage</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="networking_and_traffic.html">Managing Networks and Traffic</a></li>
<li class="toctree-l1"><a class="reference internal" href="networking/using_remote_access.html">Using Remote Access VPN</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="management.html">管理云</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="reliability.html">System Reliability and 高可用</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="plugins/quota.html">Quota Plugin</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="tuning.html">调优</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="events.html">Event Notification</a></li>
<li class="toctree-l1"><a class="reference internal" href="troubleshooting.html">故障排除</a></li>
</ul>


                </ul>
              </li>
              
                
              
            
            
              
                
  <li>
    <a href="hosts.html" title="Previous Chapter: 主机"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; 主机</span>
    </a>
  </li>
  <li>
    <a href="systemvm.html" title="Next Chapter: 系统虚拟机"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">系统虚拟机 &raquo;</span>
    </a>
  </li>
              
            
            
            
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
      <div class="col-md-3">
        <div id="sidebar" class="bs-sidenav" role="complementary"><ul>
<li><a class="reference internal" href="storage.html#">存储</a><ul>
<li><a class="reference internal" href="storage.html#storage-overview">存储概述</a></li>
<li><a class="reference internal" href="storage.html#primary-storage">主存储</a><ul>
<li><a class="reference internal" href="storage.html#best-practices-for-primary-storage">最佳实践 for 主存储</a></li>
<li><a class="reference internal" href="storage.html#runtime-behaviour-of-primary-storage">Runtime Behaviour of 主存储</a></li>
<li><a class="reference internal" href="storage.html#hypervisor-support-for-primary-storage">Hypervisor Support for 主存储</a></li>
<li><a class="reference internal" href="storage.html#storage-tags">Storage Tags</a></li>
<li><a class="reference internal" href="storage.html#maintenance-mode-for-primary-storage">Maintenance Mode for 主存储</a></li>
</ul>
</li>
<li><a class="reference internal" href="storage.html#secondary-storage">二级存储</a></li>
<li><a class="reference internal" href="storage.html#working-with-volumes">磁盘</a><ul>
<li><a class="reference internal" href="storage.html#creating-a-new-volume">Creating a New Volume</a><ul>
<li><a class="reference internal" href="storage.html#using-local-storage-for-data-volumes">Using Local Storage for Data Volumes</a></li>
<li><a class="reference internal" href="storage.html#to-create-a-new-volume">To Create a New Volume</a></li>
</ul>
</li>
<li><a class="reference internal" href="storage.html#uploading-an-existing-volume-to-a-virtual-machine">Uploading an Existing Volume to a Virtual Machine</a></li>
<li><a class="reference internal" href="storage.html#attaching-a-volume">Attaching a Volume</a></li>
<li><a class="reference internal" href="storage.html#detaching-and-moving-volumes">Detaching and Moving Volumes</a></li>
<li><a class="reference internal" href="storage.html#id2">VM Storage Migration</a><ul>
<li><a class="reference internal" href="storage.html#migrating-a-data-volume-to-a-new-storage-pool">Migrating a Data Volume to a New Storage Pool</a><ul>
<li><a class="reference internal" href="storage.html#migrating-storage-for-a-running-vm-on-xenserver-and-vmware">Migrating Storage For a Running VM on XenServer and VMware</a></li>
<li><a class="reference internal" href="storage.html#migrating-storage-for-a-running-vm-on-kvm">Migrating Storage For a Running VM on KVM</a></li>
<li><a class="reference internal" href="storage.html#migrating-storage-and-attaching-to-a-different-vm">Migrating Storage and Attaching to a Different VM</a></li>
</ul>
</li>
<li><a class="reference internal" href="storage.html#migrating-a-vm-root-volume-to-a-new-storage-pool">Migrating a VM Root Volume to a New Storage Pool</a></li>
</ul>
</li>
<li><a class="reference internal" href="storage.html#resizing-volumes">Resizing Volumes</a></li>
<li><a class="reference internal" href="storage.html#reset-vm-to-new-root-disk-on-reboot">Reset VM to New Root Disk on Reboot</a></li>
<li><a class="reference internal" href="storage.html#volume-deletion-and-garbage-collection">Volume Deletion and Garbage Collection</a></li>
</ul>
</li>
<li><a class="reference internal" href="storage.html#working-with-volume-snapshots">磁盘镜像</a><ul>
<li><a class="reference internal" href="storage.html#how-to-snapshot-a-volume">How to Snapshot a Volume</a></li>
<li><a class="reference internal" href="storage.html#automatic-snapshot-creation-and-retention">Automatic Snapshot Creation and Retention</a></li>
<li><a class="reference internal" href="storage.html#incremental-snapshots-and-backup">Incremental Snapshots and Backup</a></li>
<li><a class="reference internal" href="storage.html#volume-status">Volume Status</a></li>
<li><a class="reference internal" href="storage.html#snapshot-restore">Snapshot Restore</a></li>
<li><a class="reference internal" href="storage.html#snapshot-job-throttling">Snapshot Job Throttling</a></li>
<li><a class="reference internal" href="storage.html#vmware-volume-snapshot-performance">VMware Volume Snapshot Performance</a></li>
<li><a class="reference internal" href="storage.html#disk-caching-kvm">Disk caching (KVM)</a></li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
      </div>
    <div class="col-md-9">
      
  <div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>NOTICE: THIS DOCUMENTATION SITE HAS BEEN SUPERSEDED.</p>
<p class="last">For the current documentation site goto: <a class="reference external" href="../../../../index.html">http://docs.cloudstack.apache.org</a></p>
</div>
<div class="section" id="working-with-storage">
<h1>存储<a class="headerlink" href="storage.html#working-with-storage" title="Permalink to this headline">¶</a></h1>
<div class="section" id="storage-overview">
<h2>存储概述<a class="headerlink" href="storage.html#storage-overview" title="Permalink to this headline">¶</a></h2>
<p>CloudStack defines two types of storage: primary and secondary. Primary
storage can be accessed by either iSCSI or NFS. Additionally, direct
attached storage may be used for primary storage. Secondary storage is
always accessed using NFS.</p>
<p>There is no ephemeral storage in CloudStack. All volumes on all nodes
are persistent.</p>
</div>
<div class="section" id="primary-storage">
<h2>主存储<a class="headerlink" href="storage.html#primary-storage" title="Permalink to this headline">¶</a></h2>
<p>This section gives concepts and technical details about CloudStack
primary storage. For information about how to install and configure
primary storage through the CloudStack UI, see the 安装指南.</p>
<p><a class="reference external" href="http://docs.cloudstack.apache.org/en/latest/concepts.html#about-primary-storage">“About 主存储”</a></p>
<div class="section" id="best-practices-for-primary-storage">
<h3>最佳实践 for 主存储<a class="headerlink" href="storage.html#best-practices-for-primary-storage" title="Permalink to this headline">¶</a></h3>
<ul>
<li><p class="first">The speed of primary storage will impact guest performance. If
possible, choose smaller, higher RPM drives or SSDs for primary
storage.</p>
</li>
<li><p class="first">There are two ways CloudStack can leverage primary storage:</p>
<p>Static: This is CloudStack’s traditional way of handling storage. In
this model, a preallocated amount of storage (ex. a volume from a
SAN) is given to CloudStack. CloudStack then permits many of its
volumes to be created on this storage (can be root and/or data
disks). If using this technique, ensure that nothing is stored on the
storage. Adding the storage to CloudStack will destroy any existing
data.</p>
<p>Dynamic: This is a newer way for CloudStack to manage storage. In
this model, a storage system (rather than a preallocated amount of
storage) is given to CloudStack. CloudStack, working in concert with
a storage plug-in, dynamically creates volumes on the storage system
and each volume on the storage system maps to a single CloudStack
volume. This is highly useful for features such as storage Quality of
Service. Currently this feature is supported for data disks (Disk
Offerings).</p>
</li>
</ul>
</div>
<div class="section" id="runtime-behaviour-of-primary-storage">
<h3>Runtime Behaviour of 主存储<a class="headerlink" href="storage.html#runtime-behaviour-of-primary-storage" title="Permalink to this headline">¶</a></h3>
<p>Root volumes are created automatically when a virtual machine is
created. Root volumes are deleted when the VM is destroyed. Data volumes
can be created and dynamically attached to VMs. Data volumes are not
deleted when VMs are destroyed.</p>
<p>Administrators should monitor the capacity of primary storage devices
and add additional primary storage as needed. See the Advanced
安装指南.</p>
<p>Administrators add primary storage to the system by creating a
CloudStack storage pool. Each storage pool is associated with a cluster
or a zone.</p>
<p>With regards to data disks, when a user executes a Disk Offering to
create a data disk, the information is initially written to the
CloudStack database only. Upon the first request that the data disk be
attached to a VM, CloudStack determines what storage to place the volume
on and space is taken from that storage (either from preallocated
storage or from a storage system (ex. a SAN), depending on how the
primary storage was added to CloudStack).</p>
</div>
<div class="section" id="hypervisor-support-for-primary-storage">
<h3>Hypervisor Support for 主存储<a class="headerlink" href="storage.html#hypervisor-support-for-primary-storage" title="Permalink to this headline">¶</a></h3>
<p>The following table shows storage options and parameters for different
hypervisors.</p>
<table border="1" class="table-striped table-bordered table-hover docutils">
<colgroup>
<col width="34%" />
<col width="12%" />
<col width="15%" />
<col width="20%" />
<col width="20%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Storage media \ hypervisor</th>
<th class="head">VMware vSphere</th>
<th class="head">Citrix XenServer</th>
<th class="head">KVM</th>
<th class="head">Hyper-V</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td><strong>Format for Disks, 模板, and Snapshots</strong></td>
<td>VMDK</td>
<td>VHD</td>
<td>QCOW2</td>
<td>VHD
Snapshots are not supported.</td>
</tr>
<tr class="row-odd"><td><strong>iSCSI support</strong></td>
<td>VMFS</td>
<td>Clustered LVM</td>
<td>Yes, via Shared Mountpoint</td>
<td>No</td>
</tr>
<tr class="row-even"><td><strong>Fiber Channel support</strong></td>
<td>VMFS</td>
<td>Yes, via Existing SR</td>
<td>Yes, via Shared Mountpoint</td>
<td>No</td>
</tr>
<tr class="row-odd"><td><strong>NFS support</strong></td>
<td>Yes</td>
<td>Yes</td>
<td>Yes</td>
<td>No</td>
</tr>
<tr class="row-even"><td><strong>Local storage support</strong></td>
<td>Yes</td>
<td>Yes</td>
<td>Yes</td>
<td>Yes</td>
</tr>
<tr class="row-odd"><td><strong>Storage over-provisioning</strong></td>
<td>NFS and iSCSI</td>
<td>NFS</td>
<td>NFS</td>
<td>No</td>
</tr>
<tr class="row-even"><td><strong>SMB/CIFS</strong></td>
<td>No</td>
<td>No</td>
<td>No</td>
<td>Yes</td>
</tr>
<tr class="row-odd"><td><strong>Ceph/RBD</strong></td>
<td>No</td>
<td>No</td>
<td>Yes</td>
<td>No</td>
</tr>
</tbody>
</table>
<p>XenServer uses a clustered LVM system to store VM images on iSCSI and
Fiber Channel volumes and does not support over-provisioning in the
hypervisor. The storage server itself, however, can support
thin-provisioning. As a result the CloudStack can still support storage
over-provisioning by running on thin-provisioned storage volumes.</p>
<p>KVM supports “Shared Mountpoint” storage. A shared mountpoint is a file
system path local to each server in a given cluster. The path must be
the same across all Hosts in the cluster, for example /mnt/primary1.
This shared mountpoint is assumed to be a clustered filesystem such as
OCFS2. In this case the CloudStack does not attempt to mount or unmount
the storage as is done with NFS. The CloudStack requires that the
administrator insure that the storage is available</p>
<p>With NFS storage, CloudStack manages the overprovisioning. In this case
the global configuration parameter storage.overprovisioning.factor
controls the degree of overprovisioning. This is independent of
hypervisor type.</p>
<p>Local storage is an option for primary storage for vSphere, XenServer,
and KVM. When the local disk option is enabled, a local disk storage
pool is automatically created on each host. To use local storage for the
System Virtual Machines (such as the 虚拟路由器), set
system.vm.use.local.storage to true in global configuration.</p>
<p>CloudStack supports multiple primary storage pools in a 集群. For
example, you could provision 2 NFS servers in primary storage. Or you
could provision 1 iSCSI LUN initially and then add a second iSCSI LUN
when the first approaches capacity.</p>
</div>
<div class="section" id="storage-tags">
<h3>Storage Tags<a class="headerlink" href="storage.html#storage-tags" title="Permalink to this headline">¶</a></h3>
<p>Storage may be “tagged”. A tag is a text string attribute associated
with primary storage, a Disk Offering, or a Service Offering. Tags allow
administrators to provide additional information about the storage. For
example, that is a “SSD” or it is “slow”. Tags are not interpreted by
CloudStack. They are matched against tags placed on service and disk
offerings. CloudStack requires all tags on service and disk offerings to
exist on the primary storage before it allocates root or data disks on
the primary storage. Service and disk offering tags are used to identify
the requirements of the storage that those offerings have. For example,
the high end service offering may require “fast” for its root disk
volume.</p>
<p>The interaction between tags, allocation, and volume copying across
clusters and pods can be complex. To simplify the situation, use the
same set of tags on the primary storage for all clusters in a pod. Even
if different devices are used to present those tags, the set of exposed
tags can be the same.</p>
</div>
<div class="section" id="maintenance-mode-for-primary-storage">
<h3>Maintenance Mode for 主存储<a class="headerlink" href="storage.html#maintenance-mode-for-primary-storage" title="Permalink to this headline">¶</a></h3>
<p>Primary storage may be placed into maintenance mode. This is useful, for
example, to replace faulty RAM in a storage device. Maintenance mode for
a storage device will first stop any new guests from being provisioned
on the storage device. Then it will stop all guests that have any volume
on that storage device. When all such guests are stopped the storage
device is in maintenance mode and may be shut down. When the storage
device is online again you may cancel maintenance mode for the device.
The CloudStack will bring the device back online and attempt to start
all guests that were running at the time of the entry into maintenance
mode.</p>
</div>
</div>
<div class="section" id="secondary-storage">
<h2>二级存储<a class="headerlink" href="storage.html#secondary-storage" title="Permalink to this headline">¶</a></h2>
<p>This section gives concepts and technical details about CloudStack
secondary storage. For information about how to install and configure
secondary storage through the CloudStack UI, see the Advanced
安装指南.</p>
<p><a class="reference external" href="http://docs.cloudstack.apache.org/en/latest/concepts.html#about-secondary-storage">“About 二级存储”</a></p>
</div>
<div class="section" id="working-with-volumes">
<h2>磁盘<a class="headerlink" href="storage.html#working-with-volumes" title="Permalink to this headline">¶</a></h2>
<p>A volume provides storage to a guest VM. The volume can provide for a
root disk or an additional data disk. CloudStack supports additional
volumes for guest VMs.</p>
<p>Volumes are created for a specific hypervisor type. A volume that has
been attached to guest using one hypervisor type (e.g, XenServer) may
not be attached to a guest that is using another hypervisor type, for
example:vSphere, KVM. This is because the different hypervisors use
different disk image formats.</p>
<p>CloudStack defines a volume as a unit of storage available to a guest
VM. Volumes are either root disks or data disks. The root disk has “/”
in the file system and is usually the boot device. Data disks provide
for additional storage, for example: “/opt” or “D:”. Every guest VM has
a root disk, and VMs can also optionally have a data disk. End users can
mount multiple data disks to guest VMs. Users choose data disks from the
disk offerings created by administrators. The user can create a template
from a volume as well; this is the standard procedure for private
template creation. Volumes are hypervisor-specific: a volume from one
hypervisor type may not be used on a guest of another hypervisor type.</p>
<div class="admonition note">
<p class="first admonition-title">提示</p>
<p>CloudStack supports attaching up to</p>
<ul class="last simple">
<li>13 data disks on XenServer hypervisor versions 6.0 and above,
And all versions of VMware.</li>
<li>64 data disks on Hyper-V.</li>
<li>6 data disks on other hypervisor types.</li>
</ul>
</div>
<div class="section" id="creating-a-new-volume">
<h3>Creating a New Volume<a class="headerlink" href="storage.html#creating-a-new-volume" title="Permalink to this headline">¶</a></h3>
<p>You can add more data disk volumes to a guest VM at any time, up to the
limits of your storage capacity. Both CloudStack administrators and
users can add volumes to VM instances. When you create a new volume, it
is stored as an entity in CloudStack, but the actual storage resources
are not allocated on the physical storage device until you attach the
volume. This optimization allows the CloudStack to provision the volume
nearest to the guest that will use it when the first attachment is made.</p>
<div class="section" id="using-local-storage-for-data-volumes">
<h4>Using Local Storage for Data Volumes<a class="headerlink" href="storage.html#using-local-storage-for-data-volumes" title="Permalink to this headline">¶</a></h4>
<p>You can create data volumes on local storage (supported with XenServer,
KVM, and VMware). The data volume is placed on the same host as the VM
instance that is attached to the data volume. These local data volumes
can be attached to virtual machines, detached, re-attached, and deleted
just as with the other types of data volume.</p>
<p>Local storage is ideal for scenarios where persistence of data volumes
and HA is not required.&nbsp;Some of the benefits include reduced disk I/O
latency and cost reduction from using inexpensive local disks.</p>
<p>In order for local volumes to be used, the feature must be enabled for
the zone.</p>
<p>You can create a data disk offering for local storage. When a user
creates a new VM, they can select this disk offering in order to cause
the data disk volume to be placed in local storage.</p>
<p>You can not migrate a VM that has a volume in local storage to a
different host, nor migrate the volume itself away to a different host.
If you want to put a host into maintenance mode, you must first stop any
VMs with local data volumes on that host.</p>
</div>
<div class="section" id="to-create-a-new-volume">
<h4>To Create a New Volume<a class="headerlink" href="storage.html#to-create-a-new-volume" title="Permalink to this headline">¶</a></h4>
<ol class="arabic">
<li><p class="first">Log in to the CloudStack UI as a user or admin.</p>
</li>
<li><p class="first">In the left navigation bar, click Storage.</p>
</li>
<li><p class="first">In Select View, choose Volumes.</p>
</li>
<li><p class="first">To create a new volume, click Add Volume, provide the following
details, and click OK.</p>
<ul class="simple">
<li>Name. Give the volume a unique name so you can find it later.</li>
<li>Availability Zone. Where do you want the storage to reside? This
should be close to the VM that will use the volume.</li>
<li>Disk Offering. Choose the characteristics of the storage.</li>
</ul>
<p>The new volume appears in the list of volumes with the state
“Allocated.” The volume data is stored in CloudStack, but the volume
is not yet ready for use</p>
</li>
<li><p class="first">To start using the volume, continue to Attaching a Volume</p>
</li>
</ol>
</div>
</div>
<div class="section" id="uploading-an-existing-volume-to-a-virtual-machine">
<h3>Uploading an Existing Volume to a Virtual Machine<a class="headerlink" href="storage.html#uploading-an-existing-volume-to-a-virtual-machine" title="Permalink to this headline">¶</a></h3>
<p>Existing data can be made accessible to a virtual machine. This is
called uploading a volume to the VM. For example, this is useful to
upload data from a local file system and attach it to a VM. Root
administrators, domain administrators, and end users can all upload
existing volumes to VMs.</p>
<p>The upload is performed using HTTP. The uploaded volume is placed in the
zone’s secondary storage</p>
<p>You cannot upload a volume if the preconfigured volume limit has already
been reached. The default limit for the cloud is set in the global
configuration parameter max.account.volumes, but administrators can also
set per-domain limits that are different from the global default. See
Setting Usage Limits</p>
<p>To upload a volume:</p>
<ol class="arabic">
<li><p class="first">（可选） Create an MD5 hash (checksum) of the disk image file that
you are going to upload. After uploading the data disk, CloudStack
will use this value to verify that no data corruption has occurred.</p>
</li>
<li><p class="first">Log in to the CloudStack UI as an administrator or user</p>
</li>
<li><p class="first">In the left navigation bar, click Storage.</p>
</li>
<li><p class="first">Click Upload Volume.</p>
</li>
<li><p class="first">Provide the following:</p>
<ul>
<li><p class="first">Name and Description. Any desired name and a brief description
that can be shown in the UI.</p>
</li>
<li><p class="first">Availability Zone. Choose the zone where you want to store the
volume. VMs running on hosts in this zone can attach the volume.</p>
</li>
<li><p class="first">Format. Choose one of the following to indicate the disk image
format of the volume.</p>
<table border="1" class="table-striped table-bordered table-hover docutils">
<colgroup>
<col width="37%" />
<col width="63%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Hypervisor</th>
<th class="head">Disk Image Format</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>XenServer</td>
<td>VHD</td>
</tr>
<tr class="row-odd"><td>VMware</td>
<td>OVA</td>
</tr>
<tr class="row-even"><td>KVM</td>
<td>QCOW2</td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">URL. The secure HTTP or HTTPS URL that CloudStack can use to
access your disk. The type of file at the URL must match the value
chosen in Format. For example, if Format is VHD, the URL might
look like the following:</p>
<p><code class="docutils literal notranslate"><span class="pre">http://yourFileServerIP/userdata/myDataDisk.vhd</span></code></p>
</li>
<li><p class="first">MD5 checksum. （可选） Use the hash that you created in step 1.</p>
</li>
</ul>
</li>
<li><p class="first">Wait until the status of the volume shows that the upload is
complete. Click Instances - Volumes, find the name you specified in
step 5, and make sure the status is Uploaded.</p>
</li>
</ol>
</div>
<div class="section" id="attaching-a-volume">
<h3>Attaching a Volume<a class="headerlink" href="storage.html#attaching-a-volume" title="Permalink to this headline">¶</a></h3>
<p>You can attach a volume to a guest VM to provide extra disk storage.
Attach a volume when you first create a new volume, when you are moving
an existing volume from one VM to another, or after you have migrated a
volume from one storage pool to another.</p>
<ol class="arabic simple">
<li>Log in to the CloudStack UI as a user or admin.</li>
<li>In the left navigation, click Storage.</li>
<li>In Select View, choose Volumes.</li>
<li>Click the volume name in the Volumes list, then click the Attach Disk
button <img alt="Attach Disk Button." src="_images/attach-disk-icon.png" /></li>
<li>In the Instance popup, choose the VM to which you want to attach the
volume. You will only see instances to which you are allowed to
attach volumes; for example, a user will see only instances created
by that user, but the administrator will have more choices.</li>
<li>When the volume has been attached, you should be able to see it by
clicking Instances, the instance name, and View Volumes.</li>
</ol>
</div>
<div class="section" id="detaching-and-moving-volumes">
<h3>Detaching and Moving Volumes<a class="headerlink" href="storage.html#detaching-and-moving-volumes" title="Permalink to this headline">¶</a></h3>
<div class="admonition note">
<p class="first admonition-title">提示</p>
<p class="last">This procedure is different from moving volumes from one storage pool
to another as described in <a class="reference external" href="storage.html#vm-storage-migration">“VM Storage Migration”</a>.</p>
</div>
<p>A volume can be detached from a guest VM and attached to another guest.
Both CloudStack administrators and users can detach volumes from VMs and
move them to other VMs.</p>
<p>If the two VMs are in different clusters, and the volume is large, it
may take several minutes for the volume to be moved to the new VM.</p>
<ol class="arabic simple">
<li>Log in to the CloudStack UI as a user or admin.</li>
<li>In the left navigation bar, click Storage, and choose Volumes in
Select View. Alternatively, if you know which VM the volume is
attached to, you can click Instances, click the VM name, and click
View Volumes.</li>
<li>Click the name of the volume you want to detach, then click the
Detach Disk button. <img alt="Detach Disk Button." src="_images/detach-disk-icon.png" /></li>
<li>To move the volume to another VM, follow the steps in
<a class="reference external" href="storage.html#attaching-a-volume">“Attaching a Volume”</a>.</li>
</ol>
</div>
<div class="section" id="id2">
<h3>VM Storage Migration<a class="headerlink" href="storage.html#id2" title="Permalink to this headline">¶</a></h3>
<p>Supported in XenServer, VMware and KVM</p>
<div class="admonition note">
<p class="first admonition-title">提示</p>
<p class="last">This procedure is different from moving disk volumes from one VM to
another as described in <a class="reference external" href="storage.html#detaching-and-moving-volumes">“Detaching and Moving Volumes”</a>.</p>
</div>
<p>You can migrate a virtual machine’s root disk volume or any additional
data disk volume from one storage pool to another in the same zone.</p>
<p>You can use the storage migration feature to achieve some commonly
desired administration goals, such as balancing the load on storage
pools and increasing the reliability of virtual machines by moving them
away from any storage pool that is experiencing issues.</p>
<p>On XenServer and VMware, live migration of VM storage is enabled through
CloudStack support for XenMotion and vMotion. Live storage migration
allows VMs to be moved from one host to another, where the VMs are not
located on storage shared between the two hosts. It provides the option
to live migrate a VM’s disks along with the VM itself. It is possible to
migrate a VM from one XenServer resource pool / VMware cluster to
another, or to migrate a VM whose disks are on local storage, or even to
migrate a VM’s disks from one storage repository to another, all while
the VM is running.</p>
<div class="admonition note">
<p class="first admonition-title">提示</p>
<p class="last">Because of a limitation in VMware, live migration of storage for a
VM is allowed only if the source and target storage pool are
accessible to the source host; that is, the host where the VM is
running when the live migration operation is requested.</p>
</div>
<p>For KVM, live storage migration is available from the 4.11 release
and currently only supports migration from NFS/CEPH to SolidFire Managed Storage.</p>
<div class="section" id="migrating-a-data-volume-to-a-new-storage-pool">
<h4>Migrating a Data Volume to a New Storage Pool<a class="headerlink" href="storage.html#migrating-a-data-volume-to-a-new-storage-pool" title="Permalink to this headline">¶</a></h4>
<p>There are two situations when you might want to migrate a disk:</p>
<ul class="simple">
<li>Move the disk to new storage, but leave it attached to the same
running VM.</li>
<li>Detach the disk from its current VM, move it to new storage, and
attach it to a new VM.</li>
</ul>
<div class="section" id="migrating-storage-for-a-running-vm-on-xenserver-and-vmware">
<h5>Migrating Storage For a Running VM on XenServer and VMware<a class="headerlink" href="storage.html#migrating-storage-for-a-running-vm-on-xenserver-and-vmware" title="Permalink to this headline">¶</a></h5>
<ol class="arabic simple">
<li>Log in to the CloudStack UI as a user or admin.</li>
<li>In the left navigation bar, click Instances, click the VM name, and
click View Volumes.</li>
<li>Click the volume you want to migrate.</li>
<li>Detach the disk from the VM. See <a class="reference external" href="storage.html#detaching-and-moving-volumes">“Detaching and
Moving Volumes”</a> but skip the “reattach”
step at the end. You will do that after migrating to new storage.</li>
<li>Click the Migrate Volume button <img alt="button to migrate a volume." src="_images/migrate-instance.png" /> and choose the
destination from the dropdown list.</li>
<li>Watch for the volume status to change to Migrating, then back to
Ready.</li>
</ol>
</div>
<div class="section" id="migrating-storage-for-a-running-vm-on-kvm">
<h5>Migrating Storage For a Running VM on KVM<a class="headerlink" href="storage.html#migrating-storage-for-a-running-vm-on-kvm" title="Permalink to this headline">¶</a></h5>
<p>KVM live storage migration is currently supported only from CEPH and NFS to SolidFire Managed Storage,
and is currently only supported via API call (i.e. we can use CloudMonkey)</p>
<ol class="arabic simple">
<li>Identify the VM UUID to be migrated.</li>
<li>Identify the volume(s) UUID(s) which are attached to VM and needs to be migrated.</li>
<li>Identify the SolidFire pool UUID to which you want to migrate VM’s volumes.</li>
<li>Identify suitable KVM host UUID to which the VM will be live migrated.</li>
</ol>
<p>Using CloudMonkey issue the command as in example given below:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">migrateVirtualMachineWithVolume</span> <span class="n">virtualmachineid</span><span class="o">=</span><span class="n">ec5d3a84</span><span class="o">-</span><span class="mi">2</span><span class="n">eb8</span><span class="o">-</span><span class="mi">4</span><span class="n">a37</span><span class="o">-</span><span class="mi">83</span><span class="n">f3</span><span class="o">-</span><span class="mi">007</span><span class="n">b5013e3d9</span>
<span class="n">hostid</span><span class="o">=</span><span class="n">bee55404</span><span class="o">-</span><span class="mf">68e9</span><span class="o">-</span><span class="mi">4710</span><span class="o">-</span><span class="n">bb10</span><span class="o">-</span><span class="n">ab9f4a3d357d</span>
<span class="n">migrateto</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">pool</span><span class="o">=</span><span class="mi">67654174</span><span class="o">-</span><span class="n">e2b6</span><span class="o">-</span><span class="mi">4734</span><span class="o">-</span><span class="mi">813</span><span class="n">d</span><span class="o">-</span><span class="mi">2</span><span class="n">a4f0b027c0d</span> <span class="n">migrateto</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">volume</span><span class="o">=</span><span class="n">ea390749</span><span class="o">-</span><span class="mi">0194</span><span class="o">-</span><span class="mi">4088</span><span class="o">-</span><span class="mi">860</span><span class="n">c</span><span class="o">-</span><span class="mi">71717</span><span class="n">c4efabe</span>
<span class="n">migrateto</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">pool</span><span class="o">=</span><span class="mi">67654174</span><span class="o">-</span><span class="n">e2b6</span><span class="o">-</span><span class="mi">4734</span><span class="o">-</span><span class="mi">813</span><span class="n">d</span><span class="o">-</span><span class="mi">2</span><span class="n">a4f0b027c0d</span> <span class="n">migrateto</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">volume</span><span class="o">=</span><span class="mi">3</span><span class="n">b37927b</span><span class="o">-</span><span class="mi">2</span><span class="n">cd2</span><span class="o">-</span><span class="mi">46</span><span class="n">d1</span><span class="o">-</span><span class="n">aeca</span><span class="o">-</span><span class="mi">18</span><span class="n">d4af46bda2</span>
</pre></div>
</div>
<p>In the command above, new volumes are being created on SolidFire Managed Storage,
internal volume mirroring process is started via libvirt (from current storage NFS/CEPH to SolidFire)
and at the end of the volume mirroring process, the VM live migration is done to the host defined above.</p>
<p>In the command above we have “pairing” of volume and the storage pool to which to migrate specific volume to.
In example above, we are migrating 2 volumes to the same SolidFire Storage 集群, but optionally you could
migrate 2 volumes to 2 different SolidFire Storage Clusters.</p>
<p>Order of volumes, as attached to VM, is NOT relevant - i.e. first volume in the migration command ( migrateto[0].volume )
can be any DATA volume, while second volume ( migrateto[1].volume ) can be i.e. ROOT volume</p>
<p>You can migrate only some or all of the volumes (attached to specific VM) to a new Storage Pool.</p>
<p>Note, that depending on your configuration, you will need to change Compute/Data 磁盘方案, in case you have
different storage tags set on CEPH/NFS versus tags on SolidFire (and in case your Compute/Data disk offerings reference these tags).</p>
</div>
<div class="section" id="migrating-storage-and-attaching-to-a-different-vm">
<h5>Migrating Storage and Attaching to a Different VM<a class="headerlink" href="storage.html#migrating-storage-and-attaching-to-a-different-vm" title="Permalink to this headline">¶</a></h5>
<ol class="arabic simple">
<li>Log in to the CloudStack UI as a user or admin.</li>
<li>Detach the disk from the VM. See <a class="reference external" href="storage.html#detaching-and-moving-volumes">“Detaching and
Moving Volumes”</a> but skip the “reattach”
step at the end. You will do that after migrating to new storage.</li>
<li>Click the Migrate Volume button <img alt="button to migrate a volume." src="_images/migrate-instance.png" /> and choose the
destination from the dropdown list.</li>
<li>Watch for the volume status to change to Migrating, then back to
Ready. You can find the volume by clicking Storage in the left
navigation bar. Make sure that Volumes is displayed at the top of the
window, in the Select View dropdown.</li>
<li>Attach the volume to any desired VM running in the same cluster as
the new storage server. See <a class="reference external" href="storage.html#attaching-a-volume">“Attaching a
Volume”</a></li>
</ol>
</div>
</div>
<div class="section" id="migrating-a-vm-root-volume-to-a-new-storage-pool">
<h4>Migrating a VM Root Volume to a New Storage Pool<a class="headerlink" href="storage.html#migrating-a-vm-root-volume-to-a-new-storage-pool" title="Permalink to this headline">¶</a></h4>
<p>(XenServer, VMware) You can live migrate a VM’s root disk from one
storage pool to another, without stopping the VM first.</p>
<p>(KVM) When migrating the root disk volume, the VM must first be stopped,
and users can not access the VM. After migration is complete, the VM can
be restarted.</p>
<ol class="arabic">
<li><p class="first">Log in to the CloudStack UI as a user or admin.</p>
</li>
<li><p class="first">In the left navigation bar, click Instances, and click the VM name.</p>
</li>
<li><p class="first">(KVM only) Stop the VM.</p>
</li>
<li><p class="first">Click the Migrate button <img alt="button to migrate a volume." src="_images/migrate-instance.png" /> and choose the
destination from the dropdown list.</p>
<div class="admonition note">
<p class="first admonition-title">提示</p>
<p class="last">If the VM’s storage has to be migrated along with the VM, this will
be noted in the host list. CloudStack will take care of the storage
migration for you.</p>
</div>
</li>
<li><p class="first">Watch for the volume status to change to Migrating, then back to
Running (or Stopped, in the case of KVM). This can take some time.</p>
</li>
<li><p class="first">(KVM only) Restart the VM.</p>
</li>
</ol>
</div>
</div>
<div class="section" id="resizing-volumes">
<h3>Resizing Volumes<a class="headerlink" href="storage.html#resizing-volumes" title="Permalink to this headline">¶</a></h3>
<p>CloudStack provides the ability to resize data disks; CloudStack
controls volume size by using disk offerings. This provides CloudStack
administrators with the flexibility to choose how much space they want
to make available to the end users. Volumes within the disk offerings
with the same storage tag can be resized. For example, if you only want
to offer 10, 50, and 100 GB offerings, the allowed resize should stay
within those limits. That implies if you define a 10 GB, a 50 GB and a
100 GB disk offerings, a user can upgrade from 10 GB to 50 GB, or 50 GB
to 100 GB. If you create a custom-sized disk offering, then you have the
option to resize the volume by specifying a new, larger size.</p>
<p>Additionally, using the resizeVolume API, a data volume can be moved
from a static disk offering to a custom disk offering with the size
specified. This functionality allows those who might be billing by
certain volume sizes or disk offerings to stick to that model, while
providing the flexibility to migrate to whatever custom size necessary.</p>
<p>This feature is supported on KVM, XenServer, and VMware hosts. However,
shrinking volumes is not supported on VMware hosts.</p>
<p>Before you try to resize a volume, consider the following:</p>
<ul class="simple">
<li>The VMs associated with the volume are stopped.</li>
<li>The data disks associated with the volume are removed.</li>
<li>When a volume is shrunk, the disk associated with it is simply
truncated, and doing so would put its content at risk of data loss.
Therefore, resize any partitions or file systems before you shrink a
data disk so that all the data is moved off from that disk.</li>
</ul>
<p>To resize a volume:</p>
<ol class="arabic">
<li><p class="first">Log in to the CloudStack UI as a user or admin.</p>
</li>
<li><p class="first">In the left navigation bar, click Storage.</p>
</li>
<li><p class="first">In Select View, choose Volumes.</p>
</li>
<li><p class="first">Select the volume name in the Volumes list, then click the Resize
Volume button <img alt="button to display the resize volume option." src="_images/resize-volume-icon.png" /></p>
</li>
<li><p class="first">In the Resize Volume pop-up, choose desired characteristics for the
storage.</p>
<p><img alt="option to resize a volume." src="_images/resize-volume.png" /></p>
<ol class="arabic">
<li><p class="first">If you select Custom Disk, specify a custom size.</p>
</li>
<li><p class="first">Click Shrink OK to confirm that you are reducing the size of a
volume.</p>
<p>This parameter protects against inadvertent shrinking of a disk,
which might lead to the risk of data loss. You must sign off that
you know what you are doing.</p>
</li>
</ol>
</li>
<li><p class="first">Click OK.</p>
</li>
</ol>
</div>
<div class="section" id="reset-vm-to-new-root-disk-on-reboot">
<h3>Reset VM to New Root Disk on Reboot<a class="headerlink" href="storage.html#reset-vm-to-new-root-disk-on-reboot" title="Permalink to this headline">¶</a></h3>
<p>You can specify that you want to discard the root disk and create a new
one whenever a given VM is rebooted. This is useful for secure
environments that need a fresh start on every boot and for desktops that
should not retain state. The IP address of the VM will not change due to
this operation.</p>
<p><strong>To enable root disk reset on VM reboot:</strong></p>
<p>When creating a new service offering, set the parameter isVolatile to
True. VMs created from this service offering will have their disks reset
upon reboot. See <a class="reference external" href="service_offerings.html#creating-a-new-compute-offering">“Creating a New Compute
Offering”</a>.</p>
</div>
<div class="section" id="volume-deletion-and-garbage-collection">
<h3>Volume Deletion and Garbage Collection<a class="headerlink" href="storage.html#volume-deletion-and-garbage-collection" title="Permalink to this headline">¶</a></h3>
<p>The deletion of a volume does not delete the snapshots that have been
created from the volume</p>
<p>When a VM is destroyed, data disk volumes that are attached to the VM
are not deleted.</p>
<p>Volumes are permanently destroyed using a garbage collection process.
The global configuration variables expunge.delay and expunge.interval
determine when the physical deletion of volumes will occur.</p>
<ul class="simple">
<li><cite>expunge.delay</cite>: determines how old the volume must be before it is
destroyed, in seconds</li>
<li><cite>expunge.interval</cite>: determines how often to run the garbage collection
check</li>
</ul>
<p>Administrators should adjust these values depending on site policies
around data retention.</p>
</div>
</div>
<div class="section" id="working-with-volume-snapshots">
<h2>磁盘镜像<a class="headerlink" href="storage.html#working-with-volume-snapshots" title="Permalink to this headline">¶</a></h2>
<p>(Supported for the following hypervisors: <strong>XenServer</strong>, <strong>VMware
vSphere</strong>, and <strong>KVM</strong>)</p>
<p>CloudStack supports snapshots of disk volumes. Snapshots are a
point-in-time capture of virtual machine disks. Memory and CPU states
are not captured. If you are using the Oracle VM hypervisor, you can not
take snapshots, since OVM does not support them.</p>
<p>Snapshots may be taken for volumes, including both root and data disks
(except when the Oracle VM hypervisor is used, which does not support
snapshots). The administrator places a limit on the number of stored
snapshots per user. Users can create new volumes from the snapshot for
recovery of particular files and they can create templates from
snapshots to boot from a restored disk.</p>
<p>Users can create snapshots manually or by setting up automatic recurring
snapshot policies. Users can also create disk volumes from snapshots,
which may be attached to a VM like any other disk volume. Snapshots of
both root disks and data disks are supported. However, CloudStack does
not currently support booting a VM from a recovered root disk. A disk
recovered from snapshot of a root disk is treated as a regular data
disk; the data on recovered disk can be accessed by attaching the disk
to a VM.</p>
<p>A completed snapshot is copied from primary storage to secondary
storage, where it is stored until deleted or purged by newer snapshot.</p>
<div class="section" id="how-to-snapshot-a-volume">
<h3>How to Snapshot a Volume<a class="headerlink" href="storage.html#how-to-snapshot-a-volume" title="Permalink to this headline">¶</a></h3>
<ol class="arabic simple">
<li>Log in to the CloudStack UI as a user or administrator.</li>
<li>In the left navigation bar, click Storage.</li>
<li>In Select View, be sure Volumes is selected.</li>
<li>Click the name of the volume you want to snapshot.</li>
<li>Click the Snapshot button. <img alt="Snapshot Button." src="_images/SnapshotButton.png" /></li>
</ol>
</div>
<div class="section" id="automatic-snapshot-creation-and-retention">
<h3>Automatic Snapshot Creation and Retention<a class="headerlink" href="storage.html#automatic-snapshot-creation-and-retention" title="Permalink to this headline">¶</a></h3>
<p>(Supported for the following hypervisors: <strong>XenServer</strong>, <strong>VMware
vSphere</strong>, and <strong>KVM</strong>)</p>
<p>Users can set up a recurring snapshot policy to automatically create
multiple snapshots of a disk at regular intervals. Snapshots can be
created on an hourly, daily, weekly, or monthly interval. One snapshot
policy can be set up per disk volume. For example, a user can set up a
daily snapshot at 02:30.</p>
<p>With each snapshot schedule, users can also specify the number of
scheduled snapshots to be retained. Older snapshots that exceed the
retention limit are automatically deleted. This user-defined limit must
be equal to or lower than the global limit set by the CloudStack
administrator. See <a class="reference external" href="usage.html#globally-configured-limits">“Globally Configured
Limits”</a>. The limit applies only
to those snapshots that are taken as part of an automatic recurring
snapshot policy. Additional manual snapshots can be created and
retained.</p>
</div>
<div class="section" id="incremental-snapshots-and-backup">
<h3>Incremental Snapshots and Backup<a class="headerlink" href="storage.html#incremental-snapshots-and-backup" title="Permalink to this headline">¶</a></h3>
<p>Snapshots are created on primary storage where a disk resides. After a
snapshot is created, it is immediately backed up to secondary storage
and removed from primary storage for optimal utilization of space on
primary storage.</p>
<p>CloudStack does incremental backups for some hypervisors. When
incremental backups are supported, every N backup is a full backup.</p>
<table border="1" class="table-striped table-bordered table-hover docutils">
<colgroup>
<col width="42%" />
<col width="25%" />
<col width="25%" />
<col width="7%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">&#160;</th>
<th class="head">VMware vSphere</th>
<th class="head">Citrix XenServer</th>
<th class="head">KVM</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Support incremental backup</td>
<td>No</td>
<td>Yes</td>
<td>No</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="volume-status">
<h3>Volume Status<a class="headerlink" href="storage.html#volume-status" title="Permalink to this headline">¶</a></h3>
<p>When a snapshot operation is triggered by means of a recurring snapshot
policy, a snapshot is skipped if a volume has remained inactive since
its last snapshot was taken. A volume is considered to be inactive if it
is either detached or attached to a VM that is not running. CloudStack
ensures that at least one snapshot is taken since the volume last became
inactive.</p>
<p>When a snapshot is taken manually, a snapshot is always created
regardless of whether a volume has been active or not.</p>
</div>
<div class="section" id="snapshot-restore">
<h3>Snapshot Restore<a class="headerlink" href="storage.html#snapshot-restore" title="Permalink to this headline">¶</a></h3>
<p>There are two paths to restoring snapshots. Users can create a volume
from the snapshot. The volume can then be mounted to a VM and files
recovered as needed. Alternatively, a template may be created from the
snapshot of a root disk. The user can then boot a VM from this template
to effect recovery of the root disk.</p>
</div>
<div class="section" id="snapshot-job-throttling">
<h3>Snapshot Job Throttling<a class="headerlink" href="storage.html#snapshot-job-throttling" title="Permalink to this headline">¶</a></h3>
<p>When a snapshot of a virtual machine is requested, the snapshot job runs
on the same host where the VM is running or, in the case of a stopped
VM, the host where it ran last. If many snapshots are requested for VMs
on a single host, this can lead to problems with too many snapshot jobs
overwhelming the resources of the host.</p>
<p>To address this situation, the cloud’s root administrator can throttle
how many snapshot jobs are executed simultaneously on the hosts in the
cloud by using the global configuration setting
concurrent.snapshots.threshold.perhost. By using this setting, the
administrator can better ensure that snapshot jobs do not time out and
hypervisor hosts do not experience performance issues due to hosts being
overloaded with too many snapshot requests.</p>
<p>Set concurrent.snapshots.threshold.perhost to a value that represents a
best guess about how many snapshot jobs the hypervisor hosts can execute
at one time, given the current resources of the hosts and the number of
VMs running on the hosts. If a given host has more snapshot requests,
the additional requests are placed in a waiting queue. No new snapshot
jobs will start until the number of currently executing snapshot jobs
falls below the configured limit.</p>
<p>The admin can also set job.expire.minutes to place a maximum on how long
a snapshot request will wait in the queue. If this limit is reached, the
snapshot request fails and returns an error message.</p>
</div>
<div class="section" id="vmware-volume-snapshot-performance">
<h3>VMware Volume Snapshot Performance<a class="headerlink" href="storage.html#vmware-volume-snapshot-performance" title="Permalink to this headline">¶</a></h3>
<p>When you take a snapshot of a data or root volume on VMware, CloudStack
uses an efficient storage technique to improve performance.</p>
<p>A snapshot is not immediately exported from vCenter to a mounted NFS
share and packaged into an OVA file format. This operation would consume
time and resources. Instead, the original file formats (e.g., VMDK)
provided by vCenter are retained. An OVA file will only be created as
needed, on demand. To generate the OVA, CloudStack uses information in a
properties file (*.ova.meta) which it stored along with the original
snapshot data.</p>
<div class="admonition note">
<p class="first admonition-title">提示</p>
<p class="last">For upgrading customers: This process applies only to newly created
snapshots after upgrade to CloudStack 4.2. Snapshots that have already
been taken and stored in OVA format will continue to exist in that
format, and will continue to work as expected.</p>
</div>
</div>
<div class="section" id="disk-caching-kvm">
<h3>Disk caching (KVM)<a class="headerlink" href="storage.html#disk-caching-kvm" title="Permalink to this headline">¶</a></h3>
<p>This is for advanced user only, since may cause issues with improper DB changes.</p>
<p>Disk cache mode is the property of Compute Offering (ROOT disk) and Disk Offering (DATA disk).
Currently, disk cache mode can only be set by editing “disk_offering” table inside “cloud” DB
and can not be done via API/GUI (although there is “Write-cache Type” filed in the GUI on the “Add Disk Offering” wizard).
Cache modes available are: write-back and write-through</p>
<p>Before proceeding with changing cache mode on disks (Offerings), please make sure that you understand
the consequences and limitations it might bring.</p>
<ol class="arabic simple">
<li>If the guest storage is hosted on a clustered file system (or is read-only or is marked shareable), then the cache mode is ignored when determining if VM live migration can be allowed.</li>
<li>If guest storage is hosted on shared storage (NFS/CEPH) libvirt will not allow VM live migration unless the cache mode is set to “none”.</li>
<li>This means that in case of NFS and CEPH, VM live migrations will not be possible, and this will also make it impossible to put host into maintenance mode (VMs being live migrated away from this host - will not work)</li>
</ol>
<p>In order to set disk write-back or write-through cache mode, we need to edit it’s parent Compute Offering (for ROOT disk) or Disk Offering (for DATA disks). Please note that this means that all volumes/disks which are created from specific offering will inherit cache mode.</p>
<div class="code highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mysql</span><span class="o">&gt;</span> <span class="n">select</span> <span class="nb">id</span> <span class="kn">from</span> <span class="nn">disk_offering</span> <span class="n">where</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;8vCPU-64GB-HDD-STD-NFS&quot;</span><span class="p">;</span>
<span class="o">+-----+</span>
<span class="o">|</span> <span class="nb">id</span>  <span class="o">|</span>
<span class="o">+-----+</span>
<span class="o">|</span> <span class="mi">111</span> <span class="o">|</span>
<span class="o">+-----+</span>
<span class="mi">1</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="n">select</span> <span class="nb">id</span> <span class="kn">from</span> <span class="nn">disk_offering</span> <span class="n">where</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;100GB-HDD-STD-NFS&quot;</span><span class="p">;</span>
<span class="o">+-----+</span>
<span class="o">|</span> <span class="nb">id</span>  <span class="o">|</span>
<span class="o">+-----+</span>
<span class="o">|</span> <span class="mi">114</span> <span class="o">|</span>
<span class="o">+-----+</span>
<span class="mi">1</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>
<span class="n">mysql</span><span class="o">&gt;</span> <span class="n">UPDATE</span> <span class="n">disk_offering</span> <span class="n">SET</span> <span class="n">cache_mode</span><span class="o">=</span><span class="s1">&#39;writeback&#39;</span> <span class="n">WHERE</span> <span class="nb">id</span> <span class="ow">in</span> <span class="p">(</span><span class="s1">&#39;111&#39;</span><span class="p">,</span><span class="s1">&#39;114&#39;</span><span class="p">);</span>
<span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">2</span> <span class="n">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>
<span class="n">Rows</span> <span class="n">matched</span><span class="p">:</span> <span class="mi">2</span>  <span class="n">Changed</span><span class="p">:</span> <span class="mi">2</span>  <span class="n">Warnings</span><span class="p">:</span> <span class="mi">0</span>
</pre></div>
</div>
<p>In example above, we have set the write-back cache mode for a single Compute Offering and single Disk Offering.
In order for KVM to actually pick-up the cache mode we have set, we need to stop VM and start VM. VM Reboot (“Reboot Instance” button)
via GUI will not be enough.</p>
<p>After VM is started we can confirm that the both the ROOT and DATA disk of a VM have cache mode set to write-back:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">root</span><span class="nd">@ix1</span><span class="o">-</span><span class="n">c7</span><span class="o">-</span><span class="mi">4</span><span class="p">:</span><span class="o">~</span><span class="c1"># virsh dumpxml i-2-10-VM | grep cache -A2</span>
   <span class="o">&lt;</span><span class="n">driver</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;qemu&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;qcow2&#39;</span> <span class="n">cache</span><span class="o">=</span><span class="s1">&#39;writeback&#39;</span><span class="o">/&gt;</span>
   <span class="o">&lt;</span><span class="n">source</span> <span class="n">file</span><span class="o">=</span><span class="s1">&#39;/mnt/63a3ae7b-9ea9-3884-a772-1ea939ef6ec3/1b655159-ae10-41cf-8987-f1cfb47fe453&#39;</span><span class="o">/&gt;</span>
   <span class="o">&lt;</span><span class="n">target</span> <span class="n">dev</span><span class="o">=</span><span class="s1">&#39;vda&#39;</span> <span class="n">bus</span><span class="o">=</span><span class="s1">&#39;virtio&#39;</span><span class="o">/&gt;</span>
   <span class="o">...</span>
   <span class="o">&lt;</span><span class="n">driver</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;qemu&#39;</span> <span class="nb">type</span><span class="o">=</span><span class="s1">&#39;qcow2&#39;</span> <span class="n">cache</span><span class="o">=</span><span class="s1">&#39;writeback&#39;</span><span class="o">/&gt;</span>
   <span class="o">&lt;</span><span class="n">source</span> <span class="n">file</span><span class="o">=</span><span class="s1">&#39;/mnt/63a3ae7b-9ea9-3884-a772-1ea939ef6ec3/09bdadcb-ec6e-4dda-b37b-17b1a749257f&#39;</span><span class="o">/&gt;</span>
   <span class="o">&lt;</span><span class="n">target</span> <span class="n">dev</span><span class="o">=</span><span class="s1">&#39;vdb&#39;</span> <span class="n">bus</span><span class="o">=</span><span class="s1">&#39;virtio&#39;</span><span class="o">/&gt;</span>
</pre></div>
</div>
</div>
</div>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="storage.html#">Back to top</a>
          | <a href="hosts.html" title="Previous Chapter: 主机"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; 主机</span>
          </a>
          | <a href="systemvm.html" title="Next Chapter: 系统虚拟机"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">系统虚拟机 &raquo;</span>
          </a>
      
        <br/>
        
<div id="sourcelink">
  <a href="_sources/storage.rst.txt"
     rel="nofollow">Source</a>
</div>
      
    </p>
    <p>
        &copy; Copyright 2016, Apache Software Foundation.<br/>
    </p>
  </div>
</footer>
  </body>
</html>