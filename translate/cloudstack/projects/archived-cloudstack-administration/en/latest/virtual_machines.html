<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>Working with Virtual Machines &#8212; Apache CloudStack Administration Documentation 4.11.0.0 documentation</title>
    <link rel="stylesheet" href="_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="https://assets.readthedocs.org/static/css/badge_only.css" type="text/css" />
    <link rel="stylesheet" href="_static/bootswatch-3.2.0/spacelab/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="_static/bootstrap-sphinx.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
    <script type="text/javascript" src="_static/jquery.js"></script>
    <script type="text/javascript" src="_static/underscore.js"></script>
    <script type="text/javascript" src="_static/doctools.js"></script>
    <script type="text/javascript" src="https://assets.readthedocs.org/static/javascript/readthedocs-doc-embed.js"></script>
    <script type="text/javascript" src="_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="_static/bootstrap-3.2.0/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="_static/bootstrap-sphinx.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Working with Templates" href="templates.html" />
    <link rel="prev" title="Setting Up Networking for Users" href="networking.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  
<!-- RTD Extra Head -->

<!-- 
Always link to the latest version, as canonical.
http://docs.readthedocs.org/en/latest/canonical.html
-->
<link rel="canonical" href="virtual_machines.html" />

<link rel="stylesheet" href="https://assets.readthedocs.org/static/css/readthedocs-doc-embed.css" type="text/css" />

<script type="text/javascript" src="_static/readthedocs-data.js"></script>

<!-- Add page-specific data, which must exist in the page js, not global -->
<script type="text/javascript">
READTHEDOCS_DATA['page'] = 'virtual_machines'
READTHEDOCS_DATA['source_suffix'] = '.rst'
</script>

<script type="text/javascript" src="https://assets.readthedocs.org/static/javascript/readthedocs-analytics.js"></script>

<!-- end RTD <extrahead> -->
</head><body>

  <div id="navbar" class="navbar navbar-inverse navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="index.html">
          管理员手册</a>
        <span class="navbar-text navbar-version pull-left"><b>4.11</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
            
              <li class="dropdown globaltoc-container">
                <a role="button"
                   id="dLabelGlobalToc"
                   data-toggle="dropdown"
                   data-target="#"
                   href="index.html">Sections <b class="caret"></b></a>
                <ul class="dropdown-menu globaltoc"
                    role="menu"
                    aria-labelledby="dLabelGlobalToc">
                     <ul>
<li class="toctree-l1"><a class="reference internal" href="ui.html">User Interface</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="accounts.html">Managing Roles, Accounts, Users and Domains</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="projects.html">Using Projects to Organize Users and Resources</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="service_offerings.html">Service Offerings</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="networking.html">Setting Up Networking for Users</a></li>
</ul>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="virtual_machines.html#">Working with Virtual Machines</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="templates.html">Working with Templates</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="hosts.html">Working with Hosts</a></li>
<li class="toctree-l1"><a class="reference internal" href="hosts.html#security">Security</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="storage.html">Working with Storage</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="systemvm.html">Working with System Virtual Machines</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="usage.html">Working with Usage</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="networking_and_traffic.html">Managing Networks and Traffic</a></li>
<li class="toctree-l1"><a class="reference internal" href="networking/using_remote_access.html">Using Remote Access VPN</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="management.html">Managing the Cloud</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="reliability.html">System Reliability and High Availability</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="plugins/quota.html">Quota Plugin</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="tuning.html">Tuning</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="events.html">Event Notification</a></li>
<li class="toctree-l1"><a class="reference internal" href="troubleshooting.html">TroubleShooting</a></li>
</ul>


                </ul>
              </li>
              
                
              
            
            
              
                
  <li>
    <a href="networking.html" title="Previous Chapter: Setting Up Networking for Users"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; Setting Up Networking for Users</span>
    </a>
  </li>
  <li>
    <a href="templates.html" title="Next Chapter: Working with Templates"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">Working with Templates &raquo;</span>
    </a>
  </li>
              
            
            
            
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
      <div class="col-md-3">
        <div id="sidebar" class="bs-sidenav" role="complementary"><ul>
<li><a class="reference internal" href="virtual_machines.html#">Working with Virtual Machines</a><ul>
<li><a class="reference internal" href="virtual_machines.html#about-working-with-virtual-machines">About Working with Virtual Machines</a></li>
<li><a class="reference internal" href="virtual_machines.html#best-practices-for-virtual-machines">最佳实践 for Virtual Machines</a><ul>
<li><a class="reference internal" href="virtual_machines.html#monitor-vms-for-max-capacity">Monitor VMs for Max Capacity</a></li>
<li><a class="reference internal" href="virtual_machines.html#install-required-tools-and-drivers">Install Required Tools and Drivers</a></li>
</ul>
</li>
<li><a class="reference internal" href="virtual_machines.html#vm-lifecycle">VM Lifecycle</a></li>
<li><a class="reference internal" href="virtual_machines.html#creating-vms">Creating VMs</a></li>
<li><a class="reference internal" href="virtual_machines.html#accessing-vms">Accessing VMs</a></li>
<li><a class="reference internal" href="virtual_machines.html#stopping-and-starting-vms">Stopping and Starting VMs</a></li>
<li><a class="reference internal" href="virtual_machines.html#assigning-vms-to-hosts">Assigning VMs to Hosts</a><ul>
<li><a class="reference internal" href="virtual_machines.html#affinity-groups">Affinity Groups</a><ul>
<li><a class="reference internal" href="virtual_machines.html#creating-a-new-affinity-group">Creating a New Affinity Group</a></li>
<li><a class="reference internal" href="virtual_machines.html#assign-a-new-vm-to-an-affinity-group">Assign a New VM to an Affinity Group</a></li>
<li><a class="reference internal" href="virtual_machines.html#change-affinity-group-for-an-existing-vm">Change Affinity Group for an Existing VM</a></li>
<li><a class="reference internal" href="virtual_machines.html#view-members-of-an-affinity-group">View Members of an Affinity Group</a></li>
<li><a class="reference internal" href="virtual_machines.html#delete-an-affinity-group">Delete an Affinity Group</a></li>
</ul>
</li>
</ul>
</li>
<li><a class="reference internal" href="virtual_machines.html#virtual-machine-snapshots">Virtual Machine Snapshots</a><ul>
<li><a class="reference internal" href="virtual_machines.html#limitations-on-vm-snapshots">Limitations on VM Snapshots</a></li>
<li><a class="reference internal" href="virtual_machines.html#configuring-vm-snapshots">Configuring VM Snapshots</a></li>
<li><a class="reference internal" href="virtual_machines.html#using-vm-snapshots">Using VM Snapshots</a></li>
</ul>
</li>
<li><a class="reference internal" href="virtual_machines.html#changing-the-vm-name-os-or-group">Changing the VM Name, OS, or Group</a></li>
<li><a class="reference internal" href="virtual_machines.html#id3">Appending a Display Name to the Guest VM’s Internal Name</a></li>
<li><a class="reference internal" href="virtual_machines.html#changing-the-service-offering-for-a-vm">Changing the Service Offering for a VM</a><ul>
<li><a class="reference internal" href="virtual_machines.html#cpu-and-memory-scaling-for-running-vms">CPU and Memory Scaling for Running VMs</a></li>
<li><a class="reference internal" href="virtual_machines.html#updating-existing-vms">Updating Existing VMs</a></li>
<li><a class="reference internal" href="virtual_machines.html#configuring-dynamic-cpu-and-ram-scaling">Configuring Dynamic CPU and RAM Scaling</a></li>
<li><a class="reference internal" href="virtual_machines.html#how-to-dynamically-scale-cpu-and-ram">How to Dynamically Scale CPU and RAM</a></li>
<li><a class="reference internal" href="virtual_machines.html#limitations">Limitations</a></li>
</ul>
</li>
<li><a class="reference internal" href="virtual_machines.html#resetting-the-virtual-machine-root-volume-on-reboot">Resetting the Virtual Machine Root Volume on Reboot</a></li>
<li><a class="reference internal" href="virtual_machines.html#moving-vms-between-hosts-manual-live-migration">Moving VMs Between Hosts (Manual Live Migration)</a></li>
<li><a class="reference internal" href="virtual_machines.html#deleting-vms">Deleting VMs</a></li>
<li><a class="reference internal" href="virtual_machines.html#working-with-isos">Working with ISOs</a><ul>
<li><a class="reference internal" href="virtual_machines.html#adding-an-iso">Adding an ISO</a></li>
<li><a class="reference internal" href="virtual_machines.html#attaching-an-iso-to-a-vm">Attaching an ISO to a VM</a></li>
<li><a class="reference internal" href="virtual_machines.html#changing-a-vm-s-base-image">Changing a VM’s Base Image</a></li>
</ul>
</li>
<li><a class="reference internal" href="virtual_machines.html#using-ssh-keys-for-authentication">Using SSH Keys for Authentication</a><ul>
<li><a class="reference internal" href="virtual_machines.html#creating-an-instance-template-that-supports-ssh-keys">Creating an Instance Template that Supports SSH Keys</a></li>
<li><a class="reference internal" href="virtual_machines.html#creating-the-ssh-keypair">Creating the SSH Keypair</a></li>
<li><a class="reference internal" href="virtual_machines.html#creating-an-instance">Creating an Instance</a></li>
<li><a class="reference internal" href="virtual_machines.html#logging-in-using-the-ssh-keypair">Logging In Using the SSH Keypair</a></li>
<li><a class="reference internal" href="virtual_machines.html#resetting-ssh-keys">Resetting SSH Keys</a></li>
</ul>
</li>
<li><a class="reference internal" href="virtual_machines.html#user-data-and-meta-data">User-Data and Meta-Data</a><ul>
<li><a class="reference internal" href="virtual_machines.html#using-cloud-init">Using Cloud-Init</a></li>
<li><a class="reference internal" href="virtual_machines.html#user-data-example">user-data example</a></li>
</ul>
</li>
<li><a class="reference internal" href="virtual_machines.html#assigning-gpu-vgpu-to-guest-vms">Assigning GPU/vGPU to Guest VMs</a><ul>
<li><a class="reference internal" href="virtual_machines.html#prerequisites-and-system-requirements">Prerequisites and System Requirements</a></li>
<li><a class="reference internal" href="virtual_machines.html#supported-gpu-devices">Supported GPU Devices</a></li>
<li><a class="reference internal" href="virtual_machines.html#gpu-vgpu-assignment-workflow">GPU/vGPU Assignment Workflow</a></li>
</ul>
</li>
</ul>
</li>
</ul>

        </div>
      </div>
    <div class="col-md-9">
      
  <div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>NOTICE: THIS DOCUMENTATION SITE HAS BEEN SUPERSEDED.</p>
<p class="last">For the current documentation site goto: <a class="reference external" href="../../../../index.html">http://docs.cloudstack.apache.org</a></p>
</div>
<div class="section" id="working-with-virtual-machines">
<h1>Working with Virtual Machines<a class="headerlink" href="virtual_machines.html#working-with-virtual-machines" title="Permalink to this headline">¶</a></h1>
<div class="section" id="about-working-with-virtual-machines">
<h2>About Working with Virtual Machines<a class="headerlink" href="virtual_machines.html#about-working-with-virtual-machines" title="Permalink to this headline">¶</a></h2>
<p>CloudStack provides administrators with complete control over the
lifecycle of all guest VMs executing in the cloud. CloudStack provides
several guest management operations for end users and administrators.
VMs may be stopped, started, rebooted, and destroyed.</p>
<p>Guest VMs have a name and group. VM names and groups are opaque to
CloudStack and are available for end users to organize their VMs. Each
VM can have three names for use in different contexts. Only two of these
names can be controlled by the user:</p>
<ul class="simple">
<li>Instance name – a unique, immutable ID that is generated by
CloudStack and can not be modified by the user. This name conforms to
the requirements in IETF RFC 1123.</li>
<li>Display name – the name displayed in the CloudStack web UI. Can be
set by the user. Defaults to instance name.</li>
<li>Name – host name that the DHCP server assigns to the VM. Can be set
by the user. Defaults to instance name</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">You can append the display name of a guest VM to its internal name.
For more information, see <a class="reference external" href="virtual_machines.html#appending-a-display-name-to-the-guest-vms-internal-name">“Appending a Display Name to the Guest VM’s
Internal Name”</a>.</p>
</div>
<p>Guest VMs can be configured to be Highly Available (HA). An HA-enabled
VM is monitored by the system. If the system detects that the VM is
down, it will attempt to restart the VM, possibly on a different host.
For more information, see HA-Enabled Virtual Machines on</p>
<p>Each new VM is allocated one public IP address. When the VM is started,
CloudStack automatically creates a static NAT between this public IP
address and the private IP address of the VM.</p>
<p>If elastic IP is in use (with the NetScaler load balancer), the IP
address initially allocated to the new VM is not marked as elastic. The
user must replace the automatically configured IP with a specifically
acquired elastic IP, and set up the static NAT mapping between this new
IP and the guest VM’s private IP. The VM’s original IP address is then
released and returned to the pool of available public IPs. Optionally,
you can also decide not to allocate a public IP to a VM in an
EIP-enabled Basic zone. For more information on Elastic IP, see
<a class="reference external" href="http://docs.cloudstack.apache.org/projects/archived-cloudstack-administration/en/latest/networking2.html#about-elastic-ip">“About Elastic IP”</a>.</p>
<p>CloudStack cannot distinguish a guest VM that was shut down by the user
(such as with the “shutdown” command in Linux) from a VM that shut down
unexpectedly. If an HA-enabled VM is shut down from inside the VM,
CloudStack will restart it. To shut down an HA-enabled VM, you must go
through the CloudStack UI or API.</p>
</div>
<div class="section" id="best-practices-for-virtual-machines">
<h2>最佳实践 for Virtual Machines<a class="headerlink" href="virtual_machines.html#best-practices-for-virtual-machines" title="Permalink to this headline">¶</a></h2>
<p>For VMs to work as expected and provide excellent service, follow these
guidelines.</p>
<div class="section" id="monitor-vms-for-max-capacity">
<h3>Monitor VMs for Max Capacity<a class="headerlink" href="virtual_machines.html#monitor-vms-for-max-capacity" title="Permalink to this headline">¶</a></h3>
<p>The CloudStack administrator should monitor the total number of VM
instances in each cluster, and disable allocation to the cluster if the
total is approaching the maximum that the hypervisor can handle. Be sure
to leave a safety margin to allow for the possibility of one or more
hosts failing, which would increase the VM load on the other hosts as
the VMs are automatically redeployed. Consult the documentation for your
chosen hypervisor to find the maximum permitted number of VMs per host,
then use CloudStack global configuration settings to set this as the
default limit. Monitor the VM activity in each cluster at all times.
Keep the total number of VMs below a safe level that allows for the
occasional host failure. For example, if there are N hosts in the
cluster, and you want to allow for one host in the cluster to be down at
any given time, the total number of VM instances you can permit in the
cluster is at most (N-1) * (per-host-limit). Once a cluster reaches
this number of VMs, use the CloudStack UI to disable allocation of more
VMs to the cluster.</p>
</div>
<div class="section" id="install-required-tools-and-drivers">
<h3>Install Required Tools and Drivers<a class="headerlink" href="virtual_machines.html#install-required-tools-and-drivers" title="Permalink to this headline">¶</a></h3>
<p>Be sure the following are installed on each VM:</p>
<ul class="simple">
<li>For XenServer, install PV drivers and Xen tools on each VM. This will
enable live migration and clean guest shutdown. Xen tools are
required in order for dynamic CPU and RAM scaling to work.</li>
<li>For vSphere, install VMware Tools on each VM. This will enable
console view to work properly. VMware Tools are required in order for
dynamic CPU and RAM scaling to work.</li>
</ul>
<p>To be sure that Xen tools or VMware Tools is installed, use one of the
following techniques:</p>
<ul class="simple">
<li>Create each VM from a template that already has the tools installed;
or,</li>
<li>When registering a new template, the administrator or user can
indicate whether tools are installed on the template. This can be
done through the UI or using the updateTemplate API; or,</li>
<li>If a user deploys a virtual machine with a template that does not
have Xen tools or VMware Tools, and later installs the tools on the
VM, then the user can inform CloudStack using the
updateVirtualMachine API. After installing the tools and updating the
virtual machine, stop and start the VM.</li>
</ul>
</div>
</div>
<div class="section" id="vm-lifecycle">
<h2>VM Lifecycle<a class="headerlink" href="virtual_machines.html#vm-lifecycle" title="Permalink to this headline">¶</a></h2>
<p>Virtual machines can be in the following states:</p>
<p><img alt="Basic two-machine CloudStack deployment" src="_images/basic-deployment.png" /></p>
<p>Once a virtual machine is destroyed, it cannot be recovered. All the
resources used by the virtual machine will be reclaimed by the system.
This includes the virtual machine’s IP address.</p>
<p>A stop will attempt to gracefully shut down the operating system, which
typically involves terminating all the running applications. If the
operation system cannot be stopped, it will be forcefully terminated.
This has the same effect as pulling the power cord to a physical
machine.</p>
<p>A reboot is a stop followed by a start.</p>
<p>CloudStack preserves the state of the virtual machine hard disk until
the machine is destroyed.</p>
<p>A running virtual machine may fail because of hardware or network
issues. A failed virtual machine is in the down state.</p>
<p>The system places the virtual machine into the down state if it does not
receive the heartbeat from the hypervisor for three minutes.</p>
<p>The user can manually restart the virtual machine from the down state.</p>
<p>The system will start the virtual machine from the down state
automatically if the virtual machine is marked as HA-enabled.</p>
</div>
<div class="section" id="creating-vms">
<h2>Creating VMs<a class="headerlink" href="virtual_machines.html#creating-vms" title="Permalink to this headline">¶</a></h2>
<p>Virtual machines are usually created from a template. Users can also
create blank virtual machines. A blank virtual machine is a virtual
machine without an OS template. Users can attach an ISO file and install
the OS from the CD/DVD-ROM.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">You can create a VM without starting it. You can determine whether the
VM needs to be started as part of the VM deployment. A request parameter,
startVM, in the deployVm API provides this feature. For more information,
see the Developer’s Guide.</p>
</div>
<p>To create a VM from a template:</p>
<ol class="arabic">
<li><p class="first">Log in to the CloudStack UI as an administrator or user.</p>
</li>
<li><p class="first">In the left navigation bar, click Instances.</p>
</li>
<li><p class="first">Click Add Instance.</p>
</li>
<li><p class="first">Select a zone.</p>
</li>
<li><p class="first">Select a template, then follow the steps in the wizard. For more
information about how the templates came to be in this list, see
<a class="reference external" href="templates.html">*Working with Templates*</a>.</p>
</li>
<li><p class="first">Be sure that the hardware you have allows starting the selected
service offering.</p>
</li>
<li><p class="first">Click Submit and your VM will be created and started.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">For security reason, the internal name of the VM is visible
only to the root admin.</p>
</div>
</li>
</ol>
<p>To create a VM from an ISO:</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">(XenServer) Windows VMs running on XenServer require PV drivers,
which may be provided in the template or added after the VM is
created. The PV drivers are necessary for essential management
functions such as mounting additional volumes and ISO images,
live migration, and graceful shutdown.</p>
</div>
<ol class="arabic simple">
<li>Log in to the CloudStack UI as an administrator or user.</li>
<li>In the left navigation bar, click Instances.</li>
<li>Click Add Instance.</li>
<li>Select a zone.</li>
<li>Select ISO Boot, and follow the steps in the wizard.</li>
<li>Click Submit and your VM will be created and started.</li>
</ol>
</div>
<div class="section" id="accessing-vms">
<h2>Accessing VMs<a class="headerlink" href="virtual_machines.html#accessing-vms" title="Permalink to this headline">¶</a></h2>
<p>Any user can access their own virtual machines. The administrator can
access all VMs running in the cloud.</p>
<p>To access a VM through the CloudStack UI:</p>
<ol class="arabic simple">
<li>Log in to the CloudStack UI as a user or admin.</li>
<li>Click Instances, then click the name of a running VM.</li>
<li>Click the View Console button <img alt="depicts adding an iso image" src="_images/console-icon.png" />.</li>
</ol>
<p>To access a VM directly over the network:</p>
<ol class="arabic simple">
<li>The VM must have some port open to incoming traffic. For example, in
a basic zone, a new VM might be assigned to a security group which
allows incoming traffic. This depends on what security group you
picked when creating the VM. In other cases, you can open a port by
setting up a port forwarding policy. See <a class="reference external" href="http://docs.cloudstack.apache.org/projects/archived-cloudstack-administration/en/latest/networking2.html#ip-forwarding-and-firewalling">“IP
Forwarding and Firewalling”</a>.</li>
<li>If a port is open but you can not access the VM using ssh, it’s
possible that ssh is not already enabled on the VM. This will depend
on whether ssh is enabled in the template you picked when creating
the VM. Access the VM through the CloudStack UI and enable ssh on the
machine using the commands for the VM’s operating system.</li>
<li>If the network has an external firewall device, you will need to
create a firewall rule to allow access. See <a class="reference external" href="http://docs.cloudstack.apache.org/projects/archived-cloudstack-administration/en/latest/networking2.html#ip-forwarding-and-firewalling">“IP
Forwarding and Firewalling”</a>.</li>
</ol>
</div>
<div class="section" id="stopping-and-starting-vms">
<h2>Stopping and Starting VMs<a class="headerlink" href="virtual_machines.html#stopping-and-starting-vms" title="Permalink to this headline">¶</a></h2>
<p>Once a VM instance is created, you can stop, restart, or delete it as
needed. In the CloudStack UI, click Instances, select the VM, and use
the Stop, Start, Reboot, and Destroy buttons.</p>
</div>
<div class="section" id="assigning-vms-to-hosts">
<h2>Assigning VMs to Hosts<a class="headerlink" href="virtual_machines.html#assigning-vms-to-hosts" title="Permalink to this headline">¶</a></h2>
<p>At any point in time, each virtual machine instance is running on a
single host. How does CloudStack determine which host to place a VM on?
There are several ways:</p>
<ul class="simple">
<li>Automatic default host allocation. CloudStack can automatically pick
the most appropriate host to run each virtual machine.</li>
<li>Instance type preferences. CloudStack administrators can specify that
certain hosts should have a preference for particular types of guest
instances. For example, an administrator could state that a host
should have a preference to run Windows guests. The default host
allocator will attempt to place guests of that OS type on such hosts
first. If no such host is available, the allocator will place the
instance wherever there is sufficient physical capacity.</li>
<li>Vertical and horizontal allocation. Vertical allocation consumes all
the resources of a given host before allocating any guests on a
second host. This reduces power consumption in the cloud. Horizontal
allocation places a guest on each host in a round-robin fashion. This
may yield better performance to the guests in some cases.</li>
<li>End user preferences. Users can not control exactly which host will
run a given VM instance, but they can specify a zone for the VM.
CloudStack is then restricted to allocating the VM only to one of the
hosts in that zone.</li>
<li>Host tags. The administrator can assign tags to hosts. These tags can
be used to specify which host a VM should use. The CloudStack
administrator decides whether to define host tags, then create a
service offering using those tags and offer it to the user.</li>
<li>Affinity groups. By defining affinity groups and assigning VMs to
them, the user or administrator can influence (but not dictate) which
VMs should run on separate hosts. This feature is to let users
specify that certain VMs won’t be on the same host.</li>
<li>CloudStack also provides a pluggable interface for adding new
allocators. These custom allocators can provide any policy the
administrator desires.</li>
</ul>
<div class="section" id="affinity-groups">
<h3>Affinity Groups<a class="headerlink" href="virtual_machines.html#affinity-groups" title="Permalink to this headline">¶</a></h3>
<p>By defining affinity groups and assigning VMs to them, the user or
administrator can influence (but not dictate) which VMs should run on
separate hosts. This feature is to let users specify that VMs with the
same “host anti-affinity” type won’t be on the same host. This serves to
increase fault tolerance. If a host fails, another VM offering the same
service (for example, hosting the user’s website) is still up and
running on another host.</p>
<p>The scope of an affinity group is per user account.</p>
<div class="section" id="creating-a-new-affinity-group">
<h4>Creating a New Affinity Group<a class="headerlink" href="virtual_machines.html#creating-a-new-affinity-group" title="Permalink to this headline">¶</a></h4>
<p>To add an affinity group:</p>
<ol class="arabic simple">
<li>Log in to the CloudStack UI as an administrator or user.</li>
<li>In the left navigation bar, click Affinity Groups.</li>
<li>Click Add affinity group. In the dialog box, fill in the following
fields:<ul>
<li>Name. Give the group a name.</li>
<li>Description. Any desired text to tell more about the purpose of
the group.</li>
<li>Type. The only supported type shipped with CloudStack is Host
Anti-Affinity. This indicates that the VMs in this group should
avoid being placed on the same host with each other. If you see
other types in this list, it means that your installation of
CloudStack has been extended with customized affinity group
plugins.</li>
</ul>
</li>
</ol>
</div>
<div class="section" id="assign-a-new-vm-to-an-affinity-group">
<h4>Assign a New VM to an Affinity Group<a class="headerlink" href="virtual_machines.html#assign-a-new-vm-to-an-affinity-group" title="Permalink to this headline">¶</a></h4>
<p>To assign a new VM to an affinity group:</p>
<ul class="simple">
<li>Create the VM as usual, as described in <a class="reference external" href="virtual_machines.html#creating-vms">“Creating
VMs”</a>. In the Add Instance
wizard, there is a new Affinity tab where you can select the
affinity group.</li>
</ul>
</div>
<div class="section" id="change-affinity-group-for-an-existing-vm">
<h4>Change Affinity Group for an Existing VM<a class="headerlink" href="virtual_machines.html#change-affinity-group-for-an-existing-vm" title="Permalink to this headline">¶</a></h4>
<p>To assign an existing VM to an affinity group:</p>
<ol class="arabic simple">
<li>Log in to the CloudStack UI as an administrator or user.</li>
<li>In the left navigation bar, click Instances.</li>
<li>Click the name of the VM you want to work with.</li>
<li>Stop the VM by clicking the Stop button.</li>
<li>Click the Change Affinity button. <img alt="button to assign an affinity group to a virtual machine." src="_images/change-affinity-button.png" /></li>
</ol>
</div>
<div class="section" id="view-members-of-an-affinity-group">
<h4>View Members of an Affinity Group<a class="headerlink" href="virtual_machines.html#view-members-of-an-affinity-group" title="Permalink to this headline">¶</a></h4>
<p>To see which VMs are currently assigned to a particular affinity group:</p>
<ol class="arabic">
<li><p class="first">In the left navigation bar, click Affinity Groups.</p>
</li>
<li><p class="first">Click the name of the group you are interested in.</p>
</li>
<li><p class="first">Click View Instances. The members of the group are listed.</p>
<p>From here, you can click the name of any VM in the list to access all
its details and controls.</p>
</li>
</ol>
</div>
<div class="section" id="delete-an-affinity-group">
<h4>Delete an Affinity Group<a class="headerlink" href="virtual_machines.html#delete-an-affinity-group" title="Permalink to this headline">¶</a></h4>
<p>To delete an affinity group:</p>
<ol class="arabic">
<li><p class="first">In the left navigation bar, click Affinity Groups.</p>
</li>
<li><p class="first">Click the name of the group you are interested in.</p>
</li>
<li><p class="first">Click Delete.</p>
<p>Any VM that is a member of the affinity group will be disassociated
from the group. The former group members will continue to run
normally on the current hosts, but if the VM is restarted, it will no
longer follow the host allocation rules from its former affinity
group.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="section" id="virtual-machine-snapshots">
<h2>Virtual Machine Snapshots<a class="headerlink" href="virtual_machines.html#virtual-machine-snapshots" title="Permalink to this headline">¶</a></h2>
<p>(Supported on VMware and XenServer)</p>
<p>In addition to the existing CloudStack ability to snapshot individual VM
volumes, you can take a VM snapshot to preserve all the VM’s data
volumes as well as (optionally) its CPU/memory state. This is useful for
quick restore of a VM. For example, you can snapshot a VM, then make
changes such as software upgrades. If anything goes wrong, simply
restore the VM to its previous state using the previously saved VM
snapshot.</p>
<p>The snapshot is created using the hypervisor’s native snapshot facility.
The VM snapshot includes not only the data volumes, but optionally also
whether the VM is running or turned off (CPU state) and the memory
contents. The snapshot is stored in CloudStack’s primary storage.</p>
<p>VM snapshots can have a parent/child relationship. Each successive
snapshot of the same VM is the child of the snapshot that came before
it. Each time you take an additional snapshot of the same VM, it saves
only the differences between the current state of the VM and the state
stored in the most recent previous snapshot. The previous snapshot
becomes a parent, and the new snapshot is its child. It is possible to
create a long chain of these parent/child snapshots, which amount to a
“redo” record leading from the current state of the VM back to the
original.</p>
<p>If you need more information about VM snapshots on VMware, check out the
VMware documentation and the VMware Knowledge Base, especially
<a class="reference external" href="http://kb.vmware.com/selfservice/microsites/search.do?cmd=displayKC&amp;externalId=1015180">Understanding virtual machine snapshots</a>.</p>
<div class="section" id="limitations-on-vm-snapshots">
<h3>Limitations on VM Snapshots<a class="headerlink" href="virtual_machines.html#limitations-on-vm-snapshots" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>If a VM has some stored snapshots, you can’t attach new volume to the
VM or delete any existing volumes. If you change the volumes on the
VM, it would become impossible to restore the VM snapshot which was
created with the previous volume structure. If you want to attach a
volume to such a VM, first delete its snapshots.</li>
<li>VM snapshots which include both data volumes and memory can’t be kept
if you change the VM’s service offering. Any existing VM snapshots of
this type will be discarded.</li>
<li>You can’t make a VM snapshot at the same time as you are taking a
volume snapshot.</li>
<li>You should use only CloudStack to create VM snapshots on hosts
managed by CloudStack. Any snapshots that you make directly on the
hypervisor will not be tracked in CloudStack.</li>
</ul>
</div>
<div class="section" id="configuring-vm-snapshots">
<h3>Configuring VM Snapshots<a class="headerlink" href="virtual_machines.html#configuring-vm-snapshots" title="Permalink to this headline">¶</a></h3>
<p>The cloud administrator can use global configuration variables to
control the behavior of VM snapshots. To set these variables, go through
the Global Settings area of the CloudStack UI.</p>
<p>Configuration Setting Name</p>
<p>Description</p>
<p>vmsnapshots.max</p>
<p>The maximum number of VM snapshots that can be saved for any given
virtual machine in the cloud. The total possible number of VM snapshots
in the cloud is (number of VMs) * vmsnapshots.max. If the number of
snapshots for any VM ever hits the maximum, the older ones are removed
by the snapshot expunge job.</p>
<p>vmsnapshot.create.wait</p>
<p>Number of seconds to wait for a snapshot job to succeed before declaring
failure and issuing an error.</p>
</div>
<div class="section" id="using-vm-snapshots">
<h3>Using VM Snapshots<a class="headerlink" href="virtual_machines.html#using-vm-snapshots" title="Permalink to this headline">¶</a></h3>
<p>To create a VM snapshot using the CloudStack UI:</p>
<ol class="arabic">
<li><p class="first">Log in to the CloudStack UI as a user or administrator.</p>
</li>
<li><p class="first">Click Instances.</p>
</li>
<li><p class="first">Click the name of the VM you want to snapshot.</p>
</li>
<li><p class="first">Click the Take VM Snapshot button. <img alt="button to restart a VPC" src="_images/VMSnapshotButton.png" /></p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If a snapshot is already in progress, then clicking this button
will have no effect.</p>
</div>
</li>
<li><p class="first">Provide a name and description. These will be displayed in the VM
Snapshots list.</p>
</li>
<li><p class="first">(For running VMs only) If you want to include the VM’s memory in the
snapshot, click the Memory checkbox. This saves the CPU and memory
state of the virtual machine. If you don’t check this box, then only
the current state of the VM disk is saved. Checking this box makes
the snapshot take longer.</p>
</li>
<li><p class="first">Quiesce VM: check this box if you want to quiesce the file system on
the VM before taking the snapshot. Not supported on XenServer when
used with CloudStack-provided primary storage.</p>
<p>When this option is used with CloudStack-provided primary storage,
the quiesce operation is performed by the underlying hypervisor
(VMware is supported). When used with another primary storage
vendor’s plugin, the quiesce operation is provided according to the
vendor’s implementation.</p>
</li>
<li><p class="first">Click OK.</p>
</li>
</ol>
<p>To delete a snapshot or restore a VM to the state saved in a particular
snapshot:</p>
<ol class="arabic">
<li><p class="first">Navigate to the VM as described in the earlier steps.</p>
</li>
<li><p class="first">Click View VM Snapshots.</p>
</li>
<li><p class="first">In the list of snapshots, click the name of the snapshot you want to
work with.</p>
</li>
<li><p class="first">Depending on what you want to do:</p>
<p>To delete the snapshot, click the Delete button. <img alt="delete-button.png" src="_images/delete-button.png" /></p>
<p>To revert to the snapshot, click the Revert button. <img alt="depicts adding an iso image" src="_images/revert-vm.png" /></p>
</li>
</ol>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">VM snapshots are deleted automatically when a VM is destroyed. You don’t
have to manually delete the snapshots in this case.</p>
</div>
</div>
</div>
<div class="section" id="changing-the-vm-name-os-or-group">
<h2>Changing the VM Name, OS, or Group<a class="headerlink" href="virtual_machines.html#changing-the-vm-name-os-or-group" title="Permalink to this headline">¶</a></h2>
<p>After a VM is created, you can modify the display name, operating
system, and the group it belongs to.</p>
<p>To access a VM through the CloudStack UI:</p>
<ol class="arabic simple">
<li>Log in to the CloudStack UI as a user or admin.</li>
<li>In the left navigation, click Instances.</li>
<li>Select the VM that you want to modify.</li>
<li>Click the Stop button to stop the VM. <img alt="depicts adding an iso image" src="_images/stop-instance-icon.png" /></li>
<li>Click Edit. <img alt="button to edit the properties of a VM" src="_images/edit-icon.png" /></li>
<li>Make the desired changes to the following:</li>
<li><strong>Display name</strong>: Enter a new display name if you want to change the
name of the VM.</li>
<li><strong>OS Type</strong>: Select the desired operating system.</li>
<li><strong>Group</strong>: Enter the group name for the VM.</li>
<li>Click Apply.</li>
</ol>
</div>
<div class="section" id="id3">
<h2>Appending a Display Name to the Guest VM’s Internal Name<a class="headerlink" href="virtual_machines.html#id3" title="Permalink to this headline">¶</a></h2>
<p>Every guest VM has an internal name. The host uses the internal name to
identify the guest VMs. CloudStack gives you an option to provide a
guest VM with a display name. You can set this display name as the
internal name so that the vCenter can use it to identify the guest VM. A
new global parameter, vm.instancename.flag, has now been added to
achieve this functionality.</p>
<p>The default format of the internal name is
i-&lt;user_id&gt;-&lt;vm_id&gt;-&lt;instance.name&gt;, where instance.name is a global
parameter. However, If vm.instancename.flag is set to true, and if a
display name is provided during the creation of a guest VM, the display
name is appended to the internal name of the guest VM on the host. This
makes the internal name format as i-&lt;user_id&gt;-&lt;vm_id&gt;-&lt;displayName&gt;.
The default value of vm.instancename.flag is set to false. This feature
is intended to make the correlation between instance names and internal
names easier in large data center deployments.</p>
<p>The following table explains how a VM name is displayed in different
scenarios.</p>
<table border="1" class="table-striped table-bordered table-hover docutils">
<colgroup>
<col width="20%" />
<col width="16%" />
<col width="14%" />
<col width="25%" />
<col width="25%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">User-Provided Display Name</th>
<th class="head">vm.instancename.flag</th>
<th class="head">Hostname on the VM</th>
<th class="head">Name on vCenter</th>
<th class="head">Internal Name</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>Yes</td>
<td>True</td>
<td>Display name</td>
<td>i-&lt;user_id&gt;-&lt;vm_id&gt;-displayName</td>
<td>i-&lt;user_id&gt;-&lt;vm_id&gt;-displayName</td>
</tr>
<tr class="row-odd"><td>No</td>
<td>True</td>
<td>UUID</td>
<td>i-&lt;user_id&gt;-&lt;vm_id&gt;-&lt;instance.name&gt;</td>
<td>i-&lt;user_id&gt;-&lt;vm_id&gt;-&lt;instance.name&gt;</td>
</tr>
<tr class="row-even"><td>Yes</td>
<td>False</td>
<td>Display name</td>
<td>i-&lt;user_id&gt;-&lt;vm_id&gt;-&lt;instance.name&gt;</td>
<td>i-&lt;user_id&gt;-&lt;vm_id&gt;-&lt;instance.name&gt;</td>
</tr>
<tr class="row-odd"><td>No</td>
<td>False</td>
<td>UUID</td>
<td>i-&lt;user_id&gt;-&lt;vm_id&gt;-&lt;instance.name&gt;</td>
<td>i-&lt;user_id&gt;-&lt;vm_id&gt;-&lt;instance.name&gt;</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="changing-the-service-offering-for-a-vm">
<h2>Changing the Service Offering for a VM<a class="headerlink" href="virtual_machines.html#changing-the-service-offering-for-a-vm" title="Permalink to this headline">¶</a></h2>
<p>To upgrade or downgrade the level of compute resources available to a
virtual machine, you can change the VM’s compute offering.</p>
<ol class="arabic">
<li><p class="first">Log in to the CloudStack UI as a user or admin.</p>
</li>
<li><p class="first">In the left navigation, click Instances.</p>
</li>
<li><p class="first">Choose the VM that you want to work with.</p>
</li>
<li><p class="first">(Skip this step if you have enabled dynamic VM scaling; see
<a class="reference internal" href="virtual_machines.html#cpu-and-memory-scaling"><span class="std std-ref">CPU and Memory Scaling for Running VMs</span></a>.)</p>
<p>Click the Stop button to stop the VM. <img alt="depicts adding an iso image" src="_images/stop-instance-icon.png" /></p>
</li>
<li><p class="first">Click the Change Service button. <img alt="button to change the service of a VM" src="_images/change-service-icon.png" /></p>
<p>The Change service dialog box is displayed.</p>
</li>
<li><p class="first">Select the offering you want to apply to the selected VM.</p>
</li>
<li><p class="first">Click OK.</p>
</li>
</ol>
<div class="section" id="cpu-and-memory-scaling-for-running-vms">
<span id="cpu-and-memory-scaling"></span><h3>CPU and Memory Scaling for Running VMs<a class="headerlink" href="virtual_machines.html#cpu-and-memory-scaling-for-running-vms" title="Permalink to this headline">¶</a></h3>
<p>(Supported on VMware and XenServer)</p>
<p>It is not always possible to accurately predict the CPU and RAM
requirements when you first deploy a VM. You might need to increase
these resources at any time during the life of a VM. You can dynamically
modify CPU and RAM levels to scale up these resources for a running VM
without incurring any downtime.</p>
<p>Dynamic CPU and RAM scaling can be used in the following cases:</p>
<ul class="simple">
<li>User VMs on hosts running VMware and XenServer.</li>
<li>System VMs on VMware.</li>
<li>VMware Tools or XenServer Tools must be installed on the virtual
machine.</li>
<li>The new requested CPU and RAM values must be within the constraints
allowed by the hypervisor and the VM operating system.</li>
<li>New VMs that are created after the installation of CloudStack 4.2 can
use the dynamic scaling feature. If you are upgrading from a previous
version of CloudStack, your existing VMs created with previous
versions will not have the dynamic scaling capability unless you
update them using the following procedure.</li>
</ul>
</div>
<div class="section" id="updating-existing-vms">
<h3>Updating Existing VMs<a class="headerlink" href="virtual_machines.html#updating-existing-vms" title="Permalink to this headline">¶</a></h3>
<p>If you are upgrading from a previous version of CloudStack, and you want
your existing VMs created with previous versions to have the dynamic
scaling capability, update the VMs using the following steps:</p>
<ol class="arabic simple">
<li>Make sure the zone-level setting enable.dynamic.scale.vm is set to
true. In the left navigation bar of the CloudStack UI, click
Infrastructure, then click Zones, click the zone you want, and click
the Settings tab.</li>
<li>Install Xen tools (for XenServer hosts) or VMware Tools (for VMware
hosts) on each VM if they are not already installed.</li>
<li>Stop the VM.</li>
<li>Click the Edit button.</li>
<li>Click the Dynamically Scalable checkbox.</li>
<li>Click Apply.</li>
<li>Restart the VM.</li>
</ol>
</div>
<div class="section" id="configuring-dynamic-cpu-and-ram-scaling">
<h3>Configuring Dynamic CPU and RAM Scaling<a class="headerlink" href="virtual_machines.html#configuring-dynamic-cpu-and-ram-scaling" title="Permalink to this headline">¶</a></h3>
<p>To configure this feature, use the following new global configuration
variables:</p>
<ul class="simple">
<li>enable.dynamic.scale.vm: Set to True to enable the feature. By
default, the feature is turned off.</li>
<li>scale.retry: How many times to attempt the scaling operation. Default
= 2.</li>
</ul>
</div>
<div class="section" id="how-to-dynamically-scale-cpu-and-ram">
<h3>How to Dynamically Scale CPU and RAM<a class="headerlink" href="virtual_machines.html#how-to-dynamically-scale-cpu-and-ram" title="Permalink to this headline">¶</a></h3>
<p>To modify the CPU and/or RAM capacity of a virtual machine, you need to
change the compute offering of the VM to a new compute offering that has
the desired CPU and RAM values. You can use the same steps described
above in <a class="reference external" href="virtual_machines.html#changing-the-service-offering-for-a-vm">“Changing the Service Offering for a
VM”</a>, but skip the step where you
stop the virtual machine. Of course, you might have to create a new
compute offering first.</p>
<p>When you submit a dynamic scaling request, the resources will be scaled
up on the current host if possible. If the host does not have enough
resources, the VM will be live migrated to another host in the same
cluster. If there is no host in the cluster that can fulfill the
requested level of CPU and RAM, the scaling operation will fail. The VM
will continue to run as it was before.</p>
</div>
<div class="section" id="limitations">
<h3>Limitations<a class="headerlink" href="virtual_machines.html#limitations" title="Permalink to this headline">¶</a></h3>
<ul class="simple">
<li>You can not do dynamic scaling for system VMs on XenServer.</li>
<li>CloudStack will not check to be sure that the new CPU and RAM levels
are compatible with the OS running on the VM.</li>
<li>When scaling memory or CPU for a Linux VM on VMware, you might need
to run scripts in addition to the other steps mentioned above. For
more information, see <a class="reference external" href="http://kb.vmware.com/selfservice/microsites/search.do?language=en_US&amp;cmd=displayKC&amp;externalId=1012764">Hot adding memory in Linux
(1012764)</a>
in the VMware Knowledge Base.</li>
<li>(VMware) If resources are not available on the current host, scaling
up will fail on VMware because of a known issue where CloudStack and
vCenter calculate the available capacity differently. For more
information, see
<a class="reference external" href="https://issues.apache.org/jira/browse/CLOUDSTACK-1809">https://issues.apache.org/jira/browse/CLOUDSTACK-1809</a>.</li>
<li>On VMs running Linux 64-bit and Windows 7 32-bit operating systems,
if the VM is initially assigned a RAM of less than 3 GB, it can be
dynamically scaled up to 3 GB, but not more. This is due to a known
issue with these operating systems, which will freeze if an attempt
is made to dynamically scale from less than 3 GB to more than 3 GB.</li>
</ul>
</div>
</div>
<div class="section" id="resetting-the-virtual-machine-root-volume-on-reboot">
<h2>Resetting the Virtual Machine Root Volume on Reboot<a class="headerlink" href="virtual_machines.html#resetting-the-virtual-machine-root-volume-on-reboot" title="Permalink to this headline">¶</a></h2>
<p>For secure environments, and to ensure that VM state is not persisted
across reboots, you can reset the root disk. For more information, see
<a class="reference external" href="storage.html#reset-vm-to-new-root-disk-on-reboot">“Reset VM to New Root Disk on
Reboot”</a>.</p>
</div>
<div class="section" id="moving-vms-between-hosts-manual-live-migration">
<h2>Moving VMs Between Hosts (Manual Live Migration)<a class="headerlink" href="virtual_machines.html#moving-vms-between-hosts-manual-live-migration" title="Permalink to this headline">¶</a></h2>
<p>The CloudStack administrator can move a running VM from one host to
another without interrupting service to users or going into maintenance
mode. This is called manual live migration, and can be done under the
following conditions:</p>
<ul class="simple">
<li>The root administrator is logged in. Domain admins and users can not
perform manual live migration of VMs.</li>
<li>The VM is running. Stopped VMs can not be live migrated.</li>
<li>The destination host must have enough available capacity. If not, the
VM will remain in the “migrating” state until memory becomes
available.</li>
<li>(KVM) The VM must not be using local disk storage. (On XenServer and
VMware, VM live migration with local disk is enabled by CloudStack
support for XenMotion and vMotion.)</li>
<li>(KVM) The destination host must be in the same cluster as the
original host. (On XenServer and VMware, VM live migration from one
cluster to another is enabled by CloudStack support for XenMotion and
vMotion.)</li>
</ul>
<p>To manually live migrate a virtual machine</p>
<ol class="arabic">
<li><p class="first">Log in to the CloudStack UI as a user or admin.</p>
</li>
<li><p class="first">In the left navigation, click Instances.</p>
</li>
<li><p class="first">Choose the VM that you want to migrate.</p>
</li>
<li><p class="first">Click the Migrate Instance button. <img alt="button to migrate an instance" src="_images/migrate-instance.png" /></p>
</li>
<li><p class="first">From the list of suitable hosts, choose the one to which you want to
move the VM.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">If the VM’s storage has to be migrated along with the VM, this will
be noted in the host list. CloudStack will take care of the storage
migration for you.</p>
</div>
</li>
<li><p class="first">Click OK.</p>
</li>
</ol>
</div>
<div class="section" id="deleting-vms">
<h2>Deleting VMs<a class="headerlink" href="virtual_machines.html#deleting-vms" title="Permalink to this headline">¶</a></h2>
<p>Users can delete their own virtual machines. A running virtual machine
will be abruptly stopped before it is deleted. Administrators can delete
any virtual machines.</p>
<p>To delete a virtual machine:</p>
<ol class="arabic simple">
<li>Log in to the CloudStack UI as a user or admin.</li>
<li>In the left navigation, click Instances.</li>
<li>Choose the VM that you want to delete.</li>
<li>Click the Destroy Instance button. <img alt="button to destroy an instance" src="_images/destroy-instance.png" /></li>
</ol>
</div>
<div class="section" id="working-with-isos">
<h2>Working with ISOs<a class="headerlink" href="virtual_machines.html#working-with-isos" title="Permalink to this headline">¶</a></h2>
<p>CloudStack supports ISOs and their attachment to guest VMs. An ISO is a
read-only file that has an ISO/CD-ROM style file system. Users can
upload their own ISOs and mount them on their guest VMs.</p>
<p>ISOs are uploaded based on a URL. HTTP is the supported protocol. Once
the ISO is available via HTTP specify an upload URL such as
<a class="reference external" href="http://my.web.server/filename.iso">http://my.web.server/filename.iso</a>.</p>
<p>ISOs may be public or private, like templates.ISOs are not
hypervisor-specific. That is, a guest on vSphere can mount the exact
same image that a guest on KVM can mount.</p>
<p>ISO images may be stored in the system and made available with a privacy
level similar to templates. ISO images are classified as either bootable
or not bootable. A bootable ISO image is one that contains an OS image.
CloudStack allows a user to boot a guest VM off of an ISO image. Users
can also attach ISO images to guest VMs. For example, this enables
installing PV drivers into Windows. ISO images are not
hypervisor-specific.</p>
<div class="section" id="adding-an-iso">
<h3>Adding an ISO<a class="headerlink" href="virtual_machines.html#adding-an-iso" title="Permalink to this headline">¶</a></h3>
<p>To make additional operating system or other software available for use
with guest VMs, you can add an ISO. The ISO is typically thought of as
an operating system image, but you can also add ISOs for other types of
software, such as desktop applications that you want to be installed as
part of a template.</p>
<ol class="arabic">
<li><p class="first">Log in to the CloudStack UI as an administrator or end user.</p>
</li>
<li><p class="first">In the left navigation bar, click Templates.</p>
</li>
<li><p class="first">In Select View, choose ISOs.</p>
</li>
<li><p class="first">Click Add ISO.</p>
</li>
<li><p class="first">In the Add ISO screen, provide the following:</p>
<ul>
<li><p class="first"><strong>Name</strong>: Short name for the ISO image. For example, CentOS 6.2
64-bit.</p>
</li>
<li><p class="first"><strong>Description</strong>: Display test for the ISO image. For example,
CentOS 6.2 64-bit.</p>
</li>
<li><p class="first"><strong>URL</strong>: The URL that hosts the ISO image. The 管理服务
must be able to access this location via HTTP. If needed you can
place the ISO image directly on the 管理服务</p>
</li>
<li><p class="first"><strong>Zone</strong>: Choose the zone where you want the ISO to be available,
or All Zones to make it available throughout CloudStack.</p>
</li>
<li><p class="first"><strong>Bootable</strong>: Whether or not a guest could boot off this ISO
image. For example, a CentOS ISO is bootable, a Microsoft Office
ISO is not bootable.</p>
</li>
<li><p class="first"><strong>OS Type</strong>: This helps CloudStack and the hypervisor perform
certain operations and make assumptions that improve the
performance of the guest. Select one of the following.</p>
<ul class="simple">
<li>If the operating system of your desired ISO image is listed,
choose it.</li>
<li>If the OS Type of the ISO is not listed or if the ISO is not
bootable, choose Other.</li>
<li>(XenServer only) If you want to boot from this ISO in PV mode,
choose Other PV (32-bit) or Other PV (64-bit)</li>
<li>(KVM only) If you choose an OS that is PV-enabled, the VMs
created from this ISO will have a SCSI (virtio) root disk. If
the OS is not PV-enabled, the VMs will have an IDE root disk.
The PV-enabled types are:<ul>
<li>Fedora 13</li>
<li>Fedora 12</li>
<li>Fedora 11</li>
<li>Fedora 10</li>
<li>Fedora 9</li>
<li>Other PV</li>
<li>Debian GNU/Linux</li>
<li>CentOS 5.3</li>
<li>CentOS 5.4</li>
<li>CentOS 5.5</li>
<li>Red Hat Enterprise Linux 5.3</li>
<li>Red Hat Enterprise Linux 5.4</li>
<li>Red Hat Enterprise Linux 5.5</li>
<li>Red Hat Enterprise Linux 6</li>
</ul>
</li>
</ul>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">It is not recommended to choose an older version of the OS than
the version in the image. For example, choosing CentOS 5.4 to
support a CentOS 6.2 image will usually not work. In these
cases, choose Other.</p>
</div>
</li>
<li><p class="first"><strong>Extractable</strong>: Choose Yes if the ISO should be available for
extraction.</p>
</li>
<li><p class="first"><strong>Public</strong>: Choose Yes if this ISO should be available to other
users.</p>
</li>
<li><p class="first"><strong>Featured</strong>: Choose Yes if you would like this ISO to be more
prominent for users to select. The ISO will appear in the Featured
ISOs list. Only an administrator can make an ISO Featured.</p>
</li>
</ul>
</li>
<li><p class="first">Click OK.</p>
<p>The 管理服务 will download the ISO. Depending on the size of
the ISO, this may take a long time. The ISO status column will
display Ready once it has been successfully downloaded into secondary
storage. Clicking Refresh updates the download percentage.</p>
</li>
<li><p class="first"><strong>Important</strong>: Wait for the ISO to finish downloading. If you move on
to the next task and try to use the ISO right away, it will appear to
fail. The entire ISO must be available before CloudStack can work
with it.</p>
</li>
</ol>
</div>
<div class="section" id="attaching-an-iso-to-a-vm">
<h3>Attaching an ISO to a VM<a class="headerlink" href="virtual_machines.html#attaching-an-iso-to-a-vm" title="Permalink to this headline">¶</a></h3>
<ol class="arabic simple">
<li>In the left navigation, click Instances.</li>
<li>Choose the virtual machine you want to work with.</li>
<li>Click the Attach ISO button. <img alt="depicts adding an iso image" src="_images/iso-icon.png" /></li>
<li>In the Attach ISO dialog box, select the desired ISO.</li>
<li>Click OK.</li>
</ol>
</div>
<div class="section" id="changing-a-vm-s-base-image">
<h3>Changing a VM’s Base Image<a class="headerlink" href="virtual_machines.html#changing-a-vm-s-base-image" title="Permalink to this headline">¶</a></h3>
<p>Every VM is created from a base image, which is a template or ISO which
has been created and stored in CloudStack. Both cloud administrators and
end users can create and modify templates, ISOs, and VMs.</p>
<p>In CloudStack, you can change an existing VM’s base image from one
template to another, or from one ISO to another. (You can not change
from an ISO to a template, or from a template to an ISO).</p>
<p>For example, suppose there is a template based on a particular operating
system, and the OS vendor releases a software patch. The administrator
or user naturally wants to apply the patch and then make sure existing
VMs start using it. Whether a software update is involved or not, it’s
also possible to simply switch a VM from its current template to any
other desired template.</p>
<p>To change a VM’s base image, call the restoreVirtualMachine API command
and pass in the virtual machine ID and a new template ID. The template
ID parameter may refer to either a template or an ISO, depending on
which type of base image the VM was already using (it must match the
previous type of image). When this call occurs, the VM’s root disk is
first destroyed, then a new root disk is created from the source
designated in the template ID parameter. The new root disk is attached
to the VM, and now the VM is based on the new template.</p>
<p>You can also omit the template ID parameter from the
restoreVirtualMachine call. In this case, the VM’s root disk is
destroyed and recreated, but from the same template or ISO that was
already in use by the VM.</p>
</div>
</div>
<div class="section" id="using-ssh-keys-for-authentication">
<h2>Using SSH Keys for Authentication<a class="headerlink" href="virtual_machines.html#using-ssh-keys-for-authentication" title="Permalink to this headline">¶</a></h2>
<p>In addition to the username and password authentication, CloudStack
supports using SSH keys to log in to the cloud infrastructure for
additional security. You can use the createSSHKeyPair API to generate
the SSH keys.</p>
<p>Because each cloud user has their own SSH key, one cloud user cannot log
in to another cloud user’s instances unless they share their SSH key
files. Using a single SSH key pair, you can manage multiple instances.</p>
<div class="section" id="creating-an-instance-template-that-supports-ssh-keys">
<h3>Creating an Instance Template that Supports SSH Keys<a class="headerlink" href="virtual_machines.html#creating-an-instance-template-that-supports-ssh-keys" title="Permalink to this headline">¶</a></h3>
<p>Create an instance template that supports SSH Keys.</p>
<ol class="arabic">
<li><p class="first">Create a new instance by using the template provided by cloudstack.</p>
<p>For more information on creating a new instance, see</p>
</li>
<li><p class="first">Download the cloudstack script from <a class="reference external" href="http://sourceforge.net/projects/cloudstack/files/SSH%20Key%20Gen%20Script/">The SSH Key Gen Script</a>
to the instance you have created.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>wget https://raw.githubusercontent.com/apache/cloudstack/master/setup/bindir/cloud-set-guest-sshkey.in
</pre></div>
</div>
</li>
<li><p class="first">Copy the file to /etc/init.d.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>cp cloud-set-guest-sshkey.in /etc/init.d/
</pre></div>
</div>
</li>
<li><p class="first">Give the necessary permissions on the script:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>chmod +x /etc/init.d/cloud-set-guest-sshkey.in
</pre></div>
</div>
</li>
<li><p class="first">Run the script while starting up the operating system:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>chkconfig --add cloud-set-guest-sshkey.in
</pre></div>
</div>
</li>
<li><p class="first">Stop the instance.</p>
</li>
</ol>
</div>
<div class="section" id="creating-the-ssh-keypair">
<h3>Creating the SSH Keypair<a class="headerlink" href="virtual_machines.html#creating-the-ssh-keypair" title="Permalink to this headline">¶</a></h3>
<p>You must make a call to the createSSHKeyPair api method. You can either
use the CloudStack Python API library or the curl commands to make the
call to the cloudstack api.</p>
<p>For example, make a call from the cloudstack server to create a SSH
keypair called “keypair-doc” for the admin account in the root domain:</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Ensure that you adjust these values to meet your needs. If you are
making the API call from a different server, your URL/PORT will be
different, and you will need to use the API keys.</p>
</div>
<ol class="arabic">
<li><p class="first">Run the following curl command:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>curl --globoff <span class="s2">&quot;http://localhost:8096/?command=createSSHKeyPair&amp;name=keypair-doc&amp;account=admin&amp;domainid=5163440e-c44b-42b5-9109-ad75cae8e8a2&quot;</span>
</pre></div>
</div>
<p>The output is something similar to what is given below:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>&lt;?xml <span class="nv">version</span><span class="o">=</span><span class="s2">&quot;1.0&quot;</span> <span class="nv">encoding</span><span class="o">=</span><span class="s2">&quot;ISO-8859-1&quot;</span>?&gt;&lt;createsshkeypairresponse cloud-stack-version<span class="o">=</span><span class="s2">&quot;3.0.0.20120228045507&quot;</span>&gt;&lt;keypair&gt;&lt;name&gt;keypair-doc&lt;/name&gt;&lt;fingerprint&gt;f6:77:39:d5:5e:77:02:22:6a:d8:7f:ce:ab:cd:b3:56&lt;/fingerprint&gt;&lt;privatekey&gt;-----BEGIN RSA PRIVATE KEY-----
MIICXQIBAAKBgQCSydmnQ67jP6lNoXdX3noZjQdrMAWNQZ7y5SrEu4wDxplvhYci
dXYBeZVwakDVsU2MLGl/K+wefwefwefwefwefJyKJaogMKn7BperPD6n1wIDAQAB
AoGAdXaJ7uyZKeRDoy6wA0UmF0kSPbMZCR+UTIHNkS/E0/4U+6lhMokmFSHtu
mfDZ1kGGDYhMsdytjDBztljawfawfeawefawfawfawQQDCjEsoRdgkduTy
QpbSGDIa11Jsc+XNDx2fgRinDsxXI/zJYXTKRhSl/LIPHBw/brW8vzxhOlSOrwm7
VvemkkgpAkEAwSeEw394LYZiEVv395ar9MLRVTVLwpo54jC4tsOxQCBlloocK
lYaocpk0yBqqOUSBawfIiDCuLXSdvBo1Xz5ICTM19vgvEp/+kMuECQBzm
nVo8b2Gvyagqt/KEQo8wzH2THghZ1qQ1QRhIeJG2aissEacF6bGB2oZ7Igim5L14
4KR7OeEToyCLC2k+02UCQQCrniSnWKtDVoVqeK/zbB32JhW3Wullv5p5zUEcd
KfEEuzcCUIxtJYTahJ1pvlFkQ8anpuxjSEDp8x/18bq3
-----END RSA PRIVATE KEY-----
&lt;/privatekey&gt;&lt;/keypair&gt;&lt;/createsshkeypairresponse&gt;
</pre></div>
</div>
</li>
<li><p class="first">Copy the key data into a file. The file looks like this:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>-----BEGIN RSA PRIVATE KEY-----
MIICXQIBAAKBgQCSydmnQ67jP6lNoXdX3noZjQdrMAWNQZ7y5SrEu4wDxplvhYci
dXYBeZVwakDVsU2MLGl/K+wefwefwefwefwefJyKJaogMKn7BperPD6n1wIDAQAB
AoGAdXaJ7uyZKeRDoy6wA0UmF0kSPbMZCR+UTIHNkS/E0/4U+6lhMokmFSHtu
mfDZ1kGGDYhMsdytjDBztljawfawfeawefawfawfawQQDCjEsoRdgkduTy
QpbSGDIa11Jsc+XNDx2fgRinDsxXI/zJYXTKRhSl/LIPHBw/brW8vzxhOlSOrwm7
VvemkkgpAkEAwSeEw394LYZiEVv395ar9MLRVTVLwpo54jC4tsOxQCBlloocK
lYaocpk0yBqqOUSBawfIiDCuLXSdvBo1Xz5ICTM19vgvEp/+kMuECQBzm
nVo8b2Gvyagqt/KEQo8wzH2THghZ1qQ1QRhIeJG2aissEacF6bGB2oZ7Igim5L14
4KR7OeEToyCLC2k+02UCQQCrniSnWKtDVoVqeK/zbB32JhW3Wullv5p5zUEcd
KfEEuzcCUIxtJYTahJ1pvlFkQ8anpuxjSEDp8x/18bq3
-----END RSA PRIVATE KEY-----
</pre></div>
</div>
</li>
<li><p class="first">Save the file.</p>
</li>
</ol>
</div>
<div class="section" id="creating-an-instance">
<h3>Creating an Instance<a class="headerlink" href="virtual_machines.html#creating-an-instance" title="Permalink to this headline">¶</a></h3>
<p>After you save the SSH keypair file, you must create an instance by
using the template that you created at <a class="reference external" href="virtual_machines.html#create-ssh-template">Section&nbsp;5.2.1, “ Creating an
Instance Template that Supports SSH Keys”</a>.
Ensure that you use the same SSH key name that you created at
<a class="reference external" href="virtual_machines.html#create-ssh-keypair">Section&nbsp;5.2.2, “Creating the SSH Keypair”</a>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">You cannot create the instance by using the GUI at this time and
associate the instance with the newly created SSH keypair.</p>
</div>
<p>A sample curl command to create a new instance is:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>curl --globoff http://localhost:&lt;port number&gt;/?command<span class="o">=</span>deployVirtualMachine<span class="se">\&amp;</span><span class="nv">zoneId</span><span class="o">=</span><span class="m">1</span><span class="se">\&amp;</span><span class="nv">serviceOfferingId</span><span class="o">=</span><span class="m">18727021</span>-7556-4110-9322-d625b52e0813<span class="se">\&amp;</span><span class="nv">templateId</span><span class="o">=</span>e899c18a-ce13-4bbf-98a9-625c5026e0b5<span class="se">\&amp;</span><span class="nv">securitygroupids</span><span class="o">=</span>ff03f02f-9e3b-48f8-834d-91b822da40c5<span class="se">\&amp;</span><span class="nv">account</span><span class="o">=</span>admin<span class="se">\&amp;</span><span class="nv">domainid</span><span class="o">=</span><span class="m">1</span><span class="se">\&amp;</span><span class="nv">keypair</span><span class="o">=</span>keypair-doc
</pre></div>
</div>
<p>Substitute the template, service offering and security group IDs (if you
are using the security group feature) that are in your cloud
environment.</p>
</div>
<div class="section" id="logging-in-using-the-ssh-keypair">
<h3>Logging In Using the SSH Keypair<a class="headerlink" href="virtual_machines.html#logging-in-using-the-ssh-keypair" title="Permalink to this headline">¶</a></h3>
<p>To test your SSH key generation is successful, check whether you can log
in to the cloud setup.</p>
<p>For example, from a Linux OS, run:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ssh -i ~/.ssh/keypair-doc &lt;ip address&gt;
</pre></div>
</div>
<p>The -i parameter tells the ssh client to use a ssh key found at
~/.ssh/keypair-doc.</p>
</div>
<div class="section" id="resetting-ssh-keys">
<h3>Resetting SSH Keys<a class="headerlink" href="virtual_machines.html#resetting-ssh-keys" title="Permalink to this headline">¶</a></h3>
<p>With the API command resetSSHKeyForVirtualMachine, a user can set or
reset the SSH keypair assigned to a virtual machine. A lost or
compromised SSH keypair can be changed, and the user can access the VM
by using the new keypair. Just create or register a new keypair, then
call resetSSHKeyForVirtualMachine.</p>
</div>
</div>
<div class="section" id="user-data-and-meta-data">
<h2>User-Data and Meta-Data<a class="headerlink" href="virtual_machines.html#user-data-and-meta-data" title="Permalink to this headline">¶</a></h2>
<p>CloudStack provides API access to attach up to 2KB of data after base64 encoding
to a deployed VM. Using HTTP POST(via POST body), you can send up to 32K of data
after base64 encoding. Deployed VMs also have access to instance metadata via
the virtual router.</p>
<p>Create virtual machine thru the API: <a class="reference external" href="http://cloudstack.apache.org/docs/api/apidocs-4.5/user/deployVirtualMachine.html">deployVirtualMachine</a>
using the parameter <code class="docutils literal notranslate"><span class="pre">userdata=</span></code> to include user-data formated in
<a class="reference external" href="https://www.base64encode.org/">base64</a>.</p>
<p>Accessed user-data from VM. Once the IP address of the virtual router is
known, use the following steps to retrieve user-data:</p>
<ol class="arabic">
<li><p class="first">Run the following command to find the virtual router.</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># cat /var/lib/dhclient/dhclient-eth0.leases | grep dhcp-server-identifier | tail -1</span>
</pre></div>
</div>
</li>
<li><p class="first">Access user-data by running the following command using the result of
the above command</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># curl http://10.1.1.1/latest/user-data</span>
</pre></div>
</div>
</li>
</ol>
<p>Meta Data can be accessed similarly, using a URL of the form
<code class="docutils literal notranslate"><span class="pre">http://10.1.1.1/latest/meta-data/{metadata</span> <span class="pre">type}</span></code>. (For backwards
compatibility, the previous URL <code class="docutils literal notranslate"><span class="pre">http://10.1.1.1/latest/{metadata</span> <span class="pre">type}</span></code>
is also supported.) For metadata type, use one of the following:</p>
<ul class="simple">
<li><code class="docutils literal notranslate"><span class="pre">service-offering</span></code>. A description of the VMs service offering</li>
<li><code class="docutils literal notranslate"><span class="pre">availability-zone</span></code>. The Zone name</li>
<li><code class="docutils literal notranslate"><span class="pre">local-ipv4</span></code>. The guest IP of the VM</li>
<li><code class="docutils literal notranslate"><span class="pre">local-hostname</span></code>. The hostname of the VM</li>
<li><code class="docutils literal notranslate"><span class="pre">public-ipv4</span></code>. The first public IP for the router. (E.g. the first IP
of eth2)</li>
<li><code class="docutils literal notranslate"><span class="pre">public-hostname</span></code>. This is the same as public-ipv4</li>
<li><code class="docutils literal notranslate"><span class="pre">instance-id</span></code>. The instance name of the VM</li>
</ul>
<div class="section" id="using-cloud-init">
<h3>Using Cloud-Init<a class="headerlink" href="virtual_machines.html#using-cloud-init" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="https://cloudinit.readthedocs.org/en/latest">Cloud-Init</a> can be use to access
an interpret user-data from virtual machines. Cloud-Init be installed into
templates and also require CloudStack password and sshkey scripts (<a class="reference internal" href="templates/_password.html#adding-password-management-to-templates"><span class="std std-ref">Adding Password Management to Your Templates</span></a> and <a class="reference external" href="virtual_machines.html#using-ssh-keys-for-authentication">using ssh keys</a>). User password management and
<code class="docutils literal notranslate"><span class="pre">resetSSHKeyForVirtualMachine</span></code> API are not yet supported by cloud-init.</p>
<ol class="arabic">
<li><p class="first">Install cloud-init package into a template:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span># yum install cloud-init
  or
$ sudo apt-get install cloud-init
</pre></div>
</div>
</li>
<li><p class="first">Create datasource configuration file: <code class="docutils literal notranslate"><span class="pre">/etc/cloud/cloud.cfg.d/99_cloudstack.cfg</span></code></p>
<div class="code yaml highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">datasource</span><span class="p">:</span>
  <span class="n">CloudStack</span><span class="p">:</span> <span class="p">{}</span>
  <span class="kc">None</span><span class="p">:</span> <span class="p">{}</span>
<span class="n">datasource_list</span><span class="p">:</span>
  <span class="o">-</span> <span class="n">CloudStack</span>
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="user-data-example">
<h3>user-data example<a class="headerlink" href="virtual_machines.html#user-data-example" title="Permalink to this headline">¶</a></h3>
<p>This example use cloud-init to Upgrade Operating-System of the newly created VM:</p>
<div class="code yaml highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#cloud-config</span>

<span class="c1"># Upgrade the instance on first boot</span>
<span class="c1"># (ie run apt-get upgrade)</span>
<span class="c1">#</span>
<span class="c1"># Default: false</span>
<span class="c1"># Aliases: apt_upgrade</span>
<span class="n">package_upgrade</span><span class="p">:</span> <span class="n">true</span>
</pre></div>
</div>
<p>base64 formated:</p>
<div class="code bash highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">I2Nsb3VkLWNvbmZpZw0KDQojIFVwZ3JhZGUgdGhlIGluc3RhbmNlIG9uIGZpcnN0IGJvb3QNCiMgKGllIHJ1biBhcHQtZ2V0IHVwZ3JhZGUpDQojDQojIERlZmF1bHQ6IGZhbHNlDQojIEFsaWFzZXM6IGFwdF91cGdyYWRlDQpwYWNrYWdlX3VwZ3JhZGU6IHRydWUNCg</span><span class="o">==</span>
</pre></div>
</div>
<p>Refer to <a class="reference external" href="http://cloudinit.readthedocs.org/en/latest/topics/datasources.html#cloudstack">Cloud-Init CloudStack datasource</a>
documentation for latest capabilities. Cloud-Init and Cloud-Init CloudStack
datasource are not supported by Apache CloudStack community.</p>
</div>
</div>
<div class="section" id="assigning-gpu-vgpu-to-guest-vms">
<h2>Assigning GPU/vGPU to Guest VMs<a class="headerlink" href="virtual_machines.html#assigning-gpu-vgpu-to-guest-vms" title="Permalink to this headline">¶</a></h2>
<p>CloudStack can deploy guest VMs with Graphics Processing Unit (GPU) or Virtual
Graphics Processing Unit (vGPU) capabilities on XenServer hosts. At the time of
VM deployment or at a later stage, you can assign a physical GPU ( known as
GPU-passthrough) or a portion of a physical GPU card (vGPU) to a guest VM by
changing the Service Offering. With this capability, the VMs running on
CloudStack meet the intensive graphical processing requirement by means of the
high computation power of GPU/vGPU, and CloudStack users can run multimedia
rich applications, such as Auto-CAD, that they otherwise enjoy at their desk on
a virtualized environment.
CloudStack leverages the XenServer support for NVIDIA GRID Kepler 1 and 2 series
to run GPU/vGPU enabled VMs. NVIDIA GRID cards allows sharing a single GPU cards
among multiple VMs by creating vGPUs for each VM. With vGPU technology, the
graphics commands from each VM are passed directly to the underlying dedicated
GPU, without the intervention of the hypervisor. This allows the GPU hardware
to be time-sliced and shared across multiple VMs. XenServer hosts use the GPU
cards in following ways:</p>
<p><strong>GPU passthrough</strong>: GPU passthrough represents a physical GPU which can be
directly assigned to a VM. GPU passthrough can be used on a hypervisor alongside
GRID vGPU, with some restrictions: A GRID physical GPU can either host GRID
vGPUs or be used as passthrough, but not both at the same time.</p>
<p><strong>GRID vGPU</strong>: GRID vGPU enables multiple VMs to share a single physical GPU.
The VMs run an NVIDIA driver stack and get direct access to the GPU. GRID
physical GPUs are capable of supporting multiple virtual GPU devices (vGPUs)
that can be assigned directly to guest VMs. Guest VMs use GRID virtual GPUs in
the same manner as a physical GPU that has been passed through by the
hypervisor: an NVIDIA driver loaded in the guest VM provides direct access to
the GPU for performance-critical fast paths, and a paravirtualized interface to
the GRID Virtual GPU Manager, which is used for nonperformant management
operations. NVIDIA GRID Virtual GPU Manager for XenServer runs in dom0.
CloudStack provides you with the following capabilities:</p>
<ul class="simple">
<li>Adding XenServer hosts with GPU/vGPU capability provisioned by the administrator.</li>
<li>Creating a Compute Offering with GPU/vGPU capability.</li>
<li>Deploying a VM with GPU/vGPU capability.</li>
<li>Destroying a VM with GPU/vGPU capability.</li>
<li>Allowing an user to add GPU/vGPU support to a VM without GPU/vGPU support by
changing the Service Offering and vice-versa.</li>
<li>Migrating VMs (cold migration) with GPU/vGPU capability.</li>
<li>Managing GPU cards capacity.</li>
<li>Querying hosts to obtain information about the GPU cards, supported vGPU types
in case of GRID cards, and capacity of the cards.</li>
</ul>
<div class="section" id="prerequisites-and-system-requirements">
<h3>Prerequisites and System Requirements<a class="headerlink" href="virtual_machines.html#prerequisites-and-system-requirements" title="Permalink to this headline">¶</a></h3>
<p>Before proceeding, ensure that you have these prerequisites:</p>
<ul class="simple">
<li>The vGPU-enabled XenServer 6.2 and later versions.
For more information, see <a class="reference external" href="https://www.citrix.com/go/private/vgpu.html">Citrix 3D Graphics Pack</a>.</li>
<li>GPU/vPGU functionality is supported for following HVM guest operating systems:
For more information, see <a class="reference external" href="https://www.citrix.com/go/private/vgpu.html">Citrix 3D Graphics Pack</a>.</li>
<li>Windows 7 (x86 and x64)</li>
<li>Windows Server 2008 R2</li>
<li>Windows Server 2012</li>
<li>Windows 8 (x86 and x64)</li>
<li>Windows 8.1 (“Blue”) (x86 and x64)</li>
<li>Windows Server 2012 R2 (server equivalent of “Blue”)</li>
<li>CloudStack does not restrict the deployment of GPU-enabled VMs with guest OS types that are not supported by XenServer for GPU/vGPU functionality. The deployment would be successful and a GPU/vGPU will also get allocated for VMs; however, due to missing guest OS drivers, VM would not be able to leverage GPU resources. Therefore, it is recommended to use GPU-enabled service offering only with supported guest OS.</li>
<li>NVIDIA GRID K1 (16 GiB video RAM) AND K2 (8 GiB of video RAM) cards supports homogeneous virtual GPUs, implies that at any given time, the vGPUs resident on a single physical GPU must be all of the same type. However, this restriction doesn’t extend across physical GPUs on the same card. Each physical GPU on a K1 or K2 may host different types of virtual GPU at the same time. For example, a GRID K2 card has two physical GPUs, and supports four types of virtual GPU; GRID K200, GRID K220Q, GRID K240Q, AND GRID K260Q.</li>
<li>NVIDIA driver must be installed to enable vGPU operation as for a physical NVIDIA GPU.</li>
<li>XenServer tools are installed in the VM to get maximum performance on XenServer, regardless of type of vGPU you are using. Without the optimized networking and storage drivers that the XenServer tools provide, remote graphics applications running on GRID vGPU will not deliver maximum performance.</li>
<li>To deliver high frames from multiple heads on vGPU, install XenDesktop with HDX 3D Pro remote graphics.</li>
</ul>
<p>Before continuing with configuration, consider the following:</p>
<ul class="simple">
<li>Deploying VMs GPU/vGPU capability is not supported if hosts are not available with enough GPU capacity.</li>
<li>A Service Offering cannot be created with the GPU values that are not supported by CloudStack UI. However, you can make an API call to achieve this.</li>
<li>Dynamic scaling is not supported. However, you can choose to deploy a VM without GPU support, and at a later point, you can change the system offering to upgrade to the one with vGPU. You can achieve this by offline upgrade: stop the VM, upgrade the Service Offering to the one with vGPU, then start the VM.</li>
<li>Live migration of GPU/vGPU enabled VM is not supported.</li>
<li>Limiting GPU resources per Account/Domain is not supported.</li>
<li>Disabling GPU at Cluster level is not supported.</li>
<li>Notification thresholds for GPU resource is not supported.</li>
</ul>
</div>
<div class="section" id="supported-gpu-devices">
<h3>Supported GPU Devices<a class="headerlink" href="virtual_machines.html#supported-gpu-devices" title="Permalink to this headline">¶</a></h3>
<table border="1" class="table-striped table-bordered table-hover docutils">
<colgroup>
<col width="17%" />
<col width="83%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Device</th>
<th class="head">Type</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>GPU</td>
<td><ul class="first last simple">
<li>Group of NVIDIA Corporation GK107GL [GRID K1] GPUs</li>
<li>Group of NVIDIA Corporation GK104GL [GRID K2] GPUs</li>
<li>Any other GPU Group</li>
</ul>
</td>
</tr>
<tr class="row-odd"><td>vGPU</td>
<td><ul class="first last simple">
<li>GRID K100</li>
<li>GRID K120Q</li>
<li>GRID K140Q</li>
<li>GRID K200</li>
<li>GRID K220Q</li>
<li>GRID K240Q</li>
<li>GRID K260Q</li>
</ul>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="gpu-vgpu-assignment-workflow">
<h3>GPU/vGPU Assignment Workflow<a class="headerlink" href="virtual_machines.html#gpu-vgpu-assignment-workflow" title="Permalink to this headline">¶</a></h3>
<p>CloudStack follows the below sequence of operations to provide GPU/vGPU support for VMs:</p>
<ol class="arabic">
<li><p class="first">Ensure that XenServer host is ready with GPU installed and configured.
For more information, see <a class="reference external" href="https://www.citrix.com/go/private/vgpu.html">Citrix 3D Graphics Pack</a>.</p>
</li>
<li><p class="first">Add the host to CloudStack.
CloudStack checks if the host is GPU-enabled or not. CloudStack queries the host and detect if it’s GPU enabled.</p>
</li>
<li><p class="first">Create a compute offering with GPU/vGPU support:
For more information, see <a class="reference external" href="virtual_machines.html#creating-a-new-compute-offering">Creating a New Compute Offering</a>..</p>
</li>
<li><p class="first">Continue with any of the following operations:</p>
<ul>
<li><p class="first">Deploy a VM.</p>
<p>Deploy a VM with GPU/vGPU support by selecting appropriate Service Offering. CloudStack decide which host to choose for VM deployment based on following criteria:</p>
<ul class="simple">
<li>Host has GPU cards in it. In case of vGPU, CloudStack checks if cards have the required vGPU type support and enough capacity available. Having no appropriate hosts results in an InsufficientServerCapacity exception.</li>
<li>Alternately, you can choose to deploy a VM without GPU support, and at a later point, you can change the system offering. You can achieve this by offline upgrade: stop the VM, upgrade the Service Offering to the one with vGPU, then start the VM.
In this case, CloudStack gets a list of hosts which have enough capacity to host the VM. If there is a GPU-enabled host, CloudStack reorders this host list and place the GPU-enabled hosts at the bottom of the list.</li>
</ul>
</li>
<li><p class="first">Migrate a VM.</p>
<p>CloudStack searches for hosts available for VM migration, which satisfies GPU requirement. If the host is available, stop the     VM in the current host and perform the VM migration task. If the VM migration is successful, the remaining GPU capacity is     updated for both the hosts accordingly.</p>
</li>
<li><p class="first">Destroy a VM.</p>
<p>GPU resources are released automatically when you stop a VM. Once the destroy VM is successful, CloudStack will make a resource call to the host to get the remaining GPU capacity in the card and update the database accordingly.</p>
</li>
</ul>
</li>
</ol>
</div>
</div>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="virtual_machines.html#">Back to top</a>
          | <a href="networking.html" title="Previous Chapter: Setting Up Networking for Users"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; Setting Up Networking for Users</span>
          </a>
          | <a href="templates.html" title="Next Chapter: Working with Templates"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">Working with Templates &raquo;</span>
          </a>
      
        <br/>
        
<div id="sourcelink">
  <a href="_sources/virtual_machines.rst.txt"
     rel="nofollow">Source</a>
</div>
      
    </p>
    <p>
        &copy; Copyright 2016, Apache Software Foundation.<br/>
    </p>
  </div>
</footer>
  </body>
</html>