<!DOCTYPE html>

<html xmlns="http://www.w3.org/1999/xhtml" lang="en">
  <head>
    <meta http-equiv="X-UA-Compatible" content="IE=Edge" />
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <title>基于 4.8.x 升级 &#8212; Apache CloudStack 发行版本说明 4.12.0.0 documentation</title>
    <link rel="stylesheet" href="../_static/basic.css" type="text/css" />
    <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="stylesheet" href="https://media.readthedocs.org/css/badge_only.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootswatch-3.2.0/spacelab/bootstrap.min.css" type="text/css" />
    <link rel="stylesheet" href="../_static/bootstrap-sphinx.css" type="text/css" />
    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
    <script type="text/javascript" src="https://media.readthedocs.org/javascript/jquery/jquery-2.0.3.min.js"></script>
    <script type="text/javascript" src="https://media.readthedocs.org/javascript/jquery/jquery-migrate-1.2.1.min.js"></script>
    <script type="text/javascript" src="https://media.readthedocs.org/javascript/underscore.js"></script>
    <script type="text/javascript" src="https://media.readthedocs.org/javascript/doctools.js"></script>
    <script type="text/javascript" src="https://media.readthedocs.org/javascript/readthedocs-doc-embed.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-1.11.0.min.js"></script>
    <script type="text/javascript" src="../_static/js/jquery-fix.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-3.2.0/js/bootstrap.min.js"></script>
    <script type="text/javascript" src="../_static/bootstrap-sphinx.js"></script>
    <link rel="author" title="About these documents" href="../about.html" />
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="基于 4.7.x 升级" href="upgrade-4.7.html" />
    <link rel="prev" title="基于 4.9.x 升级" href="upgrade-4.9.html" />
<meta charset='utf-8'>
<meta http-equiv='X-UA-Compatible' content='IE=edge,chrome=1'>
<meta name='viewport' content='width=device-width, initial-scale=1.0, maximum-scale=1'>
<meta name="apple-mobile-web-app-capable" content="yes">

  
<!-- RTD Extra Head -->

<!-- 
Always link to the latest version, as canonical.
http://docs.readthedocs.org/en/latest/canonical.html
-->
<link rel="canonical" href="upgrade-4.8.html" />

<link rel="stylesheet" href="https://media.readthedocs.org/css/readthedocs-doc-embed.css" type="text/css" />

<script type="text/javascript" src="../_static/readthedocs-data.js"></script>

<!-- Add page-specific data, which must exist in the page js, not global -->
<script type="text/javascript">
READTHEDOCS_DATA['page'] = 'upgrade/upgrade-4.8'
READTHEDOCS_DATA['source_suffix'] = '.rst'
</script>

<script type="text/javascript" src="https://media.readthedocs.org/javascript/readthedocs-analytics.js"></script>

<!-- end RTD <extrahead> -->
</head><body>

  <div id="navbar" class="navbar navbar-inverse navbar-default navbar-fixed-top">
    <div class="container">
      <div class="navbar-header">
        <!-- .btn-navbar is used as the toggle for collapsed navbar content -->
        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".nav-collapse">
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
          <span class="icon-bar"></span>
        </button>
        <a class="navbar-brand" href="../index.html">
          发行版本说明</a>
        <span class="navbar-text navbar-version pull-left"><b>4.12</b></span>
      </div>

        <div class="collapse navbar-collapse nav-collapse">
          <ul class="nav navbar-nav">
            
            
              <li class="dropdown globaltoc-container">
                <a role="button"
                   id="dLabelGlobalToc"
                   data-toggle="dropdown"
                   data-target="#"
                   href="../index.html">Sections <b class="caret"></b></a>
                <ul class="dropdown-menu globaltoc"
                    role="menu"
                    aria-labelledby="dLabelGlobalToc">
                     <ul>
<li class="toctree-l1"><a class="reference internal" href="../about.html">What’s New in 4.12</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../fixed_issues.html">Issues Fixed in 4.12</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../compat.html">Compatibility Matrix</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../api-changes.html">API Changes Introduced in 4.12</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="upgrade_notes.html">General Upgrade Notes</a></li>
</ul>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="upgrade-4.11.html">Upgrade Instruction from 4.11.0.0</a></li>
<li class="toctree-l1"><a class="reference internal" href="upgrade-4.10.html">基于 4.10.x 升级</a></li>
<li class="toctree-l1"><a class="reference internal" href="upgrade-4.9.html">基于 4.9.x 升级</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="upgrade-4.8.html#">基于 4.8.x 升级</a></li>
<li class="toctree-l1"><a class="reference internal" href="upgrade-4.7.html">基于 4.7.x 升级</a></li>
<li class="toctree-l1"><a class="reference internal" href="upgrade-4.6.html">基于 4.6.x 升级</a></li>
<li class="toctree-l1"><a class="reference internal" href="upgrade-4.5.html">基于 4.5.x 升级</a></li>
<li class="toctree-l1"><a class="reference internal" href="upgrade-4.4.html">基于 4.4.x 升级</a></li>
<li class="toctree-l1"><a class="reference internal" href="upgrade-4.3.html">基于 4.3.x 升级</a></li>
</ul>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../known_issues.html">Known Issues in 4.12.0.0</a></li>
</ul>


                </ul>
              </li>
              
                
              
            
            
              
                
  <li>
    <a href="upgrade-4.9.html" title="Previous Chapter: 基于 4.9.x 升级"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; 基于 4.9.x 升级</span>
    </a>
  </li>
  <li>
    <a href="upgrade-4.7.html" title="Next Chapter: 基于 4.7.x 升级"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">基于 4.7.x 升级 &raquo;</span>
    </a>
  </li>
              
            
            
            
            
          </ul>

          
            
<form class="navbar-form navbar-right" action="../search.html" method="get">
 <div class="form-group">
  <input type="text" name="q" class="form-control" placeholder="Search" />
 </div>
  <input type="hidden" name="check_keywords" value="yes" />
  <input type="hidden" name="area" value="default" />
</form>
          
        </div>
    </div>
  </div>

<div class="container">
  <div class="row">
      <div class="col-md-3">
        <div id="sidebar" class="bs-sidenav" role="complementary"><ul>
<li><a class="reference internal" href="upgrade-4.8.html#">基于 4.8.x 升级</a><ul>
<li><a class="reference internal" href="upgrade-4.8.html#update-system-vm-templates">升级系统虚拟机模版</a></li>
<li><a class="reference internal" href="upgrade-4.8.html#packages-repository">软件包存储库</a></li>
<li><a class="reference internal" href="upgrade-4.8.html#database-preparation">Database Preparation</a></li>
<li><a class="reference internal" href="upgrade-4.8.html#management-server-on-ubuntu">管理服务 on Ubuntu</a></li>
<li><a class="reference internal" href="upgrade-4.8.html#java-8-jre-on-ubuntu">Java 8 JRE on Ubuntu</a><ul>
<li><a class="reference internal" href="upgrade-4.8.html#cloudstack-apt-repository">CloudStack apt repository</a></li>
</ul>
</li>
<li><a class="reference internal" href="upgrade-4.8.html#management-server-on-centos-rhel">管理服务 on CentOS/RHEL</a><ul>
<li><a class="reference internal" href="upgrade-4.8.html#install-new-mysql-connector">Install new MySQL connector</a><ul>
<li><a class="reference internal" href="upgrade-4.8.html#mysql-connector-rpm-repository">MySQL connector RPM repository</a></li>
</ul>
</li>
<li><a class="reference internal" href="upgrade-4.8.html#cloudstack-rpm-repository">CloudStack RPM repository</a></li>
</ul>
</li>
<li><a class="reference internal" href="upgrade-4.8.html#hypervisor-xenserver">Hypervisor: XenServer</a></li>
<li><a class="reference internal" href="upgrade-4.8.html#hypervisor-vmware">Hypervisor: VMware</a></li>
<li><a class="reference internal" href="upgrade-4.8.html#hypervisor-kvm">Hypervisor: KVM</a><ul>
<li><a class="reference internal" href="upgrade-4.8.html#kvm-on-ubuntu">KVM on Ubuntu</a></li>
<li><a class="reference internal" href="upgrade-4.8.html#kvm-on-centos-rhel">KVM on CentOS/RHEL</a></li>
</ul>
</li>
<li><a class="reference internal" href="upgrade-4.8.html#restart-management-services">重启管理服务</a></li>
</ul>
</li>
</ul>

        </div>
      </div>
    <div class="col-md-9">
      
  <div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p>NOTICE: THIS DOCUMENTATION SITE HAS BEEN SUPERSEDED.</p>
<p class="last">For the current documentation site goto: <a class="reference external" href="../../../../../index.html">http://docs.cloudstack.apache.org</a></p>
</div>
<div class="section" id="upgrade-instruction-from-version-to-upgrade">
<h1>基于 4.8.x 升级<a class="headerlink" href="upgrade-4.8.html#upgrade-instruction-from-version-to-upgrade" title="Permalink to this headline">¶</a></h1>
<p>This section will guide you from CloudStack 4.8.x to CloudStack
4.12.</p>
<p>Any steps that are hypervisor-specific will be called out with a note.</p>
<p>We recommend reading through this section once or twice before beginning
your upgrade procedure, and working through it on a test system before
working on a production system.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">The following upgrade instructions should be performed regardless of
hypervisor type.</p>
</div>
<p>Upgrade Steps:</p>
<ol class="arabic simple">
<li>Backup CloudStack database (MySQL)</li>
<li>Add package repository for MySQL connector</li>
<li>Upgrade CloudStack management server(s)</li>
<li>Update hypervisors specific dependencies</li>
</ol>
<div class="section" id="update-system-vm-templates">
<h2>升级系统虚拟机模版<a class="headerlink" href="upgrade-4.8.html#update-system-vm-templates" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p class="first">While running the existing 4.8.x system, log in to the UI as
root administrator.</p>
</li>
<li><p class="first">In the left navigation bar, click Templates.</p>
</li>
<li><p class="first">In Select view, click Templates.</p>
</li>
<li><p class="first">Click Register template.</p>
<p>The Register template dialog box is displayed.</p>
</li>
<li><p class="first">In the Register template dialog box, specify the following values
(do not change these):</p>
<table border="1" class="table-striped table-bordered table-hover docutils">
<colgroup>
<col width="17%" />
<col width="83%" />
</colgroup>
<thead valign="bottom">
<tr class="row-odd"><th class="head">Hypervisor</th>
<th class="head">Description</th>
</tr>
</thead>
<tbody valign="top">
<tr class="row-even"><td>XenServer</td>
<td><p class="first">Name: systemvm-xenserver-4.11.1</p>
<p>Description: systemvm-xenserver-4.11.1</p>
<p>URL: <a class="reference external" href="http://download.cloudstack.org/systemvm/4.11/systemvmtemplate-4.11.1-xen.vhd.bz2">http://download.cloudstack.org/systemvm/4.11/systemvmtemplate-4.11.1-xen.vhd.bz2</a></p>
<p>Zone: Choose the zone where this hypervisor is used</p>
<p>Hypervisor: XenServer</p>
<p>Format: VHD</p>
<p>OS Type: Debian GNU/Linux 7.0 (64-bit) (or the
highest Debian release number available in the
dropdown)</p>
<p>Extractable: no</p>
<p>Password Enabled: no</p>
<p>Public: no</p>
<p>Featured: no</p>
<p class="last">Routing: no</p>
</td>
</tr>
<tr class="row-odd"><td>KVM</td>
<td><p class="first">Name: systemvm-kvm-4.11.1</p>
<p>Description: systemvm-kvm-4.11.1</p>
<p>URL: <a class="reference external" href="http://download.cloudstack.org/systemvm/4.11/systemvmtemplate-4.11.1-kvm.qcow2.bz2">http://download.cloudstack.org/systemvm/4.11/systemvmtemplate-4.11.1-kvm.qcow2.bz2</a></p>
<p>Zone: Choose the zone where this hypervisor is used</p>
<p>Hypervisor: KVM</p>
<p>Format: QCOW2</p>
<p>OS Type: Debian GNU/Linux 7.0 (64-bit) (or the
highest Debian release number available in the
dropdown)</p>
<p>Extractable: no</p>
<p>Password Enabled: no</p>
<p>Public: no</p>
<p>Featured: no</p>
<p class="last">Routing: no</p>
</td>
</tr>
<tr class="row-even"><td>VMware</td>
<td><p class="first">Name: systemvm-vmware-4.11.1</p>
<p>Description: systemvm-vmware-4.11.1</p>
<p>URL: <a class="reference external" href="http://download.cloudstack.org/systemvm/4.11/systemvmtemplate-4.11.1-vmware.ova">http://download.cloudstack.org/systemvm/4.11/systemvmtemplate-4.11.1-vmware.ova</a></p>
<p>Zone: Choose the zone where this hypervisor is used</p>
<p>Hypervisor: VMware</p>
<p>Format: OVA</p>
<p>OS Type: Other Linux 64-bit (or Debian 8.0 or 9.0 64-bit)</p>
<p>Extractable: no</p>
<p>Password Enabled: no</p>
<p>Public: no</p>
<p>Featured: no</p>
<p class="last">Routing: no</p>
</td>
</tr>
<tr class="row-odd"><td>HyperV</td>
<td><p class="first">Name: systemvm-hyperv-4.11.1</p>
<p>Description: systemvm-hyperv-4.11.1</p>
<p>URL: <a class="reference external" href="http://download.cloudstack.org/systemvm/4.11/systemvmtemplate-4.11.1-hyperv.vhd.zip">http://download.cloudstack.org/systemvm/4.11/systemvmtemplate-4.11.1-hyperv.vhd.zip</a></p>
<p>Zone: Choose the zone where this hypervisor is used</p>
<p>Hypervisor: Hyper-V</p>
<p>Format: VHD</p>
<p>OS Type: Debian GNU/Linux 7.0 (64-bit) (or the
highest Debian release number available in the
dropdown)</p>
<p>Extractable: no</p>
<p>Password Enabled: no</p>
<p>Public: no</p>
<p>Featured: no</p>
<p class="last">Routing: no</p>
</td>
</tr>
</tbody>
</table>
</li>
<li><p class="first">Watch the screen to be sure that the template downloads successfully and
enters the <strong>READY</strong> state. Do not proceed until this is successful.</p>
</li>
</ol>
</div>
<div class="section" id="packages-repository">
<h2>软件包存储库<a class="headerlink" href="upgrade-4.8.html#packages-repository" title="Permalink to this headline">¶</a></h2>
<p>Most users of CloudStack manage the installation and upgrades of
CloudStack with one of Linux’s predominant package systems, RPM or
APT. This guide assumes you’ll be using RPM and Yum (for Red Hat
Enterprise Linux or CentOS), or APT and Debian packages (for Ubuntu).</p>
<p>Create RPM or Debian packages (as appropriate) and a repository from
the 4.12 source, or check the Apache CloudStack downloads page at
<a class="reference external" href="http://cloudstack.apache.org/downloads.html">http://cloudstack.apache.org/downloads.html</a>
for package repositories supplied by community members. You will need
them for <a class="reference internal" href="upgrade-4.9.html#ubuntu48"><span class="std std-ref">管理服务 on Ubuntu</span></a> or <a class="reference internal" href="upgrade-4.9.html#rhel48"><span class="std std-ref">管理服务 on CentOS/RHEL</span></a> and <a class="reference internal" href="upgrade-4.9.html#kvm48"><span class="std std-ref">Hypervisor: KVM</span></a> hosts upgrade.</p>
<p>Instructions for creating packages from the CloudStack source are in the
<a class="reference external" href="../../../../cloudstack-installation">CloudStack 安装指南</a>.</p>
</div>
<div class="section" id="database-preparation">
<h2>Database Preparation<a class="headerlink" href="upgrade-4.8.html#database-preparation" title="Permalink to this headline">¶</a></h2>
<p>Backup current database</p>
<ol class="arabic">
<li><p class="first">Stop your management server or servers. Run this on all management
server hosts:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ sudo service cloudstack-management stop
</pre></div>
</div>
</li>
<li><p class="first">If you are running a usage server or usage servers, stop those as well:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ sudo service cloudstack-usage stop
</pre></div>
</div>
</li>
<li><p class="first">Make a backup of your MySQL database. If you run into any issues or
need to roll back the upgrade, this will assist in debugging or
restoring your existing environment. You’ll be prompted for your
password.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ mysqldump -u root -p cloud &gt; cloud-backup_<span class="sb">`</span>date <span class="s1">&#39;+%Y-%m-%d&#39;</span><span class="sb">`</span>.sql
$ mysqldump -u root -p cloud_usage &gt; cloud_usage-backup_<span class="sb">`</span>date <span class="s1">&#39;+%Y-%m-%d&#39;</span><span class="sb">`</span>.sql
</pre></div>
</div>
</li>
<li><p class="first"><strong>(KVM Only)</strong> If primary storage of type local storage is in use, the
path for this storage needs to be verified to ensure it passes new
validation. Check local storage by querying the cloud.storage_pool
table:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ mysql -u cloud -p -e <span class="s2">&quot;select id,name,path from cloud.storage_pool where pool_type=&#39;Filesystem&#39;&quot;</span>
</pre></div>
</div>
<p>If local storage paths are found to have a trailing forward slash,
remove it:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ mysql -u cloud -p -e <span class="s1">&#39;update cloud.storage_pool set path=&quot;/var/lib/libvirt/images&quot; where path=&quot;/var/lib/libvirt/images/&quot;&#39;</span><span class="p">;</span>
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="management-server-on-ubuntu">
<span id="ubuntu48"></span><h2>管理服务 on Ubuntu<a class="headerlink" href="upgrade-4.8.html#management-server-on-ubuntu" title="Permalink to this headline">¶</a></h2>
<p>If you are using Ubuntu, follow this procedure to upgrade your packages. If
not, skip to step <a class="reference internal" href="upgrade-4.9.html#rhel48"><span class="std std-ref">管理服务 on CentOS/RHEL</span></a>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><strong>Community Packages:</strong> This section assumes you’re using the community
supplied packages for CloudStack. If you’ve created your own packages and
APT repository, substitute your own URL for the ones used in these examples.</p>
</div>
<p>The first order of business will be to change the sources list for
each system with CloudStack packages. This means all management
servers, and any hosts that have the KVM agent. (No changes should
be necessary for hosts that are running VMware or Xen.)</p>
<span class="target" id="apt-repo48"></span></div>
<div class="section" id="java-8-jre-on-ubuntu">
<h2>Java 8 JRE on Ubuntu<a class="headerlink" href="upgrade-4.8.html#java-8-jre-on-ubuntu" title="Permalink to this headline">¶</a></h2>
<p>CloudStack 4.12.0.0 requires installation of Java 8 JRE from an external PPA
such as openjdk-r for Ubuntu distributions where the openjdk-8 packages are not
available from the main repositories such as on Ubuntu 14.04. The PPA can be
added before installation/upgrade:</p>
<blockquote>
<div><div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ sudo add-apt-repository ppa:openjdk-r/ppa
$ sudo apt-get update
</pre></div>
</div>
</div></blockquote>
<p>Users can also choose to install Java 8 distribution from Oracle, or <a class="reference external" href="http://repos.azulsystems.com/">Xulu-8</a> OpenJDK distribution from Azul.</p>
<div class="section" id="cloudstack-apt-repository">
<h3>CloudStack apt repository<a class="headerlink" href="upgrade-4.8.html#cloudstack-apt-repository" title="Permalink to this headline">¶</a></h3>
<p>Start by opening <code class="docutils literal notranslate"><span class="pre">/etc/apt/sources.list.d/cloudstack.list</span></code> on
any systems that have CloudStack packages installed.</p>
<p>This file should have one line, which contains:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>deb http://cloudstack.apt-get.eu/ubuntu precise <span class="m">4</span>.8
</pre></div>
</div>
<p>We’ll change it to point to the new package repository:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>deb http://cloudstack.apt-get.eu/ubuntu precise <span class="m">4</span>.9
</pre></div>
</div>
<p>Setup the public key for the above repository:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>wget -qO - http://cloudstack.apt-get.eu/release.asc <span class="p">|</span> sudo apt-key add -
</pre></div>
</div>
<p>If you’re using your own package repository, change this line to
read as appropriate for your 4.12 repository.</p>
<ol class="arabic">
<li><p class="first">Now update your apt package list:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ sudo apt-get update
</pre></div>
</div>
</li>
<li><p class="first">Now that you have the repository configured, it’s time to upgrade
the <code class="docutils literal notranslate"><span class="pre">cloudstack-management</span></code> package.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ sudo apt-get upgrade cloudstack-management
</pre></div>
</div>
</li>
<li><p class="first">If you use CloudStack usage server</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ sudo apt-get upgrade cloudstack-usage
</pre></div>
</div>
</li>
</ol>
</div>
</div>
<div class="section" id="management-server-on-centos-rhel">
<span id="rhel48"></span><h2>管理服务 on CentOS/RHEL<a class="headerlink" href="upgrade-4.8.html#management-server-on-centos-rhel" title="Permalink to this headline">¶</a></h2>
<p>If you are using CentOS or RHEL, follow this procedure to upgrade your
packages. If not, skip to hypervisors section, then <span class="xref std std-ref">upg-sysvm48</span>.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last"><strong>Community Packages:</strong> This section assumes you’re using the community
supplied packages for CloudStack. If you’ve created your own packages and
yum repository, substitute your own URL for the ones used in these examples.</p>
</div>
<div class="section" id="install-new-mysql-connector">
<h3>Install new MySQL connector<a class="headerlink" href="upgrade-4.8.html#install-new-mysql-connector" title="Permalink to this headline">¶</a></h3>
<p>Apache CloudStack 4.12 require an upgrade of the MySQL connector on CentOS.
Starting with 4.9.0, cloudstack-management RPM’s now depend on
<code class="docutils literal notranslate"><span class="pre">mysql-connector-python</span></code> package.</p>
<div class="section" id="mysql-connector-rpm-repository">
<h4>MySQL connector RPM repository<a class="headerlink" href="upgrade-4.8.html#mysql-connector-rpm-repository" title="Permalink to this headline">¶</a></h4>
<p>Add a new yum repo <code class="docutils literal notranslate"><span class="pre">/etc/yum.repos.d/mysql.repo</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">[</span>mysql-community<span class="o">]</span>
<span class="nv">name</span><span class="o">=</span>MySQL Community connectors
<span class="nv">baseurl</span><span class="o">=</span>http://repo.mysql.com/yum/mysql-connectors-community/el/<span class="nv">$releasever</span>/<span class="nv">$basearch</span>/
<span class="nv">enabled</span><span class="o">=</span><span class="m">1</span>
<span class="nv">gpgcheck</span><span class="o">=</span><span class="m">1</span>
</pre></div>
</div>
<p>Import GPG public key from MySQL:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>rpm --import http://repo.mysql.com/RPM-GPG-KEY-mysql
</pre></div>
</div>
<p>Install mysql-connector</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>yum install mysql-connector-python
</pre></div>
</div>
</div>
</div>
<div class="section" id="cloudstack-rpm-repository">
<span id="rpm-repo48"></span><h3>CloudStack RPM repository<a class="headerlink" href="upgrade-4.8.html#cloudstack-rpm-repository" title="Permalink to this headline">¶</a></h3>
<p>The first order of business will be to change the yum repository
for each system with CloudStack packages. This means all
management servers, and any hosts that have the KVM agent.</p>
<p>(No changes should be necessary for hosts that are running VMware
or Xen.)</p>
<p>Start by opening <code class="docutils literal notranslate"><span class="pre">/etc/yum.repos.d/cloudstack.repo</span></code> on any
systems that have CloudStack packages installed.</p>
<p>This file should have content similar to the following:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="o">[</span>apache-cloudstack<span class="o">]</span>
<span class="nv">name</span><span class="o">=</span>Apache CloudStack
<span class="nv">baseurl</span><span class="o">=</span>http://cloudstack.apt-get.eu/centos/6/4.8/
<span class="nv">enabled</span><span class="o">=</span><span class="m">1</span>
<span class="nv">gpgcheck</span><span class="o">=</span><span class="m">0</span>
</pre></div>
</div>
<p>If you are using the community provided package repository, change
the base url to <code class="docutils literal notranslate"><span class="pre">http://cloudstack.apt-get.eu/centos/$releasever/4.9/</span></code>.</p>
<p>Setup the GPG public key if you wish to enable <code class="docutils literal notranslate"><span class="pre">gpgcheck=1</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>rpm --import http://cloudstack.apt-get.eu/RPM-GPG-KEY
</pre></div>
</div>
<p>If you’re using your own package repository, change this line to
read as appropriate for your 4.12 repository.</p>
<ol class="arabic">
<li><p class="first">Now that you have the repository configured, it’s time to upgrade the
<code class="docutils literal notranslate"><span class="pre">cloudstack-management</span></code>.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ sudo yum upgrade cloudstack-management
</pre></div>
</div>
</li>
<li><p class="first">If you use CloudStack usage server</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ sudo yum upgrade cloudstack-usage
</pre></div>
</div>
</li>
</ol>
</div>
</div>
<div class="section" id="hypervisor-xenserver">
<h2>Hypervisor: XenServer<a class="headerlink" href="upgrade-4.8.html#hypervisor-xenserver" title="Permalink to this headline">¶</a></h2>
<p><strong>(XenServer only)</strong> Copy vhd-utils file on CloudStack management servers.
Copy the file <a class="reference external" href="http://download.cloud.com.s3.amazonaws.com/tools/vhd-util">vhd-utils</a>
to <code class="docutils literal notranslate"><span class="pre">/usr/share/cloudstack-common/scripts/vm/hypervisor/xenserver</span></code>.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>wget -P /usr/share/cloudstack-common/scripts/vm/hypervisor/xenserver <span class="se">\</span>
http://download.cloud.com.s3.amazonaws.com/tools/vhd-util
</pre></div>
</div>
</div>
<div class="section" id="hypervisor-vmware">
<h2>Hypervisor: VMware<a class="headerlink" href="upgrade-4.8.html#hypervisor-vmware" title="Permalink to this headline">¶</a></h2>
<div class="admonition warning">
<p class="first admonition-title">Warning</p>
<p class="last">For VMware hypervisor CloudStack management server packages must be
build using “noredist”. Refer to <a class="reference external" href="http://docs.cloudstack.apache.org/projects/cloudstack-installation.html/en/latest/building_from_source.html">从源码编译安装</a>.</p>
</div>
<p><strong>(VMware only)</strong> Additional steps are required for each VMware cluster.
These steps will not affect running guests in the cloud. These steps
are required only for clouds using VMware clusters:</p>
<ol class="arabic">
<li><p class="first">Stop the 管理服务:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ sudo service cloudstack-management stop
</pre></div>
</div>
</li>
<li><p class="first">Generate the encrypted equivalent of your vCenter password:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ java -classpath /usr/share/cloudstack-common/lib/jasypt-1.9.2.jar org.jasypt.intf.cli.JasyptPBEStringEncryptionCLI encrypt.sh <span class="nv">input</span><span class="o">=</span><span class="s2">&quot;_your_vCenter_password_&quot;</span> <span class="nv">password</span><span class="o">=</span><span class="s2">&quot;`cat /etc/cloudstack/management/key`&quot;</span> <span class="nv">verbose</span><span class="o">=</span><span class="nb">false</span>
</pre></div>
</div>
</li>
</ol>
<p>Store the output from this step, we need to add this in
cluster_details table and vmware_data_center tables in place of
the plain text password</p>
<ol class="arabic">
<li><p class="first">Find the ID of the row of cluster_details table that you have to
update:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ mysql -u &lt;username&gt; -p&lt;password&gt;
</pre></div>
</div>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="k">select</span> * from cloud.cluster_details<span class="p">;</span>
</pre></div>
</div>
</li>
<li><p class="first">Update the plain text password with the encrypted one</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>update cloud.cluster_details <span class="nb">set</span> <span class="nv">value</span> <span class="o">=</span> <span class="s1">&#39;_ciphertext_from_step_1_&#39;</span>
where <span class="nv">id</span> <span class="o">=</span> _id_from_step_2_<span class="p">;</span>
</pre></div>
</div>
</li>
<li><p class="first">Confirm that the table is updated:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="k">select</span> * from cloud.cluster_details<span class="p">;</span>
</pre></div>
</div>
</li>
<li><dl class="first docutils">
<dt>Find the ID of the correct row of vmware_data_center that you</dt>
<dd><p class="first last">want to update</p>
</dd>
</dl>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="k">select</span> * from cloud.vmware_data_center<span class="p">;</span>
</pre></div>
</div>
</li>
<li><p class="first">update the plain text password with the encrypted one:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>update cloud.vmware_data_center <span class="nb">set</span> <span class="nv">password</span> <span class="o">=</span> <span class="s1">&#39;_ciphertext_from_step_1_&#39;</span>
where <span class="nv">id</span> <span class="o">=</span> _id_from_step_5_<span class="p">;</span>
</pre></div>
</div>
</li>
<li><p class="first">Confirm that the table is updated:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="k">select</span> * from cloud.vmware_data_center<span class="p">;</span>
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="hypervisor-kvm">
<span id="kvm48"></span><h2>Hypervisor: KVM<a class="headerlink" href="upgrade-4.8.html#hypervisor-kvm" title="Permalink to this headline">¶</a></h2>
<div class="section" id="kvm-on-ubuntu">
<h3>KVM on Ubuntu<a class="headerlink" href="upgrade-4.8.html#kvm-on-ubuntu" title="Permalink to this headline">¶</a></h3>
<p>(KVM only) Additional steps are required for each KVM host. These
steps will not affect running guests in the cloud. These steps are
required only for clouds using KVM as hosts and only on the KVM
hosts.</p>
<ol class="arabic">
<li><p class="first">Configure the <span class="xref std std-ref">apt-repo48</span> as detailed above.</p>
</li>
<li><p class="first">Stop the running agent.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ sudo service cloudstack-agent stop
</pre></div>
</div>
</li>
<li><p class="first">Update the agent software.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ sudo apt-get upgrade cloudstack-agent
</pre></div>
</div>
</li>
<li><dl class="first docutils">
<dt>Verify that the file <code class="docutils literal notranslate"><span class="pre">/etc/cloudstack/agent/environment.properties</span></code> has a</dt>
<dd><p class="first last">line that reads:</p>
</dd>
</dl>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>paths.script<span class="o">=</span>/usr/share/cloudstack-common
</pre></div>
</div>
<p>If not, add the line.</p>
</li>
<li><p class="first">Start the agent.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ sudo service cloudstack-agent start
</pre></div>
</div>
</li>
</ol>
</div>
<div class="section" id="kvm-on-centos-rhel">
<h3>KVM on CentOS/RHEL<a class="headerlink" href="upgrade-4.8.html#kvm-on-centos-rhel" title="Permalink to this headline">¶</a></h3>
<p>For KVM hosts, upgrade the <code class="docutils literal notranslate"><span class="pre">cloudstack-agent</span></code> package</p>
<ol class="arabic">
<li><p class="first">Configure the <a class="reference internal" href="upgrade-4.9.html#rpm-repo48"><span class="std std-ref">CloudStack RPM repository</span></a> as detailed above.</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ sudo yum upgrade cloudstack-agent
</pre></div>
</div>
</li>
<li><p class="first">Verify that the file <code class="docutils literal notranslate"><span class="pre">/etc/cloudstack/agent/environment.properties</span></code> has a
line that reads:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>paths.script<span class="o">=</span>/usr/share/cloudstack-common
</pre></div>
</div>
<p>If not, add the line.</p>
</li>
<li><p class="first">Restart the agent:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ sudo service cloudstack-agent stop
$ sudo killall jsvc
$ sudo service cloudstack-agent start
</pre></div>
</div>
</li>
</ol>
</div>
</div>
<div class="section" id="restart-management-services">
<h2>重启管理服务<a class="headerlink" href="upgrade-4.8.html#restart-management-services" title="Permalink to this headline">¶</a></h2>
<ol class="arabic">
<li><p class="first">Now it’s time to start the management server</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ sudo service cloudstack-management start
</pre></div>
</div>
</li>
<li><p class="first">If you use it, start the usage server</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>$ sudo service cloudstack-usage start
</pre></div>
</div>
</li>
</ol>
</div>
</div>


    </div>
      
  </div>
</div>
<footer class="footer">
  <div class="container">
    <p class="pull-right">
      <a href="upgrade-4.8.html#">Back to top</a>
          | <a href="upgrade-4.9.html" title="Previous Chapter: 基于 4.9.x 升级"><span class="glyphicon glyphicon-chevron-left visible-sm"></span><span class="hidden-sm hidden-tablet">&laquo; 基于 4.9.x 升级</span>
          </a>
          | <a href="upgrade-4.7.html" title="Next Chapter: 基于 4.7.x 升级"><span class="glyphicon glyphicon-chevron-right visible-sm"></span><span class="hidden-sm hidden-tablet">基于 4.7.x 升级 &raquo;</span>
          </a>
      
        <br/>
        
<div id="sourcelink">
  <a href="../_sources/upgrade/upgrade-4.8.rst.txt"
     rel="nofollow">Source</a>
</div>
      
    </p>
    <p>
        &copy; Copyright 2018, Apache CloudStack.<br/>
    </p>
  </div>
</footer>
  </body>
</html>