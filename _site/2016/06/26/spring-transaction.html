<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0,minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <!-- 添加搜索关键字 -->
  <meta name="keywords" content="梦回少年,梦回,saber,lemonjing,少年">

  <title>精-Spring事务管理（详解+实例) | 梦回少年</title>
  <meta name="description" content="1、初步理解">

  <link rel="stylesheet" href="/assets/css/bootstrap.css">
  <link rel="stylesheet" href="/assets/css/font-awesome.css">
  <link rel="stylesheet" href="/assets/css/main.css" >
  <link rel="stylesheet" href="/assets/js/prettify/prettify.css">
  <link rel="shortcut icon" href="/assets/img/favicon.ico" />
  <link rel="canonical" href="http://localhost:4000/2016/06/26/spring-transaction.html">
  <link rel="alternate" type="application/rss+xml" title="梦回少年" href="http://localhost:4000/feed.xml" />
</head>


  <body>

    <header class="site-header">
    <div class="container">
        <div class="row">
            <nav class="navbar navbar-default" role="navigation">
                <div class="navbar-header col-xs-12 col-sm-12 col-md-3 col-lg-3 center">
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#example-navbar-collapse">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <div class="sitehome">
                        <a href="/" title="首页"><i class="fa fa-home fa-2x homeicon"></i><a><a class="site-title" href="/">梦回少年</a>
                    </div>
                </div>
                <div class="col-md-6 col-lg-6 hidden-xs hidden-sm center">
                    <nav class="site-nav">
                        <ul class="nav nav-pills">
                            <li class="select"><a class="page-link pjaxlink" href="/pages/read.html">读书</a></li>
                            <li class="select"><a class="page-link pjaxlink" href="/pages/class.html">分类</a></li>
                            <!-- <li class="select"><a class="page-link pjaxlink" href="/pages/tags.html">标签</a></li> -->
                            <li class="select"><a class="page-link pjaxlink" href="/pages/archive.html">归档</a></li>
                            <li class="select"><a class="page-link pjaxlink" href="/pages/about.html">关于</a></li>
                        </ul>
                    </nav>
                </div>
                <!-- swifttype 搜索 弃用-->
               <!--  <div class="col-md-3 col-lg-3 hidden-xs hidden-sm">
                    <div class="search">
                        <input type="text" class="search-query st-default-search-input" placeholder="Search">
                    </div>
                </div> -->
                 <!-- /swifttype 搜索 -->
                <div class="col-md-3 col-lg-3 hidden-xs hidden-sm">
                    <div style="position: fixed; top:10px;">
                        <img src="/search/img/cb-search.png" id="cb-search-btn" title="双击ctrl试一下" />
                    </div>
                </div>
                   
                    <div class="collapse navbar-collapse" id="example-navbar-collapse">
                        <ul class="nav navbar-nav phone-nav center">
                            <li class="phoneselect"><a class="page-link pjaxlink" href="/"><i class="fa fa-home"></i>&nbsp;首页</a></li>
                            <li class="phoneselect"><a class="page-link pjaxlink" href="/pages/read.html"><i class="fa fa-book"></i>&nbsp;读书</a></li>
                            <li class="phoneselect"><a class="page-link pjaxlink" href="/pages/class.html"><i class="fa fa-tasks"></i>&nbsp;分类</a></li>
                            <li class="phoneselect"><a class="page-link pjaxlink" href="/pages/tags.html"><i class="fa fa-tags"></i>&nbsp;标签</a></li>
                            <li class="phoneselect"><a class="page-link pjaxlink" href="/pages/archive.html"><i class="fa fa-archive"></i>&nbsp;归档</a></li>
                            <li class="phoneselect"><a class="page-link pjaxlink" href="/pages/about.html"><i class="fa fa-user"></i>&nbsp;关于</a></li>
                        </ul>
                    </div>
            </nav>
            </div>
        </div>
</header>


    <div class="content">
   	<div class="container">	
   		<div class="row">
			<div class="col-md-3 col-lg-3 hidden-xs hidden-sm aside1 fadein-left">
				<div class="profile box-shadow center">
					<div class="overlay"></div>
					<div class="center gavatar">
						<a href="/" class="profile_gavatar"><img class="circle" src="/assets/img/t1.jpeg"></a>
					</div>
					<div class="address">
						<h5><span class="fa fa-map-marker"></span> Hangzhou, China</h5>
					</div>
					<div class="center profile_desc">
						技术<br>生活<br>和爱情<br>此刻与你分享<br>
					</div>
				</div>
				
				<div class="tag-cloud-text">
					<a href="http://rann.cc/pages/tags.html" title="标签" class="pjaxlink"><p class="center">标签【点我】</p></a>
				</div>
				<div class="tag-cloud ">	
					<hr>
					<div class="page-tag">
							
								
							
								
							
								
							
								
								<a href="http://lemonjing.github.io/pages/tags.html#随笔" name="随笔" class="pjaxlink"><i class="fa fa-tags"></i>随笔(21)</a>
								
							
								
							
								
							
								
							
								
							
								
							
								
							
								
							
								
							
								
							
								
							
								
								<a href="http://lemonjing.github.io/pages/tags.html#Java" name="Java" class="pjaxlink"><i class="fa fa-tags"></i>Java(43)</a>
								
							
								
							
								
							
								
							
								
							
								
							
								
								<a href="http://lemonjing.github.io/pages/tags.html#爱情" name="爱情" class="pjaxlink"><i class="fa fa-tags"></i>爱情(20)</a>
								
							
								
								<a href="http://lemonjing.github.io/pages/tags.html#原创" name="原创" class="pjaxlink"><i class="fa fa-tags"></i>原创(23)</a>
								
							
								
							
								
							
								
							
								
							
								
							
								
							
								
							
								
								<a href="http://lemonjing.github.io/pages/tags.html#技术" name="技术" class="pjaxlink"><i class="fa fa-tags"></i>技术(5)</a>
								
							
								
							
								
							
								
							
								
							
								
							
								
							
								
							
								
							
								
							
								
							
								
							
								
							
								
							
								
							
								
							
								
							
								
								<a href="http://lemonjing.github.io/pages/tags.html#Spring" name="Spring" class="pjaxlink"><i class="fa fa-tags"></i>Spring(10)</a>
								
							
								
							
								
							
								
							
								
							
								
							
								
							
								
							
								
							
								
								<a href="http://lemonjing.github.io/pages/tags.html#NIO" name="NIO" class="pjaxlink"><i class="fa fa-tags"></i>NIO(13)</a>
								
							
								
							
								
							
								
							
								
							
								
							
								
							
					</div>					
				</div>
				<div class="clear"></div>

	 			<div class="recentuse">
	 					<p>GitHub项目</p>
	 					<hr>
	 					<ul>
	 						<li><a href = "https://github.com/it-interview/easy-job" target="_blank">互联网求职面试知识复习</a></li>
	 						<li><a href = "https://github.com/Lemonjing/LightweightApp" target="_blank">集成LBS查询、音乐、阅读的微信公众账号</a></li>
	 						<li><a href = "https://github.com/Lemonjing/hadoop-dedup" target="_blank">基于hadoop和hbase的大规模海量数据去重</a></li>
	 						<li><a href = "https://github.com/Lemonjing/TinyMooc" target="_blank">轻量级Java平台在线幕课学习网站</a></li>
		 					<li><a href = "https://github.com/Lemonjing/Keccak" target="_blank">SHA-3 algorithm Keccak Implementation</a></li>
		 					<li><a href = "https://github.com/Lemonjing/your-offer" target="_blank">剑指offer的Java实现</a></li>
	 					</ul>
	 			</div>
	 			
	 			<div class="recentuse">
	 					<p>经常出没</p>
	 					<hr>
	 					<ul>
	 						<li><a href = "http://music.163.com/#/user/home?id=63589002" target="_blank">网易云音乐</a></li>
	 						<li><a href = "https://github.com/Lemonjing" target="_blank">GitHub</a></li>
	 						<li><a href = "http://weibo.com/u/1662536394" target="_blank">微博</a></li>
	 						<li><a href = "http://pianke.me/profile/1924980/" target="_blank">片刻</a></li>
		 					<li><a href = "https://www.zhihu.com/people/xmusaber" target="_blank">知乎</a></li>
		 					<li><a href = "http://www.nowcoder.com/profile/213475" target="_blank">牛客</a></li>
	 					</ul>
	 			</div>
				
				<div class="friendlink">
	 					<p>友情链接</p>
	 					<hr>					
		 				<a href = "https://imjad.cn/" target="_blank">AD's Blog</a></br>
						<a href = "http://zyl.me" target="_blank">ZYL的博客</a></br>
						<a href = "http://mxwu.cn" target="_blank">梦忻屋</a></br>
						<a href = "http://www.weiyanweiyu.cn" target="_blank">微言微语</a></br>
						<a href = "http://jloong.com" target="_blank">楚书业</a></br>
						<a href = "https://emiria.io/" target="_blank">蔓舞寻樱</a></br>
						<a href = "http://www.xiaokang.info" target="_blank">小康博客</a><br>
						<a href = "http://blog.iov.me" target="_blank">随心说</a></br>
						<a href = "http://czduban.com" target="_blank">以歌。先生</a><br>
						<a href = "http://5mx.net/" target="_blank">冷夜博客</a><br>
						<a href = "http://www.8hao.com.cn/" target="_blank">艳莜日记</a><br>
						<a href = "http://blog.sunxyz.cn/" target="_blank">诸葛扬阳</a><br>
						<a href = "https://lostyou.love/" target="_blank">邻居</a><br>
						<a href = "http://www.kurodown.com/" target="_blank">酷绒站</a>
	 			</div>
				
			</div>
			
			<div class="col-xs-12 col-sm-12 col-md-9 col-lg-9 box-shadow fadein-right aside2">					 		
					<div class="page-content" id="pjax"><div class="post">
  <header class="post-header">
    <h1 class="post-title">精-Spring事务管理（详解+实例)</h1>
    <div class="info">
	    <p class="post-meta"><i class="fa fa-calendar"></i>&nbsp;2016-06-26</p>
	    
		<i class="fa fa-tags"></i>
		<span class="index-post-tag">
		
			<a class="pjaxlink" href="/pages/tags.html#Java">Java</a>
		
			<a class="pjaxlink" href="/pages/tags.html#Spring">Spring</a>
		
		</span>
	    		
    </div>
  </header>

  <article class="post-content">
    <h3 id="1初步理解">1、初步理解</h3>

<p>理解事务之前，先讲一个你日常生活中最常干的事：取钱。</p>

<p>比如你去ATM机取1000块钱，大体有两个步骤：首先输入密码金额，银行卡扣掉1000元钱；然后ATM出1000元钱。这两个步骤必须是要么都执行要么都不执行。如果银行卡扣除了1000块但是ATM出钱失败的话，你将会损失1000元；如果银行卡扣钱失败但是ATM却出了1000块，那么银行将损失1000元。所以，如果一个步骤成功另一个步骤失败对双方都不是好事，如果不管哪一个步骤失败了以后，整个取钱过程都能回滚，也就是完全取消所有操作的话，这对双方都是极好的。</p>

<p>事务就是用来解决类似问题的。事务是一系列的动作，它们综合在一起才是一个完整的工作单元，这些动作必须全部完成，如果有一个失败的话，那么事务就会回滚到最开始的状态，仿佛什么都没发生过一样。</p>

<p>在企业级应用程序开发中，事务管理必不可少的技术，用来确保数据的完整性和一致性。</p>

<p>事务有四个特性：ACID</p>

<ul>
  <li>
    <p>原子性（Atomicity）：事务是一个原子操作，由一系列动作组成。事务的原子性确保动作要么全部完成，要么完全不起作用。</p>
  </li>
  <li>
    <p>一致性（Consistency）：一旦事务完成（不管成功还是失败），系统必须确保它所建模的业务处于一致的状态，而不会是部分完成部分失败。在现实中的数据不应该被破坏。</p>
  </li>
  <li>
    <p>隔离性（Isolation）：可能有许多事务会同时处理相同的数据，因此每个事务都应该与其他事务隔离开来，防止数据损坏。</p>
  </li>
  <li>
    <p>持久性（Durability）：一旦事务完成，无论发生什么系统错误，它的结果都不应该受到影响，这样就能从任何系统崩溃中恢复过来。通常情况下，事务的结果被写到持久化存储器中。</p>
  </li>
</ul>

<p><strong>Spring中的事务管理</strong></p>

<p>作为企业级应用程序框架，Spring在不同的事务管理API之上定义了一个抽象层。而应用程序开发人员不必了解底层的事务管理API，就可以使用Spring的事务管理机制。</p>

<p>Spring既支持编程式事务管理，也支持声明式的事务管理</p>

<p><strong>编程式事务管理</strong>: 将事务管理代码嵌入到业务方法中来控制事务的提交和回滚，在编程式事务中，必须在每个业务操作中包含额外的事务管理代码</p>

<p><strong>声明式事务管理</strong>: 大多数情况下比编程式事务管理更好用。它将事务管理代码从业务方法中分离出来，以声明的方式来实现事务管理。事务管理作为一种横切关注点，可以通过AOP方法模块化。Spring通过Spring AOP框架支持声明式事务管理。</p>

<h3 id="2核心接口">2、核心接口</h3>

<p>Spring事务管理的实现有许多细节，如果对整个接口框架有个大体了解会非常有利于我们理解事务，下面通过讲解Spring的事务接口来了解Spring实现事务的具体策略。</p>

<p>Spring事务管理涉及的接口的联系如下：</p>

<p><img src="http://img.blog.csdn.net/20160324011156424" alt="" /></p>

<p><strong>2.1 事务管理器</strong></p>

<p>Spring并不直接管理事务，而是提供了多种事务管理器，他们将事务管理的职责委托给Hibernate或者JTA等持久化机制所提供的相关平台框架的事务来实现。</p>

<p>Spring事务管理器的接口是org.springframework.transaction.PlatformTransactionManager，通过这个接口，Spring为各个平台如JDBC、Hibernate等都提供了对应的事务管理器，但是具体的实现就是各个平台自己负责。此接口的内容如下：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">PlatformTransactionManager</span> <span class="o">{</span>  
    <span class="c1">// 由TransactionDefinition得到TransactionStatus对象</span>
    <span class="n">TransactionStatus</span> <span class="nf">getTransaction</span><span class="o">(</span><span class="n">TransactionDefinition</span> <span class="n">definition</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">TransactionException</span><span class="o">;</span> 
    <span class="c1">// 提交</span>
    <span class="n">Void</span> <span class="nf">commit</span><span class="o">(</span><span class="n">TransactionStatus</span> <span class="n">status</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">TransactionException</span><span class="o">;</span>  
    <span class="c1">// 回滚</span>
    <span class="n">Void</span> <span class="nf">rollback</span><span class="o">(</span><span class="n">TransactionStatus</span> <span class="n">status</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">TransactionException</span><span class="o">;</span>  
<span class="o">}</span> 
</code></pre></div></div>

<p>从这里可知具体的具体的事务管理机制对Spring来说是透明的，它并不关心那些，那些是对应各个平台需要关心的，所以Spring事务管理的一个优点就是为不同的事务API提供一致的编程模型，如JTA、JDBC、Hibernate、JPA。下面分别介绍各个平台框架实现事务管理的机制。</p>

<p><strong>2.1.1 JDBC事务</strong></p>

<p>如果应用程序中直接使用JDBC来进行持久化，DataSourceTransactionManager会为你处理事务边界。为了使用DataSourceTransactionManager，你需要使用如下的XML将其装配到应用程序的上下文定义中：</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"transactionManager"</span> <span class="na">class=</span><span class="s">"org.springframework.jdbc.datasource.DataSourceTransactionManager"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"dataSource"</span> <span class="na">ref=</span><span class="s">"dataSource"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>
</code></pre></div></div>

<p>实际上，DataSourceTransactionManager是通过调用java.sql.Connection来管理事务，而后者是通过DataSource获取到的。通过调用连接的commit()方法来提交事务，同样，事务失败则通过调用rollback()方法进行回滚。</p>

<p>2.1.2 Hibernate事务</p>

<p>如果应用程序的持久化是通过Hibernate实习的，那么你需要使用HibernateTransactionManager。对于Hibernate3，需要在Spring上下文定义中添加如下的<bean>声明：</bean></p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"transactionManager"</span> <span class="na">class=</span><span class="s">"org.springframework.orm.hibernate3.HibernateTransactionManager"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"sessionFactory"</span> <span class="na">ref=</span><span class="s">"sessionFactory"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>
</code></pre></div></div>

<p>sessionFactory属性需要装配一个Hibernate的session工厂，HibernateTransactionManager的实现细节是它将事务管理的职责委托给org.hibernate.Transaction对象，而后者是从Hibernate Session中获取到的。当事务成功完成时，HibernateTransactionManager将会调用Transaction对象的commit()方法，反之，将会调用rollback()方法。</p>

<p>2.1.3 Java持久化API事务（JPA）</p>

<p>Hibernate多年来一直是事实上的Java持久化标准，但是现在Java持久化API作为真正的Java持久化标准进入大家的视野。如果你计划使用JPA的话，那你需要使用Spring的JpaTransactionManager来处理事务。你需要在Spring中这样配置JpaTransactionManager：</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"transactionManager"</span> <span class="na">class=</span><span class="s">"org.springframework.orm.jpa.JpaTransactionManager"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"sessionFactory"</span> <span class="na">ref=</span><span class="s">"sessionFactory"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>
</code></pre></div></div>

<p>JpaTransactionManager只需要装配一个JPA实体管理工厂（javax.persistence.EntityManagerFactory接口的任意实现）。JpaTransactionManager将与由工厂所产生的JPA EntityManager合作来构建事务。</p>

<p>2.1.4 Java原生API事务</p>

<p>如果你没有使用以上所述的事务管理，或者是跨越了多个事务管理源（比如两个或者是多个不同的数据源），你就需要使用JtaTransactionManager：</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"transactionManager"</span> <span class="na">class=</span><span class="s">"org.springframework.transaction.jta.JtaTransactionManager"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"transactionManagerName"</span> <span class="na">value=</span><span class="s">"java:/TransactionManager"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>
</code></pre></div></div>

<p>JtaTransactionManager将事务管理的责任委托给javax.transaction.UserTransaction和javax.transaction.TransactionManager对象，其中事务成功完成通过UserTransaction.commit()方法提交，事务失败通过UserTransaction.rollback()方法回滚。</p>

<p><strong>2.2 基本事务属性的定义</strong></p>

<p>上面讲到的事务管理器接口PlatformTransactionManager通过getTransaction(TransactionDefinition definition)方法来得到事务，这个方法里面的参数是TransactionDefinition类，这个类就定义了一些基本的事务属性。 
那么什么是事务属性呢？事务属性可以理解成事务的一些基本配置，描述了事务策略如何应用到方法上。事务属性包含了5个方面，如图所示：</p>

<p><img src="http://img.blog.csdn.net/20160325003448793" alt="" /></p>

<p>而TransactionDefinition接口内容如下：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">TransactionDefinition</span> <span class="o">{</span>
	<span class="c1">//返回事务的传播行为</span>
    <span class="kt">int</span> <span class="nf">getPropagationBehavior</span><span class="o">();</span> 
    <span class="c1">//返回事务的隔离级别，事务管理器根据它来控制另外一个事务可以看到本事务内的哪些数据</span>
    <span class="kt">int</span> <span class="nf">getIsolationLevel</span><span class="o">();</span> 
    <span class="c1">// 返回事务必须在多少秒内完成</span>
    <span class="kt">int</span> <span class="nf">getTimeout</span><span class="o">();</span>
    <span class="c1">//事务是否只读，事务管理器能够根据这个返回值进行优化，确保事务是只读的  </span>
    <span class="kt">boolean</span> <span class="nf">isReadOnly</span><span class="o">();</span> 
<span class="o">}</span> 
</code></pre></div></div>

<p>我们可以发现TransactionDefinition正好用来定义事务属性，下面详细介绍一下各个事务属性。</p>

<p>2.2.1 传播行为</p>

<p>事务的第一个方面是传播行为（propagation behavior）。当事务方法被另一个事务方法调用时，必须指定事务应该如何传播。例如：方法可能继续在现有事务中运行，也可能开启一个新事务，并在自己的事务中运行。Spring定义了七种传播行为：</p>

<p><img src="http://7xlkoc.com1.z0.glb.clouddn.com/propagation.png" alt="" /></p>

<p>其中PROPAGATION_REQUIRED为默认的传播属性</p>

<p>注：以下具体讲解传播行为的内容参考自<a href="http://www.open-open.com/lib/view/open1350865116821.html">Spring事务机制详解</a></p>

<p>（1）PROPAGATION_REQUIRED 如果存在一个事务，则支持当前事务。如果没有事务则开启一个新的事务。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//事务属性 PROPAGATION_REQUIRED
methodA<span class="o">{</span>
    ……
    methodB<span class="o">()</span><span class="p">;</span>
    ……
<span class="o">}</span>
//事务属性 PROPAGATION_REQUIRED
methodB<span class="o">{</span>
   ……
<span class="o">}</span>
</code></pre></div></div>

<p>使用spring声明式事务，spring使用AOP来支持声明式事务，会根据事务属性，自动在方法调用之前决定是否开启一个事务，并在方法执行之后决定事务提交或回滚事务。</p>

<p>单独调用methodB方法：</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>main<span class="o">{</span> 
    metodB<span class="o">()</span><span class="p">;</span> 
<span class="o">}</span>  
相当于

Main<span class="o">{</span> 
    Connection <span class="nv">con</span><span class="o">=</span>null<span class="p">;</span> 
    try<span class="o">{</span> 
        con <span class="o">=</span> getConnection<span class="o">()</span><span class="p">;</span> 
        con.setAutoCommit<span class="o">(</span><span class="nb">false</span><span class="o">)</span><span class="p">;</span> 

        //方法调用
        methodB<span class="o">()</span><span class="p">;</span> 

        //提交事务
        con.commit<span class="o">()</span><span class="p">;</span> 
    <span class="o">}</span> Catch<span class="o">(</span>RuntimeException ex<span class="o">)</span> <span class="o">{</span> 
        //回滚事务
        con.rollback<span class="o">()</span><span class="p">;</span>   
    <span class="o">}</span> finally <span class="o">{</span> 
        //释放资源
        closeCon<span class="o">()</span><span class="p">;</span> 
    <span class="o">}</span> 
<span class="o">}</span> 
</code></pre></div></div>

<p>Spring保证在methodB方法中所有的调用都获得到一个相同的连接。在调用methodB时，没有一个存在的事务，所以获得一个新的连接，开启了一个新的事务。 
单独调用MethodA时，在MethodA内又会调用MethodB.</p>

<p>执行效果相当于：</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>main<span class="o">{</span> 
    Connection con <span class="o">=</span> null<span class="p">;</span> 
    try<span class="o">{</span> 
        con <span class="o">=</span> getConnection<span class="o">()</span><span class="p">;</span> 
        methodA<span class="o">()</span><span class="p">;</span> 
        con.commit<span class="o">()</span><span class="p">;</span> 
    <span class="o">}</span> catch<span class="o">(</span>RuntimeException ex<span class="o">)</span> <span class="o">{</span> 
        con.rollback<span class="o">()</span><span class="p">;</span> 
    <span class="o">}</span> finally <span class="o">{</span>    
        closeCon<span class="o">()</span><span class="p">;</span> 
    <span class="o">}</span>  
<span class="o">}</span> 
</code></pre></div></div>

<p>调用MethodA时，环境中没有事务，所以开启一个新的事务.当在MethodA中调用MethodB时，环境中已经有了一个事务，所以methodB就加入当前事务。</p>

<p>（2）PROPAGATION_SUPPORTS 如果存在一个事务，支持当前事务。如果没有事务，则非事务的执行。但是对于事务同步的事务管理器，PROPAGATION_SUPPORTS与不使用事务有少许不同。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//事务属性 PROPAGATION_REQUIRED
methodA<span class="o">(){</span>
  methodB<span class="o">()</span><span class="p">;</span>
<span class="o">}</span>

//事务属性 PROPAGATION_SUPPORTS
methodB<span class="o">(){</span>
  ……
<span class="o">}</span>
</code></pre></div></div>

<p>单纯的调用methodB时，methodB方法是非事务的执行的。当调用methdA时,methodB则加入了methodA的事务中,事务地执行。</p>

<p>（3）PROPAGATION_MANDATORY 如果已经存在一个事务，支持当前事务。如果没有一个活动的事务，则抛出异常。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//事务属性 PROPAGATION_REQUIRED
methodA<span class="o">(){</span>
    methodB<span class="o">()</span><span class="p">;</span>
<span class="o">}</span>

//事务属性 PROPAGATION_MANDATORY
    methodB<span class="o">(){</span>
    ……
<span class="o">}</span>
</code></pre></div></div>

<p>当单独调用methodB时，因为当前没有一个活动的事务，则会抛出异常throw new IllegalTransactionStateException(“Transaction propagation ‘mandatory’ but no existing transaction found”);当调用methodA时，methodB则加入到methodA的事务中，事务地执行。</p>

<p>（4）PROPAGATION_REQUIRES_NEW 总是开启一个新的事务。如果一个事务已经存在，则将这个存在的事务挂起。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//事务属性 PROPAGATION_REQUIRED
methodA<span class="o">(){</span>
    doSomeThingA<span class="o">()</span><span class="p">;</span>
    methodB<span class="o">()</span><span class="p">;</span>
    doSomeThingB<span class="o">()</span><span class="p">;</span>
<span class="o">}</span>

//事务属性 PROPAGATION_REQUIRES_NEW
methodB<span class="o">(){</span>
    ……
<span class="o">}</span>

调用A方法：

main<span class="o">(){</span>
    methodA<span class="o">()</span><span class="p">;</span>
<span class="o">}</span>
相当于

main<span class="o">(){</span>
    TransactionManager tm <span class="o">=</span> null<span class="p">;</span>
    try<span class="o">{</span>
        //获得一个JTA事务管理器
        tm <span class="o">=</span> getTransactionManager<span class="o">()</span><span class="p">;</span>
        tm.begin<span class="o">()</span><span class="p">;</span>//开启一个新的事务
        Transaction ts1 <span class="o">=</span> tm.getTransaction<span class="o">()</span><span class="p">;</span>
        doSomeThing<span class="o">()</span><span class="p">;</span>
        tm.suspend<span class="o">()</span><span class="p">;</span>//挂起当前事务
        try<span class="o">{</span>
            tm.begin<span class="o">()</span><span class="p">;</span>//重新开启第二个事务
            Transaction ts2 <span class="o">=</span> tm.getTransaction<span class="o">()</span><span class="p">;</span>
            methodB<span class="o">()</span><span class="p">;</span>
            ts2.commit<span class="o">()</span><span class="p">;</span>//提交第二个事务
        <span class="o">}</span> Catch<span class="o">(</span>RunTimeException ex<span class="o">)</span> <span class="o">{</span>
            ts2.rollback<span class="o">()</span><span class="p">;</span>//回滚第二个事务
        <span class="o">}</span> finally <span class="o">{</span>
            //释放资源
        <span class="o">}</span>
        //methodB执行完后，恢复第一个事务
        tm.resume<span class="o">(</span>ts1<span class="o">)</span><span class="p">;</span>
        doSomeThingB<span class="o">()</span><span class="p">;</span>
        ts1.commit<span class="o">()</span><span class="p">;</span>//提交第一个事务
    <span class="o">}</span> catch<span class="o">(</span>RunTimeException ex<span class="o">)</span> <span class="o">{</span>
        ts1.rollback<span class="o">()</span><span class="p">;</span>//回滚第一个事务
    <span class="o">}</span> finally <span class="o">{</span>
        //释放资源
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>在这里，我把ts1称为外层事务，ts2称为内层事务。从上面的代码可以看出，ts2与ts1是两个独立的事务，互不相干。Ts2是否成功并不依赖于 ts1。如果methodA方法在调用methodB方法后的doSomeThingB方法失败了，而methodB方法所做的结果依然被提交。而除了 methodB之外的其它代码导致的结果却被回滚了。使用PROPAGATION_REQUIRES_NEW,需要使用 JtaTransactionManager作为事务管理器。</p>

<p>（5）PROPAGATION_NOT_SUPPORTED 总是非事务地执行，并挂起任何存在的事务。使用PROPAGATION_NOT_SUPPORTED,也需要使用JtaTransactionManager作为事务管理器。（代码示例同上，可同理推出）</p>

<p>（6）PROPAGATION_NEVER 总是非事务地执行，如果存在一个活动事务，则抛出异常。</p>

<p>（7）PROPAGATION_NESTED如果一个活动的事务存在，则运行在一个嵌套的事务中. 如果没有活动事务, 则按TransactionDefinition.PROPAGATION_REQUIRED 属性执行。这是一个嵌套事务,使用JDBC 3.0驱动时,仅仅支持DataSourceTransactionManager作为事务管理器。需要JDBC 驱动的java.sql.Savepoint类。有一些JTA的事务管理器实现可能也提供了同样的功能。使用PROPAGATION_NESTED，还需要把PlatformTransactionManager的nestedTransactionAllowed属性设为true;而 nestedTransactionAllowed属性值默认为false。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>//事务属性 PROPAGATION_REQUIRED
methodA<span class="o">(){</span>
    doSomeThingA<span class="o">()</span><span class="p">;</span>
    methodB<span class="o">()</span><span class="p">;</span>
    doSomeThingB<span class="o">()</span><span class="p">;</span>
<span class="o">}</span>

//事务属性 PROPAGATION_NESTED
methodB<span class="o">(){</span>
    ……
<span class="o">}</span>
</code></pre></div></div>

<p>如果单独调用methodB方法，则按REQUIRED属性执行。如果调用methodA方法，相当于下面的效果：</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>main<span class="o">(){</span>
    Connection con <span class="o">=</span> null<span class="p">;</span>
    Savepoint savepoint <span class="o">=</span> null<span class="p">;</span>
    try<span class="o">{</span>
        con <span class="o">=</span> getConnection<span class="o">()</span><span class="p">;</span>
        con.setAutoCommit<span class="o">(</span><span class="nb">false</span><span class="o">)</span><span class="p">;</span>
        doSomeThingA<span class="o">()</span><span class="p">;</span>
        savepoint <span class="o">=</span> con2.setSavepoint<span class="o">()</span><span class="p">;</span>
        try<span class="o">{</span>
            methodB<span class="o">()</span><span class="p">;</span>
        <span class="o">}</span> catch<span class="o">(</span>RuntimeException ex<span class="o">)</span> <span class="o">{</span>
            con.rollback<span class="o">(</span>savepoint<span class="o">)</span><span class="p">;</span>
        <span class="o">}</span> finally <span class="o">{</span>
            //释放资源
        <span class="o">}</span>
        doSomeThingB<span class="o">()</span><span class="p">;</span>
        con.commit<span class="o">()</span><span class="p">;</span>
    <span class="o">}</span> catch<span class="o">(</span>RuntimeException ex<span class="o">)</span> <span class="o">{</span>
        con.rollback<span class="o">()</span><span class="p">;</span>
    <span class="o">}</span> finally <span class="o">{</span>
        //释放资源
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>当methodB方法调用之前，调用setSavepoint方法，保存当前的状态到savepoint。如果methodB方法调用失败，则恢复到之前保存的状态。但是需要注意的是，这时的事务并没有进行提交，如果后续的代码(doSomeThingB()方法)调用失败，则回滚包括methodB方法的所有操作。</p>

<p>嵌套事务一个非常重要的概念就是内层事务依赖于外层事务。外层事务失败时，会回滚内层事务所做的动作。而内层事务操作失败并不会引起外层事务的回滚。</p>

<p><strong>PROPAGATION_NESTED 与PROPAGATION_REQUIRES_NEW的区别:</strong></p>

<p>它们非常类似,都像一个嵌套事务，如果不存在一个活动的事务，都会开启一个新的事务。使用 PROPAGATION_REQUIRES_NEW时，内层事务与外层事务就像两个独立的事务一样，一旦内层事务进行了提交后，外层事务不能对其进行回滚。两个事务互不影响。两个事务不是一个真正的嵌套事务。同时它需要JTA事务管理器的支持。</p>

<p>使用PROPAGATION_NESTED时，外层事务的回滚可以引起内层事务的回滚。而内层事务的异常并不会导致外层事务的回滚，它是一个真正的嵌套事务。DataSourceTransactionManager使用savepoint支持PROPAGATION_NESTED时，需要JDBC 3.0以上驱动及1.4以上的JDK版本支持。其它的JTA TrasactionManager实现可能有不同的支持方式。</p>

<p>PROPAGATION_REQUIRES_NEW 启动一个新的, 不依赖于环境的 “内部” 事务. 这个事务将被完全 commited 或 rolled back 而不依赖于外部事务, 它拥有自己的隔离范围, 自己的锁, 等等. 当内部事务开始执行时, 外部事务将被挂起, 内务事务结束时, 外部事务将继续执行。</p>

<p>另一方面, PROPAGATION_NESTED 开始一个 “嵌套的” 事务, 它是已经存在事务的一个真正的子事务. 嵌套事务开始执行时, 它将取得一个 savepoint. 如果这个嵌套事务失败, 我们将回滚到此 savepoint. 潜套事务是外部事务的一部分, 只有外部事务结束后它才会被提交。</p>

<p>由此可见, PROPAGATION_REQUIRES_NEW 和 PROPAGATION_NESTED 的最大区别在于, PROPAGATION_REQUIRES_NEW 完全是一个新的事务, 而 PROPAGATION_NESTED 则是外部事务的子事务, 如果外部事务 commit, 嵌套事务也会被 commit, 这个规则同样适用于 roll back。**</p>

<p>PROPAGATION_REQUIRED应该是我们首先的事务传播行为。它能够满足我们大多数的事务需求。</p>

<p>2.2.2 隔离级别</p>

<p>事务的第二个维度就是隔离级别（isolation level）。隔离级别定义了一个事务可能受其他并发事务影响的程度。</p>

<p>（1）并发事务引起的问题</p>

<p>在典型的应用程序中，多个事务并发运行，经常会操作相同的数据来完成各自的任务。并发虽然是必须的，但可能会导致一下的问题。</p>

<p><strong>脏读（Dirty reads）</strong>——脏读发生在一个事务读取了另一个事务修改但尚未提交的数据时。如果改写在稍后被回滚了，那么第一个事务获取的数据就是无效的。</p>

<p><strong>不可重复读（Nonrepeatable read）</strong>——不可重复读发生在一个事务执行相同的查询两次或两次以上，但是每次都得到不同的数据时。这通常是因为另一个并发事务在两次查询期间进行了更新。</p>

<p><strong>幻读（Phantom read）</strong>——幻读与不可重复读类似。它发生在一个事务（T1）读取了几行数据，接着另一个并发事务（T2）插入了一些数据时。在随后的查询中，第一个事务（T1）就会发现多了一些原本不存在的记录。</p>

<p><strong>不可重复读与幻读的区别</strong></p>

<p>不可重复读的重点是修改:</p>

<p>同样的条件, 你读取过的数据, 再次读取出来发现值不一样了 
例如：在事务1中，Mary 读取了自己的工资为1000,操作并没有完成</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    con1 <span class="o">=</span> getConnection<span class="o">()</span><span class="p">;</span>  
    <span class="k">select </span>salary from employee empId <span class="o">=</span><span class="s2">"Mary"</span><span class="p">;</span>  
</code></pre></div></div>

<p>在事务2中，这时财务人员修改了Mary的工资为2000,并提交了事务.</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    con2 <span class="o">=</span> getConnection<span class="o">()</span><span class="p">;</span>  
    update employee <span class="nb">set </span>salary <span class="o">=</span> 2000<span class="p">;</span>  
    con2.commit<span class="o">()</span><span class="p">;</span>
</code></pre></div></div>

<p>在事务1中，Mary 再次读取自己的工资时，工资变为了2000</p>

<div class="highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    //con1  
    select salary from employee empId ="Mary"; 
</code></pre></div></div>

<p>在一个事务中前后两次读取的结果并不一致，导致了不可重复读。</p>

<p>幻读的重点在于新增或者删除：</p>

<p>同样的条件, 第1次和第2次读出来的记录数不一样 
例如：目前工资为1000的员工有10人。事务1,读取所有工资为1000的员工。</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    con1 <span class="o">=</span> getConnection<span class="o">()</span><span class="p">;</span>  
    Select <span class="k">*</span> from employee where salary <span class="o">=</span>1000<span class="p">;</span> 
</code></pre></div></div>

<p>共读取10条记录</p>

<p>这时另一个事务向employee表插入了一条员工记录，工资也为1000</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    con2 <span class="o">=</span> getConnection<span class="o">()</span><span class="p">;</span>  
    Insert into employee<span class="o">(</span>empId,salary<span class="o">)</span> values<span class="o">(</span><span class="s2">"Lili"</span>,1000<span class="o">)</span><span class="p">;</span>  
    con2.commit<span class="o">()</span><span class="p">;</span>  
</code></pre></div></div>

<p>事务1再次读取所有工资为1000的员工</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    //con1  
    <span class="k">select</span> <span class="k">*</span> from employee where salary <span class="o">=</span>1000<span class="p">;</span>
</code></pre></div></div>

<p>共读取到了11条记录，这就产生了幻像读。</p>

<p>从总的结果来看, 似乎不可重复读和幻读都表现为两次读取的结果不一致。但如果你从控制的角度来看, 两者的区别就比较大。 
对于前者, 只需要锁住满足条件的记录。 对于后者, 要锁住满足条件及其相近的记录。</p>

<p>（2）隔离级别</p>

<p><img src="http://7xlkoc.com1.z0.glb.clouddn.com/isolation.png" alt="" /></p>

<p>2.2.3 只读</p>

<p>事务的第三个特性是它是否为只读事务。如果事务只对后端的数据库进行该操作，数据库可以利用事务的只读特性来进行一些特定的优化。通过将事务设置为只读，你就可以给数据库一个机会，让它应用它认为合适的优化措施。</p>

<p>2.2.4 事务超时</p>

<p>为了使应用程序很好地运行，事务不能运行太长的时间。因为事务可能涉及对后端数据库的锁定，所以长时间的事务会不必要的占用数据库资源。事务超时就是事务的一个定时器，在特定时间内事务如果没有执行完毕，那么就会自动回滚，而不是一直等待其结束。</p>

<p>2.2.5 回滚规则</p>

<p>事务五边形的最后一个方面是一组规则，这些规则定义了哪些异常会导致事务回滚而哪些不会。默认情况下，事务只有遇到运行期异常时才会回滚，而在遇到检查型异常时不会回滚（这一行为与EJB的回滚行为是一致的） 
但是你可以声明事务在遇到特定的检查型异常时像遇到运行期异常那样回滚。同样，你还可以声明事务遇到特定的异常不回滚，即使这些异常是运行期异常。</p>

<p><strong>2.3 事务状态</strong></p>

<p>上面讲到的调用PlatformTransactionManager接口的getTransaction()的方法得到的是TransactionStatus接口的一个实现，这个接口的内容如下：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kd">public</span> <span class="kd">interface</span> <span class="nc">TransactionStatus</span><span class="o">{</span>
    <span class="kt">boolean</span> <span class="nf">isNewTransaction</span><span class="o">();</span> <span class="c1">// 是否是新的事物</span>
    <span class="kt">boolean</span> <span class="nf">hasSavepoint</span><span class="o">();</span> <span class="c1">// 是否有恢复点</span>
    <span class="kt">void</span> <span class="nf">setRollbackOnly</span><span class="o">();</span>  <span class="c1">// 设置为只回滚</span>
    <span class="kt">boolean</span> <span class="nf">isRollbackOnly</span><span class="o">();</span> <span class="c1">// 是否为只回滚</span>
    <span class="kt">boolean</span> <span class="n">isCompleted</span><span class="o">;</span> <span class="c1">// 是否已完成</span>
<span class="o">}</span>
</code></pre></div></div>

<p>可以发现这个接口描述的是一些处理事务提供简单的控制事务执行和查询事务状态的方法，在回滚或提交的时候需要应用对应的事务状态。</p>

<h3 id="3编程式事务">3、编程式事务</h3>

<p><strong>3.1 编程式和声明式事务的区别</strong></p>

<p>Spring提供了对编程式事务和声明式事务的支持，编程式事务允许用户在代码中精确定义事务的边界，而声明式事务（基于AOP）有助于用户将操作与事务规则进行解耦。 
简单地说，编程式事务侵入到了业务代码里面，但是提供了更加详细的事务管理；而声明式事务由于基于AOP，所以既能起到事务管理的作用，又可以不影响业务代码的具体实现。</p>

<p><strong>3.2 如何实现编程式事务？</strong></p>

<p>Spring提供两种方式的编程式事务管理，分别是：使用TransactionTemplate和直接使用PlatformTransactionManager。</p>

<p>3.2.1 使用TransactionTemplate</p>

<p>采用TransactionTemplate和采用其他Spring模板，如JdbcTempalte和HibernateTemplate是一样的方法。它使用回调方法，把应用程序从处理取得和释放资源中解脱出来。如同其他模板，TransactionTemplate是线程安全的。代码片段：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">TransactionTemplate</span> <span class="n">tt</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TransactionTemplate</span><span class="o">();</span> <span class="c1">// 新建一个TransactionTemplate</span>
    <span class="n">Object</span> <span class="n">result</span> <span class="o">=</span> <span class="n">tt</span><span class="o">.</span><span class="na">execute</span><span class="o">(</span>
        <span class="k">new</span> <span class="nf">TransactionCallback</span><span class="o">(){</span>  
            <span class="kd">public</span> <span class="n">Object</span> <span class="nf">doTransaction</span><span class="o">(</span><span class="n">TransactionStatus</span> <span class="n">status</span><span class="o">){</span>  
                <span class="n">updateOperation</span><span class="o">();</span>  
                <span class="k">return</span> <span class="nf">resultOfUpdateOperation</span><span class="o">();</span>  
            <span class="o">}</span>  
    <span class="o">});</span> <span class="c1">// 执行execute方法进行事务管理</span>
</code></pre></div></div>

<p>使用TransactionCallback()可以返回一个值。如果使用TransactionCallbackWithoutResult则没有返回值。</p>

<p>3.2.2 使用PlatformTransactionManager</p>

<p>示例代码如下：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code>    <span class="n">DataSourceTransactionManager</span> <span class="n">dataSourceTransactionManager</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DataSourceTransactionManager</span><span class="o">();</span> <span class="c1">//定义一个某个框架平台的TransactionManager，如JDBC、Hibernate</span>
    <span class="n">dataSourceTransactionManager</span><span class="o">.</span><span class="na">setDataSource</span><span class="o">(</span><span class="k">this</span><span class="o">.</span><span class="na">getJdbcTemplate</span><span class="o">().</span><span class="na">getDataSource</span><span class="o">());</span> <span class="c1">// 设置数据源</span>
    <span class="n">DefaultTransactionDefinition</span> <span class="n">transDef</span> <span class="o">=</span> <span class="k">new</span> <span class="n">DefaultTransactionDefinition</span><span class="o">();</span> <span class="c1">// 定义事务属性</span>
    <span class="n">transDef</span><span class="o">.</span><span class="na">setPropagationBehavior</span><span class="o">(</span><span class="n">DefaultTransactionDefinition</span><span class="o">.</span><span class="na">PROPAGATION_REQUIRED</span><span class="o">);</span> <span class="c1">// 设置传播行为属性</span>
    <span class="n">TransactionStatus</span> <span class="n">status</span> <span class="o">=</span> <span class="n">dataSourceTransactionManager</span><span class="o">.</span><span class="na">getTransaction</span><span class="o">(</span><span class="n">transDef</span><span class="o">);</span> <span class="c1">// 获得事务状态</span>
    <span class="k">try</span> <span class="o">{</span>
        <span class="c1">// 数据库操作</span>
        <span class="n">dataSourceTransactionManager</span><span class="o">.</span><span class="na">commit</span><span class="o">(</span><span class="n">status</span><span class="o">);</span><span class="c1">// 提交</span>
    <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">dataSourceTransactionManager</span><span class="o">.</span><span class="na">rollback</span><span class="o">(</span><span class="n">status</span><span class="o">);</span><span class="c1">// 回滚</span>
    <span class="o">}</span>
</code></pre></div></div>

<h3 id="4声明式事务">4、声明式事务</h3>

<p><strong>4.1 配置方式</strong></p>

<p>注：以下配置代码参考自Spring事务配置的五种方式</p>

<p>根据代理机制的不同，总结了五种Spring事务的配置方式，配置文件如下：</p>

<p>（1）每个Bean都有一个代理</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">"http://www.springframework.org/schema/beans"</span>
    <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="na">xmlns:context=</span><span class="s">"http://www.springframework.org/schema/context"</span>
    <span class="na">xmlns:aop=</span><span class="s">"http://www.springframework.org/schema/aop"</span>
    <span class="na">xsi:schemaLocation=</span><span class="s">"http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans-2.5.xsd
           http://www.springframework.org/schema/context
           http://www.springframework.org/schema/context/spring-context-2.5.xsd
           http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-2.5.xsd"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"sessionFactory"</span> 
            <span class="na">class=</span><span class="s">"org.springframework.orm.hibernate3.LocalSessionFactoryBean"</span><span class="nt">&gt;</span> 
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"configLocation"</span> <span class="na">value=</span><span class="s">"classpath:hibernate.cfg.xml"</span> <span class="nt">/&gt;</span> 
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"configurationClass"</span> <span class="na">value=</span><span class="s">"org.hibernate.cfg.AnnotationConfiguration"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span> 

    <span class="c">&lt;!-- 定义事务管理器（声明式的事务） --&gt;</span> 
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"transactionManager"</span>
        <span class="na">class=</span><span class="s">"org.springframework.orm.hibernate3.HibernateTransactionManager"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"sessionFactory"</span> <span class="na">ref=</span><span class="s">"sessionFactory"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

    <span class="c">&lt;!-- 配置DAO --&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"userDaoTarget"</span> <span class="na">class=</span><span class="s">"com.bluesky.spring.dao.UserDaoImpl"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"sessionFactory"</span> <span class="na">ref=</span><span class="s">"sessionFactory"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"userDao"</span> 
        <span class="na">class=</span><span class="s">"org.springframework.transaction.interceptor.TransactionProxyFactoryBean"</span><span class="nt">&gt;</span> 
           <span class="c">&lt;!-- 配置事务管理器 --&gt;</span> 
           <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"transactionManager"</span> <span class="na">ref=</span><span class="s">"transactionManager"</span> <span class="nt">/&gt;</span>    
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"target"</span> <span class="na">ref=</span><span class="s">"userDaoTarget"</span> <span class="nt">/&gt;</span> 
         <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"proxyInterfaces"</span> <span class="na">value=</span><span class="s">"com.bluesky.spring.dao.GeneratorDao"</span> <span class="nt">/&gt;</span>
        <span class="c">&lt;!-- 配置事务属性 --&gt;</span> 
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"transactionAttributes"</span><span class="nt">&gt;</span> 
            <span class="nt">&lt;props&gt;</span> 
                <span class="nt">&lt;prop</span> <span class="na">key=</span><span class="s">"*"</span><span class="nt">&gt;</span>PROPAGATION_REQUIRED<span class="nt">&lt;/prop&gt;</span>
            <span class="nt">&lt;/props&gt;</span> 
        <span class="nt">&lt;/property&gt;</span> 
    <span class="nt">&lt;/bean&gt;</span> 
<span class="nt">&lt;/beans&gt;</span>
</code></pre></div></div>

<p>（2）所有Bean共享一个代理基类</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">"http://www.springframework.org/schema/beans"</span>
    <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="na">xmlns:context=</span><span class="s">"http://www.springframework.org/schema/context"</span>
    <span class="na">xmlns:aop=</span><span class="s">"http://www.springframework.org/schema/aop"</span>
    <span class="na">xsi:schemaLocation=</span><span class="s">"http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans-2.5.xsd
           http://www.springframework.org/schema/context
           http://www.springframework.org/schema/context/spring-context-2.5.xsd
           http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-2.5.xsd"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"sessionFactory"</span> 
            <span class="na">class=</span><span class="s">"org.springframework.orm.hibernate3.LocalSessionFactoryBean"</span><span class="nt">&gt;</span> 
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"configLocation"</span> <span class="na">value=</span><span class="s">"classpath:hibernate.cfg.xml"</span> <span class="nt">/&gt;</span> 
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"configurationClass"</span> <span class="na">value=</span><span class="s">"org.hibernate.cfg.AnnotationConfiguration"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span> 

    <span class="c">&lt;!-- 定义事务管理器（声明式的事务） --&gt;</span> 
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"transactionManager"</span>
        <span class="na">class=</span><span class="s">"org.springframework.orm.hibernate3.HibernateTransactionManager"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"sessionFactory"</span> <span class="na">ref=</span><span class="s">"sessionFactory"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"transactionBase"</span> 
            <span class="na">class=</span><span class="s">"org.springframework.transaction.interceptor.TransactionProxyFactoryBean"</span> 
            <span class="na">lazy-init=</span><span class="s">"true"</span> <span class="na">abstract=</span><span class="s">"true"</span><span class="nt">&gt;</span> 
        <span class="c">&lt;!-- 配置事务管理器 --&gt;</span> 
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"transactionManager"</span> <span class="na">ref=</span><span class="s">"transactionManager"</span> <span class="nt">/&gt;</span> 
        <span class="c">&lt;!-- 配置事务属性 --&gt;</span> 
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"transactionAttributes"</span><span class="nt">&gt;</span> 
            <span class="nt">&lt;props&gt;</span> 
                <span class="nt">&lt;prop</span> <span class="na">key=</span><span class="s">"*"</span><span class="nt">&gt;</span>PROPAGATION_REQUIRED<span class="nt">&lt;/prop&gt;</span> 
            <span class="nt">&lt;/props&gt;</span> 
        <span class="nt">&lt;/property&gt;</span> 
    <span class="nt">&lt;/bean&gt;</span>   

    <span class="c">&lt;!-- 配置DAO --&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"userDaoTarget"</span> <span class="na">class=</span><span class="s">"com.bluesky.spring.dao.UserDaoImpl"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"sessionFactory"</span> <span class="na">ref=</span><span class="s">"sessionFactory"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"userDao"</span> <span class="na">parent=</span><span class="s">"transactionBase"</span> <span class="nt">&gt;</span> 
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"target"</span> <span class="na">ref=</span><span class="s">"userDaoTarget"</span> <span class="nt">/&gt;</span>  
    <span class="nt">&lt;/bean&gt;</span>
<span class="nt">&lt;/beans&gt;</span>
</code></pre></div></div>

<p>（3）使用拦截器</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">"http://www.springframework.org/schema/beans"</span>
    <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="na">xmlns:context=</span><span class="s">"http://www.springframework.org/schema/context"</span>
    <span class="na">xmlns:aop=</span><span class="s">"http://www.springframework.org/schema/aop"</span>
    <span class="na">xsi:schemaLocation=</span><span class="s">"http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans-2.5.xsd
           http://www.springframework.org/schema/context
           http://www.springframework.org/schema/context/spring-context-2.5.xsd
           http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-2.5.xsd"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"sessionFactory"</span> 
            <span class="na">class=</span><span class="s">"org.springframework.orm.hibernate3.LocalSessionFactoryBean"</span><span class="nt">&gt;</span> 
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"configLocation"</span> <span class="na">value=</span><span class="s">"classpath:hibernate.cfg.xml"</span> <span class="nt">/&gt;</span> 
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"configurationClass"</span> <span class="na">value=</span><span class="s">"org.hibernate.cfg.AnnotationConfiguration"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span> 

    <span class="c">&lt;!-- 定义事务管理器（声明式的事务） --&gt;</span> 
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"transactionManager"</span>
        <span class="na">class=</span><span class="s">"org.springframework.orm.hibernate3.HibernateTransactionManager"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"sessionFactory"</span> <span class="na">ref=</span><span class="s">"sessionFactory"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span> 

    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"transactionInterceptor"</span> 
        <span class="na">class=</span><span class="s">"org.springframework.transaction.interceptor.TransactionInterceptor"</span><span class="nt">&gt;</span> 
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"transactionManager"</span> <span class="na">ref=</span><span class="s">"transactionManager"</span> <span class="nt">/&gt;</span> 
        <span class="c">&lt;!-- 配置事务属性 --&gt;</span> 
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"transactionAttributes"</span><span class="nt">&gt;</span> 
            <span class="nt">&lt;props&gt;</span> 
                <span class="nt">&lt;prop</span> <span class="na">key=</span><span class="s">"*"</span><span class="nt">&gt;</span>PROPAGATION_REQUIRED<span class="nt">&lt;/prop&gt;</span> 
            <span class="nt">&lt;/props&gt;</span> 
        <span class="nt">&lt;/property&gt;</span> 
    <span class="nt">&lt;/bean&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">class=</span><span class="s">"org.springframework.aop.framework.autoproxy.BeanNameAutoProxyCreator"</span><span class="nt">&gt;</span> 
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"beanNames"</span><span class="nt">&gt;</span> 
            <span class="nt">&lt;list&gt;</span> 
                <span class="nt">&lt;value&gt;</span>*Dao<span class="nt">&lt;/value&gt;</span>
            <span class="nt">&lt;/list&gt;</span> 
        <span class="nt">&lt;/property&gt;</span> 
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"interceptorNames"</span><span class="nt">&gt;</span> 
            <span class="nt">&lt;list&gt;</span> 
                <span class="nt">&lt;value&gt;</span>transactionInterceptor<span class="nt">&lt;/value&gt;</span> 
            <span class="nt">&lt;/list&gt;</span> 
        <span class="nt">&lt;/property&gt;</span> 
    <span class="nt">&lt;/bean&gt;</span> 

    <span class="c">&lt;!-- 配置DAO --&gt;</span>
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"userDao"</span> <span class="na">class=</span><span class="s">"com.bluesky.spring.dao.UserDaoImpl"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"sessionFactory"</span> <span class="na">ref=</span><span class="s">"sessionFactory"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>
<span class="nt">&lt;/beans&gt;</span>
</code></pre></div></div>

<p>（4）使用tx标签配置的拦截器</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">"http://www.springframework.org/schema/beans"</span>
    <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="na">xmlns:context=</span><span class="s">"http://www.springframework.org/schema/context"</span>
    <span class="na">xmlns:aop=</span><span class="s">"http://www.springframework.org/schema/aop"</span>
    <span class="na">xmlns:tx=</span><span class="s">"http://www.springframework.org/schema/tx"</span>
    <span class="na">xsi:schemaLocation=</span><span class="s">"http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans-2.5.xsd
           http://www.springframework.org/schema/context
           http://www.springframework.org/schema/context/spring-context-2.5.xsd
           http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-2.5.xsd
           http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-2.5.xsd"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;context:annotation-config</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;context:component-scan</span> <span class="na">base-package=</span><span class="s">"com.bluesky"</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"sessionFactory"</span> 
            <span class="na">class=</span><span class="s">"org.springframework.orm.hibernate3.LocalSessionFactoryBean"</span><span class="nt">&gt;</span> 
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"configLocation"</span> <span class="na">value=</span><span class="s">"classpath:hibernate.cfg.xml"</span> <span class="nt">/&gt;</span> 
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"configurationClass"</span> <span class="na">value=</span><span class="s">"org.hibernate.cfg.AnnotationConfiguration"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span> 

    <span class="c">&lt;!-- 定义事务管理器（声明式的事务） --&gt;</span> 
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"transactionManager"</span>
        <span class="na">class=</span><span class="s">"org.springframework.orm.hibernate3.HibernateTransactionManager"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"sessionFactory"</span> <span class="na">ref=</span><span class="s">"sessionFactory"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

    <span class="nt">&lt;tx:advice</span> <span class="na">id=</span><span class="s">"txAdvice"</span> <span class="na">transaction-manager=</span><span class="s">"transactionManager"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;tx:attributes&gt;</span>
            <span class="nt">&lt;tx:method</span> <span class="na">name=</span><span class="s">"*"</span> <span class="na">propagation=</span><span class="s">"REQUIRED"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;/tx:attributes&gt;</span>
    <span class="nt">&lt;/tx:advice&gt;</span>

    <span class="nt">&lt;aop:config&gt;</span>
        <span class="nt">&lt;aop:pointcut</span> <span class="na">id=</span><span class="s">"interceptorPointCuts"</span>
            <span class="na">expression=</span><span class="s">"execution(* com.bluesky.spring.dao.*.*(..))"</span> <span class="nt">/&gt;</span>
        <span class="nt">&lt;aop:advisor</span> <span class="na">advice-ref=</span><span class="s">"txAdvice"</span>
            <span class="na">pointcut-ref=</span><span class="s">"interceptorPointCuts"</span> <span class="nt">/&gt;</span>       
    <span class="nt">&lt;/aop:config&gt;</span>     
<span class="nt">&lt;/beans&gt;</span>
</code></pre></div></div>

<p>（5）全注解</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">"http://www.springframework.org/schema/beans"</span>
    <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
    <span class="na">xmlns:context=</span><span class="s">"http://www.springframework.org/schema/context"</span>
    <span class="na">xmlns:aop=</span><span class="s">"http://www.springframework.org/schema/aop"</span>
    <span class="na">xmlns:tx=</span><span class="s">"http://www.springframework.org/schema/tx"</span>
    <span class="na">xsi:schemaLocation=</span><span class="s">"http://www.springframework.org/schema/beans
           http://www.springframework.org/schema/beans/spring-beans-2.5.xsd
           http://www.springframework.org/schema/context
           http://www.springframework.org/schema/context/spring-context-2.5.xsd
           http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-2.5.xsd
           http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-2.5.xsd"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;context:annotation-config</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;context:component-scan</span> <span class="na">base-package=</span><span class="s">"com.bluesky"</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;tx:annotation-driven</span> <span class="na">transaction-manager=</span><span class="s">"transactionManager"</span><span class="nt">/&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"sessionFactory"</span> 
            <span class="na">class=</span><span class="s">"org.springframework.orm.hibernate3.LocalSessionFactoryBean"</span><span class="nt">&gt;</span> 
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"configLocation"</span> <span class="na">value=</span><span class="s">"classpath:hibernate.cfg.xml"</span> <span class="nt">/&gt;</span> 
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"configurationClass"</span> <span class="na">value=</span><span class="s">"org.hibernate.cfg.AnnotationConfiguration"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span> 

    <span class="c">&lt;!-- 定义事务管理器（声明式的事务） --&gt;</span> 
    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"transactionManager"</span>
        <span class="na">class=</span><span class="s">"org.springframework.orm.hibernate3.HibernateTransactionManager"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"sessionFactory"</span> <span class="na">ref=</span><span class="s">"sessionFactory"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;/beans&gt;</span>
</code></pre></div></div>

<p>此时在DAO上需加上@Transactional注解，如下：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">bluesky</span><span class="o">.</span><span class="na">spring</span><span class="o">.</span><span class="na">dao</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.hibernate.SessionFactory</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.orm.hibernate3.support.HibernateDaoSupport</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Component</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">com.bluesky.spring.domain.User</span><span class="o">;</span>

<span class="nd">@Transactional</span>
<span class="nd">@Component</span><span class="o">(</span><span class="s">"userDao"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserDaoImpl</span> <span class="kd">extends</span> <span class="n">HibernateDaoSupport</span> <span class="kd">implements</span> <span class="n">UserDao</span> <span class="o">{</span>

    <span class="kd">public</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">User</span><span class="o">&gt;</span> <span class="nf">listUsers</span><span class="o">()</span> <span class="o">{</span>
        <span class="k">return</span> <span class="k">this</span><span class="o">.</span><span class="na">getSession</span><span class="o">().</span><span class="na">createQuery</span><span class="o">(</span><span class="s">"from User"</span><span class="o">).</span><span class="na">list</span><span class="o">();</span>
    <span class="o">}</span>  
<span class="o">}</span>
</code></pre></div></div>

<p><strong>4.2 一个声明式事务的实例</strong></p>

<p>注：该实例参考自Spring中的事务管理实例详解</p>

<p><strong>首先是数据库表</strong></p>

<p>book(isbn, book_name, price) 
account(username, balance) 
book_stock(isbn, stock)</p>

<p>然后是XML配置</p>

<div class="language-xml highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nt">&lt;beans</span> <span class="na">xmlns=</span><span class="s">"http://www.springframework.org/schema/beans"</span>
<span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
<span class="na">xmlns:context=</span><span class="s">"http://www.springframework.org/schema/context"</span>
<span class="na">xmlns:aop=</span><span class="s">"http://www.springframework.org/schema/aop"</span>
<span class="na">xmlns:tx=</span><span class="s">"http://www.springframework.org/schema/tx"</span>
<span class="na">xsi:schemaLocation=</span><span class="s">"http://www.springframework.org/schema/beans
http://www.springframework.org/schema/beans/spring-beans-3.0.xsd
http://www.springframework.org/schema/context
http://www.springframework.org/schema/context/spring-context-3.0.xsd
http://www.springframework.org/schema/aop http://www.springframework.org/schema/aop/spring-aop-2.5.xsd
http://www.springframework.org/schema/tx http://www.springframework.org/schema/tx/spring-tx-2.5.xsd"</span><span class="nt">&gt;</span>

    <span class="nt">&lt;import</span> <span class="na">resource=</span><span class="s">"applicationContext-db.xml"</span> <span class="nt">/&gt;</span>

    <span class="nt">&lt;context:component-scan</span>
        <span class="na">base-package=</span><span class="s">"com.springinaction.transaction"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;/context:component-scan&gt;</span>

    <span class="nt">&lt;tx:annotation-driven</span> <span class="na">transaction-manager=</span><span class="s">"txManager"</span><span class="nt">/&gt;</span>

    <span class="nt">&lt;bean</span> <span class="na">id=</span><span class="s">"transactionManager"</span> <span class="na">class=</span><span class="s">"org.springframework.jdbc.datasource.DataSourceTransactionManager"</span><span class="nt">&gt;</span>
        <span class="nt">&lt;property</span> <span class="na">name=</span><span class="s">"dataSource"</span> <span class="na">ref=</span><span class="s">"dataSource"</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/bean&gt;</span>

<span class="nt">&lt;/beans&gt;</span>
</code></pre></div></div>

<p><strong>使用的类</strong></p>

<p>BookShopDao</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">springinaction</span><span class="o">.</span><span class="na">transaction</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">BookShopDao</span> <span class="o">{</span>
    <span class="c1">// 根据书号获取书的单价</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">findBookPriceByIsbn</span><span class="o">(</span><span class="n">String</span> <span class="n">isbn</span><span class="o">);</span>
    <span class="c1">// 更新书的库存，使书号对应的库存-1</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">updateBookStock</span><span class="o">(</span><span class="n">String</span> <span class="n">isbn</span><span class="o">);</span>
    <span class="c1">// 更新用户的账户余额：account的balance-price</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">updateUserAccount</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">,</span> <span class="kt">int</span> <span class="n">price</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>BookShopDaoImpl</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">springinaction</span><span class="o">.</span><span class="na">transaction</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.jdbc.core.JdbcTemplate</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Repository</span><span class="o">;</span>

<span class="nd">@Repository</span><span class="o">(</span><span class="s">"bookShopDao"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BookShopDaoImpl</span> <span class="kd">implements</span> <span class="n">BookShopDao</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">JdbcTemplate</span> <span class="n">JdbcTemplate</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">int</span> <span class="nf">findBookPriceByIsbn</span><span class="o">(</span><span class="n">String</span> <span class="n">isbn</span><span class="o">)</span> <span class="o">{</span>
        <span class="n">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">"SELECT price FROM book WHERE isbn = ?"</span><span class="o">;</span>

        <span class="k">return</span> <span class="n">JdbcTemplate</span><span class="o">.</span><span class="na">queryForObject</span><span class="o">(</span><span class="n">sql</span><span class="o">,</span> <span class="n">Integer</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">isbn</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">updateBookStock</span><span class="o">(</span><span class="n">String</span> <span class="n">isbn</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//检查书的库存是否足够，若不够，则抛出异常</span>
        <span class="n">String</span> <span class="n">sql2</span> <span class="o">=</span> <span class="s">"SELECT stock FROM book_stock WHERE isbn = ?"</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">stock</span> <span class="o">=</span> <span class="n">JdbcTemplate</span><span class="o">.</span><span class="na">queryForObject</span><span class="o">(</span><span class="n">sql2</span><span class="o">,</span> <span class="n">Integer</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">isbn</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">stock</span> <span class="o">==</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">BookStockException</span><span class="o">(</span><span class="s">"库存不足！"</span><span class="o">);</span>
        <span class="o">}</span>
        <span class="n">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">"UPDATE book_stock SET stock = stock - 1 WHERE isbn = ?"</span><span class="o">;</span>
        <span class="n">JdbcTemplate</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">sql</span><span class="o">,</span> <span class="n">isbn</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">updateUserAccount</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">,</span> <span class="kt">int</span> <span class="n">price</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//检查余额是否不足，若不足，则抛出异常</span>
        <span class="n">String</span> <span class="n">sql2</span> <span class="o">=</span> <span class="s">"SELECT balance FROM account WHERE username = ?"</span><span class="o">;</span>
        <span class="kt">int</span> <span class="n">balance</span> <span class="o">=</span> <span class="n">JdbcTemplate</span><span class="o">.</span><span class="na">queryForObject</span><span class="o">(</span><span class="n">sql2</span><span class="o">,</span> <span class="n">Integer</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">username</span><span class="o">);</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">balance</span> <span class="o">&lt;</span> <span class="n">price</span><span class="o">)</span> <span class="o">{</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="nf">UserAccountException</span><span class="o">(</span><span class="s">"余额不足！"</span><span class="o">);</span>
        <span class="o">}</span>       
        <span class="n">String</span> <span class="n">sql</span> <span class="o">=</span> <span class="s">"UPDATE account SET balance = balance - ? WHERE username = ?"</span><span class="o">;</span>
        <span class="n">JdbcTemplate</span><span class="o">.</span><span class="na">update</span><span class="o">(</span><span class="n">sql</span><span class="o">,</span> <span class="n">price</span><span class="o">,</span> <span class="n">username</span><span class="o">);</span>
    <span class="o">}</span>

<span class="o">}</span>
</code></pre></div></div>

<p>BookShopService</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">springinaction</span><span class="o">.</span><span class="na">transaction</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">BookShopService</span> <span class="o">{</span>
     <span class="kd">public</span> <span class="kt">void</span> <span class="nf">purchase</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">,</span> <span class="n">String</span> <span class="n">isbn</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>BookShopServiceImpl</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">springinaction</span><span class="o">.</span><span class="na">transaction</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.transaction.annotation.Isolation</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.transaction.annotation.Propagation</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.transaction.annotation.Transactional</span><span class="o">;</span>

<span class="nd">@Service</span><span class="o">(</span><span class="s">"bookShopService"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BookShopServiceImpl</span> <span class="kd">implements</span> <span class="n">BookShopService</span> <span class="o">{</span>

    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">BookShopDao</span> <span class="n">bookShopDao</span><span class="o">;</span>

    <span class="cm">/**
     * 1.添加事务注解
     * 使用propagation 指定事务的传播行为，即当前的事务方法被另外一个事务方法调用时如何使用事务。
     * 默认取值为REQUIRED，即使用调用方法的事务
     * REQUIRES_NEW：使用自己的事务，调用的事务方法的事务被挂起。
     *
     * 2.使用isolation 指定事务的隔离级别，最常用的取值为READ_COMMITTED
     * 3.默认情况下 Spring 的声明式事务对所有的运行时异常进行回滚，也可以通过对应的属性进行设置。通常情况下，默认值即可。
     * 4.使用readOnly 指定事务是否为只读。 表示这个事务只读取数据但不更新数据，这样可以帮助数据库引擎优化事务。若真的是一个只读取数据库值得方法，应设置readOnly=true
     * 5.使用timeOut 指定强制回滚之前事务可以占用的时间。
     */</span>
    <span class="nd">@Transactional</span><span class="o">(</span><span class="n">propagation</span><span class="o">=</span><span class="n">Propagation</span><span class="o">.</span><span class="na">REQUIRES_NEW</span><span class="o">,</span>
            <span class="n">isolation</span><span class="o">=</span><span class="n">Isolation</span><span class="o">.</span><span class="na">READ_COMMITTED</span><span class="o">,</span>
            <span class="n">noRollbackFor</span><span class="o">={</span><span class="n">UserAccountException</span><span class="o">.</span><span class="na">class</span><span class="o">},</span>
            <span class="n">readOnly</span><span class="o">=</span><span class="kc">true</span><span class="o">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">3</span><span class="o">)</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">purchase</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">,</span> <span class="n">String</span> <span class="n">isbn</span><span class="o">)</span> <span class="o">{</span>
        <span class="c1">//1.获取书的单价</span>
        <span class="kt">int</span> <span class="n">price</span> <span class="o">=</span> <span class="n">bookShopDao</span><span class="o">.</span><span class="na">findBookPriceByIsbn</span><span class="o">(</span><span class="n">isbn</span><span class="o">);</span>
        <span class="c1">//2.更新书的库存</span>
        <span class="n">bookShopDao</span><span class="o">.</span><span class="na">updateBookStock</span><span class="o">(</span><span class="n">isbn</span><span class="o">);</span>
        <span class="c1">//3.更新用户余额</span>
        <span class="n">bookShopDao</span><span class="o">.</span><span class="na">updateUserAccount</span><span class="o">(</span><span class="n">username</span><span class="o">,</span> <span class="n">price</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>Cashier</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">springinaction</span><span class="o">.</span><span class="na">transaction</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">interface</span> <span class="nc">Cashier</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">checkout</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span><span class="n">isbns</span><span class="o">);</span>
<span class="o">}</span>
</code></pre></div></div>

<p>CashierImpl：CashierImpl.checkout和bookShopService.purchase联合测试了事务的传播行为</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">springinaction</span><span class="o">.</span><span class="na">transaction</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.List</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.springframework.beans.factory.annotation.Autowired</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.stereotype.Service</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.transaction.annotation.Transactional</span><span class="o">;</span>

<span class="nd">@Service</span><span class="o">(</span><span class="s">"cashier"</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CashierImpl</span> <span class="kd">implements</span> <span class="n">Cashier</span> <span class="o">{</span>
    <span class="nd">@Autowired</span>
    <span class="kd">private</span> <span class="n">BookShopService</span> <span class="n">bookShopService</span><span class="o">;</span>

    <span class="nd">@Transactional</span>
    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">checkout</span><span class="o">(</span><span class="n">String</span> <span class="n">username</span><span class="o">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">isbns</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">for</span><span class="o">(</span><span class="n">String</span> <span class="n">isbn</span> <span class="o">:</span> <span class="n">isbns</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">bookShopService</span><span class="o">.</span><span class="na">purchase</span><span class="o">(</span><span class="n">username</span><span class="o">,</span> <span class="n">isbn</span><span class="o">);</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>BookStockException</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">springinaction</span><span class="o">.</span><span class="na">transaction</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">BookStockException</span> <span class="kd">extends</span> <span class="n">RuntimeException</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">BookStockException</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">();</span>
        <span class="c1">// TODO Auto-generated constructor stub</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nf">BookStockException</span><span class="o">(</span><span class="n">String</span> <span class="n">arg0</span><span class="o">,</span> <span class="n">Throwable</span> <span class="n">arg1</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">arg2</span><span class="o">,</span>
            <span class="kt">boolean</span> <span class="n">arg3</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">arg0</span><span class="o">,</span> <span class="n">arg1</span><span class="o">,</span> <span class="n">arg2</span><span class="o">,</span> <span class="n">arg3</span><span class="o">);</span>
        <span class="c1">// TODO Auto-generated constructor stub</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nf">BookStockException</span><span class="o">(</span><span class="n">String</span> <span class="n">arg0</span><span class="o">,</span> <span class="n">Throwable</span> <span class="n">arg1</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">arg0</span><span class="o">,</span> <span class="n">arg1</span><span class="o">);</span>
        <span class="c1">// TODO Auto-generated constructor stub</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nf">BookStockException</span><span class="o">(</span><span class="n">String</span> <span class="n">arg0</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">arg0</span><span class="o">);</span>
        <span class="c1">// TODO Auto-generated constructor stub</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nf">BookStockException</span><span class="o">(</span><span class="n">Throwable</span> <span class="n">arg0</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">arg0</span><span class="o">);</span>
        <span class="c1">// TODO Auto-generated constructor stub</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>UserAccountException</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">springinaction</span><span class="o">.</span><span class="na">transaction</span><span class="o">;</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">UserAccountException</span> <span class="kd">extends</span> <span class="n">RuntimeException</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">long</span> <span class="n">serialVersionUID</span> <span class="o">=</span> <span class="mi">1L</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">UserAccountException</span><span class="o">()</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">();</span>
        <span class="c1">// TODO Auto-generated constructor stub</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nf">UserAccountException</span><span class="o">(</span><span class="n">String</span> <span class="n">arg0</span><span class="o">,</span> <span class="n">Throwable</span> <span class="n">arg1</span><span class="o">,</span> <span class="kt">boolean</span> <span class="n">arg2</span><span class="o">,</span>
            <span class="kt">boolean</span> <span class="n">arg3</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">arg0</span><span class="o">,</span> <span class="n">arg1</span><span class="o">,</span> <span class="n">arg2</span><span class="o">,</span> <span class="n">arg3</span><span class="o">);</span>
        <span class="c1">// TODO Auto-generated constructor stub</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nf">UserAccountException</span><span class="o">(</span><span class="n">String</span> <span class="n">arg0</span><span class="o">,</span> <span class="n">Throwable</span> <span class="n">arg1</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">arg0</span><span class="o">,</span> <span class="n">arg1</span><span class="o">);</span>
        <span class="c1">// TODO Auto-generated constructor stub</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nf">UserAccountException</span><span class="o">(</span><span class="n">String</span> <span class="n">arg0</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">arg0</span><span class="o">);</span>
        <span class="c1">// TODO Auto-generated constructor stub</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="nf">UserAccountException</span><span class="o">(</span><span class="n">Throwable</span> <span class="n">arg0</span><span class="o">)</span> <span class="o">{</span>
        <span class="kd">super</span><span class="o">(</span><span class="n">arg0</span><span class="o">);</span>
        <span class="c1">// TODO Auto-generated constructor stub</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>测试类</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">package</span> <span class="n">com</span><span class="o">.</span><span class="na">springinaction</span><span class="o">.</span><span class="na">transaction</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.util.Arrays</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">org.junit.Test</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.ApplicationContext</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.springframework.context.support.ClassPathXmlApplicationContext</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SpringTransitionTest</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="n">ApplicationContext</span> <span class="n">ctx</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">BookShopDao</span> <span class="n">bookShopDao</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">BookShopService</span> <span class="n">bookShopService</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="kd">private</span> <span class="n">Cashier</span> <span class="n">cashier</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">{</span>
        <span class="n">ctx</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ClassPathXmlApplicationContext</span><span class="o">(</span><span class="s">"config/transaction.xml"</span><span class="o">);</span>
        <span class="n">bookShopDao</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="n">BookShopDao</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">bookShopService</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="n">BookShopService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
        <span class="n">cashier</span> <span class="o">=</span> <span class="n">ctx</span><span class="o">.</span><span class="na">getBean</span><span class="o">(</span><span class="n">Cashier</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testBookShopDaoFindPriceByIsbn</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">bookShopDao</span><span class="o">.</span><span class="na">findBookPriceByIsbn</span><span class="o">(</span><span class="s">"1001"</span><span class="o">));</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testBookShopDaoUpdateBookStock</span><span class="o">(){</span>
        <span class="n">bookShopDao</span><span class="o">.</span><span class="na">updateBookStock</span><span class="o">(</span><span class="s">"1001"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testBookShopDaoUpdateUserAccount</span><span class="o">(){</span>
        <span class="n">bookShopDao</span><span class="o">.</span><span class="na">updateUserAccount</span><span class="o">(</span><span class="s">"AA"</span><span class="o">,</span> <span class="mi">100</span><span class="o">);</span>
    <span class="o">}</span>
    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testBookShopService</span><span class="o">(){</span>
        <span class="n">bookShopService</span><span class="o">.</span><span class="na">purchase</span><span class="o">(</span><span class="s">"AA"</span><span class="o">,</span> <span class="s">"1001"</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">testTransactionPropagation</span><span class="o">(){</span>
        <span class="n">cashier</span><span class="o">.</span><span class="na">checkout</span><span class="o">(</span><span class="s">"AA"</span><span class="o">,</span> <span class="n">Arrays</span><span class="o">.</span><span class="na">asList</span><span class="o">(</span><span class="s">"1001"</span><span class="o">,</span> <span class="s">"1002"</span><span class="o">));</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>OVER</p>

<p>本文部分转载于 http://www.mamicode.com/info-detail-1248286.html</p>

<h3 id="联系我">联系我</h3>

<ul>
  <li>邮箱: xmusaber@163.com</li>
  <li>QQ: 932191671</li>
</ul>

<div align="center">
<img src="http://rann.cc/assets/img/qrcode-logo.png" width="400" height="320" />
</div>

<blockquote>
  <p>本文系本人个人公众号「梦回少年」原创发布，扫一扫加关注。</p>
</blockquote>
	
  </article>
</div>

  <div class="prevandnext">
    	  
	    <div style="margin:0.5em;">
	    <span>上一篇 ：</span><a class="pjaxlink" href="http://localhost:4000/2016/06/27/spring-BeanFactoryPostProcessor-and-BeanPostProcessor.html"  title="spring后置处理器BeanFactoryPostProcessor和BeanPostProcessor的用法和区别">spring后置处理器BeanFactoryPostProcessor和BeanPostProcessor的用法和区别</a>
	    </div>
	  
  	  
	    <div style="margin:0.5em;">
	    <span>下一篇 ：</span><a class="pjaxlink" href="http://localhost:4000/2016/06/26/spring-beanfactory-and-applicationContext.html"  title="Spring中ApplicationContext和Beanfactory区别">Spring中ApplicationContext和Beanfactory区别</a>
	    </div>
	  
	  	<div style="margin:0.5em;">
			<span> 版权所有，转载时必须以链接形式注明原始出处</span>
	    </div>
	 
  </div></div>		
			</div>
 		</div>	
	</div>
    </div> 
</div>
	<div class="profile_social">
		<a class="rss" href="/feed.xml" target="_blank"></a>
		<a class="github" href="https://github.com/lemonjing"  target="_blank"></a>
		<a class="weibo" href="http://weibo.com/u/1662536394"  target="_blank"></a>
	</div>
    <div id="backtotop">
    		<a href="#"><i class="fa fa-arrow-circle-up"></i></a>
    </div>
    <div class="pjax_loading"></div>
    
    <footer class="site-footer">
  <div class="wrapper">

    <h2 class="footer-heading">saber's blog</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col  footer-col-1">
        <ul class="contact-list">
          <li>梦回少年</li>
          <li><a href="mailto:xmusaber@163.com">xmusaber@163.com</a></li>
          <li>闽ICP备15018990号</li>
        </ul>
      </div>

      <div class="footer-col  footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a class="github" href="https://github.com/lemonjing"  target="_blank"></a>
          </li>
          

          
          <li>
            <a class="weibo" href="http://weibo.com/u/1662536394"  target="_blank"></a>
          </li>
          
        </ul>
      </div>
      <div class="footer-col  footer-col-3">
        <p class="text">If,<br/>for example,<br/>you come at four o'clock in the afternoon,<br/>then at three o'clock I shall begin to be happy.</p>
      </div>
    </div>
</div>
    <div class="center sitedesc">
    	Powered by <a href ="http://jekyllrb.com/">Jekyll</a>  |  © 2018 梦回少年  |  Hosted on <a href="https://github.com/lemonjing/lemonjing.github.io"> Github</a></div>
    <div class="center sitedesc"><span id=span_dt_dt></span>&nbsp;&nbsp;|&nbsp;&nbsp;<span id="busuanzi_container_site_pv" style='display:none'>本站总访问量<span id="busuanzi_value_site_pv"></span>次<br/>
    <script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1259223523'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s11.cnzz.com/z_stat.php%3Fid%3D1259223523%26online%3D1%26show%3Dline' type='text/javascript'%3E%3C/script%3E"));</script>
    </div>

<!-- 访问统计 -->
<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<!-- 萌萌哒运行 -->
  <SCRIPT language=javascript>          
function show_date_time(){
window.setTimeout("show_date_time()", 1000);
BirthDay=new Date("8/15/2015 11:30:00");//这个日期是可以修改的
today=new Date();
timeold=(today.getTime()-BirthDay.getTime());
sectimeold=timeold/1000
secondsold=Math.floor(sectimeold);
msPerDay=24*60*60*1000
e_daysold=timeold/msPerDay
daysold=Math.floor(e_daysold);
e_hrsold=(e_daysold-daysold)*24;
hrsold=Math.floor(e_hrsold);
e_minsold=(e_hrsold-hrsold)*60;
minsold=Math.floor((e_hrsold-hrsold)*60);
seconds=Math.floor((e_minsold-minsold)*60);
span_dt_dt.innerHTML="本站已萌萌哒运行"+daysold+"天"+hrsold+"小时"+minsold+"分"+seconds+"秒";
}show_date_time();</SCRIPT>

  <!-- <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        TeX: {equationNumbers: {
            autoNumber: ["AMS"], useLabelIds: true}},
            "HTML-CSS": {linebreaks: {automatic: true}},
            SVG: {linebreaks: {automatic: true}}
    });
   </script> -->

  <!-- jQuery -->
  <script src="//cdn.bootcss.com/jquery/2.2.2/jquery.min.js"></script>
  <script type="text/javascript" src="/assets/js/jquery.pjax.js"></script>
  <!-- Bootstrap Core JavaScript -->
  <script src="//cdn.bootcss.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
  <script type="text/javascript" src="/assets/js/prettify/prettify.js"></script>
  
  <!-- <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script> -->
  <script type="text/javascript" src="/assets/js/ua-parser.js"></script>

  <!-- jekyII search-->
<div class="cb-search-tool" style="position: fixed; top: 0px ; bottom: 0px; left: 0px; right:  0px;
      opacity: 0.95; background-color: #111111; z-index: 9999; display: none;">
    <input type="text" class="form-control cb-search-content" id="cb-search-content" style="position: fixed; top: 60px" placeholder="文章标题 日期 标签" >

    <div style="position: fixed; top: 16px; right: 16px;">
        <img src="/search/img/cb-close.png"  id="cb-close-btn"/>
    </div>
</div>

<!-- <div style="position: fixed; right: 16px; bottom: 20px;">
    <img src="/search/img/cb-search.png"  id="cb-search-btn"  title="双击ctrl试一下"/>
</div> -->

<link rel="stylesheet" href="/search/css/cb-search.css">

<script src="/search/js/bootstrap3-typeahead.min.js"></script>
<script src="/search/js/cb-search.js"></script>
<!-- jekyII search end -->

  
<script type="text/javascript" src="http://echarts.baidu.com/build/dist/echarts.js"></script>
<script type="text/javascript" src="/assets/js/embed.js"></script>
<script type="text/javascript" src="/assets/js/stickUp.min.js"></script>
<script type="text/javascript" src="/assets/js/main.js"></script>

</footer>

  </body>

</html>