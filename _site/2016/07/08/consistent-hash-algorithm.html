<!DOCTYPE html>
<html>

  <head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1.0,minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">

  <!-- 添加搜索关键字 -->
  <meta name="keywords" content="梦回少年,梦回,saber,lemonjing,少年">

  <title>对一致性哈希算法的深入研究 | 梦回少年</title>
  <meta name="description" content="一致性Hash算法">

  <link rel="stylesheet" href="/assets/css/bootstrap.css">
  <link rel="stylesheet" href="/assets/css/font-awesome.css">
  <link rel="stylesheet" href="/assets/css/main.css" >
  <link rel="stylesheet" href="/assets/js/prettify/prettify.css">
  <link rel="shortcut icon" href="/assets/img/favicon.ico" />
  <link rel="canonical" href="http://localhost:4000/2016/07/08/consistent-hash-algorithm.html">
  <link rel="alternate" type="application/rss+xml" title="梦回少年" href="http://localhost:4000/feed.xml" />
</head>


  <body>

    <header class="site-header">
    <div class="container">
        <div class="row">
            <nav class="navbar navbar-default" role="navigation">
                <div class="navbar-header col-xs-12 col-sm-12 col-md-3 col-lg-3 center">
                    <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#example-navbar-collapse">
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    <div class="sitehome">
                        <a href="/" title="首页"><i class="fa fa-home fa-2x homeicon"></i><a><a class="site-title" href="/">梦回少年</a>
                    </div>
                </div>
                <div class="col-md-6 col-lg-6 hidden-xs hidden-sm center">
                    <nav class="site-nav">
                        <ul class="nav nav-pills">
                            <li class="select"><a class="page-link pjaxlink" href="/pages/read.html">读书</a></li>
                            <li class="select"><a class="page-link pjaxlink" href="/pages/class.html">分类</a></li>
                            <!-- <li class="select"><a class="page-link pjaxlink" href="/pages/tags.html">标签</a></li> -->
                            <li class="select"><a class="page-link pjaxlink" href="/pages/archive.html">归档</a></li>
                            <li class="select"><a class="page-link pjaxlink" href="/pages/about.html">关于</a></li>
                        </ul>
                    </nav>
                </div>
                <!-- swifttype 搜索 弃用-->
               <!--  <div class="col-md-3 col-lg-3 hidden-xs hidden-sm">
                    <div class="search">
                        <input type="text" class="search-query st-default-search-input" placeholder="Search">
                    </div>
                </div> -->
                 <!-- /swifttype 搜索 -->
                <div class="col-md-3 col-lg-3 hidden-xs hidden-sm">
                    <div style="position: fixed; top:10px;">
                        <img src="/search/img/cb-search.png" id="cb-search-btn" title="双击ctrl试一下" />
                    </div>
                </div>
                   
                    <div class="collapse navbar-collapse" id="example-navbar-collapse">
                        <ul class="nav navbar-nav phone-nav center">
                            <li class="phoneselect"><a class="page-link pjaxlink" href="/"><i class="fa fa-home"></i>&nbsp;首页</a></li>
                            <li class="phoneselect"><a class="page-link pjaxlink" href="/pages/read.html"><i class="fa fa-book"></i>&nbsp;读书</a></li>
                            <li class="phoneselect"><a class="page-link pjaxlink" href="/pages/class.html"><i class="fa fa-tasks"></i>&nbsp;分类</a></li>
                            <li class="phoneselect"><a class="page-link pjaxlink" href="/pages/tags.html"><i class="fa fa-tags"></i>&nbsp;标签</a></li>
                            <li class="phoneselect"><a class="page-link pjaxlink" href="/pages/archive.html"><i class="fa fa-archive"></i>&nbsp;归档</a></li>
                            <li class="phoneselect"><a class="page-link pjaxlink" href="/pages/about.html"><i class="fa fa-user"></i>&nbsp;关于</a></li>
                        </ul>
                    </div>
            </nav>
            </div>
        </div>
</header>


    <div class="content">
   	<div class="container">	
   		<div class="row">
			<div class="col-md-3 col-lg-3 hidden-xs hidden-sm aside1 fadein-left">
				<div class="profile box-shadow center">
					<div class="overlay"></div>
					<div class="center gavatar">
						<a href="/" class="profile_gavatar"><img class="circle" src="/assets/img/t1.jpeg"></a>
					</div>
					<div class="address">
						<h5><span class="fa fa-map-marker"></span> Hangzhou, China</h5>
					</div>
					<div class="center profile_desc">
						技术<br>生活<br>和爱情<br>此刻与你分享<br>
					</div>
				</div>
				
				<div class="tag-cloud-text">
					<a href="http://rann.cc/pages/tags.html" title="标签" class="pjaxlink"><p class="center">标签【点我】</p></a>
				</div>
				<div class="tag-cloud ">	
					<hr>
					<div class="page-tag">
							
								
							
								
							
								
							
								
								<a href="http://lemonjing.github.io/pages/tags.html#随笔" name="随笔" class="pjaxlink"><i class="fa fa-tags"></i>随笔(21)</a>
								
							
								
							
								
							
								
							
								
							
								
							
								
							
								
							
								
							
								
							
								
							
								
								<a href="http://lemonjing.github.io/pages/tags.html#Java" name="Java" class="pjaxlink"><i class="fa fa-tags"></i>Java(43)</a>
								
							
								
							
								
							
								
							
								
							
								
							
								
								<a href="http://lemonjing.github.io/pages/tags.html#爱情" name="爱情" class="pjaxlink"><i class="fa fa-tags"></i>爱情(20)</a>
								
							
								
								<a href="http://lemonjing.github.io/pages/tags.html#原创" name="原创" class="pjaxlink"><i class="fa fa-tags"></i>原创(23)</a>
								
							
								
							
								
							
								
							
								
							
								
							
								
							
								
							
								
								<a href="http://lemonjing.github.io/pages/tags.html#技术" name="技术" class="pjaxlink"><i class="fa fa-tags"></i>技术(5)</a>
								
							
								
							
								
							
								
							
								
							
								
							
								
							
								
							
								
							
								
							
								
							
								
							
								
							
								
							
								
							
								
							
								
							
								
								<a href="http://lemonjing.github.io/pages/tags.html#Spring" name="Spring" class="pjaxlink"><i class="fa fa-tags"></i>Spring(10)</a>
								
							
								
							
								
							
								
							
								
							
								
							
								
							
								
							
								
							
								
								<a href="http://lemonjing.github.io/pages/tags.html#NIO" name="NIO" class="pjaxlink"><i class="fa fa-tags"></i>NIO(13)</a>
								
							
								
							
								
							
								
							
								
							
								
							
								
							
					</div>					
				</div>
				<div class="clear"></div>

	 			<div class="recentuse">
	 					<p>GitHub项目</p>
	 					<hr>
	 					<ul>
	 						<li><a href = "https://github.com/it-interview/easy-job" target="_blank">互联网求职面试知识复习</a></li>
	 						<li><a href = "https://github.com/Lemonjing/LightweightApp" target="_blank">集成LBS查询、音乐、阅读的微信公众账号</a></li>
	 						<li><a href = "https://github.com/Lemonjing/hadoop-dedup" target="_blank">基于hadoop和hbase的大规模海量数据去重</a></li>
	 						<li><a href = "https://github.com/Lemonjing/TinyMooc" target="_blank">轻量级Java平台在线幕课学习网站</a></li>
		 					<li><a href = "https://github.com/Lemonjing/Keccak" target="_blank">SHA-3 algorithm Keccak Implementation</a></li>
		 					<li><a href = "https://github.com/Lemonjing/your-offer" target="_blank">剑指offer的Java实现</a></li>
	 					</ul>
	 			</div>
	 			
	 			<div class="recentuse">
	 					<p>经常出没</p>
	 					<hr>
	 					<ul>
	 						<li><a href = "http://music.163.com/#/user/home?id=63589002" target="_blank">网易云音乐</a></li>
	 						<li><a href = "https://github.com/Lemonjing" target="_blank">GitHub</a></li>
	 						<li><a href = "http://weibo.com/u/1662536394" target="_blank">微博</a></li>
	 						<li><a href = "http://pianke.me/profile/1924980/" target="_blank">片刻</a></li>
		 					<li><a href = "https://www.zhihu.com/people/xmusaber" target="_blank">知乎</a></li>
		 					<li><a href = "http://www.nowcoder.com/profile/213475" target="_blank">牛客</a></li>
	 					</ul>
	 			</div>
				
				<div class="friendlink">
	 					<p>友情链接</p>
	 					<hr>					
		 				<a href = "https://imjad.cn/" target="_blank">AD's Blog</a></br>
						<a href = "http://zyl.me" target="_blank">ZYL的博客</a></br>
						<a href = "http://mxwu.cn" target="_blank">梦忻屋</a></br>
						<a href = "http://www.weiyanweiyu.cn" target="_blank">微言微语</a></br>
						<a href = "http://jloong.com" target="_blank">楚书业</a></br>
						<a href = "https://emiria.io/" target="_blank">蔓舞寻樱</a></br>
						<a href = "http://www.xiaokang.info" target="_blank">小康博客</a><br>
						<a href = "http://blog.iov.me" target="_blank">随心说</a></br>
						<a href = "http://czduban.com" target="_blank">以歌。先生</a><br>
						<a href = "http://5mx.net/" target="_blank">冷夜博客</a><br>
						<a href = "http://www.8hao.com.cn/" target="_blank">艳莜日记</a><br>
						<a href = "http://blog.sunxyz.cn/" target="_blank">诸葛扬阳</a><br>
						<a href = "https://lostyou.love/" target="_blank">邻居</a><br>
						<a href = "http://www.kurodown.com/" target="_blank">酷绒站</a>
	 			</div>
				
			</div>
			
			<div class="col-xs-12 col-sm-12 col-md-9 col-lg-9 box-shadow fadein-right aside2">					 		
					<div class="page-content" id="pjax"><div class="post">
  <header class="post-header">
    <h1 class="post-title">对一致性哈希算法的深入研究</h1>
    <div class="info">
	    <p class="post-meta"><i class="fa fa-calendar"></i>&nbsp;2016-07-08</p>
	    
		<i class="fa fa-tags"></i>
		<span class="index-post-tag">
		
			<a class="pjaxlink" href="/pages/tags.html#Java">Java</a>
		
		</span>
	    		
    </div>
  </header>

  <article class="post-content">
    <h2 id="一致性hash算法">一致性Hash算法</h2>

<p><img src="http://7xlkoc.com1.z0.glb.clouddn.com/hash2.jpg" alt="" /></p>

<p>关于一致性Hash算法，在我之前的博文中已经有多次提到了，MemCache超详细解读一文中”一致性Hash算法”部分，对于为什么要使用一致性Hash算法、一致性Hash算法的算法原理做了详细的解读。</p>

<p>算法的具体原理这里再次贴上：</p>

<font color="blue">先构造一个长度为2^32的整数环（这个环被称为一致性Hash环），根据节点名称的Hash值（其分布为[0, 2^32-1]）将服务器节点放置在这个Hash环上，然后根据数据的Key值计算得到其Hash值（其分布也为[0, 2^32-1]），接着在Hash环上顺时针查找距离这个Key值的Hash值最近的服务器节点，完成Key到服务器的映射查找。</font>

<p>这种算法解决了普通余数Hash算法伸缩性差的问题，可以保证在上线、下线服务器的情况下尽量有多的请求命中原来路由到的服务器。</p>

<p>当然，万事不可能十全十美，一致性Hash算法比普通的余数Hash算法更具有伸缩性，但是同时其算法实现也更为复杂，本文就来研究一下，如何利用Java代码实现一致性Hash算法。在开始之前，先对一致性Hash算法中的几个核心问题进行一些探究。</p>

<h3 id="数据结构的选取">数据结构的选取</h3>

<p>一致性Hash算法最先要考虑的一个问题是：构造出一个长度为2^32的整数环，根据节点名称的Hash值将服务器节点放置在这个Hash环上。</p>

<p>那么，整数环应该使用何种数据结构，才能使得运行时的时间复杂度最低？首先说明一点，关于时间复杂度，常见的时间复杂度与时间效率的关系有如下的经验规则：</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>O<span class="o">(</span>1<span class="o">)</span> &lt; O<span class="o">(</span>log2N<span class="o">)</span> &lt; O<span class="o">(</span>n<span class="o">)</span> &lt; O<span class="o">(</span>N <span class="k">*</span> logN<span class="o">)</span> &lt; O<span class="o">(</span>N^2<span class="o">)</span> &lt; O<span class="o">(</span>N^3<span class="o">)</span> &lt; 2^N &lt; 3^N &lt; N!
</code></pre></div></div>

<p>一般来说，前四个效率比较高，中间两个差强人意，后三个比较差（只要N比较大，这个算法就动不了了）。OK，继续前面的话题，应该如何选取数据结构，我认为有以下几种可行的解决方案。</p>

<p><strong>1、解决方案一：排序+List</strong></p>

<p>我想到的第一种思路是：算出所有待加入数据结构的节点名称的Hash值放入一个数组中，然后使用某种排序算法将其从小到大进行排序，最后将排序后的数据放入List中，采用List而不是数组是为了结点的扩展考虑。</p>

<font color="blue">之后，待路由的结点，只需要在List中找到第一个Hash值比它大的服务器节点就可以了，</font>
<p>比如服务器节点的Hash值是[0,2,4,6,8,10]，带路由的结点是7，只需要找到第一个比7大的整数，也就是8，就是我们最终需要路由过去的服务器节点。</p>

<p>如果暂时不考虑前面的排序，那么这种解决方案的时间复杂度：</p>

<p>（1）最好的情况是第一次就找到，时间复杂度为O(1)</p>

<p>（2）最坏的情况是最后一次才找到，时间复杂度为O(N)</p>

<p>平均下来时间复杂度为O(0.5N+0.5)，忽略首项系数和常数，时间复杂度为O(N)。</p>

<p>但是如果考虑到之前的排序，我在网上找了张图，提供了各种排序算法的时间复杂度：</p>

<p><img src="http://7xlkoc.com1.z0.glb.clouddn.com/sort-complex.jpg" alt="排序算法复杂度" /></p>

<p><strong>2、解决方案二：遍历+List</strong></p>

<p>既然排序操作比较耗性能，那么能不能不排序？可以的，所以进一步的，有了第二种解决方案。</p>

<p>解决方案使用List不变，不过可以采用遍历的方式：</p>

<p>（1）服务器节点不排序，其Hash值全部直接放入一个List中</p>

<p>（2）带路由的节点，算出其Hash值，由于指明了”顺时针”，因此遍历List，比待路由的节点Hash值大的算出差值并记录，比待路由节点Hash值小的忽略</p>

<p>（3）算出所有的差值之后，最小的那个，就是最终需要路由过去的节点</p>

<p>在这个算法中，看一下时间复杂度：</p>

<p>1、最好情况是只有一个服务器节点的Hash值大于带路由结点的Hash值，其时间复杂度是O(N)+O(1)=O(N+1)，忽略常数项，即O(N)</p>

<p>2、最坏情况是所有服务器节点的Hash值都大于带路由结点的Hash值，其时间复杂度是O(N)+O(N)=O(2N)，忽略首项系数，即O(N)</p>

<p>所以，总的时间复杂度就是O(N)。其实算法还能更改进一些：给一个位置变量X，如果新的差值比原差值小，X替换为新的位置，否则X不变。这样遍历就减少了一轮，不过经过改进后的算法时间复杂度仍为O(N)。</p>

<p>总而言之，这个解决方案和解决方案一相比，总体来看，似乎更好了一些。</p>

<p><strong>3、解决方案三：二叉查找树</strong></p>

<p>抛开List这种数据结构，另一种数据结构则是使用<font color="blue">二叉查找树</font>。</p>

<p>当然我们不能简单地使用二叉查找树，因为可能出现不平衡的情况。平衡二叉查找树有AVL树、红黑树等，这里使用红黑树，选用红黑树的原因有两点：</p>

<p>1、红黑树主要的作用是用于存储有序的数据，这其实和第一种解决方案的思路又不谋而合了，但是它的效率非常高</p>

<p>2、JDK里面提供了红黑树的代码实现TreeMap和TreeSet</p>

<p>另外，以TreeMap为例，TreeMap本身提供了一个tailMap(K fromKey)方法，支持从红黑树中查找比fromKey大的值的集合，但并不需要遍历整个数据结构。</p>

<p>使用红黑树，可以使得查找的时间复杂度降低为O(logN)，比上面两种解决方案，效率大大提升。</p>

<p>为了验证这个说法，我做了一次测试，从大量数据中查找第一个大于其中间值的那个数据，比如10000数据就找第一个大于5000的数据（模拟平均的情况）。看一下O(N)时间复杂度和O(logN)时间复杂度运行效率的对比：</p>

<p><img src="http://7xlkoc.com1.z0.glb.clouddn.com/treemaptest.png" alt="treemaptest" /></p>

<p>因为再大就内存溢出了，所以只测试到4000000数据。可以看到，数据查找的效率，TreeMap是完胜的，其实再增大数据测试也是一样的，红黑树的数据结构决定了任何一个大于N的最小数据，它都只需要几次至几十次查找就可以查到。</p>

<p>当然，明确一点，有利必有弊，根据我另外一次测试得到的结论是，<font color="blue">为了维护红黑树，数据插入效率TreeMap在三种数据结构里面是最差的，且插入要慢上5~10倍。</font></p>

<h3 id="hash值重新计算">Hash值重新计算</h3>

<p>服务器节点我们肯定用字符串来表示，比如”192.168.1.1″、”192.168.1.2″，根据字符串得到其Hash值，那么另外一个重要的问题就是Hash值要重新计算，这个问题是我在测试String的hashCode()方法的时候发现的，不妨来看一下为什么要重新计算Hash值：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
* String的hashCode()方法运算结果查看
* @author 哓哓
*
*/</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">StringHashCodeTest</span> <span class="o">{</span>
	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
		<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"192.168.0.0:111的哈希值："</span> <span class="o">+</span> <span class="s">"192.168.0.0:1111"</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
		<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"192.168.0.1:111的哈希值："</span> <span class="o">+</span> <span class="s">"192.168.0.1:1111"</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
		<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"192.168.0.2:111的哈希值："</span> <span class="o">+</span> <span class="s">"192.168.0.2:1111"</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
		<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"192.168.0.3:111的哈希值："</span> <span class="o">+</span> <span class="s">"192.168.0.3:1111"</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
		<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"192.168.0.4:111的哈希值："</span> <span class="o">+</span> <span class="s">"192.168.0.4:1111"</span><span class="o">.</span><span class="na">hashCode</span><span class="o">());</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>我们在做集群的时候，集群点的IP以这种连续的形式存在是很正常的。看一下运行结果为：</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>192.168.0.0:111的哈希值：1845870087
192.168.0.1:111的哈希值：1874499238
192.168.0.2:111的哈希值：1903128389
192.168.0.3:111的哈希值：1931757540
192.168.0.4:111的哈希值：1960386691
</code></pre></div></div>

<p>这个就问题大了，[0,2^32-1]的区间之中，5个HashCode值却只分布在这么小小的一个区间，什么概念？[0,2^32-1]中有4294967296个数字，而我们的区间只有122516605，从概率学上讲这将导致97%待路由的服务器都被路由到”192.168.0.1″这个集群点上，简直是糟糕透了！</p>

<p>另外还有一个不好的地方：规定的区间是非负数，String的hashCode()方法却会产生负数（不信用”192.168.1.0:1111″试试看就知道了）。不过这个问题好解决，取绝对值就是一种解决的办法。</p>

<p>综上，String重写的hashCode()方法在一致性Hash算法中没有任何实用价值，得找个算法重新计算HashCode。这种重新计算Hash值的算法有很多，比如CRC32_HASH、FNV1_32_HASH、KETAMA_HASH等，其中KETAMA_HASH是默认的MemCache推荐的一致性Hash算法，用别的Hash算法也可以，比如FNV1_32_HASH算法的计算效率就会高一些。</p>

<p><strong>一致性Hash算法实现版本1：不带虚拟节点</strong></p>

<p>使用一致性Hash算法，尽管增强了系统的伸缩性，但是也有可能导致负载分布不均匀，解决办法就是<font color="red">使用虚拟节点代替真实节点，</font>第一个代码版本，先来个简单的，不带虚拟节点。</p>

<p>下面来看一下不带虚拟节点的一致性Hash算法的Java代码实现：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * 不带虚拟结点的一致性Hash算法
 * @author 哓哓
 *
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ConsistentHashWithoutVN</span> <span class="o">{</span>

	<span class="cm">/**
	 * 待加入Hash环的服务器列表
	 */</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="n">String</span><span class="o">[]</span> <span class="n">servers</span> <span class="o">=</span> <span class="o">{</span> <span class="s">"192.168.0.0:111"</span><span class="o">,</span> <span class="s">"192.168.0.1:111"</span><span class="o">,</span> <span class="s">"192.168.0.2:111"</span><span class="o">,</span> <span class="s">"192.168.0.3:111"</span><span class="o">,</span>
			<span class="s">"192.168.0.4:111"</span> <span class="o">};</span>

	<span class="cm">/**
	 * key表示服务器的hash值，value表示服务器的名称
	 */</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="n">SortedMap</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">sortedMap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TreeMap</span><span class="o">&lt;&gt;();</span>

	<span class="cm">/**
	 * 程序初始化，将所有服务器加入集合
	 */</span>
	<span class="kd">static</span> <span class="o">{</span>
		<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">servers</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
			<span class="kt">int</span> <span class="n">hash</span> <span class="o">=</span> <span class="n">getHash</span><span class="o">(</span><span class="n">servers</span><span class="o">[</span><span class="n">i</span><span class="o">]);</span>
			 <span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"["</span> <span class="o">+</span> <span class="n">servers</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">+</span> <span class="s">"]加入集群中, 其Hash值为"</span> <span class="o">+</span> <span class="n">hash</span><span class="o">);</span>
		     <span class="n">sortedMap</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">hash</span><span class="o">,</span> <span class="n">servers</span><span class="o">[</span><span class="n">i</span><span class="o">]);</span>
		<span class="o">}</span>
	<span class="o">}</span>

	<span class="cm">/**
	 * 使用FNV1_32_HASH算法计算hash值
	 * @param str
	 * @return
	 */</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">getHash</span><span class="o">(</span><span class="n">String</span> <span class="n">str</span><span class="o">)</span> <span class="o">{</span>
		<span class="kd">final</span> <span class="kt">int</span> <span class="n">p</span> <span class="o">=</span> <span class="mi">16777619</span><span class="o">;</span>
		<span class="kt">int</span> <span class="n">hash</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="mi">2166136261L</span><span class="o">;</span>
		<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">str</span><span class="o">.</span><span class="na">length</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
			<span class="n">hash</span> <span class="o">=</span> <span class="o">(</span><span class="n">hash</span> <span class="o">^</span> <span class="n">str</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="n">i</span><span class="o">))</span> <span class="o">*</span> <span class="n">p</span><span class="o">;</span>
		<span class="o">}</span>
		<span class="n">hash</span> <span class="o">+=</span> <span class="n">hash</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="o">;</span>
		<span class="n">hash</span> <span class="o">^=</span> <span class="n">hash</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="o">;</span>
		<span class="n">hash</span> <span class="o">+=</span> <span class="n">hash</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="o">;</span>
		<span class="n">hash</span> <span class="o">^=</span> <span class="n">hash</span> <span class="o">&gt;&gt;</span> <span class="mi">17</span><span class="o">;</span>
		<span class="n">hash</span> <span class="o">+=</span> <span class="n">hash</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="o">;</span>

		<span class="c1">// 如果算出来的值为负数则取其绝对值</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">hash</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span>
			<span class="n">hash</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="na">abs</span><span class="o">(</span><span class="n">hash</span><span class="o">);</span>
		<span class="k">return</span> <span class="n">hash</span><span class="o">;</span>
	<span class="o">}</span>
	
	<span class="kd">private</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">matchServer</span><span class="o">(</span><span class="n">String</span> <span class="n">node</span><span class="o">)</span> <span class="o">{</span>
		<span class="c1">// 待路由结点的Hash值</span>
		<span class="kt">int</span> <span class="n">hash</span> <span class="o">=</span> <span class="n">getHash</span><span class="o">(</span><span class="n">node</span><span class="o">);</span>
		<span class="c1">// 得到大于该Hash值的子Map</span>
		<span class="n">SortedMap</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">subMap</span> <span class="o">=</span> <span class="n">sortedMap</span><span class="o">.</span><span class="na">tailMap</span><span class="o">(</span><span class="n">hash</span><span class="o">);</span>
		<span class="c1">// 顺时针的第一个Key</span>
		<span class="n">Integer</span> <span class="n">i</span> <span class="o">=</span> <span class="n">subMap</span><span class="o">.</span><span class="na">firstKey</span><span class="o">();</span>
		<span class="c1">// 返回路由到的服务器名称</span>
		<span class="k">return</span> <span class="n">subMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
	<span class="o">}</span>
	
	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
		 
		<span class="n">String</span><span class="o">[]</span> <span class="n">nodes</span> <span class="o">=</span> <span class="o">{</span><span class="s">"127.0.0.1:1111"</span><span class="o">,</span> <span class="s">"221.226.0.1:2222"</span><span class="o">,</span> <span class="s">"10.211.0.1:3333"</span><span class="o">};</span>
		<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nodes</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
			<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"["</span> <span class="o">+</span> <span class="n">nodes</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">+</span> <span class="s">"]的hash值为"</span> <span class="o">+</span> <span class="n">getHash</span><span class="o">(</span><span class="n">nodes</span><span class="o">[</span><span class="n">i</span><span class="o">])</span> <span class="o">+</span> <span class="s">",被路由到的服务器为["</span> 
		<span class="o">+</span> <span class="n">matchServer</span><span class="o">(</span><span class="n">nodes</span><span class="o">[</span><span class="n">i</span><span class="o">])</span> <span class="o">+</span> <span class="s">""</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>
	
<span class="o">}</span>
</code></pre></div></div>

<p>可以运行一下看一下结果：</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="o">[</span>192.168.0.0:111]加入集群中, 其Hash值为575774686
<span class="o">[</span>192.168.0.1:111]加入集群中, 其Hash值为8518713
<span class="o">[</span>192.168.0.2:111]加入集群中, 其Hash值为1361847097
<span class="o">[</span>192.168.0.3:111]加入集群中, 其Hash值为1171828661
<span class="o">[</span>192.168.0.4:111]加入集群中, 其Hash值为1764547046
<span class="o">[</span>127.0.0.1:1111]的hash值为380278925,被路由到的服务器为[192.168.0.0:111]
<span class="o">[</span>221.226.0.1:2222]的hash值为1493545632,被路由到的服务器为[192.168.0.4:111]
<span class="o">[</span>10.211.0.1:3333]的hash值为1393836017,被路由到的服务器为[192.168.0.4:111]
</code></pre></div></div>

<p><strong>使用虚拟节点来改善一致性Hash算法</strong></p>

<p>上面的一致性Hash算法实现，可以在很大程度上解决很多分布式环境下不好的路由算法导致系统伸缩性差的问题，但是会带来另外一个问题：负载不均。</p>

<p>比如说有Hash环上有A、B、C三个服务器节点，分别有100个请求会被路由到相应服务器上。现在在A与B之间增加了一个节点D，这导致了原来会路由到B上的部分节点被路由到了D上，这样A、C上被路由到的请求明显多于B、D上的，原来三个服务器节点上均衡的负载被打破了。<font color="blue">某种程度上来说，这失去了负载均衡的意义，因为负载均衡的目的本身就是为了使得目标服务器均分所有的请求。</font></p>

<p>解决这个问题的办法是引入虚拟节点，其<font color="blue">工作原理是：将一个物理节点拆分为多个虚拟节点，并且同一个物理节点的虚拟节点尽量均匀分布在Hash环上。</font>采取这样的方式，就可以有效地解决增加或减少节点时候的负载不均衡的问题。</p>

<p>至于一个物理节点应该拆分为多少虚拟节点，下面可以先看一张图：</p>

<p><img src="http://7xlkoc.com1.z0.glb.clouddn.com/hash1.png" alt="" /></p>

<p>横轴表示需要为每台服务器扩展的虚拟节点倍数，纵轴表示的是实际物理服务器数。可以看出，物理服务器很少，需要更大的虚拟节点；反之物理服务器比较多，虚拟节点就可以少一些。比如有10台物理服务器，那么差不多需要为每台服务器增加100~200个虚拟节点才可以达到真正的负载均衡。</p>

<p><strong>一致性Hash算法实现版本2：带虚拟节点</strong></p>

<p>在理解了使用虚拟节点来改善一致性Hash算法的理论基础之后，就可以尝试开发代码了。编程方面需要考虑的问题是：</p>

<p>1、一个真实结点如何对应成为多个虚拟节点？</p>

<p>2、虚拟节点找到后如何还原为真实结点？</p>

<p>这两个问题其实有很多解决办法，我这里使用了一种简单的办法，给每个真实结点后面根据虚拟节点加上后缀再取Hash值，比如”192.168.0.0:111″就把它变成”192.168.0.0:111&amp;&amp;VN0″到”192.168.0.0:111&amp;&amp;VN4″，VN就是Virtual Node的缩写，还原的时候只需要从头截取字符串到”&amp;&amp;”的位置就可以了。</p>

<p>下面来看一下带虚拟节点的一致性Hash算法的Java代码实现：</p>

<div class="language-java highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="cm">/**
 * 带虚拟结点的一致性Hash算法
 * 
 * @author 哓哓
 *
 */</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">ConsistentHashWithVN</span> <span class="o">{</span>
	<span class="cm">/**
	 * 待加入Hash环的服务器列表
	 */</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="n">String</span><span class="o">[]</span> <span class="n">servers</span> <span class="o">=</span> <span class="o">{</span> <span class="s">"192.168.0.0:111"</span><span class="o">,</span> <span class="s">"192.168.0.1:111"</span><span class="o">,</span> <span class="s">"192.168.0.2:111"</span><span class="o">,</span> <span class="s">"192.168.0.3:111"</span><span class="o">,</span>
			<span class="s">"192.168.0.4:111"</span> <span class="o">};</span>

	<span class="cm">/**
	 * 真实结点列表，考虑到服务器上线、下线的场景，即添加、删除的场景会比较频繁，这里使用LinkedList会更好
	 */</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">String</span><span class="o">&gt;</span> <span class="n">realNodes</span> <span class="o">=</span> <span class="k">new</span> <span class="n">LinkedList</span><span class="o">&lt;&gt;();</span>

	<span class="cm">/**
	 * key表示虚拟结点服务器的hash值，value表示虚拟结点服务器的名称
	 */</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="n">SortedMap</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">virtualNodes</span> <span class="o">=</span> <span class="k">new</span> <span class="n">TreeMap</span><span class="o">&lt;&gt;();</span>

	<span class="cm">/**
	 * 虚拟结点数目（一个真实结点对应VN_SUM个虚拟结点）
	 */</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="n">VN_SUM</span> <span class="o">=</span> <span class="mi">5</span><span class="o">;</span>

	<span class="cm">/**
	 * 加所有服务器加入集合
	 */</span>
	<span class="kd">static</span> <span class="o">{</span>
		<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">servers</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
			<span class="n">realNodes</span><span class="o">.</span><span class="na">add</span><span class="o">(</span><span class="n">servers</span><span class="o">[</span><span class="n">i</span><span class="o">]);</span>
		<span class="o">}</span>

		<span class="k">for</span> <span class="o">(</span><span class="n">String</span> <span class="n">str</span> <span class="o">:</span> <span class="n">realNodes</span><span class="o">)</span> <span class="o">{</span>
			<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">VN_SUM</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
				<span class="n">String</span> <span class="n">virtualNodeName</span> <span class="o">=</span> <span class="n">str</span> <span class="o">+</span> <span class="s">"&amp;VN"</span> <span class="o">+</span> <span class="n">String</span><span class="o">.</span><span class="na">valueOf</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
				<span class="kt">int</span> <span class="n">hash</span> <span class="o">=</span> <span class="n">getHash</span><span class="o">(</span><span class="n">virtualNodeName</span><span class="o">);</span>
				<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"虚拟节点["</span> <span class="o">+</span> <span class="n">virtualNodeName</span> <span class="o">+</span> <span class="s">"]被添加, hash值为"</span> <span class="o">+</span> <span class="n">hash</span><span class="o">);</span>
				<span class="n">virtualNodes</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">hash</span><span class="o">,</span> <span class="n">virtualNodeName</span><span class="o">);</span>
			<span class="o">}</span>
		<span class="o">}</span>
		<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"\n===========路由映射==============\n"</span><span class="o">);</span>
	<span class="o">}</span>

	<span class="cm">/**
	 * 使用FNV1_32_HASH算法计算hash值
	 * 
	 * @param str
	 * @return
	 */</span>
	<span class="kd">private</span> <span class="kd">static</span> <span class="kt">int</span> <span class="nf">getHash</span><span class="o">(</span><span class="n">String</span> <span class="n">str</span><span class="o">)</span> <span class="o">{</span>
		<span class="kd">final</span> <span class="kt">int</span> <span class="n">p</span> <span class="o">=</span> <span class="mi">16777619</span><span class="o">;</span>
		<span class="kt">int</span> <span class="n">hash</span> <span class="o">=</span> <span class="o">(</span><span class="kt">int</span><span class="o">)</span> <span class="mi">2166136261L</span><span class="o">;</span>
		<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">str</span><span class="o">.</span><span class="na">length</span><span class="o">();</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
			<span class="n">hash</span> <span class="o">=</span> <span class="o">(</span><span class="n">hash</span> <span class="o">^</span> <span class="n">str</span><span class="o">.</span><span class="na">charAt</span><span class="o">(</span><span class="n">i</span><span class="o">))</span> <span class="o">*</span> <span class="n">p</span><span class="o">;</span>
		<span class="o">}</span>
		<span class="n">hash</span> <span class="o">+=</span> <span class="n">hash</span> <span class="o">&lt;&lt;</span> <span class="mi">13</span><span class="o">;</span>
		<span class="n">hash</span> <span class="o">^=</span> <span class="n">hash</span> <span class="o">&gt;&gt;</span> <span class="mi">7</span><span class="o">;</span>
		<span class="n">hash</span> <span class="o">+=</span> <span class="n">hash</span> <span class="o">&lt;&lt;</span> <span class="mi">3</span><span class="o">;</span>
		<span class="n">hash</span> <span class="o">^=</span> <span class="n">hash</span> <span class="o">&gt;&gt;</span> <span class="mi">17</span><span class="o">;</span>
		<span class="n">hash</span> <span class="o">+=</span> <span class="n">hash</span> <span class="o">&lt;&lt;</span> <span class="mi">5</span><span class="o">;</span>

		<span class="c1">// 如果算出来的值为负数则取其绝对值</span>
		<span class="k">if</span> <span class="o">(</span><span class="n">hash</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="o">)</span>
			<span class="n">hash</span> <span class="o">=</span> <span class="n">Math</span><span class="o">.</span><span class="na">abs</span><span class="o">(</span><span class="n">hash</span><span class="o">);</span>
		<span class="k">return</span> <span class="n">hash</span><span class="o">;</span>
	<span class="o">}</span>

	<span class="kd">private</span> <span class="kd">static</span> <span class="n">String</span> <span class="nf">matchServer</span><span class="o">(</span><span class="n">String</span> <span class="n">node</span><span class="o">)</span> <span class="o">{</span>
		<span class="c1">// 待路由结点的Hash值</span>
		<span class="kt">int</span> <span class="n">hash</span> <span class="o">=</span> <span class="n">getHash</span><span class="o">(</span><span class="n">node</span><span class="o">);</span>
		<span class="c1">// 得到大于该Hash值的子Map</span>
		<span class="n">SortedMap</span><span class="o">&lt;</span><span class="n">Integer</span><span class="o">,</span> <span class="n">String</span><span class="o">&gt;</span> <span class="n">subMap</span> <span class="o">=</span> <span class="n">virtualNodes</span><span class="o">.</span><span class="na">tailMap</span><span class="o">(</span><span class="n">hash</span><span class="o">);</span>
		<span class="c1">// 顺时针的第一个Key</span>
		<span class="n">Integer</span> <span class="n">i</span> <span class="o">=</span> <span class="n">subMap</span><span class="o">.</span><span class="na">firstKey</span><span class="o">();</span>
		<span class="c1">// 截取</span>
		<span class="n">String</span> <span class="n">virtualNode</span> <span class="o">=</span> <span class="n">subMap</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">i</span><span class="o">);</span>
		
		<span class="c1">// 返回路由到的服务器名称</span>
		<span class="k">return</span> <span class="n">virtualNode</span><span class="o">.</span><span class="na">substring</span><span class="o">(</span><span class="mi">0</span><span class="o">,</span> <span class="n">virtualNode</span><span class="o">.</span><span class="na">indexOf</span><span class="o">(</span><span class="s">"&amp;"</span><span class="o">));</span>
	<span class="o">}</span>

	<span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>

		<span class="n">String</span><span class="o">[]</span> <span class="n">nodes</span> <span class="o">=</span> <span class="o">{</span> <span class="s">"127.0.0.1:1111"</span><span class="o">,</span> <span class="s">"221.226.0.1:2222"</span><span class="o">,</span> <span class="s">"10.211.0.1:3333"</span><span class="o">,</span> <span class="s">"112.74.15.218:80"</span> <span class="o">};</span>
		<span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">nodes</span><span class="o">.</span><span class="na">length</span><span class="o">;</span> <span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
			<span class="n">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span>
					<span class="s">"["</span> <span class="o">+</span> <span class="n">nodes</span><span class="o">[</span><span class="n">i</span><span class="o">]</span> <span class="o">+</span> <span class="s">"]的hash值为"</span> <span class="o">+</span> <span class="n">getHash</span><span class="o">(</span><span class="n">nodes</span><span class="o">[</span><span class="n">i</span><span class="o">])</span> <span class="o">+</span> <span class="s">",被路由到的服务器为["</span> <span class="o">+</span> <span class="n">matchServer</span><span class="o">(</span><span class="n">nodes</span><span class="o">[</span><span class="n">i</span><span class="o">])</span> <span class="o">+</span> <span class="s">"]"</span><span class="o">);</span>
		<span class="o">}</span>
	<span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<p>关注一下运行结果：</p>

<div class="language-sh highlighter-rouge"><div class="highlight"><pre class="highlight"><code>虚拟节点[192.168.0.0:111&amp;VN0]被添加, hash值为62550928
虚拟节点[192.168.0.0:111&amp;VN1]被添加, hash值为45670134
虚拟节点[192.168.0.0:111&amp;VN2]被添加, hash值为1069081239
虚拟节点[192.168.0.0:111&amp;VN3]被添加, hash值为681260483
虚拟节点[192.168.0.0:111&amp;VN4]被添加, hash值为345193220
虚拟节点[192.168.0.1:111&amp;VN0]被添加, hash值为1014794997
虚拟节点[192.168.0.1:111&amp;VN1]被添加, hash值为314112378
虚拟节点[192.168.0.1:111&amp;VN2]被添加, hash值为1764217630
虚拟节点[192.168.0.1:111&amp;VN3]被添加, hash值为1754008301
虚拟节点[192.168.0.1:111&amp;VN4]被添加, hash值为1013081826
虚拟节点[192.168.0.2:111&amp;VN0]被添加, hash值为1936519782
虚拟节点[192.168.0.2:111&amp;VN1]被添加, hash值为1962355349
虚拟节点[192.168.0.2:111&amp;VN2]被添加, hash值为1051508275
虚拟节点[192.168.0.2:111&amp;VN3]被添加, hash值为1487794011
虚拟节点[192.168.0.2:111&amp;VN4]被添加, hash值为1010967116
虚拟节点[192.168.0.3:111&amp;VN0]被添加, hash值为1671479534
虚拟节点[192.168.0.3:111&amp;VN1]被添加, hash值为803892279
虚拟节点[192.168.0.3:111&amp;VN2]被添加, hash值为1986618297
虚拟节点[192.168.0.3:111&amp;VN3]被添加, hash值为1068919486
虚拟节点[192.168.0.3:111&amp;VN4]被添加, hash值为454720555
虚拟节点[192.168.0.4:111&amp;VN0]被添加, hash值为232783560
虚拟节点[192.168.0.4:111&amp;VN1]被添加, hash值为1097591827
虚拟节点[192.168.0.4:111&amp;VN2]被添加, hash值为812889841
虚拟节点[192.168.0.4:111&amp;VN3]被添加, hash值为1338995023
虚拟节点[192.168.0.4:111&amp;VN4]被添加, hash值为1008393313

<span class="o">===========</span>路由映射<span class="o">==============</span>

<span class="o">[</span>127.0.0.1:1111]的hash值为380278925,被路由到的服务器为[192.168.0.3:111]
<span class="o">[</span>221.226.0.1:2222]的hash值为1493545632,被路由到的服务器为[192.168.0.3:111]
<span class="o">[</span>10.211.0.1:3333]的hash值为1393836017,被路由到的服务器为[192.168.0.2:111]
<span class="o">[</span>112.74.15.218:80]的hash值为51269059,被路由到的服务器为[192.168.0.0:111]
</code></pre></div></div>

<p>从代码运行结果看，每个点路由到的服务器都是Hash值顺时针离它最近的那个服务器节点，没有任何问题。</p>

<p>通过采取虚拟节点的方法，一个真实结点不再固定在Hash环上的某个点，而是大量地分布在整个Hash环上，这样即使上线、下线服务器，也不会造成整体的负载不均衡。</p>

<p>后记</p>

<p>在写本文的时候，很多知识我也是边写边学，难免有很多写得不好、理解得不透彻的地方，而且代码整体也比较糙，未有考虑到可能的各种情况。抛砖引玉，一方面，写得不对的地方，还望网友朋友们指正；另一方面，后续我也将通过自己的工作、学习不断完善上面的代码。</p>

<blockquote>
  <p>转自<a href="http://www.cnblogs.com/xrq730/p/5186728.html">五月的仓颉</a>，代码自己重新实现过。</p>
</blockquote>

<h3 id="联系我">联系我</h3>

<ul>
  <li>邮箱: xmusaber@163.com</li>
  <li>QQ: 932191671</li>
</ul>

<div align="center">
<img src="http://rann.cc/assets/img/qrcode-logo.png" width="400" height="320" />
</div>

<blockquote>
  <p>本文系本人个人公众号「梦回少年」原创发布，扫一扫加关注。</p>
</blockquote>
	
  </article>
</div>

  <div class="prevandnext">
    	  
	    <div style="margin:0.5em;">
	    <span>上一篇 ：</span><a class="pjaxlink" href="http://localhost:4000/2016/07/09/learn-redis.html"  title="Redis学习日记">Redis学习日记</a>
	    </div>
	  
  	  
	    <div style="margin:0.5em;">
	    <span>下一篇 ：</span><a class="pjaxlink" href="http://localhost:4000/2016/07/07/spring-ioc.html"  title="Spring 的本质系列之IOC">Spring 的本质系列之IOC</a>
	    </div>
	  
	  	<div style="margin:0.5em;">
			<span> 版权所有，转载时必须以链接形式注明原始出处</span>
	    </div>
	 
  </div></div>		
			</div>
 		</div>	
	</div>
    </div> 
</div>
	<div class="profile_social">
		<a class="rss" href="/feed.xml" target="_blank"></a>
		<a class="github" href="https://github.com/lemonjing"  target="_blank"></a>
		<a class="weibo" href="http://weibo.com/u/1662536394"  target="_blank"></a>
	</div>
    <div id="backtotop">
    		<a href="#"><i class="fa fa-arrow-circle-up"></i></a>
    </div>
    <div class="pjax_loading"></div>
    
    <footer class="site-footer">
  <div class="wrapper">

    <h2 class="footer-heading">saber's blog</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col  footer-col-1">
        <ul class="contact-list">
          <li>梦回少年</li>
          <li><a href="mailto:xmusaber@163.com">xmusaber@163.com</a></li>
          <li>闽ICP备15018990号</li>
        </ul>
      </div>

      <div class="footer-col  footer-col-2">
        <ul class="social-media-list">
          
          <li>
            <a class="github" href="https://github.com/lemonjing"  target="_blank"></a>
          </li>
          

          
          <li>
            <a class="weibo" href="http://weibo.com/u/1662536394"  target="_blank"></a>
          </li>
          
        </ul>
      </div>
      <div class="footer-col  footer-col-3">
        <p class="text">If,<br/>for example,<br/>you come at four o'clock in the afternoon,<br/>then at three o'clock I shall begin to be happy.</p>
      </div>
    </div>
</div>
    <div class="center sitedesc">
    	Powered by <a href ="http://jekyllrb.com/">Jekyll</a>  |  © 2018 梦回少年  |  Hosted on <a href="https://github.com/lemonjing/lemonjing.github.io"> Github</a></div>
    <div class="center sitedesc"><span id=span_dt_dt></span>&nbsp;&nbsp;|&nbsp;&nbsp;<span id="busuanzi_container_site_pv" style='display:none'>本站总访问量<span id="busuanzi_value_site_pv"></span>次<br/>
    <script type="text/javascript">var cnzz_protocol = (("https:" == document.location.protocol) ? " https://" : " http://");document.write(unescape("%3Cspan id='cnzz_stat_icon_1259223523'%3E%3C/span%3E%3Cscript src='" + cnzz_protocol + "s11.cnzz.com/z_stat.php%3Fid%3D1259223523%26online%3D1%26show%3Dline' type='text/javascript'%3E%3C/script%3E"));</script>
    </div>

<!-- 访问统计 -->
<script async src="https://dn-lbstatics.qbox.me/busuanzi/2.3/busuanzi.pure.mini.js"></script>

<!-- 萌萌哒运行 -->
  <SCRIPT language=javascript>          
function show_date_time(){
window.setTimeout("show_date_time()", 1000);
BirthDay=new Date("8/15/2015 11:30:00");//这个日期是可以修改的
today=new Date();
timeold=(today.getTime()-BirthDay.getTime());
sectimeold=timeold/1000
secondsold=Math.floor(sectimeold);
msPerDay=24*60*60*1000
e_daysold=timeold/msPerDay
daysold=Math.floor(e_daysold);
e_hrsold=(e_daysold-daysold)*24;
hrsold=Math.floor(e_hrsold);
e_minsold=(e_hrsold-hrsold)*60;
minsold=Math.floor((e_hrsold-hrsold)*60);
seconds=Math.floor((e_minsold-minsold)*60);
span_dt_dt.innerHTML="本站已萌萌哒运行"+daysold+"天"+hrsold+"小时"+minsold+"分"+seconds+"秒";
}show_date_time();</SCRIPT>

  <!-- <script type="text/x-mathjax-config">
    MathJax.Hub.Config({
        TeX: {equationNumbers: {
            autoNumber: ["AMS"], useLabelIds: true}},
            "HTML-CSS": {linebreaks: {automatic: true}},
            SVG: {linebreaks: {automatic: true}}
    });
   </script> -->

  <!-- jQuery -->
  <script src="//cdn.bootcss.com/jquery/2.2.2/jquery.min.js"></script>
  <script type="text/javascript" src="/assets/js/jquery.pjax.js"></script>
  <!-- Bootstrap Core JavaScript -->
  <script src="//cdn.bootcss.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
  <script type="text/javascript" src="/assets/js/prettify/prettify.js"></script>
  
  <!-- <script type="text/javascript" src="http://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script> -->
  <script type="text/javascript" src="/assets/js/ua-parser.js"></script>

  <!-- jekyII search-->
<div class="cb-search-tool" style="position: fixed; top: 0px ; bottom: 0px; left: 0px; right:  0px;
      opacity: 0.95; background-color: #111111; z-index: 9999; display: none;">
    <input type="text" class="form-control cb-search-content" id="cb-search-content" style="position: fixed; top: 60px" placeholder="文章标题 日期 标签" >

    <div style="position: fixed; top: 16px; right: 16px;">
        <img src="/search/img/cb-close.png"  id="cb-close-btn"/>
    </div>
</div>

<!-- <div style="position: fixed; right: 16px; bottom: 20px;">
    <img src="/search/img/cb-search.png"  id="cb-search-btn"  title="双击ctrl试一下"/>
</div> -->

<link rel="stylesheet" href="/search/css/cb-search.css">

<script src="/search/js/bootstrap3-typeahead.min.js"></script>
<script src="/search/js/cb-search.js"></script>
<!-- jekyII search end -->

  
<script type="text/javascript" src="http://echarts.baidu.com/build/dist/echarts.js"></script>
<script type="text/javascript" src="/assets/js/embed.js"></script>
<script type="text/javascript" src="/assets/js/stickUp.min.js"></script>
<script type="text/javascript" src="/assets/js/main.js"></script>

</footer>

  </body>

</html>